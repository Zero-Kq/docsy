<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://Zero-Kq.github.io/docsy/blog/qgroundcontrol/><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/docsy/favicons/favicon.ico><link rel=apple-touch-icon href=/docsy/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/docsy/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/docsy/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/docsy/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/docsy/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/docsy/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/docsy/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/docsy/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/docsy/favicons/android-192x192.png sizes=192x192><title>QGroundControl | Zerokq</title>
<meta name=description content="基于 QGroundControl 框架的地面站开发技术文档。"><meta property="og:url" content="https://Zero-Kq.github.io/docsy/blog/qgroundcontrol/"><meta property="og:site_name" content="Zerokq"><meta property="og:title" content="QGroundControl"><meta property="og:description" content="基于 QGroundControl 框架的地面站开发技术文档。"><meta property="og:locale" content="cn"><meta property="og:type" content="website"><meta itemprop=name content="QGroundControl"><meta itemprop=description content="基于 QGroundControl 框架的地面站开发技术文档。"><meta itemprop=datePublished content="2026-02-25T15:18:48+08:00"><meta itemprop=dateModified content="2026-02-25T15:18:48+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="QGroundControl"><meta name=twitter:description content="基于 QGroundControl 框架的地面站开发技术文档。"><link rel=preload href=/docsy/scss/main.min.b3c5d5b5e4fe744101b7961318bcd54d586465cd4abf620f17de0fb0b88e151b.css as=style integrity="sha256-s8XVteT+dEEBt5YTGLzVTVhkZc1Kv2IPF94PsLiOFRs=" crossorigin=anonymous><link href=/docsy/scss/main.min.b3c5d5b5e4fe744101b7961318bcd54d586465cd4abf620f17de0fb0b88e151b.css rel=stylesheet integrity="sha256-s8XVteT+dEEBt5YTGLzVTVhkZc1Kv2IPF94PsLiOFRs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class="td-section td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/docsy/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 640 640"><path d="M304 70.1C313.1 61.9 326.9 61.9 336 70.1l232 208C577.9 286.9 578.7 302.1 569.8 312 560.9 321.9 545.8 322.7 535.9 313.8L527.9 306.6V511.9c0 35.3000000000001-28.7 64-64 64h-288c-35.3.0-64-28.6999999999999-64-64V306.6L103.9 313.8C94 322.6 78.9 321.8 70 312 61.1 302.2 62 287 71.8 278.1L304 70.1zm16 50.1L160 263.7V512C160 520.8 167.2 528 176 528h48V424c0-39.8 32.2-72 72-72h48c39.8.0 72 32.2 72 72V528h48C472.8 528 480 520.8 480 512V263.7L320 120.3zM272 528h96V424c0-13.3-10.7-24-24-24H296c-13.3.0-24 10.7-24 24V528z"/></svg></span><span class=navbar-brand__name>Zerokq</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docsy/about/><span>关于</span></a></li><li class=nav-item><a class=nav-link href=/docsy/docs/><span>说明</span></a></li><li class=nav-item><a class="nav-link active" href=/docsy/blog/><span>博客</span></a></li><li class=nav-item><a class=nav-link href=/docsy/reviews/><span>读后感</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>中文(Chinese)</a><ul class=dropdown-menu><li><a class=dropdown-item href=/docsy/en/>English</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=搜索 aria-label=搜索 autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>打印此章节
<a href=# onclick="return print(),!1">点击打印</a>.</p><p><a href=/docsy/blog/qgroundcontrol/>显示常规版本</a>.</p></div><h1 class=title>QGroundControl</h1><div class=lead>基于 QGroundControl 框架的地面站开发技术文档。</div><ul><li><a href=#pg-1c212b51256d9d2b76337461f3b6dcc1>MavSDK和QGC航点规划兼容性问题的解决方案</a></li><li><a href=#pg-7f125b68e9d871079e568027c34e1082>QGroundControl Docker 进阶构建指南</a></li><li><a href=#pg-aaa2b86831f274c3988863b89cd8f8bd>QGroundControl 基于官方文档的容器化构建</a></li><li><a href=#pg-c02dbade865b275a8f957a9075a8ffab>在 QGC 和 大模型 FastAPI 后端实现的端到端无人机语音指令框架</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-1c212b51256d9d2b76337461f3b6dcc1>MavSDK和QGC航点规划兼容性问题的解决方案</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><h2 id=1-问题背景>1. 问题背景</h2><h3 id=11-qgc-506-稳定版航点管理问题>1.1 QGC 5.0.6 稳定版航点管理问题</h3><h4 id=版本兼容性说明>版本兼容性说明</h4><p>本解决方案针对以下版本进行了测试和优化：</p><ul><li><strong>QGroundControl</strong>: 5.0.6 Stable (<a href=https://github.com/mavlink/qgroundcontrol>GitHub仓库</a>)</li><li><strong>MAVSDK-Python</strong>: 3.10.2 (<a href=https://github.com/mavlink/MAVSDK-Python>GitHub仓库</a>)</li></ul><p>QGroundControl (QGC) 5.0.6 稳定版在航点管理方面存在一些已知问题，这些问题主要影响无人机任务的规划和执行：</p><h4 id=主要问题表现>主要问题表现</h4><ol><li><p><strong>航点数量异常增长</strong></p><ul><li>用户上传5个航点，QGC显示15-20个航点</li><li>系统自动生成额外的航点，导致任务执行异常</li><li>航点序列号不连续，影响任务逻辑</li></ul></li><li><p><strong>航点执行异常</strong></p><ul><li>无人机在航点处"徘徊"不继续执行</li><li>航点接受半径设置无效</li><li>任务执行顺序混乱</li></ul></li><li><p><strong>界面显示问题</strong></p><ul><li>航点列表显示不准确</li><li>航点属性显示错误</li><li>任务状态更新延迟</li></ul></li></ol><h4 id=问题影响>问题影响</h4><ul><li><strong>任务可靠性下降</strong>：航点数量异常导致任务执行不可预测</li><li><strong>操作效率降低</strong>：需要手动清理多余航点</li><li><strong>安全风险增加</strong>：航点执行异常可能导致飞行安全问题</li></ul><h3 id=12-mavsdk-python-missionitem-与-qgc-兼容性问题>1.2 MAVSDK-Python MissionItem 与 QGC 兼容性问题</h3><p>MAVSDK-Python 的 MissionItem 数据结构与 QGC 的航点解析机制之间存在兼容性问题，主要体现在数据结构差异和协议层面问题两个方面。在数据结构方面，MAVSDK-Python 使用 <code>latitude_deg</code>，<code>longitude_deg</code> 字段格式，而 QGC 期望 <code>lat</code>，<code>lng</code> 格式，同时 MAVSDK-Python 使用枚举类型（如 <code>CameraAction</code>，<code>VehicleAction</code>），而 QGC 期望字符串或数值，导致类型转换失败和解析错误。此外，MAVSDK-Python 的参数范围与 QGC 期望不匹配，超出范围的参数被 QGC 忽略或错误处理。</p><p>在协议层面，MAVSDK-Python 使用 <code>MISSION_ITEM_INT</code> 消息格式，但 QGC 5.0.6 对某些字段处理不当，存在消息序列号管理问题。同时，经纬度精度处理存在差异，高度参考系统不一致，坐标系转换错误导致航点位置计算偏差。</p><h3 id=13-航点数量异常增长的根本原因分析>1.3 航点数量异常增长的根本原因分析</h3><p>航点数量异常增长主要由三个核心问题导致：QGC 5.0.6 在解析航点时自动生成额外的航点，系统认为某些航点需要"连接"或"优化"，但自动生成的航点没有正确的序列号；QGC 对 <code>MISSION_ITEM_INT</code> 消息解析不完整，某些字段被错误解释为新的航点，导致消息序列号管理混乱；上传新任务前没有完全清除旧任务，新旧航点混合导致数量异常，任务状态管理不当。</p><p>在技术实现层面，QGC 5.0.6 的解析逻辑存在缺陷，当遇到某些特殊字段时会错误地创建新航点，同时 QGC 期望连续的序列号，但 MAVSDK-Python 生成的序列号可能不连续，导致 QGC 认为有"缺失"的航点。此外，经纬度精度处理不当和坐标系转换算法错误导致航点位置计算偏差。</p><p>解决方案需要采用 MissionRaw 接口直接使用 <code>MISSION_ITEM_INT</code> 消息格式，避免 QGC 的自动解析和优化，确保航点数据的一致性。同时需要在上传前完全清除旧任务，确保任务状态重置，避免新旧任务混合，并使用正确的坐标系转换和参数范围控制，避免触发 QGC 的自动优化机制。</p><h2 id=2-技术原理>2. 技术原理</h2><h3 id=21-mavsdk-python-missionitem-数据结构>2.1 MAVSDK-Python MissionItem 数据结构</h3><p>MAVSDK-Python 的 MissionItem 是航点任务的核心数据结构，包含了无人机执行任务所需的所有信息：</p><h4 id=核心字段>核心字段</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 位置信息</span>
</span></span><span style=display:flex><span>    <span style=color:#000>latitude_deg</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>          <span style=color:#8f5902;font-style:italic># 纬度（度，范围：-90 到 +90）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>longitude_deg</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>        <span style=color:#8f5902;font-style:italic># 经度（度，范围：-180 到 +180）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>relative_altitude_m</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>  <span style=color:#8f5902;font-style:italic># 相对起飞高度（米）</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 飞行参数</span>
</span></span><span style=display:flex><span>    <span style=color:#000>speed_m_s</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>           <span style=color:#8f5902;font-style:italic># 飞行速度（米/秒）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>is_fly_through</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>bool</span>       <span style=color:#8f5902;font-style:italic># 是否飞越航点（True=飞越，False=停留）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>acceptance_radius_m</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span> <span style=color:#8f5902;font-style:italic># 航点接受半径（米）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>yaw_deg</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>            <span style=color:#8f5902;font-style:italic># 偏航角（度）</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 云台控制</span>
</span></span><span style=display:flex><span>    <span style=color:#000>gimbal_pitch_deg</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>   <span style=color:#8f5902;font-style:italic># 云台俯仰角（度）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>gimbal_yaw_deg</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>     <span style=color:#8f5902;font-style:italic># 云台偏航角（度）</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 相机控制</span>
</span></span><span style=display:flex><span>    <span style=color:#000>camera_action</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>CameraAction</span>           <span style=color:#8f5902;font-style:italic># 相机动作</span>
</span></span><span style=display:flex><span>    <span style=color:#000>camera_photo_interval_s</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>       <span style=color:#8f5902;font-style:italic># 拍照间隔（秒）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>camera_photo_distance_m</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>       <span style=color:#8f5902;font-style:italic># 拍照距离（米）</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 飞行控制</span>
</span></span><span style=display:flex><span>    <span style=color:#000>vehicle_action</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>VehicleAction</span>        <span style=color:#8f5902;font-style:italic># 飞行器动作</span>
</span></span><span style=display:flex><span>    <span style=color:#000>loiter_time_s</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>                 <span style=color:#8f5902;font-style:italic># 盘旋时间（秒）</span>
</span></span></code></pre></div><h4 id=枚举类型>枚举类型</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CameraAction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Enum</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>NONE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;NONE&#34;</span>                    <span style=color:#8f5902;font-style:italic># 无动作</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TAKE_PHOTO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;TAKE_PHOTO&#34;</span>        <span style=color:#8f5902;font-style:italic># 拍照</span>
</span></span><span style=display:flex><span>    <span style=color:#000>START_VIDEO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;START_VIDEO&#34;</span>      <span style=color:#8f5902;font-style:italic># 开始录像</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STOP_VIDEO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;STOP_VIDEO&#34;</span>        <span style=color:#8f5902;font-style:italic># 停止录像</span>
</span></span><span style=display:flex><span>    <span style=color:#000>START_PHOTO_INTERVAL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;START_PHOTO_INTERVAL&#34;</span>  <span style=color:#8f5902;font-style:italic># 开始定时拍照</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STOP_PHOTO_INTERVAL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;STOP_PHOTO_INTERVAL&#34;</span>    <span style=color:#8f5902;font-style:italic># 停止定时拍照</span>
</span></span><span style=display:flex><span>    <span style=color:#000>START_PHOTO_DISTANCE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;START_PHOTO_DISTANCE&#34;</span>  <span style=color:#8f5902;font-style:italic># 开始距离拍照</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STOP_PHOTO_DISTANCE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;STOP_PHOTO_DISTANCE&#34;</span>    <span style=color:#8f5902;font-style:italic># 停止距离拍照</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>VehicleAction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Enum</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>NONE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;NONE&#34;</span>                    <span style=color:#8f5902;font-style:italic># 无动作</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TAKEOFF</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;TAKEOFF&#34;</span>              <span style=color:#8f5902;font-style:italic># 起飞</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LAND</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;LAND&#34;</span>                    <span style=color:#8f5902;font-style:italic># 降落</span>
</span></span><span style=display:flex><span>    <span style=color:#000>HOLD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;HOLD&#34;</span>                    <span style=color:#8f5902;font-style:italic># 悬停</span>
</span></span><span style=display:flex><span>    <span style=color:#000>RETURN_TO_LAUNCH</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;RETURN_TO_LAUNCH&#34;</span>  <span style=color:#8f5902;font-style:italic># 返航</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TRANSITION_TO_FW</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;TRANSITION_TO_FW&#34;</span>  <span style=color:#8f5902;font-style:italic># 切换到固定翼模式</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TRANSITION_TO_MC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;TRANSITION_TO_MC&#34;</span>  <span style=color:#8f5902;font-style:italic># 切换到多旋翼模式</span>
</span></span></code></pre></div><h3 id=22-missionraw-与-mission-接口的区别>2.2 MissionRaw 与 Mission 接口的区别</h3><p>MAVSDK-Python 提供了两个不同的任务接口，它们在数据格式和用途上有重要区别：</p><h4 id=mission-接口高层接口>Mission 接口（高层接口）</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 Mission 接口</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>mavsdk.mission</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>MissionPlan</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建航点</span>
</span></span><span style=display:flex><span><span style=color:#000>mission_item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>latitude_deg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>47.641627578463165</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>longitude_deg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>122.14016532897949</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>relative_altitude_m</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>speed_m_s</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>is_fly_through</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># ... 其他参数</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建任务计划</span>
</span></span><span style=display:flex><span><span style=color:#000>mission_plan</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MissionPlan</span><span style=color:#000;font-weight:700>([</span><span style=color:#000>mission_item</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 上传任务</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>upload_mission</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mission_plan</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p><strong>特点：</strong></p><ul><li>使用高层数据结构</li><li>自动处理数据转换</li><li>适合简单的航点任务</li><li>与 QGC 兼容性较差</li></ul><h4 id=missionraw-接口底层接口>MissionRaw 接口（底层接口）</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 MissionRaw 接口</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>mavsdk.mission_raw</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>MissionItem</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>RawMissionItem</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建原始航点</span>
</span></span><span style=display:flex><span><span style=color:#000>raw_item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>                                    <span style=color:#8f5902;font-style:italic># 序列号</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>                                  <span style=color:#8f5902;font-style:italic># 坐标系（MAV_FRAME_GLOBAL_RELATIVE_ALT_INT）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>                               <span style=color:#8f5902;font-style:italic># 命令（MAV_CMD_NAV_WAYPOINT）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>                                <span style=color:#8f5902;font-style:italic># 当前航点标志</span>
</span></span><span style=display:flex><span>    <span style=color:#000>autocontinue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>                           <span style=color:#8f5902;font-style:italic># 自动继续标志</span>
</span></span><span style=display:flex><span>    <span style=color:#000>param1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>                              <span style=color:#8f5902;font-style:italic># 参数1（盘旋时间）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>param2</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5.0</span><span style=color:#000;font-weight:700>,</span>                              <span style=color:#8f5902;font-style:italic># 参数2（接受半径）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>param3</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>                              <span style=color:#8f5902;font-style:italic># 参数3（未使用）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>param4</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>                              <span style=color:#8f5902;font-style:italic># 参数4（偏航角）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>476416275</span><span style=color:#000;font-weight:700>,</span>                             <span style=color:#8f5902;font-style:italic># 纬度（度*1e7）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1221401653</span><span style=color:#000;font-weight:700>,</span>                            <span style=color:#8f5902;font-style:italic># 经度（度*1e7）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10.0</span><span style=color:#000;font-weight:700>,</span>                                  <span style=color:#8f5902;font-style:italic># 高度（米）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mission_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>                           <span style=color:#8f5902;font-style:italic># 任务类型</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 上传原始任务</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission_raw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>upload_mission</span><span style=color:#000;font-weight:700>([</span><span style=color:#000>raw_item</span><span style=color:#000;font-weight:700>])</span>
</span></span></code></pre></div><p><strong>特点：</strong></p><ul><li>直接使用 MAVLink 消息格式</li><li>完全控制数据格式</li><li>与 QGC 兼容性更好</li><li>需要手动处理数据转换</li></ul><h3 id=23-qgc-航点解析机制>2.3 QGC 航点解析机制</h3><p>QGroundControl 5.0.6 的航点解析机制存在一些已知问题：</p><h4 id=解析流程>解析流程</h4><ol><li><p><strong>接收 MAVLink 消息</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># QGC 接收 MISSION_ITEM_INT 消息</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>parse_mission_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>seq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>seq</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>frame</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>command</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># ... 解析其他字段</span>
</span></span></code></pre></div></li><li><p><strong>数据验证和转换</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># QGC 的数据验证逻辑（存在问题）</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>command</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MAV_CMD_NAV_WAYPOINT</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 错误：某些条件下会创建额外航点</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>param1</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#8f5902;font-style:italic># 问题条件</span>
</span></span><span style=display:flex><span>        <span style=color:#000>create_additional_waypoint</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div></li><li><p><strong>航点显示和存储</strong></p><ul><li>将解析的航点添加到任务列表</li><li>更新界面显示</li><li>存储到本地数据库</li></ul></li></ol><h4 id=已知问题>已知问题</h4><ol><li><p><strong>自动航点生成</strong></p><ul><li>QGC 5.0.6 在某些条件下会自动生成额外航点</li><li>这些航点没有正确的序列号</li><li>导致任务执行异常</li></ul></li><li><p><strong>参数解析错误</strong></p><ul><li>某些参数被错误解释</li><li>导致航点属性不正确</li><li>影响任务执行逻辑</li></ul></li><li><p><strong>坐标系转换问题</strong></p><ul><li>经纬度精度处理不当</li><li>坐标系转换算法错误</li><li>导致航点位置偏移</li></ul></li></ol><h3 id=24-mavlink-协议层面的兼容性>2.4 MAVLink 协议层面的兼容性</h3><h4 id=mission_item_int-消息格式>MISSION_ITEM_INT 消息格式</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># MAVLink MISSION_ITEM_INT 消息结构</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MissionItemInt</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>target_system</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>      <span style=color:#8f5902;font-style:italic># 目标系统ID</span>
</span></span><span style=display:flex><span>    <span style=color:#000>target_component</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>   <span style=color:#8f5902;font-style:italic># 目标组件ID</span>
</span></span><span style=display:flex><span>    <span style=color:#000>seq</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>               <span style=color:#8f5902;font-style:italic># 序列号</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>             <span style=color:#8f5902;font-style:italic># 坐标系</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>           <span style=color:#8f5902;font-style:italic># 命令类型</span>
</span></span><span style=display:flex><span>    <span style=color:#000>current</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>           <span style=color:#8f5902;font-style:italic># 当前航点标志</span>
</span></span><span style=display:flex><span>    <span style=color:#000>autocontinue</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>      <span style=color:#8f5902;font-style:italic># 自动继续标志</span>
</span></span><span style=display:flex><span>    <span style=color:#000>param1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>          <span style=color:#8f5902;font-style:italic># 参数1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>param2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>          <span style=color:#8f5902;font-style:italic># 参数2</span>
</span></span><span style=display:flex><span>    <span style=color:#000>param3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>          <span style=color:#8f5902;font-style:italic># 参数3</span>
</span></span><span style=display:flex><span>    <span style=color:#000>param4</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>          <span style=color:#8f5902;font-style:italic># 参数4</span>
</span></span><span style=display:flex><span>    <span style=color:#000>x</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>                 <span style=color:#8f5902;font-style:italic># 纬度（度*1e7）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>y</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>                 <span style=color:#8f5902;font-style:italic># 经度（度*1e7）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>z</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span>               <span style=color:#8f5902;font-style:italic># 高度（米）</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mission_type</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span>      <span style=color:#8f5902;font-style:italic># 任务类型</span>
</span></span></code></pre></div><h4 id=关键参数说明>关键参数说明</h4><ol><li><p><strong>坐标系 (frame)</strong></p><ul><li><code>MAV_FRAME_GLOBAL_RELATIVE_ALT_INT = 6</code></li><li>使用相对高度的全球坐标系</li><li>经纬度精度为 1e7</li></ul></li><li><p><strong>命令类型 (command)</strong></p><ul><li><code>MAV_CMD_NAV_WAYPOINT = 16</code>：普通航点</li><li><code>MAV_CMD_NAV_TAKEOFF = 22</code>：起飞命令</li><li><code>MAV_CMD_NAV_LAND = 21</code>：降落命令</li></ul></li><li><p><strong>参数含义</strong></p><ul><li><code>param1</code>：盘旋时间（秒）</li><li><code>param2</code>：接受半径（米）</li><li><code>param3</code>：未使用</li><li><code>param4</code>：偏航角（度）</li></ul></li></ol><h4 id=兼容性要求>兼容性要求</h4><ol><li><p><strong>序列号连续性</strong></p><ul><li>航点序列号必须连续</li><li>从0开始递增</li><li>不能有重复或跳跃</li></ul></li><li><p><strong>参数范围</strong></p><ul><li>经纬度范围：-90 到 +90（纬度），-180 到 +180（经度）</li><li>高度范围：0 到 1000 米</li><li>速度范围：0.1 到 50 米/秒</li></ul></li><li><p><strong>命令兼容性</strong></p><ul><li>使用标准的 MAVLink 命令</li><li>避免使用非标准命令</li><li>确保命令参数正确</li></ul></li></ol><h2 id=3-解决方案架构>3. 解决方案架构</h2><h3 id=31-双层数据转换架构>3.1 双层数据转换架构</h3><p>本解决方案采用双层数据转换架构，将高层 MissionItem 数据转换为底层 MissionRaw 格式，确保与 QGC 5.0.6 的完美兼容：</p><h4 id=架构组件>架构组件</h4><pre class=mermaid>graph TD
    A[User Data Input] --&gt; B[Field Validation &amp; Mapping]
    B --&gt; C[MissionItem Construction]
    C --&gt; D[Enum Type Conversion]
    D --&gt; E[MissionRaw Conversion]
    E --&gt; F[Flight Controller Upload]
    F --&gt; G[QGC Display]</pre><h4 id=第一层高层-missionitem-数据组织>第一层：高层 MissionItem 数据组织</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 高层 MissionItem 数据构造</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MissionItemConstructor</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>__init__</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>required_fields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;latitude_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;longitude_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;relative_altitude_m&#39;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;speed_m_s&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;is_fly_through&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>optional_fields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;gimbal_pitch_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;gimbal_yaw_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;camera_action&#39;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;loiter_time_s&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;camera_photo_interval_s&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;acceptance_radius_m&#39;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;yaw_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;camera_photo_distance_m&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;vehicle_action&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>validate_and_construct</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;验证并构造 MissionItem 对象&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 字段验证</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_validate_required_fields</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 数据类型转换</span>
</span></span><span style=display:flex><span>        <span style=color:#000>converted_data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_convert_data_types</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 枚举类型转换</span>
</span></span><span style=display:flex><span>        <span style=color:#000>converted_data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_convert_enums</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>converted_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 构造 MissionItem</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#000>converted_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>validate_mission_data</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mission_data</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>]:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;验证并构造多个 MissionItem 对象&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mission_items</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>waypoint_data</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>mission_data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;waypoints&#39;</span><span style=color:#000;font-weight:700>]:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>mission_item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>validate_and_construct</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>mission_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mission_item</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mission_items</span>
</span></span></code></pre></div><h4 id=第二层底层-missionraw-转换器>第二层：底层 MissionRaw 转换器</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 底层 MissionRaw 转换器</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MissionRawConverter</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>__init__</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_FRAME_GLOBAL_RELATIVE_ALT_INT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_WAYPOINT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>16</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_TAKEOFF</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>22</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_LAND</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>21</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert_items_to_raw</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>items</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>]:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;将 MissionItem 列表转换为 RawMissionItem 列表&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>raw_items</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
</span></span><span style=display:flex><span>        <span style=color:#000>seq_counter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>item</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>items</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 处理特殊命令（TAKEOFF/LAND）</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>vehicle_action</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>TAKEOFF</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>raw_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_create_takeoff_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq_counter</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>                <span style=color:#000>seq_counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>vehicle_action</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>LAND</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>raw_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_create_land_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq_counter</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>                <span style=color:#000>seq_counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>continue</span>  <span style=color:#8f5902;font-style:italic># LAND 后不再添加 NAV_WAYPOINT</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 创建普通航点</span>
</span></span><span style=display:flex><span>            <span style=color:#000>raw_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_create_waypoint_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq_counter</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>            <span style=color:#000>seq_counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>raw_items</span>
</span></span></code></pre></div><h3 id=32-数据流程设计>3.2 数据流程设计</h3><h4 id=完整数据流程>完整数据流程</h4><ol><li><p><strong>数据输入阶段</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 用户代码数据输入示例（符合航点输出协议）</span>
</span></span><span style=display:flex><span><span style=color:#000>mission_data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;selected_drone_id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;drone_001&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;waypoints&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;latitude_deg&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>47.39804</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;longitude_deg&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>8.54557</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;relative_altitude_m&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>30.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;speed_m_s&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>5.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;is_fly_through&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;gimbal_pitch_deg&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;gimbal_yaw_deg&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;camera_action&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;NONE&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;loiter_time_s&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;camera_photo_interval_s&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;acceptance_radius_m&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>5.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;yaw_deg&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;camera_photo_distance_m&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;vehicle_action&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;NONE&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div></li><li><p><strong>数据验证阶段</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 字段验证</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>validate_mission_data</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 检查必填字段</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#4e9a06>&#39;selected_drone_id&#39;</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Missing required field: selected_drone_id&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#4e9a06>&#39;waypoints&#39;</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Missing required field: waypoints&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 验证航点数据</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>waypoint</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>enumerate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;waypoints&#39;</span><span style=color:#000;font-weight:700>]):</span>
</span></span><span style=display:flex><span>        <span style=color:#000>required_fields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;latitude_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;longitude_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;relative_altitude_m&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;speed_m_s&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>field</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>required_fields</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>field</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>waypoint</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Missing required field in waypoint </span><span style=color:#4e9a06>{</span><span style=color:#000>i</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>: </span><span style=color:#4e9a06>{</span><span style=color:#000>field</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 数据类型验证</span>
</span></span><span style=display:flex><span>        <span style=color:#000>waypoint</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;latitude_deg&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoint</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;latitude_deg&#39;</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span>        <span style=color:#000>waypoint</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;longitude_deg&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoint</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;longitude_deg&#39;</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># ... 其他字段验证</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>data</span>
</span></span></code></pre></div></li><li><p><strong>数据转换阶段</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># MissionItem 构造</span>
</span></span><span style=display:flex><span><span style=color:#000>mission_items</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>waypoint_data</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>mission_data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;waypoints&#39;</span><span style=color:#000;font-weight:700>]:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mission_item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>        <span style=color:#000>latitude_deg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;latitude_deg&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#000>longitude_deg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;longitude_deg&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#000>relative_altitude_m</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;relative_altitude_m&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#000>speed_m_s</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;speed_m_s&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#000>is_fly_through</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;is_fly_through&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>gimbal_pitch_deg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;gimbal_pitch_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>gimbal_yaw_deg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;gimbal_yaw_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>camera_action</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>CameraAction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;camera_action&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;NONE&#39;</span><span style=color:#000;font-weight:700>)),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>loiter_time_s</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;loiter_time_s&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>camera_photo_interval_s</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;camera_photo_interval_s&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>acceptance_radius_m</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;acceptance_radius_m&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5.0</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>yaw_deg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;yaw_deg&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>camera_photo_distance_m</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;camera_photo_distance_m&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>vehicle_action</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>VehicleAction</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoint_data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;vehicle_action&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;NONE&#39;</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mission_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mission_item</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div></li><li><p><strong>MissionRaw 转换阶段</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 转换为 MissionRaw 格式</span>
</span></span><span style=display:flex><span><span style=color:#000>raw_items</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mission_item</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>enumerate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mission_items</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>raw_item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>        <span style=color:#000>seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># MAV_FRAME_GLOBAL_RELATIVE_ALT_INT</span>
</span></span><span style=display:flex><span>        <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># MAV_CMD_NAV_WAYPOINT</span>
</span></span><span style=display:flex><span>        <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>autocontinue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>mission_item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>is_fly_through</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>param1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>mission_item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>loiter_time_s</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 盘旋时间</span>
</span></span><span style=display:flex><span>        <span style=color:#000>param2</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>mission_item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>acceptance_radius_m</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 接受半径</span>
</span></span><span style=display:flex><span>        <span style=color:#000>param3</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 未使用</span>
</span></span><span style=display:flex><span>        <span style=color:#000>param4</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>mission_item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>yaw_deg</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 偏航角</span>
</span></span><span style=display:flex><span>        <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mission_item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>latitude_deg</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>1e7</span><span style=color:#000;font-weight:700>),</span>  <span style=color:#8f5902;font-style:italic># 纬度*1e7</span>
</span></span><span style=display:flex><span>        <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mission_item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>longitude_deg</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>1e7</span><span style=color:#000;font-weight:700>),</span>  <span style=color:#8f5902;font-style:italic># 经度*1e7</span>
</span></span><span style=display:flex><span>        <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>mission_item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>relative_altitude_m</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 高度</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mission_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>raw_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>raw_item</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div></li><li><p><strong>任务上传阶段</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 上传到飞行控制器</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission_raw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>clear_mission</span><span style=color:#000;font-weight:700>()</span>  <span style=color:#8f5902;font-style:italic># 清除旧任务</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission_raw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>upload_mission</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>raw_items</span><span style=color:#000;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># 上传新任务</span>
</span></span></code></pre></div></li></ol><h3 id=33-兼容性保证机制>3.3 兼容性保证机制</h3><h4 id=qgc-兼容性保证>QGC 兼容性保证</h4><ol><li><p><strong>使用 MissionRaw 接口</strong></p><ul><li>直接使用 <code>MISSION_ITEM_INT</code> 消息格式</li><li>避免 QGC 的自动解析和优化</li><li>确保航点数据的一致性</li></ul></li><li><p><strong>正确的任务清除</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 上传前清除旧任务</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>async</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>upload_mission_with_clear</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>items</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>]):</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 清除旧任务</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>await</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission_raw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>clear_mission</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 等待清除完成</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>asyncio</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0.5</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 转换并上传新任务</span>
</span></span><span style=display:flex><span>    <span style=color:#000>raw_items</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_convert_items_to_raw</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>items</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>await</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission_raw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>upload_mission</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>raw_items</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div></li><li><p><strong>参数范围控制</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 确保参数在 QGC 兼容范围内</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>validate_parameters</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 经纬度范围检查</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>90</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>latitude_deg</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Latitude out of range&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>180</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>longitude_deg</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>180</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Longitude out of range&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 高度范围检查</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>relative_altitude_m</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Altitude out of range&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 速度范围检查</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0.1</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>speed_m_s</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Speed out of range&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>item</span>
</span></span></code></pre></div></li></ol><h2 id=4-核心实现>4. 核心实现</h2><h3 id=41-missionitem-数据构造>4.1 MissionItem 数据构造</h3><h4 id=字段映射和验证>字段映射和验证</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 完整的字段映射和验证实现</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MissionItemConstructor</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>__init__</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 必填字段定义</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>required_fields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;latitude_deg&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>)},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;longitude_deg&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>180</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>180</span><span style=color:#000;font-weight:700>)},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;relative_altitude_m&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>)},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;speed_m_s&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0.1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>)},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;is_fly_through&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>bool</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>None</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 可选字段定义</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>optional_fields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;gimbal_pitch_deg&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;gimbal_yaw_deg&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>180</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>180</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;camera_action&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>None</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#39;NONE&#39;</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;loiter_time_s&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3600</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;camera_photo_interval_s&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3600</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;acceptance_radius_m&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0.1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>5.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;yaw_deg&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>180</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>180</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;camera_photo_distance_m&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;vehicle_action&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>None</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#39;NONE&#39;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>validate_and_construct</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;验证并构造 MissionItem 对象&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 验证必填字段</span>
</span></span><span style=display:flex><span>            <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_validate_required_fields</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 处理可选字段</span>
</span></span><span style=display:flex><span>            <span style=color:#000>processed_data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_process_optional_fields</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoint_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 数据类型转换</span>
</span></span><span style=display:flex><span>            <span style=color:#000>converted_data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_convert_data_types</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>processed_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 枚举类型转换</span>
</span></span><span style=display:flex><span>            <span style=color:#000>converted_data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_convert_enums</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>converted_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 构造 MissionItem</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#000>converted_data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>except</span> <span style=color:#c00;font-weight:700>Exception</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;MissionItem construction failed: </span><span style=color:#4e9a06>{</span><span style=color:#000>e</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Invalid waypoint data: </span><span style=color:#4e9a06>{</span><span style=color:#000>e</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_validate_required_fields</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;验证必填字段&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>field</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>config</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>required_fields</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>items</span><span style=color:#000;font-weight:700>():</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>field</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Missing required field: </span><span style=color:#4e9a06>{</span><span style=color:#000>field</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 类型检查</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87>isinstance</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>]):</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>](</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>except</span> <span style=color:#000;font-weight:700>(</span><span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>,</span> <span style=color:#c00;font-weight:700>TypeError</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Invalid type for </span><span style=color:#4e9a06>{</span><span style=color:#000>field</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>: expected </span><span style=color:#4e9a06>{</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>__name__</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 范围检查</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>is</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>None</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>min_val</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>max_val</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>min_val</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>max_val</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>{</span><span style=color:#000>field</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> out of range: </span><span style=color:#4e9a06>{</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>]</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> not in [</span><span style=color:#4e9a06>{</span><span style=color:#000>min_val</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>, </span><span style=color:#4e9a06>{</span><span style=color:#000>max_val</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>]&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_process_optional_fields</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;处理可选字段&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>processed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>copy</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>field</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>config</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>optional_fields</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>items</span><span style=color:#000;font-weight:700>():</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>field</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>processed</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>processed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>else</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic># 类型转换</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87>isinstance</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>processed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>]):</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>processed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;type&#39;</span><span style=color:#000;font-weight:700>](</span><span style=color:#000>processed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>except</span> <span style=color:#000;font-weight:700>(</span><span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>,</span> <span style=color:#c00;font-weight:700>TypeError</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>processed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic># 范围检查</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>is</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>None</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>min_val</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>max_val</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;range&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>min_val</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>processed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>max_val</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>processed</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>field</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;default&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>processed</span>
</span></span></code></pre></div><h4 id=枚举类型转换>枚举类型转换</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 枚举类型转换实现</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EnumConverter</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>__init__</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>camera_action_map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;NONE&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>CameraAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>NONE</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;TAKE_PHOTO&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>CameraAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>TAKE_PHOTO</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;START_VIDEO&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>CameraAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>START_VIDEO</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;STOP_VIDEO&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>CameraAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>STOP_VIDEO</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;START_PHOTO_INTERVAL&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>CameraAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>START_PHOTO_INTERVAL</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;STOP_PHOTO_INTERVAL&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>CameraAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>STOP_PHOTO_INTERVAL</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;START_PHOTO_DISTANCE&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>CameraAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>START_PHOTO_DISTANCE</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;STOP_PHOTO_DISTANCE&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>CameraAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>STOP_PHOTO_DISTANCE</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>vehicle_action_map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;NONE&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>NONE</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;TAKEOFF&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>TAKEOFF</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;LAND&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>LAND</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;HOLD&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>HOLD</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;RETURN_TO_LAUNCH&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>RETURN_TO_LAUNCH</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;TRANSITION_TO_FW&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>TRANSITION_TO_FW</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#39;TRANSITION_TO_MC&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>TRANSITION_TO_MC</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert_camera_action</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>action_str</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>CameraAction</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;转换相机动作枚举&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>action_upper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>action_str</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>upper</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>action_upper</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>camera_action_map</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>camera_action_map</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>action_upper</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>else</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>warning</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Unknown camera action: </span><span style=color:#4e9a06>{</span><span style=color:#000>action_str</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>, using NONE&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>CameraAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>NONE</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert_vehicle_action</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>action_str</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>VehicleAction</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;转换飞行器动作枚举&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>action_upper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>action_str</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>upper</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>action_upper</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>vehicle_action_map</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>vehicle_action_map</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>action_upper</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>else</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>warning</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Unknown vehicle action: </span><span style=color:#4e9a06>{</span><span style=color:#000>action_str</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>, using NONE&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>NONE</span>
</span></span></code></pre></div><h4 id=数据完整性检查>数据完整性检查</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 数据完整性检查实现</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DataIntegrityChecker</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>__init__</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>coordinate_precision</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1e7</span>  <span style=color:#8f5902;font-style:italic># 经纬度精度</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>max_waypoint_distance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1000</span>  <span style=color:#8f5902;font-style:italic># 最大航点距离（米）</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>check_waypoint_integrity</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87>bool</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;检查航点数据完整性&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 检查航点数量</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;No waypoints provided&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Too many waypoints (max 100)&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 检查航点间距</span>
</span></span><span style=display:flex><span>            <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_check_waypoint_distances</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 检查高度一致性</span>
</span></span><span style=display:flex><span>            <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_check_altitude_consistency</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 检查速度合理性</span>
</span></span><span style=display:flex><span>            <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_check_speed_consistency</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>True</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>except</span> <span style=color:#c00;font-weight:700>Exception</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Waypoint integrity check failed: </span><span style=color:#4e9a06>{</span><span style=color:#000>e</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>False</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_check_waypoint_distances</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>]):</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;检查航点间距&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>range</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>)):</span>
</span></span><span style=display:flex><span>            <span style=color:#000>prev_wp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>            <span style=color:#000>curr_wp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#000>distance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_calculate_distance</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>                <span style=color:#000>prev_wp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>latitude_deg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>prev_wp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>longitude_deg</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#000>curr_wp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>latitude_deg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>curr_wp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>longitude_deg</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>distance</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>max_waypoint_distance</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Waypoint </span><span style=color:#4e9a06>{</span><span style=color:#000>i</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> too far from previous waypoint: </span><span style=color:#4e9a06>{</span><span style=color:#000>distance</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>m&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_check_altitude_consistency</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>]):</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;检查高度一致性&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>altitudes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>wp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>relative_altitude_m</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>wp</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#000>min_alt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>min</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>altitudes</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>max_alt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>altitudes</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>max_alt</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>min_alt</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>500</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#8f5902;font-style:italic># 高度差超过500米</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>warning</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Large altitude variation in waypoints&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_check_speed_consistency</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>]):</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;检查速度一致性&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>speeds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>wp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>speed_m_s</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>wp</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>waypoints</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>speed</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>speeds</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>speed</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>0.1</span> <span style=color:#204a87;font-weight:700>or</span> <span style=color:#000>speed</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Invalid speed: </span><span style=color:#4e9a06>{</span><span style=color:#000>speed</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>m/s&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h3 id=42-_convert_items_to_raw-转换器>4.2 _convert_items_to_raw() 转换器</h3><h4 id=mavlink-命令映射>MAVLink 命令映射</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 完整的 MissionRaw 转换器实现</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MissionRawConverter</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>__init__</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># MAVLink 常量定义</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_FRAME_GLOBAL_RELATIVE_ALT_INT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_WAYPOINT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>16</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_TAKEOFF</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>22</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_LAND</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>21</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_RETURN_TO_LAUNCH</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>20</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 坐标精度</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>COORDINATE_PRECISION</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1e7</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert_items_to_raw</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>items</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>]:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;将 MissionItem 列表转换为 RawMissionItem 列表&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>raw_items</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
</span></span><span style=display:flex><span>        <span style=color:#000>seq_counter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>item</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>enumerate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>items</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic># 处理特殊命令</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>vehicle_action</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>TAKEOFF</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>raw_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_create_takeoff_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq_counter</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>seq_counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>vehicle_action</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>LAND</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>raw_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_create_land_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq_counter</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>seq_counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>continue</span>  <span style=color:#8f5902;font-style:italic># LAND 后不再添加 NAV_WAYPOINT</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>vehicle_action</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>VehicleAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>RETURN_TO_LAUNCH</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>raw_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_create_rtl_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq_counter</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>seq_counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>continue</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic># 创建普通航点</span>
</span></span><span style=display:flex><span>                <span style=color:#000>raw_items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_create_waypoint_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq_counter</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>                <span style=color:#000>seq_counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>except</span> <span style=color:#c00;font-weight:700>Exception</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Failed to convert waypoint </span><span style=color:#4e9a06>{</span><span style=color:#000>i</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>: </span><span style=color:#4e9a06>{</span><span style=color:#000>e</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Waypoint conversion failed: </span><span style=color:#4e9a06>{</span><span style=color:#000>e</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>raw_items</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_create_waypoint_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;创建普通航点&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>            <span style=color:#000>seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>seq</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_FRAME_GLOBAL_RELATIVE_ALT_INT</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_WAYPOINT</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>seq</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>autocontinue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>is_fly_through</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>loiter_time_s</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param2</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>acceptance_radius_m</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param3</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 未使用</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param4</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>yaw_deg</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>latitude_deg</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>COORDINATE_PRECISION</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>longitude_deg</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>COORDINATE_PRECISION</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>relative_altitude_m</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>mission_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_create_takeoff_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;创建起飞命令&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>            <span style=color:#000>seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>seq</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_FRAME_GLOBAL_RELATIVE_ALT_INT</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_TAKEOFF</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>seq</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>autocontinue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 最小俯仰角（多旋翼不使用）</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param2</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param3</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param4</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>yaw_deg</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>latitude_deg</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>COORDINATE_PRECISION</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>longitude_deg</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>COORDINATE_PRECISION</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>relative_altitude_m</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 起飞高度</span>
</span></span><span style=display:flex><span>            <span style=color:#000>mission_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_create_land_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;创建降落命令&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>            <span style=color:#000>seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>seq</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_FRAME_GLOBAL_RELATIVE_ALT_INT</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_LAND</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>seq</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>autocontinue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 降落不自动继续</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param2</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param3</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param4</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>yaw_deg</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>latitude_deg</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>COORDINATE_PRECISION</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>longitude_deg</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>COORDINATE_PRECISION</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 降落时高度为0</span>
</span></span><span style=display:flex><span>            <span style=color:#000>mission_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_create_rtl_item</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seq</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;创建返航命令&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>RawMissionItem</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>            <span style=color:#000>seq</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>seq</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_FRAME_GLOBAL_RELATIVE_ALT_INT</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MAV_CMD_NAV_RETURN_TO_LAUNCH</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>seq</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>autocontinue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param2</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param3</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>param4</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 返航不需要坐标</span>
</span></span><span style=display:flex><span>            <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>mission_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h4 id=坐标系转换>坐标系转换</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 坐标系转换实现</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CoordinateConverter</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>__init__</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>precision</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1e7</span>  <span style=color:#8f5902;font-style:italic># 经纬度精度</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>deg_to_int7</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>degrees</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;将度数转换为 int32 格式（度*1e7）&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>degrees</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>precision</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>int7_to_deg</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>int_value</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;将 int32 格式转换为度数&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>int_value</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>precision</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>validate_coordinates</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lat</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87>bool</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;验证坐标有效性&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>90</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>lat</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>and</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>180</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>lon</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>180</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>calculate_distance</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lat1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lat2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87>float</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;计算两点间距离（米）&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>math</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>radians</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cos</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sin</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>asin</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sqrt</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 转换为弧度</span>
</span></span><span style=display:flex><span>        <span style=color:#000>lat1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lat2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>map</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>radians</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>lat1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lat2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon2</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 使用 Haversine 公式</span>
</span></span><span style=display:flex><span>        <span style=color:#000>dlat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lat2</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>lat1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>dlon</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lon2</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>lon1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlat</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>cos</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>lat1</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cos</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>lat2</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>sin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlon</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>        <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>asin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sqrt</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 地球半径（米）</span>
</span></span><span style=display:flex><span>        <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6371000</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>r</span>
</span></span></code></pre></div><h3 id=43-upload_mission-上传流程>4.3 upload_mission() 上传流程</h3><h4 id=任务清除机制>任务清除机制</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 完整的任务上传实现</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MissionUploader</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>__init__</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>drone</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>drone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>drone</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MissionRawConverter</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>clear_timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5.0</span>  <span style=color:#8f5902;font-style:italic># 清除超时时间</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>async</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>upload_mission</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>items</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>MissionItem</span><span style=color:#000;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;上传任务到飞行控制器&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 检查连接状态</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>await</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>is_connected</span><span style=color:#000;font-weight:700>():</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Drone not connected&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 清除旧任务</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>await</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_clear_existing_mission</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 转换航点</span>
</span></span><span style=display:flex><span>            <span style=color:#000>raw_items</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>convert_items_to_raw</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>items</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 上传新任务</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>await</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission_raw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>upload_mission</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>raw_items</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Mission uploaded successfully: </span><span style=color:#4e9a06>{</span><span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>raw_items</span><span style=color:#000;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> waypoints&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;Mission uploaded successfully&#34;</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>except</span> <span style=color:#c00;font-weight:700>Exception</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Mission upload failed: </span><span style=color:#4e9a06>{</span><span style=color:#000>e</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Mission upload failed: </span><span style=color:#4e9a06>{</span><span style=color:#000>e</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>async</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_clear_existing_mission</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;清除现有任务&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 清除任务</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>await</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission_raw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>clear_mission</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 等待清除完成</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>asyncio</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0.5</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 验证清除结果</span>
</span></span><span style=display:flex><span>            <span style=color:#000>mission_items</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>await</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission_raw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>download_mission</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mission_items</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>warning</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Mission clear may not be complete&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic># 再次尝试清除</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>await</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>drone</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mission_raw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>clear_mission</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>asyncio</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0.5</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Existing mission cleared&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>except</span> <span style=color:#c00;font-weight:700>Exception</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Failed to clear existing mission: </span><span style=color:#4e9a06>{</span><span style=color:#000>e</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>raise</span> <span style=color:#c00;font-weight:700>ValueError</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Mission clear failed: </span><span style=color:#4e9a06>{</span><span style=color:#000>e</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=参考文档>参考文档</h2><ul><li><a href=https://mavlink.io/en/messages/>MAVLink 消息格式</a></li><li><a href=https://docs.qgroundcontrol.com/master/en/PlanView/PlanView.html>QGC 航点管理</a></li><li><a href=https://mavsdk-python.readthedocs.io/en/stable/plugins_sdk.html#mission>MAVSDK-Python Mission API</a></li><li><a href=https://mavlink.io/en/services/mission.html>MAVLink Mission 协议</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7f125b68e9d871079e568027c34e1082>QGroundControl Docker 进阶构建指南</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><blockquote><p><strong>版本约束：</strong> 本文档基于 QGroundControl 5.0.6 版本编写</p></blockquote><h2 id=1-android-构建>1. Android 构建</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在项目根目录执行</span>
</span></span><span style=display:flex><span>./deploy/docker/run-docker-android.sh
</span></span></code></pre></div><h3 id=依赖版本>依赖版本</h3><table><thead><tr><th>组件</th><th>版本</th></tr></thead><tbody><tr><td>基础镜像</td><td>Ubuntu 22.04</td></tr><tr><td>Java</td><td>OpenJDK 17</td></tr><tr><td>Qt</td><td>6.6.3</td></tr><tr><td>Android SDK</td><td>34</td></tr><tr><td>Build Tools</td><td>34.0.0</td></tr><tr><td>NDK</td><td>25.1.8937393 (25B)</td></tr><tr><td>Platform</td><td>android-28 (Android 9)</td></tr><tr><td>构建工具</td><td>CMake + Ninja</td></tr><tr><td>时区</td><td>Asia/Shanghai</td></tr></tbody></table><p><strong>Qt 版本详情：</strong></p><p><strong>为什么 Android 使用 Qt 6.6.3？</strong></p><p>在官方文档中，对QGC v5.0.6 的 Qt 版本要求明确指定为6.8.3,但因为NDK和Herelink兼容性问题，只能选择6.6.3进行编译。</p><ol><li><strong>NDK 兼容性</strong> - Qt 6.6.3 与 Android NDK 25.1.8937393 有最佳兼容性</li><li><strong>Herelink 支持</strong> - 该版本对 Herelink 设备有完整的支持</li><li><strong>构建工具链</strong> - 与 CMake 3.24+ 和 Android SDK 34 配合良好</li></ol><p><strong>安装的 Qt 模块：</strong></p><ul><li>qtcharts, qtpositioning, qtspeech, qt5compat</li><li>qtmultimedia, qtserialport, qtimageformats</li><li>qtshadertools, qtconnectivity, qtquick3d</li><li>qtsensors, qtlocation</li></ul><h3 id=11-支持版本>1.1 支持版本</h3><p><strong>架构支持：</strong>
构建同时支持两种架构：</p><ul><li><code>armeabi-v7a</code>（32位 ARM）</li><li><code>arm64-v8a</code>（64位 ARM）</li></ul><p><strong>Android 版本支持：</strong></p><table><thead><tr><th>项目</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td><strong>最低版本 (minSdk)</strong></td><td>API 28 (Android 9.0)</td><td>设备必须运行 Android 9.0 或更高版本</td></tr><tr><td><strong>目标版本 (targetSdk)</strong></td><td>API 35 (Android 15)</td><td>针对 Android 15 优化</td></tr><tr><td><strong>编译版本 (compileSdk)</strong></td><td>API 34 (Android 14)</td><td>使用 Android 14 SDK 编译</td></tr></tbody></table><ul><li>✅ Android 9.0 (Pie, API 28)</li><li>✅ Android 10 (Q, API 29)</li><li>✅ Android 11 (R, API 30)</li><li>✅ Android 12 (S, API 31)</li><li>✅ Android 12L (Sv2, API 32)</li><li>✅ Android 13 (T, API 33)</li><li>✅ Android 14 (U, API 34)</li><li>✅ Android 15 (V, API 35)</li></ul><h3 id=12-构建说明>1.2 构建说明</h3><p><strong>构建输出：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>build/shadow_build_dir/android-build/build/outputs/apk/release/android-build-release.apk
</span></span></code></pre></div><p><strong>安装APK到设备：</strong></p><p>如果使用wifi连接adb设备</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#在usb连接时</span>
</span></span><span style=display:flex><span>adb tcpip <span style=color:#0000cf;font-weight:700>5555</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#之后使用</span>
</span></span><span style=display:flex><span>adb connect <span style=color:#ce5c00;font-weight:700>{</span>IP<span style=color:#ce5c00;font-weight:700>}</span>:5555
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用adb安装APK到连接的Android设备</span>
</span></span><span style=display:flex><span>adb install build/shadow_build_dir/android-build/build/outputs/apk/release/android-build-release-signed.apk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 如果设备上已存在旧版本，使用以下命令强制覆盖安装</span>
</span></span><span style=display:flex><span>adb install -r build/shadow_build_dir/android-build/build/outputs/apk/release/android-build-release-signed.apk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看连接的设备</span>
</span></span><span style=display:flex><span>adb devices
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 卸载旧版本（如果需要）</span>
</span></span><span style=display:flex><span>adb uninstall org.mavlink.qgroundcontrol
</span></span></code></pre></div><h3 id=13-apk-签名>1.3 APK 签名</h3><p><strong>为什么需要签名？</strong></p><ol><li><p><strong>系统要求</strong> - Android 系统强制要求所有 APK 必须签名才能安装，未签名的 APK 无法运行</p></li><li><p><strong>应用身份</strong> - 签名是应用的唯一标识，用于：</p><ul><li>验证应用来源和开发者身份</li><li>防止应用被篡改或伪造</li><li>建立应用之间的信任关系</li></ul></li><li><p><strong>应用更新</strong> - 只有使用<strong>相同密钥</strong>签名的新版本才能覆盖安装旧版本</p><ul><li>更换密钥后，用户必须先卸载旧版本（会丢失数据）</li><li>无法在应用市场（如 Google Play）更新应用</li></ul></li><li><p><strong>安全保障</strong> - 签名机制确保 APK 在分发过程中未被修改</p></li></ol><p><strong>生成密钥库：</strong></p><p>使用以下脚本自动生成 Android 发布密钥库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Script to create Android release keystore</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Make sure to install JDK first: sudo apt install openjdk-17-jdk-headless -y</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>set</span> -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Android Release Keystore Generator&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configuration - Edit these values</span>
</span></span><span style=display:flex><span><span style=color:#000>KEYSTORE_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;android_release_new.keystore&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>KEY_ALIAS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;qgc_release&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>KEY_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{yourpasswd}&#34;</span>  <span style=color:#8f5902;font-style:italic># Change this!</span>
</span></span><span style=display:flex><span><span style=color:#000>STORE_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{yourpasswd}&#34;</span>  <span style=color:#8f5902;font-style:italic># Change this!</span>
</span></span><span style=display:flex><span><span style=color:#000>VALIDITY_DAYS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10000</span>  <span style=color:#8f5902;font-style:italic># About 27 years</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Distinguished Name (DN) information</span>
</span></span><span style=display:flex><span><span style=color:#000>DN_CN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;QGroundControl&#34;</span>  <span style=color:#8f5902;font-style:italic># Common Name</span>
</span></span><span style=display:flex><span><span style=color:#000>DN_OU</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Development&#34;</span>     <span style=color:#8f5902;font-style:italic># Organizational Unit</span>
</span></span><span style=display:flex><span><span style=color:#000>DN_O</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;QGroundControl&#34;</span>   <span style=color:#8f5902;font-style:italic># Organization</span>
</span></span><span style=display:flex><span><span style=color:#000>DN_L</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;City&#34;</span>            <span style=color:#8f5902;font-style:italic># Locality/City</span>
</span></span><span style=display:flex><span><span style=color:#000>DN_S</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;State&#34;</span>           <span style=color:#8f5902;font-style:italic># State</span>
</span></span><span style=display:flex><span><span style=color:#000>DN_C</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;US&#34;</span>              <span style=color:#8f5902;font-style:italic># Country Code (2 letters)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>SCRIPT_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>cd</span> <span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span>dirname <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BASH_SOURCE</span><span style=color:#000;font-weight:700>[0]</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>KEYSTORE_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$SCRIPT_DIR</span><span style=color:#4e9a06>/</span><span style=color:#000>$KEYSTORE_NAME</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Keystore will be created at: </span><span style=color:#000>$KEYSTORE_PATH</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Key alias: </span><span style=color:#000>$KEY_ALIAS</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check if keytool is available</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> ! <span style=color:#204a87>command</span> -v keytool <span style=color:#000;font-weight:700>&amp;</span>&gt; /dev/null<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;ERROR: keytool not found!&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Please install JDK first:&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;  sudo apt install openjdk-17-jdk-headless -y&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check if keystore already exists</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -f <span style=color:#4e9a06>&#34;</span><span style=color:#000>$KEYSTORE_PATH</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>read</span> -p <span style=color:#4e9a06>&#34;Keystore already exists. Overwrite? (y/N): &#34;</span> -n <span style=color:#0000cf;font-weight:700>1</span> -r
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[[</span> ! <span style=color:#000>$REPLY</span> <span style=color:#ce5c00;font-weight:700>=</span>~ ^<span style=color:#ce5c00;font-weight:700>[</span>Yy<span style=color:#ce5c00;font-weight:700>]</span>$ <span style=color:#ce5c00;font-weight:700>]]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Cancelled.&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    rm -f <span style=color:#4e9a06>&#34;</span><span style=color:#000>$KEYSTORE_PATH</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Generate keystore</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Generating keystore...&#34;</span>
</span></span><span style=display:flex><span>keytool -genkey -v <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -keystore <span style=color:#4e9a06>&#34;</span><span style=color:#000>$KEYSTORE_PATH</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -alias <span style=color:#4e9a06>&#34;</span><span style=color:#000>$KEY_ALIAS</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -keyalg RSA <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -keysize <span style=color:#0000cf;font-weight:700>2048</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -validity <span style=color:#000>$VALIDITY_DAYS</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -storepass <span style=color:#4e9a06>&#34;</span><span style=color:#000>$STORE_PASSWORD</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -keypass <span style=color:#4e9a06>&#34;</span><span style=color:#000>$KEY_PASSWORD</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -dname <span style=color:#4e9a06>&#34;CN=</span><span style=color:#000>$DN_CN</span><span style=color:#4e9a06>, OU=</span><span style=color:#000>$DN_OU</span><span style=color:#4e9a06>, O=</span><span style=color:#000>$DN_O</span><span style=color:#4e9a06>, L=</span><span style=color:#000>$DN_L</span><span style=color:#4e9a06>, S=</span><span style=color:#000>$DN_S</span><span style=color:#4e9a06>, C=</span><span style=color:#000>$DN_C</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Keystore created successfully!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Add these lines to your deploy/docker/run-docker-android.sh:&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;QT_ANDROID_KEYSTORE_PATH=\&#34;/project/source/deploy/android/</span><span style=color:#000>$KEYSTORE_NAME</span><span style=color:#4e9a06>\&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;QT_ANDROID_KEYSTORE_ALIAS=\&#34;</span><span style=color:#000>$KEY_ALIAS</span><span style=color:#4e9a06>\&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;QT_ANDROID_KEYSTORE_STORE_PASS=\&#34;</span><span style=color:#000>$STORE_PASSWORD</span><span style=color:#4e9a06>\&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;QT_ANDROID_KEYSTORE_KEY_PASS=\&#34;</span><span style=color:#000>$KEY_PASSWORD</span><span style=color:#4e9a06>\&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;⚠️  IMPORTANT: Keep these passwords safe!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;⚠️  Backup your keystore file - you cannot recover it if lost!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Verify the keystore</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Verifying keystore...&#34;</span>
</span></span><span style=display:flex><span>keytool -list -v -keystore <span style=color:#4e9a06>&#34;</span><span style=color:#000>$KEYSTORE_PATH</span><span style=color:#4e9a06>&#34;</span> -storepass <span style=color:#4e9a06>&#34;</span><span style=color:#000>$STORE_PASSWORD</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> head -20
</span></span></code></pre></div><p><strong>使用步骤：</strong></p><ol><li><p><strong>安装 JDK（如果未安装）：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install openjdk-17-jdk-headless -y
</span></span></code></pre></div></li><li><p><strong>修改脚本配置：</strong></p><ul><li>编辑 <code>KEY_PASSWORD</code> 和 <code>STORE_PASSWORD</code> 为您的密码</li><li>根据需要修改 DN 信息（组织名称、城市等）</li></ul></li><li><p><strong>运行脚本：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x create_keystore.sh
</span></span><span style=display:flex><span>./create_keystore.sh
</span></span></code></pre></div></li><li><p><strong>配置构建脚本：</strong>
将生成的配置信息添加到 <code>run-docker-android.sh</code> 中</p></li></ol><p><strong>密钥配置：</strong></p><p>密钥文件：<code>deploy/android/android_release.keystore</code></p><p>配置位置：<code>deploy/docker/run-docker-android.sh</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>QT_ANDROID_KEYSTORE_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/project/source/deploy/android/android_release.keystore&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>QT_ANDROID_KEYSTORE_ALIAS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;qgc_release&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>QT_ANDROID_KEYSTORE_STORE_PASS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{yourpasswd}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>QT_ANDROID_KEYSTORE_KEY_PASS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{yourpasswd}&#34;</span>
</span></span></code></pre></div><p><strong>密钥管理建议：</strong></p><ul><li>⚠️ 不要丢失密钥文件和密码</li><li>⚠️ 更换密钥将导致应用无法覆盖升级</li><li>⚠️ 生产环境应使用独立的发布密钥</li><li>⚠️ 定期备份密钥库文件</li></ul><h3 id=14-故障排查>1.4 故障排查</h3><p><strong>清理构建缓存：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo rm -rf build/shadow_build_dir
</span></span></code></pre></div><p><strong>查看构建日志：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker ps  <span style=color:#8f5902;font-style:italic># 找到容器 ID</span>
</span></span><span style=display:flex><span>docker logs -f &lt;container_id&gt;
</span></span></code></pre></div><p><strong>重新构建 Docker 镜像：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker rmi qgc-android-docker
</span></span><span style=display:flex><span>./deploy/docker/run-docker-android.sh
</span></span></code></pre></div><hr><h2 id=2-ubuntu-构建>2. Ubuntu 构建</h2><h3 id=21-依赖版本>2.1 依赖版本</h3><table><thead><tr><th>组件</th><th>版本</th></tr></thead><tbody><tr><td>基础镜像</td><td>Ubuntu 22.04</td></tr><tr><td>Qt</td><td>6.8.3</td></tr><tr><td>构建工具</td><td>CMake + Ninja</td></tr><tr><td>时区</td><td>Asia/Shanghai</td></tr></tbody></table><p><strong>安装的 Qt 模块：</strong></p><ul><li>qtcharts, qtlocation, qtpositioning, qtspeech, qt5compat</li><li>qtmultimedia, qtserialport, qtimageformats</li><li>qtshadertools, qtconnectivity, qtquick3d, qtsensors</li></ul><h3 id=22-快速开始>2.2 快速开始</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy/docker/run-docker-ubuntu.sh
</span></span></code></pre></div><p><strong>构建输出：</strong></p><ul><li>路径：<code>build/AppDir/usr/bin/</code></li><li>可执行文件：<code>QGroundControl</code></li></ul><p><strong>运行：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./build/AppDir/usr/bin/QGroundControl
</span></span></code></pre></div><hr><h2 id=验证编译结果>验证编译结果</h2><p><strong>在每次构建完成后，请务必验证以下信息：</strong></p><h4 id=1-检查版本号>1. 检查版本号</h4><p>构建完成后，在QGroundControl中查看版本信息：</p><ul><li><strong>Android版本：</strong> 设置 → 关于 → 版本信息</li><li><strong>Ubuntu版本：</strong> 帮助 → 关于QGroundControl</li></ul><p><strong>预期版本信息：</strong></p><ul><li>主版本：5.0.6</li><li>构建日期：应与您的构建时间一致</li><li>Git提交：应与您使用的源码版本一致</li></ul><h4 id=2-检查构建时间戳>2. 检查构建时间戳</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Android APK</span>
</span></span><span style=display:flex><span>ls -la build/shadow_build_dir/android-build/build/outputs/apk/release/android-build-release-signed.apk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ubuntu可执行文件</span>
</span></span><span style=display:flex><span>ls -la build/AppDir/usr/bin/QGroundControl
</span></span></code></pre></div><h4 id=3-功能验证清单>3. 功能验证清单</h4><ul><li>应用正常启动</li><li>连接设备功能正常</li><li>航点规划功能可用</li><li>设置界面正常显示</li><li>版本信息正确显示</li></ul><p><strong>如果版本号或构建时间不正确，说明更新内容未实际编译，请重新执行构建流程。</strong></p><hr><h2 id=3-为什么使用-docker>3. 为什么使用 Docker？</h2><ol><li><strong>环境一致性</strong> - 所有依赖预装在镜像中</li><li><strong>简化配置</strong> - 无需手动安装 Qt、SDK、NDK</li><li><strong>隔离构建</strong> - 不污染主机环境</li><li><strong>可重复性</strong> - 任何机器都能获得相同的构建结果</li></ol><h3 id=31-网络优化>3.1 网络优化</h3><p>使用 <code>--network=host</code> 继承主机 DNS 配置，提高下载速度。</p><h3 id=32-构建参数>3.2 构建参数</h3><p>CMake 配置参数：</p><ul><li><code>CMAKE_BUILD_TYPE=Release</code> - 发布版本</li><li><code>QT_ANDROID_BUILD_ALL_ABIS=OFF</code> - 仅构建指定架构</li><li><code>QT_ANDROID_ABIS="armeabi-v7a;arm64-v8a"</code> - 32位和64位ARM</li><li><code>QT_ANDROID_SIGN_APK=ON</code> - 启用APK签名</li><li><code>ANDROID_PLATFORM=android-28</code> - 最低支持 Android 9</li></ul><hr><h2 id=4-修改版构建脚本>4. 修改版构建脚本</h2><h3 id=41-android-构建脚本>4.1 Android 构建脚本</h3><p>以下是修改版的 Android 构建脚本 <code>run-docker-android.sh</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Exit immediately if a command exits with a non-zero status</span>
</span></span><span style=display:flex><span><span style=color:#204a87>set</span> -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ============================================================</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Android APK Signing Configuration</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ============================================================</span>
</span></span><span style=display:flex><span><span style=color:#000>QT_ANDROID_KEYSTORE_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/project/source/deploy/android/android_release.keystore&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>QT_ANDROID_KEYSTORE_ALIAS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;qgc_release&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>QT_ANDROID_KEYSTORE_STORE_PASS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{yourpasswd}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>QT_ANDROID_KEYSTORE_KEY_PASS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{yourpasswd}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ============================================================</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Define variables for better maintainability</span>
</span></span><span style=display:flex><span><span style=color:#000>DOCKERFILE_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;./deploy/docker/Dockerfile-build-android&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>IMAGE_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;qgc-android-docker&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>SOURCE_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>BUILD_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>SOURCE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/build&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Default values</span>
</span></span><span style=display:flex><span><span style=color:#000>QGC_ENABLE_HERELINK</span><span style=color:#ce5c00;font-weight:700>=</span>OFF
</span></span><span style=display:flex><span><span style=color:#000>QT_ANDROID_SIGN_APK</span><span style=color:#ce5c00;font-weight:700>=</span>ON
</span></span><span style=display:flex><span><span style=color:#000>REBUILD_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span><span style=color:#000>FULL_CLEAN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Interactive mode for cleanup selection</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;QGroundControl Android 构建选项&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;请选择构建模式:&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;1) 增量编译 (最快，保留所有缓存) - 日常开发推荐&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;2) 完全清理 (删除构建目录和Docker镜像) - 30-60分钟&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;3) 重新构建Docker镜像&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;4) 退出&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>read</span> -p <span style=color:#4e9a06>&#34;请输入选择 (1-4): &#34;</span> choice
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>$choice</span> in
</span></span><span style=display:flex><span>        1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;选择: 增量编译&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        2<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;选择: 完全清理&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>FULL_CLEAN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>            <span style=color:#000>REBUILD_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        3<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;选择: 重新构建Docker镜像&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>REBUILD_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        4<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;退出脚本&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        *<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;无效选择，请输入 1-4&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>esac</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ask about Herelink support</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Herelink 支持配置&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>read</span> -p <span style=color:#4e9a06>&#34;是否启用 Herelink 支持? (y/n): &#34;</span> herelink_choice
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>$herelink_choice</span> in
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>[</span>Yy<span style=color:#ce5c00;font-weight:700>]</span>*<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>QGC_ENABLE_HERELINK</span><span style=color:#ce5c00;font-weight:700>=</span>ON
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;已启用 Herelink 支持&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>[</span>Nn<span style=color:#ce5c00;font-weight:700>]</span>*<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>QGC_ENABLE_HERELINK</span><span style=color:#ce5c00;font-weight:700>=</span>OFF
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;未启用 Herelink 支持&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        *<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;请输入 y 或 n&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>esac</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Handle full clean: delete everything</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$FULL_CLEAN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;执行完全清理...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Delete build directory</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -d <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;清理构建目录: </span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        sudo rm -rf <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ 构建目录已清理&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Delete Docker image</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> docker image inspect <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span>1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;删除Docker镜像: </span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        docker rmi <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ Docker镜像已删除&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;完全清理完成！&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create build directory if it doesn&#39;t exist</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check if Docker image exists, build only if needed</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> ! docker image inspect <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$REBUILD_IMAGE</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$REBUILD_IMAGE</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;重新构建Docker镜像...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;构建Docker镜像...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    docker build --file <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>DOCKERFILE_PATH</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        --build-arg <span style=color:#000>QGC_ENABLE_HERELINK</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QGC_ENABLE_HERELINK</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        --network<span style=color:#ce5c00;font-weight:700>=</span>host <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -t <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>SOURCE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ Docker镜像构建完成&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Run the Docker container with adjusted mount points and DNS configuration</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;启动Docker容器进行构建...&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run --rm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --network<span style=color:#ce5c00;font-weight:700>=</span>host <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -v <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>SOURCE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:/project/source&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -v <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:/workspace/build&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -e <span style=color:#000>QT_ANDROID_SIGN_APK</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ANDROID_SIGN_APK</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -e <span style=color:#000>QT_ANDROID_KEYSTORE_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ANDROID_KEYSTORE_PATH</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -e <span style=color:#000>QT_ANDROID_KEYSTORE_ALIAS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ANDROID_KEYSTORE_ALIAS</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -e <span style=color:#000>QT_ANDROID_KEYSTORE_STORE_PASS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ANDROID_KEYSTORE_STORE_PASS</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -e <span style=color:#000>QT_ANDROID_KEYSTORE_KEY_PASS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ANDROID_KEYSTORE_KEY_PASS</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;修复文件权限...&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Fix permissions so you can modify build directory without sudo next time</span>
</span></span><span style=display:flex><span>sudo chown -R <span style=color:#204a87;font-weight:700>$(</span>id -u<span style=color:#204a87;font-weight:700>)</span>:<span style=color:#204a87;font-weight:700>$(</span>id -g<span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ 构建完成！&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;构建输出位置: </span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;版本验证提示&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;请验证以下信息确保更新内容已实际编译：&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;1. 检查APK版本号：安装后查看 设置→关于→版本信息&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;2. 检查构建时间：ls -la </span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/shadow_build_dir/android-build/build/outputs/apk/release/android-build-release-signed.apk&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;3. 确认版本号显示为 5.0.6 且构建时间正确&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span></code></pre></div><p><strong>对应的 Dockerfile：</strong></p><p>以下是 Android 构建使用的 <code>Dockerfile-build-android</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> ubuntu:22.04</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>DEBIAN_FRONTEND</span><span style=color:#ce5c00;font-weight:700>=</span>noninteractive
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COPY</span> tools/setup/install-dependencies-debian.sh /tmp/qt/<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> chmod +x /tmp/qt/*.sh <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> /tmp/qt/install-dependencies-debian.sh<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Configure DNS for better network connectivity in Docker container</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Note: Docker will override this, but we&#39;ll test with available tools</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Set environment variables for Android SDK, NDK, and paths</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>ANDROID_SDK_ROOT</span><span style=color:#ce5c00;font-weight:700>=</span>/opt/android-sdk<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>ANDROID_NDK_ROOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ANDROID_SDK_ROOT</span>/ndk/25.1.8937393<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>ANDROID_HOME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ANDROID_SDK_ROOT</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>ANDROID_BUILD_TOOLS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ANDROID_SDK_ROOT</span>/build-tools/34.0.0<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Set apt-get to non-interactive and configure time zone</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>DEBIAN_FRONTEND</span><span style=color:#ce5c00;font-weight:700>=</span>noninteractive
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>TZ</span><span style=color:#ce5c00;font-weight:700>=</span>Asia/Shanghai<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Configure time zone and install dependencies</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Use official Ubuntu sources only</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Verifying DNS configuration ===&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    cat /etc/resolv.conf <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Updating package lists ===&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-get update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-get install -y tzdata <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    ln -fs /usr/share/zoneinfo/<span style=color:#000>$TZ</span> /etc/localtime <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    dpkg-reconfigure --frontend noninteractive tzdata <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-get install -y <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-utils <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    build-essential <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libpulse-dev <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-glx0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-icccm4 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-image0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-keysyms1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-randr0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-render-util0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-render0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-shape0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-shm0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-sync1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-util1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-xfixes0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-xinerama0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxkbcommon-dev <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxkbcommon-x11-0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    libxcb-xkb-dev <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    python3 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    python3-pip <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    wget <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    unzip <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    git <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    openjdk-17-jdk <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    curl <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    locales <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    ninja-build <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    software-properties-common <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    lsb-release<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Install newer CMake version</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2&gt;/dev/null <span style=color:#000;font-weight:700>|</span> gpg --dearmor - <span style=color:#000;font-weight:700>|</span> tee /etc/apt/trusted.gpg.d/kitware.gpg &gt;/dev/null <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-add-repository <span style=color:#4e9a06>&#34;deb https://apt.kitware.com/ubuntu/ </span><span style=color:#204a87;font-weight:700>$(</span>lsb_release -cs<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06> main&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-get update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-get install -y cmake<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Set JAVA_HOME and update PATH</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>JAVA_HOME</span><span style=color:#ce5c00;font-weight:700>=</span>/usr/lib/jvm/java-17-openjdk-amd64<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Install Android SDK and NDK</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> mkdir -p <span style=color:#000>$ANDROID_SDK_ROOT</span>/cmdline-tools/latest <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    wget https://dl.google.com/android/repository/commandlinetools-linux-12266719_latest.zip -O /opt/cmdline-tools.zip <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    unzip /opt/cmdline-tools.zip -d <span style=color:#000>$ANDROID_SDK_ROOT</span>/cmdline-tools <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    mv <span style=color:#000>$ANDROID_SDK_ROOT</span>/cmdline-tools/cmdline-tools/* <span style=color:#000>$ANDROID_SDK_ROOT</span>/cmdline-tools/latest/ <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    rm -rf <span style=color:#000>$ANDROID_SDK_ROOT</span>/cmdline-tools/cmdline-tools <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    rm /opt/cmdline-tools.zip <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    yes <span style=color:#000;font-weight:700>|</span> <span style=color:#000>$ANDROID_SDK_ROOT</span>/cmdline-tools/latest/bin/sdkmanager --sdk_root<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ANDROID_SDK_ROOT</span> --licenses <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#000>$ANDROID_SDK_ROOT</span>/cmdline-tools/latest/bin/sdkmanager --sdk_root<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ANDROID_SDK_ROOT</span> <span style=color:#4e9a06>&#34;platform-tools&#34;</span> <span style=color:#4e9a06>&#34;platforms;android-34&#34;</span> <span style=color:#4e9a06>&#34;build-tools;34.0.0&#34;</span> <span style=color:#4e9a06>&#34;ndk;25.1.8937393&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Build arguments for Qt version selection</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>QGC_ENABLE_HERELINK</span><span style=color:#ce5c00;font-weight:700>=</span>OFF
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>QT_VERSION_6_6_3</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;6.6.3&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Qt setup and environment variables</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Use Qt 6.6.3 as default (known to work)</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;6.6.3&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/opt/Qt&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;linux&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_HOST_ARCH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;gcc_64&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_HOST_ARCH_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;linux_gcc_64&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_TARGET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;android&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_TARGET_ARCH_ARMV7</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;android_armv7&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_TARGET_ARCH_ARM64</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;android_arm64_v8a&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_MODULES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;qtcharts qtpositioning qtspeech qt5compat qtmultimedia qtserialport qtimageformats qtshadertools qtconnectivity qtquick3d qtsensors qtlocation&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Install aqtinstall</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> python3 -m pip install setuptools wheel py7zr aqtinstall <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    mkdir -p <span style=color:#000>$QT_PATH</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Install Qt desktop version with retry logic (split into separate RUN for better caching)</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>export</span> <span style=color:#000>QT_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$QT_VERSION_6_6_3</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Installing Qt Desktop </span><span style=color:#000>$QT_VERSION</span><span style=color:#4e9a06> ===&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#0000cf;font-weight:700>2</span> 3<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Attempt </span><span style=color:#000>$i</span><span style=color:#4e9a06> of 3...&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        aqt install-qt <span style=color:#000>$QT_HOST</span> desktop <span style=color:#000>$QT_VERSION</span> <span style=color:#000>$QT_HOST_ARCH</span> -O <span style=color:#000>$QT_PATH</span> -m <span style=color:#000>$QT_MODULES</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>break</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$i</span> -eq <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;ERROR: Failed to install Qt desktop version after 3 attempts&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>exit</span> 1<span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Retrying in 5 seconds...&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> sleep 5<span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87;font-weight:700>fi</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87;font-weight:700>done</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Install Qt Android ARMv7 version with retry logic</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>export</span> <span style=color:#000>QT_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$QT_VERSION_6_6_3</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Installing Qt Android ARMv7 </span><span style=color:#000>$QT_VERSION</span><span style=color:#4e9a06> ===&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#0000cf;font-weight:700>2</span> 3<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Attempt </span><span style=color:#000>$i</span><span style=color:#4e9a06> of 3...&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        aqt install-qt <span style=color:#000>$QT_HOST</span> <span style=color:#000>$QT_TARGET</span> <span style=color:#000>$QT_VERSION</span> <span style=color:#000>$QT_TARGET_ARCH_ARMV7</span> -O <span style=color:#000>$QT_PATH</span> -m <span style=color:#000>$QT_MODULES</span> --autodesktop <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>break</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$i</span> -eq <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;ERROR: Failed to install Qt Android ARMv7 version after 3 attempts&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>exit</span> 1<span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Retrying in 5 seconds...&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> sleep 5<span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87;font-weight:700>fi</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87;font-weight:700>done</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Install Qt Android ARM64 version with retry logic</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>export</span> <span style=color:#000>QT_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$QT_VERSION_6_6_3</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Installing Qt Android ARM64 </span><span style=color:#000>$QT_VERSION</span><span style=color:#4e9a06> ===&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#0000cf;font-weight:700>2</span> 3<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Attempt </span><span style=color:#000>$i</span><span style=color:#4e9a06> of 3...&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        aqt install-qt <span style=color:#000>$QT_HOST</span> <span style=color:#000>$QT_TARGET</span> <span style=color:#000>$QT_VERSION</span> <span style=color:#000>$QT_TARGET_ARCH_ARM64</span> -O <span style=color:#000>$QT_PATH</span> -m <span style=color:#000>$QT_MODULES</span> --autodesktop <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>break</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>$i</span> -eq <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;ERROR: Failed to install Qt Android ARM64 version after 3 attempts&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>exit</span> 1<span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Retrying in 5 seconds...&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> sleep 5<span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        <span style=color:#204a87;font-weight:700>fi</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87;font-weight:700>done</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Qt installation completed successfully ===&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Set Qt-related environment variables for ARMv7 and ARM64 architectures</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Using Qt 6.6.3</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>export</span> <span style=color:#000>QT_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#000>$QT_VERSION_6_6_3</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;export QT_ROOT_DIR_ARMV7=</span><span style=color:#000>$QT_PATH</span><span style=color:#4e9a06>/</span><span style=color:#000>$QT_VERSION</span><span style=color:#4e9a06>/</span><span style=color:#000>$QT_TARGET_ARCH_ARMV7</span><span style=color:#4e9a06>&#34;</span> &gt;&gt; /etc/environment <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;export QT_ROOT_DIR_ARM64=</span><span style=color:#000>$QT_PATH</span><span style=color:#4e9a06>/</span><span style=color:#000>$QT_VERSION</span><span style=color:#4e9a06>/</span><span style=color:#000>$QT_TARGET_ARCH_ARM64</span><span style=color:#4e9a06>&#34;</span> &gt;&gt; /etc/environment <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;export QT_HOST_PATH=</span><span style=color:#000>$QT_PATH</span><span style=color:#4e9a06>/</span><span style=color:#000>$QT_VERSION</span><span style=color:#4e9a06>/</span><span style=color:#000>$QT_HOST_ARCH</span><span style=color:#4e9a06>&#34;</span> &gt;&gt; /etc/environment<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Set default values (will be overridden by the RUN command above)</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_ROOT_DIR_ARMV7</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_PATH</span>/6.6.3/<span style=color:#000>$QT_TARGET_ARCH_ARMV7</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_ROOT_DIR_ARM64</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_PATH</span>/6.6.3/<span style=color:#000>$QT_TARGET_ARCH_ARM64</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_HOST_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_PATH</span>/6.6.3/<span style=color:#000>$QT_HOST_ARCH</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_PLUGIN_PATH_ARMV7</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ROOT_DIR_ARMV7</span>/plugins<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QT_PLUGIN_PATH_ARM64</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ROOT_DIR_ARM64</span>/plugins<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QML2_IMPORT_PATH_ARMV7</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ROOT_DIR_ARMV7</span>/qml<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>QML2_IMPORT_PATH_ARM64</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ROOT_DIR_ARM64</span>/qml<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>PKG_CONFIG_PATH_ARMV7</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ROOT_DIR_ARMV7</span>/lib/pkgconfig:<span style=color:#000>$PKG_CONFIG_PATH</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>PKG_CONFIG_PATH_ARM64</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ROOT_DIR_ARM64</span>/lib/pkgconfig:<span style=color:#000>$PKG_CONFIG_PATH</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>LD_LIBRARY_PATH_ARMV7</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ROOT_DIR_ARMV7</span>/lib:<span style=color:#000>$LD_LIBRARY_PATH</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>LD_LIBRARY_PATH_ARM64</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_ROOT_DIR_ARM64</span>/lib:<span style=color:#000>$LD_LIBRARY_PATH</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Consolidate PATH settings</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$JAVA_HOME</span>/bin:/usr/lib/ccache:<span style=color:#000>$QT_HOST_PATH</span>/bin:<span style=color:#000>$QT_ROOT_DIR_ARMV7</span>/bin:<span style=color:#000>$QT_ROOT_DIR_ARM64</span>/bin:<span style=color:#000>$PATH</span>:<span style=color:#000>$ANDROID_SDK_ROOT</span>/tools:<span style=color:#000>$ANDROID_SDK_ROOT</span>/platform-tools:<span style=color:#000>$ANDROID_SDK_ROOT</span>/cmdline-tools/latest/bin:<span style=color:#000>$ANDROID_BUILD_TOOLS</span>:<span style=color:#000>$ANDROID_NDK_ROOT</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> locale-gen en_US.UTF-8 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> update-locale <span style=color:#000>LANG</span><span style=color:#ce5c00;font-weight:700>=</span>en_US.UTF-8<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> git config --global --add safe.directory /project/source<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Set working directory</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>WORKDIR</span><span style=color:#4e9a06> /project/build</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Build the project</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>CMD</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Build Environment Verification ===&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;QGC_ENABLE_HERELINK: </span><span style=color:#000>$QGC_ENABLE_HERELINK</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Android SDK: </span><span style=color:#000>$ANDROID_SDK_ROOT</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Android NDK: </span><span style=color:#000>$ANDROID_NDK_ROOT</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;Qt Host Path: </span><span style=color:#000>$QT_HOST_PATH</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    ls -la <span style=color:#000>$ANDROID_SDK_ROOT</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;ERROR: Android SDK not found&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>exit</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    ls -la <span style=color:#000>$ANDROID_NDK_ROOT</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;ERROR: Android NDK not found&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>exit</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    ls -la <span style=color:#000>$QT_HOST_PATH</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;ERROR: Qt host installation not found&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>exit</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Creating build directory ===&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    mkdir -p /workspace/build/shadow_build_dir <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>cd</span> /workspace/build/shadow_build_dir <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Running CMake configuration ===&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    qt-cmake -S /project/source -G Ninja <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DCMAKE_BUILD_TYPE<span style=color:#ce5c00;font-weight:700>=</span>Release <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DQT_HOST_PATH<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QT_HOST_PATH</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DQT_ANDROID_BUILD_ALL_ABIS<span style=color:#ce5c00;font-weight:700>=</span>OFF <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DQT_ANDROID_ABIS<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;armeabi-v7a;arm64-v8a&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DQT_DEBUG_FIND_PACKAGE<span style=color:#ce5c00;font-weight:700>=</span>ON <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DANDROID_PLATFORM<span style=color:#ce5c00;font-weight:700>=</span>android-28 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DANDROID_BUILD_TOOLS<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ANDROID_SDK_ROOT</span>/build-tools/34.0.0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DANDROID_SDK_ROOT<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ANDROID_SDK_ROOT</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DQT_ANDROID_SIGN_APK<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>QT_ANDROID_SIGN_APK</span><span style=color:#204a87;font-weight:700>:-</span><span style=color:#000>ON</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DQGC_ENABLE_HERELINK<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$QGC_ENABLE_HERELINK</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>        -DCMAKE_TOOLCHAIN_FILE<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ANDROID_NDK_ROOT</span>/build/cmake/android.toolchain.cmake <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;ERROR: CMake configuration failed&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>exit</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Starting build process ===&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    cmake --build . --target all --config Release <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;ERROR: Build failed&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>exit</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;=== Build completed successfully ===&#34;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p><strong>脚本特点：</strong></p><ul><li>交互式构建模式选择（增量编译/完全清理/重新构建镜像）</li><li>自动配置 APK 签名参数</li><li>Herelink 支持可选配置</li><li>智能缓存管理</li><li>自动权限修复</li></ul><h3 id=42-ubuntu-构建脚本>4.2 Ubuntu 构建脚本</h3><p>以下是修改版的 Ubuntu 构建脚本 <code>run-docker-ubuntu.sh</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Exit immediately if a command exits with a non-zero status</span>
</span></span><span style=display:flex><span><span style=color:#204a87>set</span> -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Define variables for better maintainability</span>
</span></span><span style=display:flex><span><span style=color:#000>DOCKERFILE_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;./deploy/docker/Dockerfile-build-ubuntu&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>IMAGE_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;qgc-ubuntu-docker&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>SOURCE_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>pwd</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>BUILD_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>SOURCE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/build&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>CCACHE_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>SOURCE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/.ccache&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>CMAKE_CACHE_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>SOURCE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/.cmake-cache&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Default values</span>
</span></span><span style=display:flex><span><span style=color:#000>REBUILD_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span><span style=color:#000>CLEAN_BUILD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span><span style=color:#000>FULL_CLEAN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Interactive mode for cleanup selection</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;QGroundControl Ubuntu 构建选项&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;请选择构建模式:&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;1) 增量编译 (最快，保留所有缓存) - 日常开发推荐&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;2) 完全清理 (删除构建、缓存、Docker镜像) - 30-60分钟&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;3) 重新构建Docker镜像&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;4) 退出&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>read</span> -p <span style=color:#4e9a06>&#34;请输入选择 (1-4): &#34;</span> choice
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>$choice</span> in
</span></span><span style=display:flex><span>        1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;选择: 增量编译&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        2<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;选择: 完全清理&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>FULL_CLEAN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>            <span style=color:#000>CLEAN_BUILD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>            <span style=color:#000>REBUILD_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        3<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;选择: 重新构建Docker镜像&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>REBUILD_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        4<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;退出脚本&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>        *<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;无效选择，请输入 1-4&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>;;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>esac</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Handle full clean: delete everything</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$FULL_CLEAN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;执行完全清理...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Delete build directory</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -d <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;清理构建目录: </span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        sudo rm -rf <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ 构建目录已清理&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Delete ccache</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -d <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CCACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;清理ccache缓存: </span><span style=color:#4e9a06>${</span><span style=color:#000>CCACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        sudo rm -rf <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CCACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ ccache缓存已清理&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Delete cmake cache</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -d <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CMAKE_CACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;清理cmake缓存: </span><span style=color:#4e9a06>${</span><span style=color:#000>CMAKE_CACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        sudo rm -rf <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CMAKE_CACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ cmake缓存已清理&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Delete Docker image</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> docker image inspect <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span>1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;删除Docker镜像: </span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        docker rmi <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ Docker镜像已删除&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;完全清理完成！&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create cache directories if they don&#39;t exist</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CCACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CMAKE_CACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>mkdir -p <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Check if Docker image exists, build only if needed</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> ! docker image inspect <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$REBUILD_IMAGE</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$REBUILD_IMAGE</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;重新构建Docker镜像...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>else</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;构建Docker镜像...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    docker build --file <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>DOCKERFILE_PATH</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> -t <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>SOURCE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ Docker镜像构建完成&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Clean build artifacts only if requested or for QML changes</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$CLEAN_BUILD</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$FULL_CLEAN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>false</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;清理构建目录...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    sudo rm -rf <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>/* 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ 构建目录已清理&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>elif</span> <span style=color:#ce5c00;font-weight:700>[</span> -d <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$FULL_CLEAN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>false</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Only clean QML-related artifacts for incremental builds</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;清理QML相关文件...&#34;</span>
</span></span><span style=display:flex><span>    sudo rm -rf <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/qml/&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>                <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>/*.qrc <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>                <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>/*_autogen/ <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>                <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/qgroundcontrol.qrc&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ QML相关文件已清理&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Stop any running QGroundControl instances before building</span>
</span></span><span style=display:flex><span><span style=color:#000>QGC_PROCESSES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>pgrep -f <span style=color:#4e9a06>&#34;QGroundControl|qgroundcontrol&#34;</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -n <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>QGC_PROCESSES</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;停止运行中的QGroundControl进程...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Try graceful shutdown first (SIGTERM)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;发送优雅关闭信号...&#34;</span>
</span></span><span style=display:flex><span>    pkill -TERM -f <span style=color:#4e9a06>&#34;QGroundControl|qgroundcontrol&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Wait up to 5 seconds for graceful shutdown</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;等待进程优雅关闭...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..5<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> ! pgrep -f <span style=color:#4e9a06>&#34;QGroundControl|qgroundcontrol&#34;</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span>1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ 进程已优雅关闭&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>break</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;等待中... (</span><span style=color:#000>$i</span><span style=color:#4e9a06>/5)&#34;</span>
</span></span><span style=display:flex><span>        sleep <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># Force kill if still running</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> pgrep -f <span style=color:#4e9a06>&#34;QGroundControl|qgroundcontrol&#34;</span> &gt; /dev/null 2&gt;<span style=color:#000;font-weight:700>&amp;</span>1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;强制终止进程...&#34;</span>
</span></span><span style=display:flex><span>        pkill -KILL -f <span style=color:#4e9a06>&#34;QGroundControl|qgroundcontrol&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>        sleep <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ 进程已强制终止&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Run the Docker container with necessary permissions and volume mounts</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;启动Docker容器进行构建...&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --rm <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --cap-add SYS_ADMIN <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --device /dev/fuse <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --security-opt apparmor:unconfined <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -v <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>SOURCE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:/project/source&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -v <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:/project/build&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -v <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CCACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:/ccache&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -v <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CMAKE_CACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:/cmake-cache&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -e <span style=color:#000>CCACHE_DIR</span><span style=color:#ce5c00;font-weight:700>=</span>/ccache <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>IMAGE_NAME</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;修复文件权限...&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Fix permissions so you can modify build directory without sudo next time</span>
</span></span><span style=display:flex><span>sudo chown -R <span style=color:#204a87;font-weight:700>$(</span>id -u<span style=color:#204a87;font-weight:700>)</span>:<span style=color:#204a87;font-weight:700>$(</span>id -g<span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CCACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CMAKE_CACHE_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> 2&gt;/dev/null <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;✓ 构建完成！&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;构建输出位置: </span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;版本验证提示&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;请验证以下信息确保更新内容已实际编译：&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;1. 检查版本号：运行 ./</span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/AppDir/usr/bin/QGroundControl 后查看 帮助→关于QGroundControl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;2. 检查构建时间：ls -la </span><span style=color:#4e9a06>${</span><span style=color:#000>BUILD_DIR</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/AppDir/usr/bin/QGroundControl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;3. 确认版本号显示为 5.0.6 且构建时间正确&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;============================================&#34;</span>
</span></span></code></pre></div><p><strong>对应的 Dockerfile：</strong></p><p>以下是 Ubuntu 构建使用的 <code>Dockerfile-build-ubuntu</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> ubuntu:22.04</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>QT_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>6</span>.8.3<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>QT_MODULES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;qtcharts qtlocation qtpositioning qtspeech qt5compat qtmultimedia qtserialport qtimageformats qtshadertools qtconnectivity qtquick3d qtsensors&#34;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> DEBIAN_FRONTEND noninteractive<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> DISPLAY :99<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> QT_PATH /opt/Qt<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> QT_DESKTOP <span style=color:#000>$QT_PATH</span>/<span style=color:#4e9a06>${</span><span style=color:#000>QT_VERSION</span><span style=color:#4e9a06>}</span>/gcc_64<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> PATH /usr/lib/ccache:<span style=color:#000>$QT_DESKTOP</span>/bin:<span style=color:#000>$PATH</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> tools/setup/install-dependencies-debian.sh /tmp/qt/<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> /tmp/qt/install-dependencies-debian.sh<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> tools/setup/install-qt-debian.sh /tmp/qt/<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> /tmp/qt/install-qt-debian.sh<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> locale-gen en_US.UTF-8 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> dpkg-reconfigure locales<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> git config --global --add safe.directory /project/source<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>WORKDIR</span><span style=color:#4e9a06> /project/build</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>CMD</span> cmake -S /project/source -B . -G Ninja <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -DCMAKE_BUILD_TYPE<span style=color:#ce5c00;font-weight:700>=</span>Release <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -DCMAKE_C_COMPILER_LAUNCHER<span style=color:#ce5c00;font-weight:700>=</span>ccache <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -DCMAKE_CXX_COMPILER_LAUNCHER<span style=color:#ce5c00;font-weight:700>=</span>ccache <span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    cmake --build . --target all --config Release <span style=color:#000;font-weight:700>;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    cmake --install . --config Release<span style=color:#a40000>
</span></span></span></code></pre></div><p><strong>脚本特点：</strong></p><ul><li>交互式构建模式选择</li><li>智能缓存管理（ccache + cmake cache）</li><li>自动进程管理（优雅关闭运行中的QGC）</li><li>QML文件增量清理</li><li>完整的权限修复</li></ul><h3 id=43-脚本使用说明>4.3 脚本使用说明</h3><p><strong>Android 脚本使用：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 给脚本执行权限</span>
</span></span><span style=display:flex><span>chmod +x run-docker-android.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 运行脚本</span>
</span></span><span style=display:flex><span>./run-docker-android.sh
</span></span></code></pre></div><p><strong>Ubuntu 脚本使用：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 给脚本执行权限</span>
</span></span><span style=display:flex><span>chmod +x run-docker-ubuntu.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 运行脚本</span>
</span></span><span style=display:flex><span>./run-docker-ubuntu.sh
</span></span></code></pre></div><hr><h2 id=5-参考文档>5. 参考文档</h2><ul><li><a href=https://docs.qgroundcontrol.com/Stable_V5.0/zh/qgc-dev-guide/getting_started/container.html>QGC 官方容器构建指南</a></li><li><a href=https://developer.android.com/studio/build/building-cmdline>Android 开发者文档</a></li><li><a href=https://doc.qt.io/qt-6/android-getting-started.html>Qt for Android 文档</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-aaa2b86831f274c3988863b89cd8f8bd>QGroundControl 基于官方文档的容器化构建</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><p>本文档基于 QGroundControl v5.0.6 Stable 的二次开发，使用最简单稳定的容器构建方法，也是官方强烈推荐的构建方法。</p><h3 id=环境要求>环境要求</h3><ul><li>Linux（已在 Ubuntu 上验证）</li><li>Git、Docker、bash</li></ul><h3 id=获取源码>获取源码</h3><ul><li>使用递归方式获取 v5.0.6 Stable，并自动拉取所有子模块（不要直接下载仓库 ZIP 或发布源码包，容易缺少子模块）。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone --recursive --branch v5.0.6 https://github.com/mavlink/qgroundcontrol.git
</span></span></code></pre></div><ul><li>拉取完成后，仓库目录大小通常应在 400MB 以上；若明显偏小，请重新以递归方式克隆。</li></ul><h3 id=构建docker>构建（Docker）</h3><ul><li>在仓库根目录执行：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy/docker/run-docker-ubuntu.sh
</span></span></code></pre></div><ul><li>首次编译耗时较长（取决于机器配置）。出现如下日志表示编译完成并生成可运行产物：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Making AppRun file executable:  /project/build/AppDir/AppRun
</span></span></code></pre></div><h3 id=运行与版本校验>运行与版本校验</h3><ul><li>可直接运行生成的 <code>build/AppDir/AppRun</code>：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./build/AppDir/AppRun
</span></span></code></pre></div><ul><li>应用打开后，点击左上角图标，在下拉框底部可见版本号为 <code>v5.0.6 64bit</code>，以此确认构建版本正确。</li></ul><h3 id=常用工具与别名可选>常用工具与别名（可选）</h3><ul><li>为避免私有仓库配置繁琐，可使用 GitHub Desktop（Linux AppImage 版本）。</li><li>建议在 <code>~/.bashrc</code> 中添加快捷别名：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 编辑配置文件</span>
</span></span><span style=display:flex><span>nano ~/.bashrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 为 AppImage 增加执行权限</span>
</span></span><span style=display:flex><span>chmod +x ~/GitHubDesktop-linux-x86_64-3.4.13-linux1.AppImage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 添加别名（可直接在编辑器中追加到 ~/.bashrc）</span>
</span></span><span style=display:flex><span><span style=color:#204a87>alias</span> <span style=color:#000>qgcdev</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;~/qgroundcontrol/build/AppDir/AppRun&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>alias</span> <span style=color:#000>github</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;~/GitHubDesktop-linux-x86_64-3.4.13-linux1.AppImage&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使配置生效</span>
</span></span><span style=display:flex><span><span style=color:#204a87>source</span> ~/.bashrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 快速启动</span>
</span></span><span style=display:flex><span>qgcdev   <span style=color:#8f5902;font-style:italic># 打开二次开发的 QGC v5.0.6</span>
</span></span><span style=display:flex><span>github   <span style=color:#8f5902;font-style:italic># 打开 GitHub Desktop for Linux</span>
</span></span></code></pre></div><h3 id=开发工作流>开发工作流</h3><ul><li>每次新增功能或修复请创建独立分支；不要直接推送到 <code>main</code>。</li><li>修改代码后，重复执行 <code>./deploy/docker/run-docker-ubuntu.sh</code> 进行增量构建与验证。</li></ul><h3 id=常见问题>常见问题</h3><ul><li>子模块缺失：确保使用 <code>--recursive</code> 克隆；若仓库体积明显小于 400MB，请重新克隆。</li><li>构建失败：优先对照官方容器构建指南，确认本地 Docker 环境与网络条件正常。</li></ul><h3 id=参考文档>参考文档</h3><ul><li>官方容器构建指南（中文）：<a href=https://docs.qgroundcontrol.com/Stable_V5.0/zh/qgc-dev-guide/getting_started/container.html>QGC Dev Guide / Getting Started / Container</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c02dbade865b275a8f957a9075a8ffab>在 QGC 和 大模型 FastAPI 后端实现的端到端无人机语音指令框架</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><h2 id=1-概述>1. 概述</h2><h3 id=11-版本信息>1.1 版本信息</h3><p><strong>基础版本</strong>：QGroundControl v5.0.6 Stable
<strong>开发目标</strong>：为QGC添加语音交互能力，实现通过自然语言控制无人机</p><h3 id=12-二次开发说明>1.2 二次开发说明</h3><p>本实现在不修改QGC核心功能的前提下，通过以下方式扩展语音交互能力：</p><p><strong>新增源文件</strong>：</p><ul><li><code>AudioRecorderController.h/cc</code>：独立的音频录制控制器</li><li><code>BackendSettings.h/cc</code>：后端配置管理</li><li><code>Backend.SettingsGroup.json</code>：配置项定义</li><li><code>BottomFlyViewToolBar.qml</code>：添加语音按钮和交互逻辑</li></ul><p><strong>修改现有文件</strong>：</p><ul><li><code>QGroundControlQmlGlobal.cc</code>：注册新的QML类型</li><li><code>CMakeLists.txt</code>：添加新源文件到构建系统</li><li><code>MainWindow.qml</code>：添加全局状态管理</li></ul><p><strong>保持兼容性</strong>：</p><ul><li>所有新功能作为可选模块，不影响现有功能</li><li>使用QGC现有的设置管理框架</li><li>遵循QGC的代码风格和架构设计</li><li>新增组件与原有组件解耦，便于独立维护</li></ul><h2 id=2-系统架构>2. 系统架构</h2><h3 id=21-整体架构图>2.1 整体架构图</h3><pre class=mermaid>graph TB
    subgraph QGC[&#34;QGroundControl 客户端&#34;]
        User[&#34;用户操作&lt;br/&gt;(按住/松开按钮)&#34;]
        
        subgraph UI[&#34;QML 界面层&#34;]
            ToolBar[&#34;BottomFlyViewToolBar.qml&#34;]
        end
        
        subgraph Controller[&#34;C&#43;&#43; 控制器层&#34;]
            Audio[&#34;AudioRecorderController&lt;br/&gt;• startRecording()&lt;br/&gt;• stopRecording()&lt;br/&gt;• 音频格式配置&lt;br/&gt;• WAV文件生成&#34;]
        end
        
        subgraph QtLayer[&#34;Qt Multimedia 层&#34;]
            QtAudio[&#34;QAudioSource / QAudioFormat&lt;br/&gt;• 音频设备管理&lt;br/&gt;• PCM数据采集&#34;]
        end
        
        User -.-&gt; ToolBar
        ToolBar --&gt;|调用C&#43;&#43;接口| Audio
        Audio --&gt;|使用Qt框架| QtAudio
    end
    
    subgraph Backend[&#34;后端服务器 (FastAPI)&#34;]
        APIRouter[&#34;/api/v1/voice&lt;br/&gt;(FastAPI 路由)&#34;]
        VoiceCommand[&#34;POST /api/v1/voice/command&lt;br/&gt;voice_command()&#34;]
        Whisper[&#34;Whisper 模型&lt;br/&gt;(small, CPU, 单例)&#34;]
        Agent[&#34;DroneAgent&lt;br/&gt;(LLM 解释命令)&#34;]
        Fleet[&#34;FleetManager / MavSDKWrapper&lt;br/&gt;(实际控制无人机)&#34;]
        LLM[&#34;外部 / 本地部署 LLM 服务&lt;br/&gt;&#34;]
        
        APIRouter --&gt; VoiceCommand
        VoiceCommand --&gt; Whisper
        Whisper --&gt; Agent
        Agent --&gt; LLM
        Agent --&gt; Fleet
    end
    
    Dialog[&#34;结果展示&lt;br/&gt;对话框&#34;]
    
    QtAudio --&gt;|&#34;HTTP POST&lt;br/&gt;(multipart/form-data)&lt;br/&gt;字段: audio(WAV)&#34;| APIRouter
    Fleet --&gt;|&#34;执行结果字符串&lt;br/&gt;(含ANSI颜色)&#34;| Agent
    Agent --&gt;|&#34;JSON { result: &#39;执行结果...&#39; }&#34;| VoiceCommand
    VoiceCommand --&gt; Dialog
    
    style QGC fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style Backend fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style User fill:#f3e5f5,stroke:#4a148c
    style ToolBar fill:#e8f5e9,stroke:#1b5e20
    style Audio fill:#fff9c4,stroke:#f57f17
    style QtAudio fill:#fce4ec,stroke:#880e4f
    style Dialog fill:#f1f8e9,stroke:#33691e
    style APIRouter fill:#ffe0b2,stroke:#ef6c00
    style VoiceCommand fill:#ffe082,stroke:#ff8f00
    style Whisper fill:#fff9c4,stroke:#fbc02d
    style Agent fill:#e1bee7,stroke:#6a1b9a
    style Fleet fill:#c8e6c9,stroke:#2e7d32
    style LLM fill:#bbdefb,stroke:#1565c0</pre><h3 id=22-数据流向时序图>2.2 数据流向：时序图</h3><h4 id=完整交互流程>完整交互流程</h4><pre class=mermaid>sequenceDiagram
    autonumber
    actor User as 用户
    participant UI as QML界面&lt;br/&gt;BottomFlyViewToolBar
    participant Controller as C&#43;&#43;控制器&lt;br/&gt;AudioRecorderController
    participant Timer as 定时器&lt;br/&gt;QTimer(50ms)
    participant QtAudio as Qt Multimedia&lt;br/&gt;QAudioSource
    participant Network as 网络层&lt;br/&gt;XMLHttpRequest
    participant APIRouter as FastAPI路由&lt;br/&gt;/api/v1/voice
    participant VoiceAPI as 语音接口&lt;br/&gt;voice_command()
    participant Whisper as Whisper模型&lt;br/&gt;small@CPU(单例)
    participant Agent as DroneAgent&lt;br/&gt;LLM 命令解释器
    participant LLM as 外部 / 本地部署 LLM 服务&lt;br/&gt;
    participant Fleet as 机队管理器&lt;br/&gt;FleetManager/MavSDK
    
    %% 阶段1: 开始录音
    rect rgb(227, 242, 253)
        Note over User,QtAudio: 阶段1: 开始录音
        User-&gt;&gt;&#43;UI: 按下&#34;发送语音&#34;按钮
        UI-&gt;&gt;&#43;Controller: startRecording()
        Controller-&gt;&gt;Controller: 清空旧数据&lt;br/&gt;_rawAudioData.clear()
        Controller-&gt;&gt;QtAudio: 创建QAudioSource
        activate QtAudio
        QtAudio--&gt;&gt;Controller: 返回音频设备
        Controller-&gt;&gt;QtAudio: start() 启动录音
        QtAudio--&gt;&gt;Controller: 返回QIODevice
        Controller-&gt;&gt;Timer: start() 启动定时器
        activate Timer
        Controller--&gt;&gt;UI: emit isRecordingChanged(true)
        UI--&gt;&gt;User: 显示&#34;录音中...&#34;
        Controller--&gt;&gt;UI: 录音已启动
    end
    
    %% 阶段2: 周期性读取音频数据
    rect rgb(243, 229, 245)
        Note over Timer,Controller: 阶段2: 周期性读取音频数据
        loop 每50ms循环
            Timer-&gt;&gt;Controller: timeout() 触发
            Controller-&gt;&gt;QtAudio: bytesAvailable() 检查
            QtAudio--&gt;&gt;Controller: 可用字节数
            Controller-&gt;&gt;QtAudio: read() 读取PCM数据
            QtAudio--&gt;&gt;Controller: PCM音频数据
            Controller-&gt;&gt;Controller: _rawAudioData.append()&lt;br/&gt;追加到缓冲区
            Note right of Controller: 内存缓冲区持续增长
        end
    end
    
    %% 阶段3: 停止录音
    rect rgb(255, 243, 224)
        Note over User,Controller: 阶段3: 停止录音
        User-&gt;&gt;UI: 松开按钮
        UI-&gt;&gt;Controller: stopRecording()
        Controller-&gt;&gt;Timer: stop() 停止定时器
        deactivate Timer
        Controller-&gt;&gt;QtAudio: 读取剩余数据
        QtAudio--&gt;&gt;Controller: 最后的PCM数据
        Controller-&gt;&gt;QtAudio: stop() 停止录音
        deactivate QtAudio
        Controller-&gt;&gt;Controller: _createWavHeader()&lt;br/&gt;生成WAV头部(44字节)
        Controller-&gt;&gt;Controller: _audioData = header &#43; _rawAudioData&lt;br/&gt;拼接完整WAV文件
        Note right of Controller: 完整WAV文件已准备就绪
        Controller--&gt;&gt;UI: emit recordingFinished()
        Controller--&gt;&gt;UI: emit isRecordingChanged(false)
        UI--&gt;&gt;User: 显示确认对话框
        deactivate UI
    end
    
    %% 阶段4: 用户确认
    rect rgb(232, 245, 233)
        Note over User,UI: 阶段4: 用户确认
        User-&gt;&gt;&#43;UI: 点击&#34;是&#34;确认发送
    end
    
    %% 阶段5: 准备网络请求
    rect rgb(255, 249, 196)
        Note over UI,Network: 阶段5: 准备网络请求
        UI-&gt;&gt;Controller: 获取audioData
        Controller--&gt;&gt;UI: 返回QByteArray(WAV文件)
        UI-&gt;&gt;UI: 转换QByteArray → Uint8Array
        UI-&gt;&gt;&#43;Network: 构建multipart/form-data
        Network-&gt;&gt;Network: 生成boundary标识
        Network-&gt;&gt;Network: 构建HTTP头部
        Network-&gt;&gt;Network: 组装ArrayBuffer
        Note right of Network: 完整HTTP请求已构建完成
        UI-&gt;&gt;Controller: clearAudioData() 立即清理
        Note right of Controller: 内存清理(关键优化点)
    end
    
    %% 阶段6: 发送HTTP请求
    rect rgb(252, 228, 236)
        Note over Network,APIRouter: 阶段6: 发送HTTP请求
        Network-&gt;&gt;&#43;APIRouter: POST /api/v1/voice/command&lt;br/&gt;Content-Type: multipart/form-data&lt;br/&gt;Body: audio=WAV
        UI--&gt;&gt;User: 显示&#34;等待响应...&#34;
        deactivate UI
    end
    
    %% 阶段7: 后端处理（语音 → 文本 → 命令 → 控制）
    rect rgb(224, 242, 241)
        Note over APIRouter,Fleet: 阶段7: 后端处理
        APIRouter-&gt;&gt;&#43;VoiceAPI: 路由到 voice_command()&lt;br/&gt;依赖注入 DroneAgent
        VoiceAPI-&gt;&gt;VoiceAPI: 校验文件名/扩展名/内容长度
        VoiceAPI-&gt;&gt;VoiceAPI: 写入临时文件(temp.wav)
        VoiceAPI-&gt;&gt;&#43;Whisper: get_whisper_model()&lt;br/&gt;单例加载 small 模型
        Whisper--&gt;&gt;VoiceAPI: model 实例
        VoiceAPI-&gt;&gt;Whisper: transcribe(temp.wav)
        Whisper--&gt;&gt;VoiceAPI: transcribed_text(自然语言命令)
        VoiceAPI-&gt;&gt;VoiceAPI: 删除临时文件
        VoiceAPI-&gt;&gt;&#43;Agent: await process(transcribed_text)
        Agent-&gt;&gt;Agent: 构造控制提示词&lt;br/&gt;检查机队状态
        Agent-&gt;&gt;&#43;Fleet: get_fleet_status()&lt;br/&gt;仅使用已连接无人机
        Fleet--&gt;&gt;Agent: 当前无人机状态
        Agent-&gt;&gt;&#43;LLM: chat.completions.create()&lt;br/&gt;生成控制代码
        LLM--&gt;&gt;Agent: Python 控制代码
        Agent-&gt;&gt;Agent: 在受限作用域内执行代码&lt;br/&gt;调用 FleetManager/MavSDK
        Agent--&gt;&gt;VoiceAPI: 执行结果字符串&lt;br/&gt;(含ANSI颜色/Success等)
        VoiceAPI--&gt;&gt;-APIRouter: AgentResponse(result=...)
        APIRouter--&gt;&gt;-Network: JSON响应&lt;br/&gt;{result: &#34;...&#34;}
    end
    
    %% 阶段8: 处理响应
    rect rgb(225, 245, 254)
        Note over Network,User: 阶段8: 处理响应
        Network--&gt;&gt;&#43;UI: onreadystatechange&lt;br/&gt;xhr.responseText
        UI-&gt;&gt;UI: parseResponseText()&lt;br/&gt;提取result字段
        UI-&gt;&gt;UI: ansiToHtml()&lt;br/&gt;转换ANSI颜色→HTML
        UI-&gt;&gt;Controller: clearAudioData() 防御性清理
        deactivate Controller
        Note right of Controller: 确保内存已释放
        UI--&gt;&gt;User: 显示结果对话框&lt;br/&gt;可选择复制
        deactivate UI
        User-&gt;&gt;User: 查看执行结果
    end</pre><h2 id=3-核心组件>3. 核心组件</h2><h3 id=31-audiorecordercontrollerc音频控制器>3.1 AudioRecorderController（C++音频控制器）</h3><h4 id=类设计>类设计</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AudioRecorderController</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>QObject</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_OBJECT</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QML_ELEMENT</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// QML可访问属性
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Q_PROPERTY</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>isRecording</span> <span style=color:#000>READ</span> <span style=color:#000>isRecording</span> <span style=color:#000>NOTIFY</span> <span style=color:#000>isRecordingChanged</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_PROPERTY</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QByteArray</span> <span style=color:#000>audioData</span> <span style=color:#000>READ</span> <span style=color:#000>audioData</span> <span style=color:#000>NOTIFY</span> <span style=color:#000>audioDataChanged</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_PROPERTY</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>audioDataSize</span> <span style=color:#000>READ</span> <span style=color:#000>audioDataSize</span> <span style=color:#000>NOTIFY</span> <span style=color:#000>audioDataChanged</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>explicit</span> <span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QObject</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>nullptr</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 公共方法 - QML可调用
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Q_INVOKABLE</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_INVOKABLE</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_INVOKABLE</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#f57900>signals</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>isRecordingChanged</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>isRecording</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>audioDataChanged</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>recordingFinished</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>errorOccurred</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>QString</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>errorString</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QAudioSource</span><span style=color:#ce5c00;font-weight:700>*</span>  <span style=color:#000>_audioSource</span><span style=color:#000;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// 音频输入设备
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QIODevice</span><span style=color:#ce5c00;font-weight:700>*</span>     <span style=color:#000>_audioIODevice</span><span style=color:#000;font-weight:700>;</span>      <span style=color:#8f5902;font-style:italic>// I/O设备接口
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QTimer</span><span style=color:#ce5c00;font-weight:700>*</span>        <span style=color:#000>_readTimer</span><span style=color:#000;font-weight:700>;</span>          <span style=color:#8f5902;font-style:italic>// 定时读取音频数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QAudioFormat</span>   <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// 音频格式配置
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QByteArray</span>     <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// 原始PCM数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QByteArray</span>     <span style=color:#000>_audioData</span><span style=color:#000;font-weight:700>;</span>          <span style=color:#8f5902;font-style:italic>// 完整WAV数据（含头部）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>bool</span>           <span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// 录制状态
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><h3 id=32-音频格式配置>3.2 音频格式配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QObject</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>parent</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>QObject</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>_audioSource</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>nullptr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>_audioIODevice</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>nullptr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>_readTimer</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>QTimer</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>false</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 配置音频格式: 16位PCM, 44100Hz采样率, 单声道
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleRate</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>44100</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setChannelCount</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleFormat</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QAudioFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SampleFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Int16</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 设置定时器周期性读取音频数据（每50ms）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>setInterval</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>setSingleShot</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>false</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>connect</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_readTimer</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>QTimer</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>timeout</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>_onAudioDataReady</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=33-开始录制流程>3.3 开始录制流程</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 1. 状态检查
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>qCWarning</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>AudioRecorderControllerLog</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Already recording&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 2. 清空旧数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clear</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clear</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 3. 创建音频源
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>_audioSource</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>_audioSource</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>deleteLater</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>QAudioSource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 4. 启动音频输入
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioIODevice</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_audioSource</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>start</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_audioIODevice</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>emit</span> <span style=color:#000>errorOccurred</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to start audio input device&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 5. 启动定时器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>start</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 6. 更新状态
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_isRecording</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>emit</span> <span style=color:#000>isRecordingChanged</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=34-周期性数据读取>3.4 周期性数据读取</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>_onAudioDataReady</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_audioIODevice</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 检查可用字节数
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint64</span> <span style=color:#000>bytesAvailable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_audioIODevice</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>bytesAvailable</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>bytesAvailable</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 读取音频数据并追加到缓冲区
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>QByteArray</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_audioIODevice</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>read</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytesAvailable</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>qCDebug</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>AudioRecorderControllerLog</span><span style=color:#000;font-weight:700>)</span> 
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Read audio data:&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>()</span> 
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;bytes, total:&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=35-停止录制并生成wav文件>3.5 停止录制并生成WAV文件</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 1. 停止定时器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>stop</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 2. 读取剩余数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>_audioIODevice</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>_audioIODevice</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>bytesAvailable</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>QByteArray</span> <span style=color:#000>remainingData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_audioIODevice</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>readAll</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>remainingData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>remainingData</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 3. 停止音频源
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>_audioSource</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>_audioSource</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>stop</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioIODevice</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>nullptr</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 4. 生成WAV文件头部
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>QByteArray</span> <span style=color:#000>wavHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_createWavHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>(),</span> 
</span></span><span style=display:flex><span>                                                 <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>_audioData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>wavHeader</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// WAV文件结构验证
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>qCDebug</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>AudioRecorderControllerLog</span><span style=color:#000;font-weight:700>)</span> 
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;WAV total size:&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>_audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 5. 更新状态并发出信号
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_isRecording</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>false</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>emit</span> <span style=color:#000>isRecordingChanged</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>emit</span> <span style=color:#000>recordingFinished</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>emit</span> <span style=color:#000>audioDataChanged</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=36-wav文件头部生成>3.6 WAV文件头部生成</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>QByteArray</span> <span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>_createWavHeader</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint32</span> <span style=color:#000>dataSize</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>QAudioFormat</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>format</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>const</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QByteArray</span> <span style=color:#000>header</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QDataStream</span> <span style=color:#000>stream</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>header</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>QIODevice</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>WriteOnly</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setByteOrder</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QDataStream</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>LittleEndian</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 计算格式参数
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint16</span> <span style=color:#000>numChannels</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>format</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>channelCount</span><span style=color:#000;font-weight:700>();</span>      <span style=color:#8f5902;font-style:italic>// 1 (单声道)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint32</span> <span style=color:#000>sampleRate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>format</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sampleRate</span><span style=color:#000;font-weight:700>();</span>         <span style=color:#8f5902;font-style:italic>// 44100
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint16</span> <span style=color:#000>bytesPerSample</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>format</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>bytesPerSample</span><span style=color:#000;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 2 (16位)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint16</span> <span style=color:#000>bitsPerSample</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bytesPerSample</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// 16
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint32</span> <span style=color:#000>byteRate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sampleRate</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>numChannels</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>bytesPerSample</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint16</span> <span style=color:#000>blockAlign</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>numChannels</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>bytesPerSample</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// RIFF头部 (12字节)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>writeRawData</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;RIFF&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint32</span> <span style=color:#000>fileSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>36</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dataSize</span><span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// 总大小 - 8
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>fileSize</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>writeRawData</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;WAVE&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// fmt块 (24字节)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>writeRawData</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;fmt &#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint32</span> <span style=color:#000>fmtChunkSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>;</span>         <span style=color:#8f5902;font-style:italic>// PCM格式块大小
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>fmtChunkSize</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint16</span> <span style=color:#000>audioFormat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>           <span style=color:#8f5902;font-style:italic>// PCM = 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>audioFormat</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>numChannels</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>sampleRate</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>byteRate</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>blockAlign</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>bitsPerSample</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// data块头 (8字节)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>writeRawData</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>dataSize</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 验证头部大小 (应为44字节)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>header</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>44</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>qCWarning</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>AudioRecorderControllerLog</span><span style=color:#000;font-weight:700>)</span> 
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;WAV header size incorrect:&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>header</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>header</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>WAV文件格式详解</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>偏移  大小  字段           值
</span></span><span style=display:flex><span>─────────────────────────────────────
</span></span><span style=display:flex><span>0     4     ChunkID       &#34;RIFF&#34;
</span></span><span style=display:flex><span>4     4     ChunkSize     文件大小-8
</span></span><span style=display:flex><span>8     4     Format        &#34;WAVE&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>12    4     Subchunk1ID   &#34;fmt &#34;
</span></span><span style=display:flex><span>16    4     Subchunk1Size 16 (PCM)
</span></span><span style=display:flex><span>20    2     AudioFormat   1 (PCM)
</span></span><span style=display:flex><span>22    2     NumChannels   1 (单声道)
</span></span><span style=display:flex><span>24    4     SampleRate    44100
</span></span><span style=display:flex><span>28    4     ByteRate      88200 (=44100*1*2)
</span></span><span style=display:flex><span>32    2     BlockAlign    2 (=1*2)
</span></span><span style=display:flex><span>34    2     BitsPerSample 16
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>36    4     Subchunk2ID   &#34;data&#34;
</span></span><span style=display:flex><span>40    4     Subchunk2Size PCM数据大小
</span></span><span style=display:flex><span>44    N     Data          实际音频数据
</span></span></code></pre></div><h4 id=音频质量与性能平衡>音频质量与性能平衡</h4><table><thead><tr><th>参数</th><th>值</th><th>理由</th></tr></thead><tbody><tr><td>采样率</td><td>44100 Hz</td><td>标准CD音质，适合所有语音识别系统</td></tr><tr><td>位深度</td><td>16 bit</td><td>足够的动态范围，比8bit清晰，比24bit节省空间</td></tr><tr><td>声道数</td><td>1 (单声道)</td><td>语音识别不需要立体声，减少50%数据量</td></tr><tr><td>读取间隔</td><td>50 ms</td><td>平衡响应性和CPU占用</td></tr></tbody></table><p><strong>数据量计算</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>每秒数据量 = 44100 Hz × 2 bytes × 1 channel = 88,200 bytes/s ≈ 86 KB/s
</span></span><span style=display:flex><span>10秒录音 ≈ 860 KB
</span></span><span style=display:flex><span>30秒录音 ≈ 2.5 MB
</span></span></code></pre></div><h4 id=音频参数配置>音频参数配置</h4><p>如需修改音频参数，编辑 <code>AudioRecorderController</code> 构造函数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QObject</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>parent</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 可自定义的参数
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleRate</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>44100</span><span style=color:#000;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// 采样率：8000, 16000, 44100, 48000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setChannelCount</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>        <span style=color:#8f5902;font-style:italic>// 声道数：1=单声道, 2=立体声
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleFormat</span><span style=color:#000;font-weight:700>(</span>           <span style=color:#8f5902;font-style:italic>// 采样格式
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>QAudioFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SampleFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Int16</span>   <span style=color:#8f5902;font-style:italic>// Int16, Int32, Float
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 读取间隔（毫秒）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>setInterval</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>);</span>            <span style=color:#8f5902;font-style:italic>// 10-100ms范围推荐
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>常见配置组合</strong>：</p><table><thead><tr><th>场景</th><th>采样率</th><th>位深度</th><th>声道</th><th>数据率</th></tr></thead><tbody><tr><td>语音识别（推荐）</td><td>44100Hz</td><td>16bit</td><td>单声道</td><td>86KB/s</td></tr><tr><td>低质量/节省带宽</td><td>16000Hz</td><td>16bit</td><td>单声道</td><td>31KB/s</td></tr><tr><td>高质量/专业录音</td><td>48000Hz</td><td>24bit</td><td>立体声</td><td>281KB/s</td></tr><tr><td>电话音质</td><td>8000Hz</td><td>16bit</td><td>单声道</td><td>16KB/s</td></tr></tbody></table><h3 id=38-qml界面层>3.8 QML界面层</h3><h4 id=主要组件结构>主要组件结构</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-qml data-lang=qml><span style=display:flex><span><span style=color:#000>Item</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>id:</span> <span style=color:#000>_root</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 属性定义 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>property</span> <span style=color:#000>bool</span> <span style=color:#204a87;font-weight:700>isBackendAlive:</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>    <span style=color:#000>property</span> <span style=color:#000>bool</span> <span style=color:#204a87;font-weight:700>isWaitingForBackendResponse:</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>    <span style=color:#000>property</span> <span style=color:#000>bool</span> <span style=color:#204a87;font-weight:700>isRecording:</span> <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isRecording</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 后端API URLs
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>backendBaseUrl:</span> 
</span></span><span style=display:flex><span>        <span style=color:#000>QGroundControl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settingsManager</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backendSettings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backendBaseUrl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span>
</span></span><span style=display:flex><span>    <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>voiceApiPath:</span> 
</span></span><span style=display:flex><span>        <span style=color:#000>QGroundControl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settingsManager</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backendSettings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>voiceApiPath</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span>
</span></span><span style=display:flex><span>    <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>voiceApiUrl:</span> <span style=color:#000>_buildCompleteUrl</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>voiceApiPath</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 音频录制控制器 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>AudioRecorderController</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>id: audioRecorderController</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>onRecordingFinished:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 录音完成，显示确认对话框
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>dialog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>voiceConfirmDialogComponent</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>createObject</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>dialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>open</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>onErrorOccurred:</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>errorString</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 处理录音错误
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Audio recording error:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errorString</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 录音按钮 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QGCButton</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>id: microphoneButton</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>text:</span> <span style=color:#000>isRecording</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;录音中...&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;发送语音&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>enabled:</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>isWaitingForBackendResponse</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>onPressed:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>_root</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>onReleased:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>_root</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 确认对话框 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Component</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>id: voiceConfirmDialogComponent</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>QGCPopupDialog</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>title:</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;发送语音指令&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>buttons:</span> <span style=color:#000>Dialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Yes</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Dialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>No</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>onAccepted:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>audioData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>audioData</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>audioData</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>_root</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sendVoiceCommandFromMemory</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>onRejected:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 响应显示对话框 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Component</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>id: responseDialogComponent</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>QGCPopupDialog</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>responseText:</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>plainText:</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>coloredHtml:</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 可滚动的文本显示区域
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ScrollView</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>TextEdit</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>text:</span> <span style=color:#000>responseDialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>coloredHtml</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>textFormat:</span> <span style=color:#000>TextEdit</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RichText</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>readOnly:</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>selectByMouse:</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 复制按钮
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>QGCButton</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>text:</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;复制&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>onClicked:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>clipboard</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>text</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>responseDialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>plainText</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=启动录制>启动录制</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-qml data-lang=qml><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Started recording to memory&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to start recording:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=停止录制>停止录制</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-qml data-lang=qml><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Stopped recording&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to stop recording:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=发送语音命令>发送语音命令</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-qml data-lang=qml><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>sendVoiceCommandFromMemory</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>audioData</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>===</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;No audio data to send&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 设置等待状态
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isWaitingForBackendResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 数据转换 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 将QByteArray转换为Uint8Array
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>uint8Array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Uint8Array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>uint8Array</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>charCodeAt</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#0000cf;font-weight:700>0xFF</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 构建multipart请求 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;----WebKitFormBoundary&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>fileName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;recording_&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.wav&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 辅助函数：字符串转字节数组
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Uint8Array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>str</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>bytes</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>str</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>charCodeAt</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#0000cf;font-weight:700>0xFF</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bytes</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 构建multipart各部分
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>boundaryStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;--&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\r\n&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>dispositionStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;Content-Disposition: form-data; &#39;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>                            <span style=color:#4e9a06>&#39;name=&#34;audio&#34;; filename=&#34;&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>fileName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;&#34;\r\n&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>contentTypeStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Content-Type: audio/wav\r\n\r\n&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>crlfStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;\r\n&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>closingStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;--&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;--\r\n&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>boundaryBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>boundaryStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>dispositionBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dispositionStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>contentTypeBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>contentTypeStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>crlfBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>crlfStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>closingBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>closingStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 组装完整请求体 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>totalSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundaryBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>dispositionBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>contentTypeBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>uint8Array</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>crlfBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>closingBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>multipartBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayBuffer</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>totalSize</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>multipartView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Uint8Array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>multipartBuffer</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 按顺序复制各部分
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>boundaryBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>boundaryBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dispositionBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>dispositionBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>contentTypeBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>contentTypeBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uint8Array</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>uint8Array</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>crlfBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>crlfBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>closingBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 发送HTTP请求 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>xhr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLHttpRequest</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>open</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;POST&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>voiceApiUrl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setRequestHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Content-Type&#34;</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                            <span style=color:#4e9a06>&#34;multipart/form-data; boundary=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setRequestHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Accept&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;application/json&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 立即清理音频数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Sending audio, size:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>totalSize</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 发送请求
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>multipartBuffer</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 处理响应 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>onreadystatechange</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>readyState</span> <span style=color:#ce5c00;font-weight:700>===</span> <span style=color:#000>XMLHttpRequest</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DONE</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>status</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>body</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>responseText</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// 确保清理内存
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isWaitingForBackendResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#0000cf;font-weight:700>200</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>300</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// 成功响应
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>parsedBody</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseResponseText</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>body</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>displayText</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parsedBody</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>?</span> 
</span></span><span style=display:flex><span>                        <span style=color:#204a87;font-weight:700>parsedBody :</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;命令执行成功，但未返回内容&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>parsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ansiToHtml</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>displayText</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>dialog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>responseDialogComponent</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>createObject</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#204a87;font-weight:700>responseTitle:</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;命令执行结果&#34;</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>                            <span style=color:#204a87;font-weight:700>plainText:</span> <span style=color:#000>parsed</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>plain</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#204a87;font-weight:700>coloredHtml:</span> <span style=color:#000>parsed</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>colored</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>dialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>open</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// 错误响应
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>errorText</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;命令执行失败\n状态码: %1\n响应: %2&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>.</span><span style=color:#000>arg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>arg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parseResponseText</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>body</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>                    
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// 显示错误对话框...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>onerror</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>            <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isWaitingForBackendResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 显示网络错误...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isWaitingForBackendResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error sending voice command:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=音频质量与性能考虑>音频质量与性能考虑</h5><p>在发送语音命令时，音频数据的质量和性能参数直接影响传输效率和识别准确度。本实现采用以下参数配置：</p><p><strong>音频参数配置</strong>：</p><table><thead><tr><th>参数</th><th>值</th><th>理由</th></tr></thead><tbody><tr><td>采样率</td><td>44100 Hz</td><td>标准CD音质，适合所有语音识别系统</td></tr><tr><td>位深度</td><td>16 bit</td><td>足够的动态范围，比8bit清晰，比24bit节省空间</td></tr><tr><td>声道数</td><td>1 (单声道)</td><td>语音识别不需要立体声，减少50%数据量</td></tr><tr><td>读取间隔</td><td>50 ms</td><td>平衡响应性和CPU占用</td></tr></tbody></table><p><strong>数据量计算</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>每秒数据量 = 44100 Hz × 2 bytes × 1 channel = 88,200 bytes/s ≈ 86 KB/s
</span></span><span style=display:flex><span>10秒录音 ≈ 860 KB
</span></span><span style=display:flex><span>30秒录音 ≈ 2.5 MB
</span></span></code></pre></div><p><strong>为什么选择这些参数</strong>：</p><ol><li><p><strong>44100 Hz 采样率</strong>：这是标准CD音质，能够完整保留人声频率范围（20 Hz - 20 kHz），确保语音识别系统能够准确识别语音内容。虽然16000 Hz也能满足基本需求，但44100 Hz提供了更好的音质冗余，适应不同环境下的录音质量变化。</p></li><li><p><strong>16 bit 位深度</strong>：提供了65536个量化级别，足够捕捉人声的动态范围。8 bit（256级）会导致明显的量化噪声，而24 bit虽然更精确，但会增加50%的数据量，对语音识别来说收益有限。</p></li><li><p><strong>单声道</strong>：语音识别主要关注频率内容和时间序列，不需要立体声的空间信息。使用单声道可以将数据量减半，显著降低网络传输负担和内存占用。</p></li><li><p><strong>50 ms 读取间隔</strong>：在录音过程中，每50毫秒读取一次音频数据，既能及时响应录音状态变化，又不会过度占用CPU资源。过短的间隔（如10 ms）会增加CPU开销，过长的间隔（如100 ms）会导致内存缓冲区过大。</p></li></ol><p><strong>常见配置组合对比</strong>：</p><table><thead><tr><th>场景</th><th>采样率</th><th>位深度</th><th>声道</th><th>数据率</th><th>适用性</th></tr></thead><tbody><tr><td>语音识别（推荐）</td><td>44100Hz</td><td>16bit</td><td>单声道</td><td>86KB/s</td><td>✅ 最佳平衡</td></tr><tr><td>低质量/节省带宽</td><td>16000Hz</td><td>16bit</td><td>单声道</td><td>31KB/s</td><td>⚠️ 音质可能不足</td></tr><tr><td>高质量/专业录音</td><td>48000Hz</td><td>24bit</td><td>立体声</td><td>281KB/s</td><td>❌ 过度配置</td></tr><tr><td>电话音质</td><td>8000Hz</td><td>16bit</td><td>单声道</td><td>16KB/s</td><td>❌ 音质较差</td></tr></tbody></table><p><strong>性能影响</strong>：</p><ul><li><strong>网络传输</strong>：10秒录音约860 KB，即使在较慢的网络环境下也能快速上传</li><li><strong>内存占用</strong>：单次录音的内存占用可控，不会导致内存溢出</li><li><strong>CPU占用</strong>：50 ms读取间隔保证了流畅的录音体验，不会造成明显的CPU负担</li></ul><p>如需修改音频参数，可在 <code>AudioRecorderController</code> 构造函数中调整：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QObject</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>parent</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 可自定义的参数
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleRate</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>44100</span><span style=color:#000;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// 采样率：8000, 16000, 44100, 48000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setChannelCount</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>        <span style=color:#8f5902;font-style:italic>// 声道数：1=单声道, 2=立体声
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleFormat</span><span style=color:#000;font-weight:700>(</span>           <span style=color:#8f5902;font-style:italic>// 采样格式
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>QAudioFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SampleFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Int16</span>   <span style=color:#8f5902;font-style:italic>// Int16, Int32, Float
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 读取间隔（毫秒）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>setInterval</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>);</span>            <span style=color:#8f5902;font-style:italic>// 10-100ms范围推荐
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=multipartform-data>multipart/form-data</h5><p>与上面的 <code>sendVoiceCommandFromMemory</code> 函数对应，音频数据通过 <code>multipart/form-data</code> 编码发送到后端。</p><h5 id=什么是-multipartform-data>什么是 multipart/form-data</h5><p><code>multipart/form-data</code> 是 HTTP 协议中定义的一种内容编码类型（Content-Type），用于在单个 HTTP 请求中传输<strong>多个不同类型的数据块</strong>。</p><p><strong>核心特点</strong>：</p><ul><li><strong>多部分传输</strong>：可在一个请求中同时发送文本字段和二进制文件</li><li><strong>边界分隔</strong>：使用 boundary（边界标识符）分隔不同的数据部分</li><li><strong>独立描述</strong>：每个部分都有自己的 Content-Disposition 和 Content-Type</li><li><strong>二进制安全</strong>：能够正确传输任意二进制数据，不会损坏文件内容</li></ul><h5 id=为什么使用-multipartform-data>为什么使用 multipart/form-data</h5><p><strong>文件上传的标准方式</strong></p><p>传统的表单编码方式 <code>application/x-www-form-urlencoded</code> 存在局限：</p><ul><li>只能传输文本数据</li><li>会对二进制数据进行 URL 编码，导致文件体积膨胀 33%</li><li>无法高效传输大文件</li></ul><p>而 <code>multipart/form-data</code> 专为文件上传设计：</p><ul><li>原样传输二进制数据，无额外开销</li><li>可同时上传多个文件</li><li>支持混合文本字段和文件</li></ul><p><strong>在本项目中的应用场景</strong></p><p>QGC 需要将录制的 WAV 音频文件发送到后端服务器进行语音识别：</p><pre class=mermaid>sequenceDiagram
    participant Client as 客户端(QGC)
    participant Server as 服务端(后端API)
    
    Note over Client: 录制音频&lt;br/&gt;(内存中的WAV文件)
    
    Client-&gt;&gt;&#43;Server: POST multipart/form-data
    Note right of Client: 字段名: &#34;audio&#34;&lt;br/&gt;文件名: &#34;recording.wav&#34;&lt;br/&gt;内容类型: audio/wav&lt;br/&gt;二进制数据: [WAV bytes]
    
    Note over Server: 语音识别 &#43; 意图理解&lt;br/&gt;&#43; 命令执行
    
    Server--&gt;&gt;-Client: JSON响应
    Note left of Server: { &#34;result&#34;: &#34;执行结果&#34; }</pre><p><strong>选择 multipart/form-data 的原因</strong>：</p><ul><li>WAV 是二进制格式，必须保持原始字节不变</li><li>服务端可通过标准的文件上传处理库解析</li><li>符合 Web 标准，兼容性好</li><li>便于调试（可用 curl、Postman 等工具测试）</li></ul><p><strong>与其他格式的对比</strong></p><table><thead><tr><th>编码格式</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><code>application/x-www-form-urlencoded</code></td><td>简单文本表单</td><td>简单，历史悠久</td><td>不支持文件，二进制数据效率低</td></tr><tr><td><code>application/json</code></td><td>API 数据交换</td><td>结构清晰，易解析</td><td>二进制需 Base64 编码（+33%体积）</td></tr><tr><td><strong><code>multipart/form-data</code></strong></td><td><strong>文件上传</strong></td><td><strong>二进制高效，标准化</strong></td><td><strong>格式复杂，需手动构建</strong></td></tr><tr><td><code>application/octet-stream</code></td><td>纯二进制流</td><td>最简单</td><td>无元数据，无法传递文件名等信息</td></tr></tbody></table><h4 id=格式结构说明>格式结构说明</h4><p><strong>基本组成</strong>：</p><pre tabindex=0><code>请求头：
  Content-Type: multipart/form-data; boundary=&lt;边界标识符&gt;

请求体：
  --&lt;边界标识符&gt;                          ← 开始边界
  Content-Disposition: form-data; ...    ← 字段描述
  Content-Type: ...                      ← 内容类型
                                         ← 空行（重要！）
  [数据内容]                              ← 实际数据
  --&lt;边界标识符&gt;--                        ← 结束边界（多了两个横杠）
</code></pre><p><strong>关键概念</strong>：</p><ol><li><strong>Boundary（边界）</strong>：唯一标识符，不能出现在数据内容中</li><li><strong>CRLF（\r\n）</strong>：每行必须以 <code>\r\n</code> 结尾（HTTP 标准）</li><li><strong>Content-Disposition</strong>：描述字段名（name）和文件名（filename）</li><li><strong>Content-Type</strong>：指定数据的 MIME 类型</li></ol><h5 id=完整请求示例>完整请求示例</h5><pre tabindex=0><code>POST /api/v1/voice/command HTTP/1.1
Host: 127.0.0.1:8000
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary1234567890
Content-Length: 44132
Accept: application/json

------WebKitFormBoundary1234567890
Content-Disposition: form-data; name=&#34;audio&#34;; filename=&#34;recording_1234567890.wav&#34;
Content-Type: audio/wav

RIFF....WAVE....data[二进制音频数据]
------WebKitFormBoundary1234567890--
</code></pre><h5 id=构建步骤>构建步骤</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 1. 生成唯一boundary
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;----WebKitFormBoundary&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 2. 构建各个部分（所有部分都是Uint8Array）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>parts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>boundary</span><span style=color:#ce5c00;font-weight:700>:</span>     <span style=color:#4e9a06>&#34;--&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\r\n&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>disposition</span><span style=color:#ce5c00;font-weight:700>:</span>  <span style=color:#4e9a06>&#39;Content-Disposition: form-data; name=&#34;audio&#34;; filename=&#34;file.wav&#34;\r\n&#39;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>contentType</span><span style=color:#ce5c00;font-weight:700>:</span>  <span style=color:#4e9a06>&#34;Content-Type: audio/wav\r\n\r\n&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>audioData</span><span style=color:#ce5c00;font-weight:700>:</span>    <span style=color:#000;font-weight:700>[</span><span style=color:#000>WAV文件的二进制数据</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#000>crlf</span><span style=color:#ce5c00;font-weight:700>:</span>         <span style=color:#4e9a06>&#34;\r\n&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>closing</span><span style=color:#ce5c00;font-weight:700>:</span>      <span style=color:#4e9a06>&#34;--&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;--\r\n&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 3. 计算总大小
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>totalSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>boundary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disposition</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>contentType</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>crlf</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>closing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 4. 分配ArrayBuffer
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayBuffer</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>totalSize</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>view</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Uint8Array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 5. 按顺序复制
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>boundary</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>boundary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disposition</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disposition</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>contentType</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>contentType</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>crlf</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>crlf</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>closing</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 6. 发送
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=4-端到端语音链路>4. 端到端语音链路</h2><h3 id=41-后端整体角色与接口约束>4.1 后端整体角色与接口约束</h3><ul><li><strong>后端框架</strong>：基于一个现代的 Python Web 框架构建，对外提供 REST 风格 API。</li><li><strong>版本管理</strong>：所有接口统一挂载在一个版本前缀之下，例如 <code>/api/v1</code>，便于未来扩展与兼容。</li><li><strong>语音相关接口</strong>：<ul><li>语音转命令接口：<code>POST /api/v1/voice/command</code></li><li>语音转文字接口（测试语音）：<code>POST /api/v1/voice/transcribe</code></li></ul></li><li><strong>与 QGC 对接方式</strong>：<ul><li>QGC 前端通过 <code>multipart/form-data</code> 上传字段名为 <code>audio</code> 的音频文件。</li><li>后端返回 JSON 结构，主体字段为 <code>result</code> 或 <code>text</code> 等，用于承载执行结果或转写文字。</li></ul></li></ul><h3 id=42-后端分层结构>4.2 后端分层结构</h3><ul><li><p><strong>API 接口层</strong>：</p><ul><li>暴露 <code>/voice/command</code> 和 <code>/voice/transcribe</code> 等 HTTP 接口。</li><li>负责请求解析、基础校验、依赖注入以及异常到 HTTP 错误码的转换。</li></ul></li><li><p><strong>语音处理层</strong>：</p><ul><li>接收上传音频，完成格式和内容的基础检查（例如：文件是否为空、扩展名是否在允许列表中）。</li><li>将音频内容写入临时介质或缓冲区，以便后续语音识别模型使用。</li><li>调用本地语音识别模型（如 Whisper small@CPU，单例加载），得到转写文本。</li></ul></li><li><p><strong>智能体与无人机控制层</strong>：</p><ul><li>提供一个“无人机智能体”对象，对外暴露 <code>process(command_text, task_type)</code> 等高层方法。</li><li>内部持有一个“机队管理器”对象，用于实际下发飞行指令（如起飞、降落、绕圈、飞往航点等）。</li><li>通过外部大模型（LLM）完成自然语言到控制代码的转换，并在受控环境中执行。</li></ul></li><li><p><strong>配置与异常处理层</strong>：</p><ul><li>定义一组专门的异常类型（例如：音频为空、音频格式不支持、语音模型不可用、转写结果为空、智能体未初始化等），并由统一异常处理器转换为结构化 HTTP 响应。</li></ul></li></ul><h3 id=43-语音转命令接口逻辑流程>4.3 语音转命令接口：逻辑流程</h3><p>语音转命令接口的逻辑可以概括为以下步骤：</p><ol><li><p><strong>接收上传音频</strong></p><ul><li>使用一个通用的文件上传参数（例如 <code>audio_file</code>），通过 <code>multipart/form-data</code> 方式接收。</li><li>若文件名缺失或内容为空，抛出如 <code>EmptyAudioError</code> 之类的业务异常。</li></ul></li><li><p><strong>文件格式与内容校验</strong></p><ul><li>允许扩展名集合如：<code>{".wav", ".mp3", ".flac", ".m4a", ".ogg", ".webm", ".mpeg", ".mp4"}</code>。</li><li>若扩展名不在允许列表中，抛出如 <code>UnsupportedAudioFormatError</code> 异常，并在错误信息中提示支持的格式。</li><li>QGC 端推荐统一上传标准 WAV（PCM, 44100Hz, 16bit, 单声道），以简化链路和调试。</li></ul></li><li><p><strong>写入临时介质并调用语音模型</strong></p><ul><li>将上传的二进制内容写入一个临时路径或缓冲区，供语音识别模型使用。</li><li>通过类似 <code>get_speech_model()</code> 的单例函数获取语音识别模型实例：<ul><li>首次调用时完成模型加载，并捕获缺少依赖、加载失败等情况。</li><li>后续请求复用同一个模型实例，避免重复加载导致的性能问题。</li></ul></li><li>调用模型的 <code>transcribe(temp_audio)</code> 方法获得 <code>transcribed_text</code>。</li><li>无论成功与否，都在合适时机删除临时音频文件或释放缓冲区，避免磁盘/内存泄漏。</li><li>若 <code>transcribed_text</code> 为空，抛出如 <code>AudioTranscribeError</code> 的语义化异常。</li></ul></li><li><p><strong>调用智能体进行命令解释与执行</strong></p><ul><li>通过依赖注入或全局管理函数获取当前的“无人机智能体”实例（例如 <code>get_drone_agent()</code>）。</li><li>若智能体尚未正确初始化（例如机队管理器不可用等），直接返回指引用户检查环境的配置提示，而不是继续执行。</li><li>调用智能体的异步方法，例如：<ul><li><code>agent.process(transcribed_text, task_type="control")</code></li></ul></li><li>在 <code>task_type="control"</code> 场景下，智能体内部的大致逻辑为：<ol><li>读取当前机队状态，只允许对“已连接无人机”进行操作。</li><li>若无可用无人机，直接返回例如“未连接任何无人机”的错误文案，而不是尝试自行连接。</li><li>构造上游约束清晰的提示词，将用户自然语言命令、可用方法列表和安全限制一同输入 LLM。</li><li>从 LLM 返回中提取 Python 控制代码片段，在受限制的命名空间内执行，仅暴露受控的机队管理对象和必要的工具方法。</li><li>汇总“生成代码文本 + 实际执行结果”，拼接成一个富文本字符串，作为最终返回值。</li></ol></li></ul></li><li><p><strong>统一结果封装与返回</strong></p><ul><li>将智能体返回的字符串包装到统一的响应模型中，例如：<ul><li><code>{ "result": "&lt;带或不带 ANSI 颜色的执行结果文本>" }</code></li></ul></li><li>发生异常时，将内部异常转换为结构化 JSON 错误响应，包含至少：<ul><li>机器可读的错误类型（如 <code>"error_type": "empty_audio"</code>）</li><li>面向用户的错误提示（如 <code>"message": "音频文件为空，请重新录制后再试"</code>）</li></ul></li></ul></li></ol><h3 id=44-语音转文字接口测试接口>4.4 语音转文字接口（测试接口）</h3><p>除语音转命令外，后端还提供一个纯“语音转文字”能力，主要用于：</p><ul><li>调试语音识别链路（确认录音质量与模型表现）。</li><li>为其他上层应用提供字幕/转写服务。</li></ul><p>该接口的典型行为：</p><ol><li>与 <code>/voice/command</code> 相同方式接收 <code>multipart/form-data</code> 的音频文件。</li><li>复用相同的语音识别模型，将音频转写为文本。</li><li>返回结构化响应，例如：<ul><li><code>text</code>: 转写得到的文本内容。</li><li><code>language</code>: 语言标识（如 <code>"zh"</code>）。</li><li><code>duration</code>: 音频时长的字符串表示。</li><li><code>processing_time</code>: 服务端处理耗时的字符串表示。</li></ul></li></ol><h3 id=45-端到端时序总结后端视角>4.5 端到端时序总结（后端视角）</h3><p>结合前端章节中的整体时序图，从后端视角可以将关键步骤概括为：</p><ol><li><strong>接收请求</strong>：收到 <code>POST /api/v1/voice/command</code> 请求，Content-Type 为 <code>multipart/form-data</code>，字段名为 <code>audio</code>。</li><li><strong>基础校验</strong>：检查文件名、扩展名、内容长度，过滤掉明显无效请求。</li><li><strong>语音转写</strong>：将音频内容交给本地语音识别模型，得到自然语言 <code>transcribed_text</code>。</li><li><strong>智能体处理</strong>：调用无人机智能体的 <code>process()</code> 方法，由 LLM 生成受约束的控制代码并执行，严格遵守“只操作已连接无人机、不自行连接”的规则。</li><li><strong>结果封装</strong>：将执行结果封装成统一 JSON 响应返回前端，可包含 ANSI 颜色信息以便前端渲染。</li><li><strong>资源清理</strong>：确保临时音频文件和中间缓冲在成功或异常场景下均被正确清理，避免长期资源泄漏。</li></ol><h2 id=5-api-接口规范>5. API 接口规范</h2><h3 id=51-语音命令接口>5.1 语音命令接口</h3><h4 id=请求规范>请求规范</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>POST /api/v1/voice/command
</span></span><span style=display:flex><span>Content-Type: multipart/form-data; boundary=&lt;boundary&gt;
</span></span><span style=display:flex><span>Accept: application/json
</span></span></code></pre></div><p><strong>请求体（multipart格式）</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>------WebKitFormBoundary1234567890
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;audio&#34;; filename=&#34;recording_1234567890.wav&#34;
</span></span><span style=display:flex><span>Content-Type: audio/wav
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[WAV文件二进制数据]
</span></span><span style=display:flex><span>------WebKitFormBoundary1234567890--
</span></span></code></pre></div><p><strong>WAV文件格式要求</strong>：</p><ul><li>格式：PCM</li><li>采样率：44100 Hz</li><li>位深度：16 bit</li><li>声道数：1 (单声道)</li><li>文件格式：标准WAV (RIFF header)</li></ul><h4 id=响应规范>响应规范</h4><p><strong>成功响应（200 OK）</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;result&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;命令执行成功的详细信息&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>result字段</strong>可以包含：</p><ul><li>纯文本</li><li>带ANSI颜色代码的文本</li><li>多行文本（\n换行）</li></ul><p><strong>ANSI颜色代码示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>\033[32m成功\033[0m: 起飞命令已执行
</span></span><span style=display:flex><span>\033[33m警告\033[0m: 电池电量较低
</span></span><span style=display:flex><span>\033[31m错误\033[0m: GPS信号弱
</span></span></code></pre></div><h2 id=6-附录文件位置参考>6. 附录：文件位置参考</h2><h4 id=c文件>C++文件</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>src/QmlControls/AudioRecorderController.h       - 音频控制器头文件
</span></span><span style=display:flex><span>src/QmlControls/AudioRecorderController.cc      - 音频控制器实现
</span></span><span style=display:flex><span>src/Settings/BackendSettings.h                  - 后端设置头文件
</span></span><span style=display:flex><span>src/Settings/BackendSettings.cc                 - 后端设置实现
</span></span><span style=display:flex><span>src/QmlControls/QGroundControlQmlGlobal.cc      - QML类型注册
</span></span></code></pre></div><h4 id=json配置文件>JSON配置文件</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>src/Settings/Backend.SettingsGroup.json         - 后端设置配置
</span></span></code></pre></div><h4 id=qml文件>QML文件</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>src/QmlControls/BottomFlyViewToolBar.qml        - 底部工具栏（含语音交互）
</span></span><span style=display:flex><span>src/UI/MainWindow.qml                           - 主窗口状态管理
</span></span></code></pre></div><h4 id=构建配置>构建配置</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>src/QmlControls/CMakeLists.txt                  - 添加AudioRecorderController
</span></span></code></pre></div><hr><h2 id=参考文档>参考文档</h2><ul><li><a href=https://docs.qgroundcontrol.com/master/en/>QGroundControl 开发文档</a></li><li><a href=https://fastapi.tiangolo.com/>FastAPI 官方文档</a></li><li><a href=https://platform.openai.com/docs/api-reference>OpenAI GPT 模型 API 参考</a></li><li><a href=https://github.com/openai/whisper>Whisper 模型文档</a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Mail aria-label=Mail><a target=_blank rel=noopener href=/about/ aria-label=Mail><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Wechat aria-label=Wechat><a target=_blank rel=noopener href=/about/ aria-label=Wechat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=QQ aria-label=QQ><a target=_blank rel=noopener href=/about/ aria-label=QQ><i class="fab fa-qq"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Wallhaven aria-label=Wallhaven><a target=_blank rel=noopener href=https://wallhaven.cc/user/Zero-kq/favorites/1954116 aria-label=Wallhaven><i class="fa fa-image"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Docsy & Template" aria-label="Docsy & Template"><a target=_blank rel=noopener href=https://github.com/google/docsy aria-label="Docsy & Template"><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Docsy Authors | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=https://policies.google.com/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/docsy/js/main.min.b540f305b126afbbf8653419bb091d1c388e5adc77b849e8a878766c4de19b67.js integrity="sha256-tUDzBbEmr7v4ZTQZuwkdHDiOWtx3uEnoqHh2bE3hm2c=" crossorigin=anonymous></script><script defer src=/docsy/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/docsy/js/tabpane-persist.js></script></body></html>