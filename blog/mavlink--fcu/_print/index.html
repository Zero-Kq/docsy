<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://Zero-Kq.github.io/docsy/blog/mavlink--fcu/><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/docsy/favicons/favicon.ico><link rel=apple-touch-icon href=/docsy/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/docsy/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/docsy/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/docsy/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/docsy/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/docsy/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/docsy/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/docsy/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/docsy/favicons/android-192x192.png sizes=192x192><title>MAVLink & FCU | Zerokq</title>
<meta name=description content="涵盖 MAVLink 通信协议、飞控系统（PX4/ArduPilot）集成、任务规划、日志分析与数据融合的完整技术文档集合。"><meta property="og:url" content="https://Zero-Kq.github.io/docsy/blog/mavlink--fcu/"><meta property="og:site_name" content="Zerokq"><meta property="og:title" content="MAVLink & FCU"><meta property="og:description" content="涵盖 MAVLink 通信协议、飞控系统（PX4/ArduPilot）集成、任务规划、日志分析与数据融合的完整技术文档集合。"><meta property="og:locale" content="cn"><meta property="og:type" content="website"><meta itemprop=name content="MAVLink & FCU"><meta itemprop=description content="涵盖 MAVLink 通信协议、飞控系统（PX4/ArduPilot）集成、任务规划、日志分析与数据融合的完整技术文档集合。"><meta itemprop=datePublished content="2026-02-25T15:18:48+08:00"><meta itemprop=dateModified content="2026-02-25T15:18:48+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="MAVLink & FCU"><meta name=twitter:description content="涵盖 MAVLink 通信协议、飞控系统（PX4/ArduPilot）集成、任务规划、日志分析与数据融合的完整技术文档集合。"><link rel=preload href=/docsy/scss/main.min.b3c5d5b5e4fe744101b7961318bcd54d586465cd4abf620f17de0fb0b88e151b.css as=style integrity="sha256-s8XVteT+dEEBt5YTGLzVTVhkZc1Kv2IPF94PsLiOFRs=" crossorigin=anonymous><link href=/docsy/scss/main.min.b3c5d5b5e4fe744101b7961318bcd54d586465cd4abf620f17de0fb0b88e151b.css rel=stylesheet integrity="sha256-s8XVteT+dEEBt5YTGLzVTVhkZc1Kv2IPF94PsLiOFRs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class="td-section td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/docsy/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 640 640"><path d="M304 70.1C313.1 61.9 326.9 61.9 336 70.1l232 208C577.9 286.9 578.7 302.1 569.8 312 560.9 321.9 545.8 322.7 535.9 313.8L527.9 306.6V511.9c0 35.3000000000001-28.7 64-64 64h-288c-35.3.0-64-28.6999999999999-64-64V306.6L103.9 313.8C94 322.6 78.9 321.8 70 312 61.1 302.2 62 287 71.8 278.1L304 70.1zm16 50.1L160 263.7V512C160 520.8 167.2 528 176 528h48V424c0-39.8 32.2-72 72-72h48c39.8.0 72 32.2 72 72V528h48C472.8 528 480 520.8 480 512V263.7L320 120.3zM272 528h96V424c0-13.3-10.7-24-24-24H296c-13.3.0-24 10.7-24 24V528z"/></svg></span><span class=navbar-brand__name>Zerokq</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docsy/about/><span>关于</span></a></li><li class=nav-item><a class=nav-link href=/docsy/docs/><span>说明</span></a></li><li class=nav-item><a class="nav-link active" href=/docsy/blog/><span>博客</span></a></li><li class=nav-item><a class=nav-link href=/docsy/reviews/><span>读后感</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>中文(Chinese)</a><ul class=dropdown-menu><li><a class=dropdown-item href=/docsy/en/>English</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=搜索 aria-label=搜索 autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>打印此章节
<a href=# onclick="return print(),!1">点击打印</a>.</p><p><a href=/docsy/blog/mavlink--fcu/>显示常规版本</a>.</p></div><h1 class=title>MAVLink & FCU</h1><div class=lead>涵盖 MAVLink 通信协议、飞控系统（PX4/ArduPilot）集成、任务规划、日志分析与数据融合的完整技术文档集合。</div><ul><li><a href=#pg-4010b2b77ec412a172db286a74e7b2f0>MAVLink Router-安装与使用指南</a></li><li><a href=#pg-93b3177b7b7bc359543ba8e7c06ae164>WSL2 环境下 PX4 SITL 多端口 MAVLink 配置指南</a></li><li><a href=#pg-a26aeb1ebf869f43614b7983b58097c1>使用 pyulog 分析 PX4 飞控日志</a></li><li><a href=#pg-1d064c41083fdc82cfa08c6cf55c4fb0>基于 Pymavlink 的任务规划实现</a></li><li><a href=#pg-5850a7c933d4b43e7d209d56a7d23f90>基于 VRPN 的 PX4 EKF2 视觉融合基础调试指南</a></li><li><a href=#pg-31c03dd6417fab4ded284383657807b4>MAVROS 与 MAVProxy：APM 平台上的使用场景、差异与取舍</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-4010b2b77ec412a172db286a74e7b2f0>MAVLink Router-安装与使用指南</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><h2 id=1-概述>1. 概述</h2><p>MAVLink Router 是一个用于路由 MAVLink 消息的工具，可以在不同的端点（UART、UDP、TCP）之间转发 MAVLink 数据包。在某些 Ubuntu 版本（如 Ubuntu 20.04 Focal）中，可能无法通过 <code>apt</code> 直接安装 <code>mavlink-router</code> 包，此时需要从源码编译安装。</p><h2 id=2-为什么使用-mavlink-router>2. 为什么使用 MAVLink Router</h2><h3 id=21-优势>2.1 优势</h3><p>MAVLink Router 解决了无人机系统中多个应用同时访问飞控的问题，优势包括：</p><p><strong>多应用并行访问</strong></p><p>在无人机系统中，通常需要多个应用同时与飞控通信：</p><ul><li><strong>地面站软件</strong>（如 QGroundControl）需要实时显示飞行状态</li><li><strong>任务规划工具</strong>（如 pymavlink / MAVSDK-Python）需要发送航点任务</li><li><strong>数据记录工具</strong>需要记录飞行数据</li><li><strong>自定义应用</strong>需要执行特定功能</li></ul><p>由于串口或单一网络连接通常只能被一个应用独占，MAVLink Router 可以将一个物理连接（如串口）转换为多个网络端点，让多个应用同时访问飞控数据。</p><blockquote><p><strong>注意</strong>：QGroundControl 的 MAVLink 转发功能可以实现从飞控接收数据，但无法向飞控发送数据，会提示超时错误。如果需要双向通信（如发送航点任务、参数设置等），必须使用 MAVLink Router、MAVProxy 或其他支持双向转发的工具。</p></blockquote><p><strong>协议转换与桥接</strong></p><p>MAVLink Router 支持在不同传输介质之间桥接：</p><ul><li><strong>UART ↔ UDP/TCP</strong>：将串口数据转换为网络数据，方便远程访问</li><li><strong>UDP ↔ TCP</strong>：在不同网络协议之间转换</li><li><strong>多端点分发</strong>：将一条数据流分发到多个目标</li></ul><p><strong>消息路由与过滤</strong></p><ul><li><strong>智能路由</strong>：根据系统 ID 和组件 ID 智能路由消息，避免消息循环</li><li><strong>消息过滤</strong>：可以过滤特定类型的消息，减少网络负载</li><li><strong>消息去重</strong>：自动去除重复消息，提高效率</li></ul><p><strong>灵活的网络配置</strong></p><ul><li>支持 IPv4 和 IPv6</li><li>支持单播、多播和广播</li><li>支持客户端和服务器模式</li><li>自动检测链路本地地址</li></ul><h3 id=22-典型部署场景>2.2 典型部署场景</h3><p>MAVLink Router 在实际应用中有多种部署方式，可以根据具体需求选择机载部署或地面站部署。以下是一个综合的典型部署架构：</p><pre class=mermaid>graph TB
    FC[飞控&lt;br/&gt;PX4/ArduPilot] --&gt;|UART&lt;br/&gt;/dev/ttyACM0| MR[MAVLink Router]
    
    subgraph CC[&#34;机载计算机&#34;]
        MR --&gt;|UDP:14550| QGC[QGroundControl&lt;br/&gt;地面站]
        MR --&gt;|UDP:14540| MP[任务规划工具&lt;br/&gt;pymavlink / MAVSDK-Python]
        MR --&gt;|UDP:14560| MAVROS[MAVROS&lt;br/&gt;ROS/ROS2 节点]
        MR --&gt;|TCP:5760| REMOTE[其他应用&lt;br/&gt;可选]
        
        MAVROS --&gt; APP1[ROS/ROS2 节点]
        MP --&gt; APP2[Python 脚本]
        REMOTE --&gt; APP3[数据记录工具]
    end
    
    
    style FC fill:#e1f5ff
    style CC fill:#fff4e1,stroke:#ff9800,stroke-width:3px
    style MR fill:#e8f5e9
    style QGC fill:#f3e5f5
    style MAVROS fill:#f3e5f5
    style MP fill:#f3e5f5</pre><p><strong>飞控连接（UART）</strong></p><p>飞控通过 UART（如 <code>/dev/ttyACM0</code>）连接到机载计算机，波特率通常为 1500000（1.5Mbps）或 921600。需要确保串口权限正确配置（将用户加入 <code>dialout</code> 组）。一个串口只能被一个 MAVLink Router 实例使用。如果需要在机载计算机和地面站同时访问，需要在机载计算机上部署 MAVLink Router。串口连接延迟低，适合实时控制应用。</p><p><strong>QGroundControl 连接（UDP:14550）</strong></p><p>QGroundControl 通过 UDP:14550 连接到 MAVLink Router，可以在同一网络内或通过 WiFi/4G 远程连接。QGroundControl 主要用于实时监控飞行状态，接收飞控数据。如果需要发送航点任务，建议使用 pymavlink 或 MAVSDK-Python（通过其他端口）。</p><blockquote><p><strong>注意</strong>：QGroundControl 的 MAVLink 转发功能只能接收数据，无法发送数据，会提示超时错误。如果需要双向通信（如发送航点任务、参数设置等），必须使用 MAVLink Router、MAVProxy 或其他支持双向转发的工具。</p></blockquote><p><strong>任务规划工具连接（UDP:14540）</strong></p><p>pymavlink 或 MAVSDK-Python 通过 UDP:14540 连接到 MAVLink Router，支持双向通信，可以发送航点任务、参数设置等。注意：一个 UDP 端口通常只能被一个应用独占接收使用。如果需要多个应用并行，为每个应用分配不同端口（如 14540、14550、14600）。pymavlink 和 MAVSDK-Python 可以同时使用，但需要连接不同的端口。</p><p><strong>配置示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># MAVLink Router 配置</span>
</span></span><span style=display:flex><span>mavlink-routerd /dev/ttyACM0:1500000 -e 127.0.0.1:14540 -e 127.0.0.1:14550
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pymavlink 连接</span>
</span></span><span style=display:flex><span><span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> mavutil.mavlink_connection<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;udp:127.0.0.1:14540&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># MAVSDK-Python 连接</span>
</span></span><span style=display:flex><span><span style=color:#000>drone</span> <span style=color:#ce5c00;font-weight:700>=</span> System<span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>await drone.connect<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>system_address</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;udp://:14550&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p><strong>MAVROS 连接（UDP:14560）</strong></p><p>MAVROS 通过 UDP:14560 连接到 MAVLink Router。MAVROS 是 ROS/ROS2 与 MAVLink 协议之间的桥接节点。配置方式如下：</p><ol><li>MAVLink Router 配置：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mavlink-routerd /dev/ttyACM0:1500000 -e 127.0.0.1:14560
</span></span></code></pre></div><ol start=2><li>MAVROS 启动（使用命令行参数）：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ros2 launch mavros px4.launch fcu_url:<span style=color:#ce5c00;font-weight:700>=</span>udp://:14560@127.0.0.1:14560
</span></span></code></pre></div><p>如果使用 TCP 连接（MAVLink Router 默认监听 TCP:5760），可以使用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ros2 launch mavros px4.launch fcu_url:<span style=color:#ce5c00;font-weight:700>=</span>tcp://127.0.0.1:5760
</span></span></code></pre></div><p><code>127.0.0.1:14560</code> 配置说明：该配置开放给本地的 MAVROS 使用。当外部连接到伴随计算机的 14560 端口时，MAVLink Router 会自动转发 MAVLink 消息到飞控，实现通过 MAVROS 对飞控的直接操作。这样既支持本地 MAVROS 节点访问，也支持远程通过该端口连接并控制飞控。</p><p><strong>使用场景</strong>：</p><ul><li>ROS/ROS2 节点通信：通过 MAVROS 发布/订阅飞控话题</li><li>传感器融合：将机载传感器数据与飞控数据融合</li><li>自主导航：ROS 导航栈通过 MAVROS 控制无人机</li><li>视觉处理：视觉 SLAM 节点获取位置信息并发送控制指令</li></ul><p><strong>注意事项</strong>：</p><ul><li>MAVROS 需要独占一个 UDP 端口</li><li>可以同时运行多个 ROS 节点共享飞控数据</li><li>与 ROS 生态系统无缝集成，支持标准的 ROS 话题和服务接口</li></ul><p><strong>其他应用连接（TCP:5760）</strong></p><p>TCP 服务器默认启用，监听端口 5760，支持多个 TCP 客户端同时连接。TCP 连接比 UDP 更可靠，但延迟略高，适合数据记录、远程监控等对可靠性要求高的应用。可以动态连接和断开，不影响其他端点。</p><h2 id=3-安装方式选择>3. 安装方式选择</h2><h3 id=31-使用包管理器安装>3.1 使用包管理器安装</h3><p>在支持的 Ubuntu 版本中，可以直接使用包管理器安装：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install mavlink-router
</span></span></code></pre></div><h3 id=32-从源码编译安装>3.2 从源码编译安装</h3><p>如果在 Ubuntu Focal 等版本中遇到以下错误：</p><pre style=color:red><code>E: Unable to locate package mavlink-router</code></pre><p>则需要从源码编译安装。</p><h2 id=4-从源码编译安装>4. 从源码编译安装</h2><h3 id=41-安装依赖>4.1 安装依赖</h3><p>首先安装编译所需的依赖包：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install git meson ninja-build pkg-config gcc g++ systemd
</span></span></code></pre></div><h3 id=42-克隆源码>4.2 克隆源码</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/mavlink-router/mavlink-router.git
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> mavlink-router
</span></span><span style=display:flex><span>git submodule update --init --recursive
</span></span></code></pre></div><h3 id=43-检查并安装-meson>4.3 检查并安装 Meson</h3><p>检查 Meson 版本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>meson --version
</span></span></code></pre></div><p>如果版本低于 0.55，需要升级：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip3 install <span style=color:#000>meson</span><span style=color:#ce5c00;font-weight:700>==</span>0.55
</span></span></code></pre></div><h3 id=44-编译和安装>4.4 编译和安装</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>meson setup build . <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ninja -C build
</span></span><span style=display:flex><span>sudo ninja -C build install
</span></span></code></pre></div><h2 id=5-验证安装>5. 验证安装</h2><h3 id=51-验证安装成功>5.1 验证安装成功</h3><p>安装完成后，可以通过以下命令验证 MAVLink Router 是否安装成功：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mavlink-routerd --help
</span></span></code></pre></div><p>如果能够正常显示帮助信息，说明安装成功。</p><h3 id=52-配置串口权限---将用户加入-dialout-组>5.2 配置串口权限 - 将用户加入 dialout 组</h3><p>在使用 MAVLink Router 连接飞控串口之前，需要配置串口权限。</p><p>Linux 下所有串口 <code>/dev/ttyACM*</code>，<code>/dev/ttyUSB*</code> 默认属于 <code>dialout</code> 组。将用户加入该组可以一次性解决所有串口权限问题：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo usermod -a -G dialout <span style=color:#000>$USER</span>
</span></span></code></pre></div><p><strong>重要</strong>：执行上述命令后，必须重启或重新登录系统才能生效：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>reboot
</span></span></code></pre></div><p>重启后检查权限：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ls -l /dev/ttyACM0
</span></span></code></pre></div><p>应该能看到类似输出：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>crw-rw---- 1 root dialout ...
</span></span></code></pre></div><p>此时用户已经在 <code>dialout</code> 组里，MAVLink Router 就能访问串口了。</p><h2 id=6-命令行使用方法>6. 命令行使用方法</h2><h3 id=61-参数说明>6.1 参数说明</h3><ul><li>TCP 服务器默认启用（监听端口 5760）</li><li>TCP 和 UDP 端点可以多次添加</li><li>使用 <code>-e</code> 选项添加的 UDP 端点以普通模式启动（发送数据到指定地址和端口）</li><li>最后一个参数（无键值）可以是 UART 设备或 UDP 连接，UDP 端点将以服务器模式启动（等待传入连接）</li></ul><h3 id=62-使用示例>6.2 使用示例</h3><h4 id=从-uart-路由到-udp>从 UART 路由到 UDP</h4><p>将 MAVLink 数据包从 UART <code>ttyS1</code> 路由到 2 个 UDP 端点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mavlink-routerd -e 192.168.7.1:14550 -e 127.0.0.1:14550 /dev/ttyS1:1500000
</span></span></code></pre></div><p>其中 <code>1500000</code> 是 UART 波特率。</p><h4 id=从-udp-路由到-udp>从 UDP 路由到 UDP</h4><p>也可以从传入的 UDP 连接路由 MAVLink 数据包：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mavlink-routerd -e 192.168.7.1:14550 -e 127.0.0.1:14550 0.0.0.0:24550
</span></span></code></pre></div><h4 id=ipv6-地址格式>IPv6 地址格式</h4><p>IPv6 地址必须用方括号括起来，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mavlink-routerd -e <span style=color:#ce5c00;font-weight:700>[</span>::1<span style=color:#ce5c00;font-weight:700>]</span>:14550 /dev/ttyS1:1500000
</span></span></code></pre></div><p>单播和多播地址都能正确处理，链路本地地址的接口会自动检测。</p><h2 id=7-详细说明>7. 详细说明</h2><h3 id=71-端点类型>7.1 端点类型</h3><p>MAVLink Router 支持三种基本端点类型：UART, UDP 链接和 TCP 客户端。此外，它还可以作为 TCP 服务器为动态客户端提供服务（除非明确禁用）。</p><h4 id=711-uart>7.1.1 UART</h4><ul><li><strong>用途</strong>：用于遥测无线电或其他串行链接</li><li><strong>配置</strong>：UART 设备路径/名称和波特率</li><li><strong>行为</strong>：无需等待传入数据即可接收和发送数据</li></ul><h4 id=712-udp>7.1.2 UDP</h4><ul><li><strong>配置</strong>：模式（客户端或服务器）、IP 地址和端口</li><li><strong>客户端模式行为</strong>：端点配置有目标 IP 和端口组合。启动后可以直接发送 MAVLink 消息，但只有在远程端发送第一条消息后才会接收数据（否则远程端不知道我们的 IP 和端口）</li><li><strong>服务器模式行为</strong>：端点配置有监听端口和 IP 地址。启动后可以直接接收消息，但只有在收到第一条消息后才能发送消息（否则不知道远程 IP 和端口）。MAVLink 消息总是发送到最后一条传入消息的 IP 和端口</li></ul><h4 id=713-tcp-客户端>7.1.3 TCP 客户端</h4><ul><li><strong>配置</strong>：目标 IP 地址和端口，断开连接时的重连间隔</li><li><strong>行为</strong>：TCP 会话建立后立即接收和发送数据</li></ul><h3 id=72-端点定义>7.2 端点定义</h3><p>端点通过以下方式创建：</p><ol><li>在配置文件中定义端点</li><li>通过相应的命令行选项定义端点</li><li>TCP 客户端连接到 TCP 服务器端口</li></ol><p>端点在以下情况下被销毁：</p><ol><li>TCP 客户端从 TCP 服务器端口断开连接</li><li>MAVLink Router 终止</li></ol><p>（这意味着 UART、UDP 和 TCP 客户端端点在运行期间永远不会被销毁）</p><h3 id=73-消息路由>7.3 消息路由</h3><h4 id=731-基本路由规则>7.3.1 基本路由规则</h4><p>一般来说，在一个端点上接收的每条消息都会被传递到所有已看到该目标系统/组件的端点。如果是广播消息，则传递到所有端点。消息永远不会发送回它来源的同一端点。</p><h4 id=732-详细路由规则>7.3.2 详细路由规则</h4><ol><li>每个端点会记住在其整个生命周期内从哪些系统（系统 ID 和组件 ID）接收过消息</li><li>在一个端点上接收的消息会被提供给除接收端点外的所有端点。端点将：<ul><li>如果消息的发送者地址在此端点的已连接系统列表中，则拒绝该消息（防止消息循环）</li><li>根据出站消息过滤器拒绝消息（如果启用）</li><li>如果消息的目标是此端点已连接系统列表中的任何系统，则接受该消息。广播规则在检查目标是否可通过此端点到达时适用。没有目标地址的消息视为广播</li><li>如果已连接系统列表为空，则只发送系统 ID 广播消息，不发送组件 ID 广播（因为目标系统未知是否可通过此端点到达）</li><li>拒绝所有其他消息</li></ul></li></ol><h3 id=74-消息过滤>7.4 消息过滤</h3><p>在每个端点上有两个位置可以过滤消息：</p><ul><li><strong>In（入站）</strong>：在此端点上从外部接收的消息在路由到其他端点之前，根据相应的过滤规则被丢弃或允许</li><li><strong>Out（出站）</strong>：在传输之前，根据端点的过滤规则丢弃或允许消息。这是在内部路由之后（见上面的<code>路由规则</code>章节）</li></ul><p>消息过滤器可以基于以下消息标识符之一：</p><ul><li><strong>MsgId</strong>：基于 MAVLink 消息 ID（如 HEARTBEAT）过滤消息</li><li><strong>SrcSys</strong>：基于 MAVLink 源系统 ID 过滤消息</li><li><strong>SrcComp</strong>：基于 MAVLink 源组件 ID 过滤消息</li></ul><p>消息过滤器可以是阻止列表或允许列表：</p><ul><li><strong>Block（阻止）</strong>：丢弃所有匹配相应标识符的消息（允许所有其他消息）</li><li><strong>Allow（允许）</strong>：允许所有匹配相应标识符的消息（丢弃所有其他消息）</li></ul><p>注意：在同一标识符上同时使用 <code>Allow</code> 和 <code>Block</code> 过滤器没有意义，但在不同标识符上使用它们可能很有用（例如，只允许特定的出站系统 ID，并阻止该系统发送一些不需要的消息 ID）。</p><h3 id=75-消息去重>7.5 消息去重</h3><p>如果启用，每条传入消息都会被检查，是否在过去 <code>DeduplicationPeriod</code> 毫秒内已经收到过另一个副本。如果已知，消息将被丢弃，就像从未收到过一样，该消息的超时计数器将被重置。消息通过包括其标头在内的完整 MAVLink 消息的 <code>std::hash</code> 值进行标识。</p><p>只要在配置的周期内没有收到具有完全相同标头序列号和内容的消息，一切正常。最关键的消息是心跳，因为它主要包含静态数据。因此，周期短于最快静态消息的更新周期在任何情况下都可以（对于 1 Hz 心跳，小于 1000 毫秒）。</p><h3 id=76-端点组>7.6 端点组</h3><p>可以将多个端点配置为在同一端点组中。同一组中的端点将共享相同的已连接系统列表。</p><p>当使用两个（或更多）并行数据链路时（例如 LTE 和遥测无线电），端点必须在两侧都分组。否则，由于路由规则 1，一个链路将不再被使用。</p><h3 id=77-消息嗅探>7.7 消息嗅探</h3><p>可以通过设置 <code>SnifferSysID</code> 来定义嗅探器。这将把所有流量转发到连接了此 MAVLink 系统 ID 的端点。这可用于记录或查看流经 mavlink-router 的所有消息。</p><hr><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/mavlink-router/mavlink-router>MAVLink Router GitHub 仓库</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-93b3177b7b7bc359543ba8e7c06ae164>WSL2 环境下 PX4 SITL 多端口 MAVLink 配置指南</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><h2 id=1-概述>1. 概述</h2><p>本文档介绍在 WSL2 环境下配置 PX4 1.16.0 stable 版本与 AirSim 1.8.1 进行软件在环（SITL）仿真时，如何通过修改 <code>rcS</code> 启动脚本实现自动开启多个 MAVLink 端口，解决多个设备（如 QGroundControl, MAVROS, MAVSDK 等）同时连接飞控的问题。</p><h2 id=2-环境准备>2. 环境准备</h2><h3 id=21-系统要求>2.1 系统要求</h3><ul><li><strong>操作系统</strong>：Windows 10/11 with WSL2</li><li><strong>WSL2 发行版</strong>：Ubuntu 20.04 或更高版本</li><li><strong>PX4 版本</strong>：1.16.0 stable</li><li><strong>AirSim 版本</strong>：1.8.1</li><li><strong>PX4 源码路径</strong>：<code>C:\Users\Administrator\PX4\PX4-Autopilot</code></li></ul><h2 id=3-自动端口开放配置>3. 自动端口开放配置</h2><h3 id=31-问题背景>3.1 问题背景</h3><p>在 AirSim 的 SITL 文档中，开启 PX4 SITL 的命令为 <code>make px4_sitl_default none_iris</code>。在此模式下，PX4 默认绑定的地址（如 UDP 14550/14580 或 TCP 4560 等）<strong>仅能同时接受一个连接</strong>。</p><p>当需要使用多个设备（如 QGroundControl, MAVSDK, MAVROS 等）同时连接 SITL 飞控时，需要在 PX4 命令行中手动执行开启端口的命令（如 <code>mavlink start -u 14550 -o 14550</code> 等）才能打开另一个端口。</p><p>经测试，<strong>可能因 WSL2 的网络配置特殊性</strong>，在 WSL2 上同时部署 <strong>MAVLink Router</strong> 或 <strong>MAVProxy</strong> 均不能实现在真实的机载计算机上实现的串口/端口路由功能。当需要使用多个设备连接 SITL 飞控时，每次启动飞控就需要手动开启多个端口，特别麻烦。</p><h3 id=32-修改-rcs-启动脚本实现自动开启多个端口>3.2 修改 rcS 启动脚本实现自动开启多个端口</h3><p>通过在 PX4 的启动脚本 <code>rcS</code> 中添加 <code>mavlink start</code> 命令，可以在每次编译和启动时自动开启多个 MAVLink 端口，实现多个设备同时连接。这在需要同步进行可视化或多智能体控制无人机的仿真场景下十分有用。如果某个设备只需要收到 <code>MAVLink</code> 数据，而无需发出控制命令到飞控，则仅需通过 <code>QGroundControl</code> 的 MAVLink 转发或其他方式转发即可。</p><p><strong>文件路径</strong>：<code>C:\Users\Administrator\PX4\PX4-Autopilot\ROMFS\px4fmu_common\init.d-posix\rcS</code></p><p>在 <code>rcS</code> 文件中添加以下内容（建议在文件末尾，MAVLink 相关配置部分之后添加）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 开启额外的 MAVLink UDP 端口</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 端口 14550：用于 QGroundControl 地面站连接</span>
</span></span><span style=display:flex><span>mavlink start -u <span style=color:#0000cf;font-weight:700>14550</span> -o <span style=color:#0000cf;font-weight:700>14550</span> -t 192.168.31.88 -r <span style=color:#0000cf;font-weight:700>1000000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 端口 14560：用于 MAVROS 连接</span>
</span></span><span style=display:flex><span>mavlink start -u <span style=color:#0000cf;font-weight:700>14560</span> -o <span style=color:#0000cf;font-weight:700>14560</span> -t 192.168.31.77 -r <span style=color:#0000cf;font-weight:700>1000000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 端口 14540：用于 MAVSDK-Python 或其他应用连接</span>
</span></span><span style=display:flex><span>mavlink start -u <span style=color:#0000cf;font-weight:700>14540</span> -o <span style=color:#0000cf;font-weight:700>14540</span> -t 192.168.31.66 -r <span style=color:#0000cf;font-weight:700>1000000</span>
</span></span></code></pre></div><p><strong>命令参数说明</strong>：</p><ul><li><code>-u &lt;端口></code>：指定本地 UDP 端口，PX4 在此端口上监听和发送数据</li><li><code>-o &lt;端口></code>：指定远程 UDP 端口（通常与本地端口相同）</li><li><code>-t &lt;IP地址></code>：指定伙伴 IP 地址（可选，用于指定数据发送的目标 IP）。使用此参数可以将 MAVLink 数据直接发送到指定 IP 地址的设备，实现与多个不同设备的定向连接</li><li><code>-r &lt;速率></code>：设置最大发送数据速率（字节/秒），<code>1000000</code> 表示 1MB/s</li></ul><h3 id=33-验证端口开启状态>3.3 验证端口开启状态</h3><p>启动 PX4 SITL 后，可以通过以下方式验证端口是否成功开启：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在 PX4 SITL 的命令行中执行</span>
</span></span><span style=display:flex><span>mavlink status
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或使用 netstat 检查端口监听状态</span>
</span></span><span style=display:flex><span>netstat -an <span style=color:#000;font-weight:700>|</span> grep -E <span style=color:#4e9a06>&#34;14540|14550|14560&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或使用 ss 命令（Linux）</span>
</span></span><span style=display:flex><span>ss -ulnp <span style=color:#000;font-weight:700>|</span> grep -E <span style=color:#4e9a06>&#34;14540|14550|14560&#34;</span>
</span></span></code></pre></div><p>如果配置正确，应该能看到多个 UDP 端口处于监听状态，不同的应用可以连接到不同的端口，实现同时访问飞控。</p><hr><h2 id=参考文档>参考文档</h2><ul><li><a href=https://docs.px4.io/main/en/simulation/>PX4 官方文档 - SITL 仿真</a></li><li><a href=https://microsoft.github.io/AirSim/>AirSim 官方文档</a></li><li><a href=https://docs.microsoft.com/zh-cn/windows/wsl/networking>WSL2 网络配置指南</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a26aeb1ebf869f43614b7983b58097c1>使用 pyulog 分析 PX4 飞控日志</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><p>本文档以实际案例 <code>log_284_2025-11-25-01-15-04.ulg</code> 为例，系统介绍如何使用 Python 的 <code>pyulog</code> 库分析 PX4 飞控生成的 ULog 格式日志文件，通过提取关键数据并生成可视化图表来诊断飞行过程中的潜在问题。</p><p>本案例展示了系统性的日志分析流程：从数据探索（识别关键主题）→ 数据提取与预处理 → 理解数据意义 → 可视化分析（生成专业图表）→ 问题诊断（建立因果链条）→ 解决方案（问题排查清单）。这种方法具有系统性、可复现性和实用性，适用于各种飞行日志分析场景，能够帮助开发者快速定位和解决飞行过程中的问题，提升飞行器的安全性和性能。</p><p>你可以从以下链接下载该日志文件进行实践：</p><ul><li><a href=/Docsy/files/log_284_2025-11-25-01-15-04.ulg>log_284_2025-11-25-01-15-04.ulg</a></li></ul><h2 id=1-从-ulog-中提取有效的数据条目>1. 从 ULog 中提取有效的数据条目</h2><p>ULog 是 PX4 飞控系统采用的二进制日志格式，记录了飞行过程中的传感器数据、系统状态、控制指令等丰富信息。要解析 ULog 文件，需要使用 <code>pyulog</code> 库。</p><h3 id=11-安装-pyulog>1.1 安装 pyulog</h3><p>首先，确保已安装 Python 环境（推荐 Python 3.7+），然后使用 pip 安装 <code>pyulog</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install pyulog
</span></span></code></pre></div><p>同时，为了进行数据分析和可视化，还需要安装以下依赖：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install numpy matplotlib pandas
</span></span></code></pre></div><h3 id=12-读取-ulog-文件>1.2 读取 ULog 文件</h3><p>使用 <code>pyulog</code> 读取 ULog 文件的基本方法：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>pyulog</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>ULog</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 读取 ULog 文件（使用实际案例日志）</span>
</span></span><span style=display:flex><span><span style=color:#000>ulog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ULog</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;log_284_2025-11-25-01-15-04.ulg&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 获取所有消息名称（uORB 主题）</span>
</span></span><span style=display:flex><span><span style=color:#000>message_names</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ulog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_message_names</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;日志中包含的消息类型: </span><span style=color:#4e9a06>{</span><span style=color:#000>message_names</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h3 id=13-解析日志>1.3 解析日志</h3><p>在实际分析中，我们首先需要了解日志中包含哪些主题，然后根据分析目标识别关键主题。以下脚本可以帮助我们系统地探索日志内容：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>pyulog</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>ULog</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sys</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 读取日志文件</span>
</span></span><span style=display:flex><span><span style=color:#000>ulog_file</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;log_284_2025-11-25-01-15-04.ulg&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>ulog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ULog</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ulog_file</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 获取所有消息名称</span>
</span></span><span style=display:flex><span><span style=color:#000>message_names</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>dataset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>dataset</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>ulog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data_list</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;日志文件: </span><span style=color:#4e9a06>{</span><span style=color:#000>ulog_file</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;总共包含 </span><span style=color:#4e9a06>{</span><span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message_names</span><span style=color:#000;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> 个主题</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;=&#34;</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>80</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;所有主题列表:&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;=&#34;</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>80</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 按类别分类主题</span>
</span></span><span style=display:flex><span><span style=color:#000>categories</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;飞行状态&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;vehicle_status&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;commander_state&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;vehicle_control_mode&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;姿态控制&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;vehicle_attitude&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;vehicle_attitude_setpoint&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;vehicle_rates_setpoint&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;位置导航&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;vehicle_local_position&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;vehicle_global_position&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;vehicle_gps_position&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;EKF2 融合&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;estimator_local_position&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;estimator_status&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;estimator_innovations&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;传感器数据&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;sensor_combined&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;sensor_accel&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;sensor_gyro&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;sensor_mag&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;电机/舵机&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;actuator_outputs&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;actuator_controls&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;外部定位&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;vehicle_vision_position&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;vehicle_odometry&#39;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;其他&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 分类显示</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>category</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>keywords</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>categories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>items</span><span style=color:#000;font-weight:700>():</span>
</span></span><span style=display:flex><span>    <span style=color:#000>matched</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>sorted</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message_names</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>any</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>keyword</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>keyword</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>keywords</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>            <span style=color:#000>matched</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>elif</span> <span style=color:#000>category</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;其他&#39;</span> <span style=color:#204a87;font-weight:700>and</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87>any</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>m</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>m</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>categories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>values</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>categories</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;其他&#39;</span><span style=color:#000;font-weight:700>]):</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>item</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>sublist</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>v</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>k</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>categories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>items</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;其他&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>item</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>sublist</span><span style=color:#000;font-weight:700>]:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>matched</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>matched</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>【</span><span style=color:#4e9a06>{</span><span style=color:#000>category</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>】&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>matched</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#000>dataset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ulog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_dataset</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#000>field_count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dataset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>keys</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>                <span style=color:#000>sample_count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>list</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dataset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>values</span><span style=color:#000;font-weight:700>())[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>dataset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;  - </span><span style=color:#4e9a06>{</span><span style=color:#000>name</span><span style=color:#4e9a06>:</span><span style=color:#4e9a06>40s</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> (字段数: </span><span style=color:#4e9a06>{</span><span style=color:#000>field_count</span><span style=color:#4e9a06>:</span><span style=color:#4e9a06>3d</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>, 样本数: </span><span style=color:#4e9a06>{</span><span style=color:#000>sample_count</span><span style=color:#4e9a06>:</span><span style=color:#4e9a06>6d</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>)&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>except</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;  - </span><span style=color:#4e9a06>{</span><span style=color:#000>name</span><span style=color:#4e9a06>:</span><span style=color:#4e9a06>40s</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> (无法读取)&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>运行后返回</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>日志文件: log_284_2025-11-25-01-15-04.ulg
</span></span><span style=display:flex><span>总共包含 <span style=color:#0000cf;font-weight:700>97</span> <span style=color:#000>个主题</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>================================================================================</span>
</span></span><span style=display:flex><span>所有主题列表:
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>================================================================================</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>【飞行状态】
</span></span><span style=display:flex><span>  - vehicle_control_mode                     <span style=color:#ce5c00;font-weight:700>(</span>字段数:  16, 样本数:    114<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_status                           <span style=color:#ce5c00;font-weight:700>(</span>字段数:  39, 样本数:    114<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>【姿态控制】
</span></span><span style=display:flex><span>  - vehicle_attitude                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  11, 样本数:   1124<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_attitude_setpoint                <span style=color:#ce5c00;font-weight:700>(</span>字段数:  11, 样本数:   1124<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_rates_setpoint                   <span style=color:#ce5c00;font-weight:700>(</span>字段数:   8, 样本数:   2807<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>【位置导航】
</span></span><span style=display:flex><span>  - vehicle_local_position                   <span style=color:#ce5c00;font-weight:700>(</span>字段数:  55, 样本数:    563<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_local_position_setpoint          <span style=color:#ce5c00;font-weight:700>(</span>字段数:  15, 样本数:    563<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>【EKF2 融合】
</span></span><span style=display:flex><span>  - estimator_innovations                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  33, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_innovations                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  33, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_local_position                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  55, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_local_position                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  55, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_status                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  40, 样本数:    282<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_status                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  40, 样本数:    282<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_status_flags                   <span style=color:#ce5c00;font-weight:700>(</span>字段数:  71, 样本数:     72<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_status_flags                   <span style=color:#ce5c00;font-weight:700>(</span>字段数:  71, 样本数:     72<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>【传感器数据】
</span></span><span style=display:flex><span>  - sensor_accel                             <span style=color:#ce5c00;font-weight:700>(</span>字段数:  12, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - sensor_accel                             <span style=color:#ce5c00;font-weight:700>(</span>字段数:  12, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - sensor_combined                          <span style=color:#ce5c00;font-weight:700>(</span>字段数:  14, 样本数:  11528<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - sensor_gyro                              <span style=color:#ce5c00;font-weight:700>(</span>字段数:  12, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - sensor_gyro                              <span style=color:#ce5c00;font-weight:700>(</span>字段数:  12, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - sensor_mag                               <span style=color:#ce5c00;font-weight:700>(</span>字段数:   8, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>【电机/舵机】
</span></span><span style=display:flex><span>  - actuator_outputs                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  18, 样本数:      1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - actuator_outputs                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  18, 样本数:      1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - actuator_outputs                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  18, 样本数:      1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>【其他】
</span></span><span style=display:flex><span>  - action_request                           <span style=color:#ce5c00;font-weight:700>(</span>字段数:   4, 样本数:      5<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - actuator_armed                           <span style=color:#ce5c00;font-weight:700>(</span>字段数:   8, 样本数:    114<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - actuator_motors                          <span style=color:#ce5c00;font-weight:700>(</span>字段数:  15, 样本数:    563<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - battery_status                           <span style=color:#ce5c00;font-weight:700>(</span>字段数:  52, 样本数:    282<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - can_interface_status                     <span style=color:#ce5c00;font-weight:700>(</span>字段数:   5, 样本数:    551<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - can_interface_status                     <span style=color:#ce5c00;font-weight:700>(</span>字段数:   5, 样本数:    551<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - config_overrides                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:   6, 样本数:    115<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - control_allocator_status                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  26, 样本数:    282<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - cpuload                                  <span style=color:#ce5c00;font-weight:700>(</span>字段数:   3, 样本数:    113<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - distance_sensor_mode_change_request      <span style=color:#ce5c00;font-weight:700>(</span>字段数:   2, 样本数:      1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_ev_hgt                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  14, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_ev_hgt                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  14, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_ev_pos                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  21, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_ev_pos                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  21, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_ev_yaw                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  14, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_ev_yaw                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  14, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_gravity                <span style=color:#ce5c00;font-weight:700>(</span>字段数:  28, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_gravity                <span style=color:#ce5c00;font-weight:700>(</span>字段数:  28, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_mag                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  28, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_aid_src_mag                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  28, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_attitude                       <span style=color:#ce5c00;font-weight:700>(</span>字段数:  11, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_attitude                       <span style=color:#ce5c00;font-weight:700>(</span>字段数:  11, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_event_flags                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  20, 样本数:     60<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_event_flags                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  20, 样本数:     60<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_innovation_test_ratios         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  33, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_innovation_test_ratios         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  33, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_innovation_variances           <span style=color:#ce5c00;font-weight:700>(</span>字段数:  33, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_innovation_variances           <span style=color:#ce5c00;font-weight:700>(</span>字段数:  33, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_odometry                       <span style=color:#ce5c00;font-weight:700>(</span>字段数:  28, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_odometry                       <span style=color:#ce5c00;font-weight:700>(</span>字段数:  28, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_selector_status                <span style=color:#ce5c00;font-weight:700>(</span>字段数:  46, 样本数:    589<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_sensor_bias                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  32, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_sensor_bias                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  32, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_states                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  52, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_states                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  52, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_status_flags                   <span style=color:#ce5c00;font-weight:700>(</span>字段数:  71, 样本数:     72<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - estimator_status_flags                   <span style=color:#ce5c00;font-weight:700>(</span>字段数:  71, 样本数:     72<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - event                                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  29, 样本数:     25<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - failsafe_flags                           <span style=color:#ce5c00;font-weight:700>(</span>字段数:  40, 样本数:    104<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - failure_detector_status                  <span style=color:#ce5c00;font-weight:700>(</span>字段数:  11, 样本数:    114<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - home_position                            <span style=color:#ce5c00;font-weight:700>(</span>字段数:  13, 样本数:      3<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - input_rc                                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:  30, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - magnetometer_bias_estimate               <span style=color:#ce5c00;font-weight:700>(</span>字段数:  21, 样本数:      3<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - manual_control_setpoint                  <span style=color:#ce5c00;font-weight:700>(</span>字段数:  17, 样本数:    282<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - manual_control_switches                  <span style=color:#ce5c00;font-weight:700>(</span>字段数:  15, 样本数:     58<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - navigator_status                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:   3, 样本数:    114<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - parameter_update                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:   9, 样本数:      2<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - position_setpoint_triplet                <span style=color:#ce5c00;font-weight:700>(</span>字段数:  70, 样本数:      1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - px4io_status                             <span style=color:#ce5c00;font-weight:700>(</span>字段数:  77, 样本数:     57<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - rate_ctrl_status                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:   5, 样本数:    282<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - rtl_status                               <span style=color:#ce5c00;font-weight:700>(</span>字段数:   6, 样本数:     28<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - rtl_time_estimate                        <span style=color:#ce5c00;font-weight:700>(</span>字段数:   4, 样本数:     28<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - sensor_baro                              <span style=color:#ce5c00;font-weight:700>(</span>字段数:   6, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - sensor_selection                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:   3, 样本数:      4<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - sensors_status_imu                       <span style=color:#ce5c00;font-weight:700>(</span>字段数:  35, 样本数:    282<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - system_power                             <span style=color:#ce5c00;font-weight:700>(</span>字段数:  17, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - takeoff_status                           <span style=color:#ce5c00;font-weight:700>(</span>字段数:   3, 样本数:     11<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - telemetry_status                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:  38, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - timesync_status                          <span style=color:#ce5c00;font-weight:700>(</span>字段数:   6, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - trajectory_setpoint                      <span style=color:#ce5c00;font-weight:700>(</span>字段数:  15, 样本数:    282<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - transponder_report                       <span style=color:#ce5c00;font-weight:700>(</span>字段数:  40, 样本数:      1<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_acceleration                     <span style=color:#ce5c00;font-weight:700>(</span>字段数:   5, 样本数:   1124<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_air_data                         <span style=color:#ce5c00;font-weight:700>(</span>字段数:   9, 样本数:    282<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_angular_velocity                 <span style=color:#ce5c00;font-weight:700>(</span>字段数:   8, 样本数:   2807<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_command                          <span style=color:#ce5c00;font-weight:700>(</span>字段数:  15, 样本数:      3<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_command_ack                      <span style=color:#ce5c00;font-weight:700>(</span>字段数:   8, 样本数:      4<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_constraints                      <span style=color:#ce5c00;font-weight:700>(</span>字段数:   4, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_imu                              <span style=color:#ce5c00;font-weight:700>(</span>字段数:  16, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_imu                              <span style=color:#ce5c00;font-weight:700>(</span>字段数:  16, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_imu_status                       <span style=color:#ce5c00;font-weight:700>(</span>字段数:  32, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_imu_status                       <span style=color:#ce5c00;font-weight:700>(</span>字段数:  32, 样本数:     56<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_land_detected                    <span style=color:#ce5c00;font-weight:700>(</span>字段数:  13, 样本数:     62<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_local_position_setpoint          <span style=color:#ce5c00;font-weight:700>(</span>字段数:  15, 样本数:    563<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_magnetometer                     <span style=color:#ce5c00;font-weight:700>(</span>字段数:   7, 样本数:    112<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_thrust_setpoint                  <span style=color:#ce5c00;font-weight:700>(</span>字段数:   5, 样本数:   2807<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  - vehicle_torque_setpoint                  <span style=color:#ce5c00;font-weight:700>(</span>字段数:   5, 样本数:   2807<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>我们可以清楚地看到日志中包含的所有主题，并根据分析目标选择关键主题。对于 <code>log_284</code> 这个案例，在此文档中我们特别关注：</p><ul><li><strong>飞行模式</strong>：<code>vehicle_status</code> - 了解何时切换到 Position 模式</li><li><strong>EKF2 融合状态</strong>：<code>estimator_status</code> - 检查融合器是否正常工作</li><li><strong>位置估计</strong>：<code>estimator_local_position</code> 和 <code>vehicle_local_position</code> - 对比分析位置跳变问题</li><li><strong>姿态数据</strong>：<code>vehicle_attitude</code> - 评估飞行器姿态稳定性</li></ul><h2 id=2-关键数据条目>2. 关键数据条目</h2><p>基于 <code>log_284</code> 案例中识别出的关键主题，本节详细讲解每个数据条目的物理意义、数据单位和提取方法。</p><h3 id=21-飞行模式与系统状态>2.1 飞行模式与系统状态</h3><p><strong><code>vehicle_status</code></strong> - 飞行器系统状态，包含飞行模式、安全状态等关键信息。</p><table><thead><tr><th>字段名</th><th>类型</th><th>单位</th><th>说明</th></tr></thead><tbody><tr><td><code>timestamp</code></td><td>uint64</td><td>微秒 (μs)</td><td>时间戳</td></tr><tr><td><code>nav_state</code></td><td>uint8</td><td>-</td><td>导航状态（飞行模式）：0=MANUAL(手动), 1=ALTCTL(高度控制), 2=POSCTL(位置控制), 3=AUTO_MISSION(自动任务), 4=AUTO_LOITER(自动悬停), 5=AUTO_RTL(自动返航), 6=ACRO(特技), 7=OFFBOARD(外部控制)</td></tr><tr><td><code>arming_state</code></td><td>uint8</td><td>-</td><td>解锁状态：0=未解锁, 1=已解锁</td></tr><tr><td><code>hil_state</code></td><td>uint8</td><td>-</td><td>HIL 仿真状态</td></tr><tr><td><code>failsafe</code></td><td>bool</td><td>-</td><td>故障保护是否激活</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>vehicle_status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ulog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_dataset</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;vehicle_status&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>timestamps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>vehicle_status</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;timestamp&#39;</span><span style=color:#000;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>1e6</span>
</span></span><span style=display:flex><span><span style=color:#000>nav_state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>vehicle_status</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;nav_state&#39;</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span><span style=color:#000>arming_state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>vehicle_status</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;arming_state&#39;</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查找模式切换时间点</span>
</span></span><span style=display:flex><span><span style=color:#000>mode_changes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>where</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>diff</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>nav_state</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>idx</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>mode_changes</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;时间 </span><span style=color:#4e9a06>{</span><span style=color:#000>timestamps</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#000;font-weight:700>]</span><span style=color:#4e9a06>:</span><span style=color:#4e9a06>.2f</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> s: 切换到模式 </span><span style=color:#4e9a06>{</span><span style=color:#000>nav_state</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h3 id=22-姿态控制数据>2.2 姿态控制数据</h3><p><strong><code>vehicle_attitude</code></strong> - 飞行器姿态信息，使用四元数表示。</p><table><thead><tr><th>字段名</th><th>类型</th><th>单位</th><th>说明</th></tr></thead><tbody><tr><td><code>timestamp</code></td><td>uint64</td><td>微秒 (μs)</td><td>时间戳</td></tr><tr><td><code>q[0]</code></td><td>float</td><td>-</td><td>四元数 w 分量（标量部分）</td></tr><tr><td><code>q[1]</code></td><td>float</td><td>-</td><td>四元数 x 分量（对应横滚轴）</td></tr><tr><td><code>q[2]</code></td><td>float</td><td>-</td><td>四元数 y 分量（对应俯仰轴）</td></tr><tr><td><code>q[3]</code></td><td>float</td><td>-</td><td>四元数 z 分量（对应偏航轴）</td></tr></tbody></table><p><strong><code>vehicle_attitude_setpoint</code></strong> - 姿态设定值，用于评估控制器跟踪性能。</p><table><thead><tr><th>字段名</th><th>类型</th><th>单位</th><th>说明</th></tr></thead><tbody><tr><td><code>roll_body</code></td><td>float</td><td>弧度 (rad)</td><td>横滚角设定值</td></tr><tr><td><code>pitch_body</code></td><td>float</td><td>弧度 (rad)</td><td>俯仰角设定值</td></tr><tr><td><code>yaw_body</code></td><td>float</td><td>弧度 (rad)</td><td>偏航角设定值</td></tr><tr><td><code>thrust_body[0]</code></td><td>float</td><td>-</td><td>X 轴推力设定值（归一化）</td></tr><tr><td><code>thrust_body[1]</code></td><td>float</td><td>-</td><td>Y 轴推力设定值（归一化）</td></tr><tr><td><code>thrust_body[2]</code></td><td>float</td><td>-</td><td>Z 轴推力设定值（归一化）</td></tr></tbody></table><h3 id=23-位置与导航数据>2.3 位置与导航数据</h3><p><strong><code>vehicle_local_position</code></strong> - 本地坐标系（NED）下的位置、速度和加速度信息，这是对外发布的位置估计。</p><table><thead><tr><th>字段名</th><th>类型</th><th>单位</th><th>说明</th></tr></thead><tbody><tr><td><code>timestamp</code></td><td>uint64</td><td>微秒 (μs)</td><td>时间戳</td></tr><tr><td><code>x</code></td><td>float</td><td>米 (m)</td><td>X 轴位置（北向，NED 坐标系）</td></tr><tr><td><code>y</code></td><td>float</td><td>米 (m)</td><td>Y 轴位置（东向，NED 坐标系）</td></tr><tr><td><code>z</code></td><td>float</td><td>米 (m)</td><td>Z 轴位置（地向，NED 坐标系，向上为负）</td></tr><tr><td><code>vx</code></td><td>float</td><td>米/秒 (m/s)</td><td>X 轴速度</td></tr><tr><td><code>vy</code></td><td>float</td><td>米/秒 (m/s)</td><td>Y 轴速度</td></tr><tr><td><code>vz</code></td><td>float</td><td>米/秒 (m/s)</td><td>Z 轴速度</td></tr><tr><td><code>ax</code></td><td>float</td><td>米/秒² (m/s²)</td><td>X 轴加速度</td></tr><tr><td><code>ay</code></td><td>float</td><td>米/秒² (m/s²)</td><td>Y 轴加速度</td></tr><tr><td><code>az</code></td><td>float</td><td>米/秒² (m/s²)</td><td>Z 轴加速度</td></tr><tr><td><code>xy_valid</code></td><td>bool</td><td>-</td><td>XY 平面位置是否有效</td></tr><tr><td><code>z_valid</code></td><td>bool</td><td>-</td><td>Z 轴位置是否有效</td></tr><tr><td><code>v_xy_valid</code></td><td>bool</td><td>-</td><td>XY 平面速度是否有效</td></tr><tr><td><code>v_z_valid</code></td><td>bool</td><td>-</td><td>Z 轴速度是否有效</td></tr></tbody></table><p><strong><code>estimator_local_position</code></strong> - EKF2 内部位置估计，用于分析融合算法性能。字段与 <code>vehicle_local_position</code> 相同，但这是 EKF2 的原始输出，未经过位置控制器的处理。</p><p><strong>注意</strong>：在 <code>log_284</code> 案例中，对比这两个位置数据源可以发现 Position 模式下的位置跳变问题。</p><h3 id=24-ekf2-融合状态数据>2.4 EKF2 融合状态数据</h3><p><strong><code>estimator_status</code></strong> - EKF2 融合器状态，包含融合质量指标和故障标志。</p><table><thead><tr><th>字段名</th><th>类型</th><th>单位</th><th>说明</th></tr></thead><tbody><tr><td><code>timestamp</code></td><td>uint64</td><td>微秒 (μs)</td><td>时间戳</td></tr><tr><td><code>gps_check_fail_flags</code></td><td>uint16</td><td>-</td><td>GPS 检查失败标志位</td></tr><tr><td><code>filter_fault_flags</code></td><td>uint16</td><td>-</td><td>滤波器故障标志位</td></tr><tr><td><code>innovation_check_flags</code></td><td>uint16</td><td>-</td><td>残差检查标志位</td></tr><tr><td><code>solution_status_flags</code></td><td>uint16</td><td>-</td><td>解算状态标志位</td></tr><tr><td><code>pos_horiz_accuracy</code></td><td>float</td><td>米 (m)</td><td>水平位置精度估计</td></tr><tr><td><code>pos_vert_accuracy</code></td><td>float</td><td>米 (m)</td><td>垂直位置精度估计</td></tr><tr><td><code>vel_accuracy</code></td><td>float</td><td>米/秒 (m/s)</td><td>速度精度估计</td></tr></tbody></table><p><strong><code>estimator_innovations</code></strong> - EKF2 融合残差（innovation），用于诊断融合质量。</p><table><thead><tr><th>字段名</th><th>类型</th><th>单位</th><th>说明</th></tr></thead><tbody><tr><td><code>timestamp</code></td><td>uint64</td><td>微秒 (μs)</td><td>时间戳</td></tr><tr><td><code>ev_hvel[0]</code></td><td>float</td><td>米/秒 (m/s)</td><td>外部视觉水平速度残差 X</td></tr><tr><td><code>ev_hvel[1]</code></td><td>float</td><td>米/秒 (m/s)</td><td>外部视觉水平速度残差 Y</td></tr><tr><td><code>ev_hpos[0]</code></td><td>float</td><td>米 (m)</td><td>外部视觉水平位置残差 X</td></tr><tr><td><code>ev_hpos[1]</code></td><td>float</td><td>米 (m)</td><td>外部视觉水平位置残差 Y</td></tr><tr><td><code>ev_vpos</code></td><td>float</td><td>米 (m)</td><td>外部视觉垂直位置残差</td></tr><tr><td><code>ev_hvel_test_ratio[0]</code></td><td>float</td><td>-</td><td>水平速度 X 测试比率（test_ratio）</td></tr><tr><td><code>ev_hvel_test_ratio[1]</code></td><td>float</td><td>-</td><td>水平速度 Y 测试比率</td></tr><tr><td><code>ev_hpos_test_ratio[0]</code></td><td>float</td><td>-</td><td>水平位置 X 测试比率</td></tr><tr><td><code>ev_hpos_test_ratio[1]</code></td><td>float</td><td>-</td><td>水平位置 Y 测试比率</td></tr></tbody></table><p><strong>test_ratio 说明</strong>：当 <code>test_ratio > 1.0</code> 时，EKF2 会拒绝该次测量数据。在 <code>log_284</code> 案例中，过小的 <code>EKF2_EV_POS_X/Y</code> 参数导致 test_ratio 频繁超过阈值，视觉数据被拒绝，造成位置跳变。</p><h3 id=25-传感器数据>2.5 传感器数据</h3><p><strong><code>sensor_combined</code></strong> - 综合传感器数据，包含加速度计、陀螺仪和磁力计的融合读数。</p><table><thead><tr><th>字段名</th><th>类型</th><th>单位</th><th>说明</th></tr></thead><tbody><tr><td><code>timestamp</code></td><td>uint64</td><td>微秒 (μs)</td><td>时间戳</td></tr><tr><td><code>accelerometer_m_s2[0]</code></td><td>float</td><td>米/秒² (m/s²)</td><td>X 轴加速度</td></tr><tr><td><code>accelerometer_m_s2[1]</code></td><td>float</td><td>米/秒² (m/s²)</td><td>Y 轴加速度</td></tr><tr><td><code>accelerometer_m_s2[2]</code></td><td>float</td><td>米/秒² (m/s²)</td><td>Z 轴加速度</td></tr><tr><td><code>gyro_rad[0]</code></td><td>float</td><td>弧度/秒 (rad/s)</td><td>X 轴角速度</td></tr><tr><td><code>gyro_rad[1]</code></td><td>float</td><td>弧度/秒 (rad/s)</td><td>Y 轴角速度</td></tr><tr><td><code>gyro_rad[2]</code></td><td>float</td><td>弧度/秒 (rad/s)</td><td>Z 轴角速度</td></tr><tr><td><code>magnetometer_ga[0]</code></td><td>float</td><td>高斯 (G)</td><td>X 轴磁力计读数</td></tr><tr><td><code>magnetometer_ga[1]</code></td><td>float</td><td>高斯 (G)</td><td>Y 轴磁力计读数</td></tr><tr><td><code>magnetometer_ga[2]</code></td><td>float</td><td>高斯 (G)</td><td>Z 轴磁力计读数</td></tr></tbody></table><p><strong>合理范围</strong>：</p><ul><li>加速度计：±20 m/s²（正常飞行），±9.8 m/s²（静止时重力）</li><li>陀螺仪：±10 rad/s（正常飞行）</li><li>磁力计：±0.5 G（地球磁场强度）</li></ul><h2 id=3-通过绘图分析关键数据>3. 通过绘图分析关键数据</h2><p>基于 <a href=/Docsy/files/log_284_2025-11-25-01-15-04.ulg><code>log_284</code></a> 案例，本节展示如何将提取的关键数据绘制成图表，直观展示数据变化趋势，为问题诊断提供可视化支持。</p><p>读者可以自行下载该日志文件，使用本文提供的脚本进行复现分析。</p><h3 id=31-飞行模式时间线>3.1 飞行模式时间线</h3><p>通过飞行模式随时间变化的曲线，可以直接观测整段飞行中飞机经历的模式阶段（起飞、悬停、手动介入、稳高/定点、降落等），这是后续所有细节分析的时间框架。</p><p>脚本下载：<a href=/Docsy/files/plot_flight_mode.py><code>plot_flight_mode.py</code></a></p><p><img src=/Docsy/images/flight_mode_timeline.png alt=飞行模式时间线（log_284）></p><ul><li><p><strong>图表含义</strong>：</p><ul><li><strong>横轴</strong>：时间（秒），从日志开始后的相对时间，范围 0-55 秒。</li><li><strong>纵轴</strong>：飞行模式（Flight Mode），显示 PX4 中的各个模式，包括 MANUAL, ALTCTL, POSCTL, AUTO_MISSION, AUTO_LOITER, AUTO_RTL, ACRO, OFFBOARD 等。</li><li><strong>数据系列</strong>：蓝色线条和圆形标记表示当前激活的飞行模式，模式切换时线条发生垂直跳变。</li><li><strong>关键信息</strong>：每一次模式切换的精确时间点、模式持续时长，以及模式切换的频率和模式。</li></ul></li><li><p><strong>分析</strong>：</p><ul><li><strong>数据观察</strong>：<ul><li><strong>飞行模式序列（0-55秒）</strong>：<ul><li><strong>0-13.5秒：ALTCTL（高度控制）模式</strong>：飞行开始阶段，飞机处于高度控制模式，此阶段对水平位置估计的依赖较弱，主要依赖气压计和加速度计进行高度控制。</li><li><strong>13.5-17.5秒：POSCTL（位置控制）模式</strong>：首次切换到位置控制模式，持续约<strong>4秒</strong>。这是第一个关键时间点，飞机开始依赖水平位置估计进行控制。</li><li><strong>17.5-25.5秒：ALTCTL（高度控制）模式</strong>：切回高度控制模式，持续约<strong>8秒</strong>。可能由于位置控制出现问题，飞手或系统自动切回高度控制模式。</li><li><strong>25.5-37.5秒：POSCTL（位置控制）模式</strong>：再次切换到位置控制模式，持续约<strong>12秒</strong>。这是第二个关键时间点，也是持续时间最长的位置控制阶段。</li><li><strong>37.5-55秒：ALTCTL（高度控制）模式</strong>：最后切回高度控制模式，直到日志结束。</li></ul></li><li><strong>模式切换特征</strong>：<ul><li>飞机<strong>仅在 ALTCTL 和 POSCTL 之间切换</strong>，没有进入其他模式（如 MANUAL, AUTO_MISSION, OFFBOARD 等），说明飞行过程相对简单。</li><li>在约55秒的飞行过程中，发生了<strong>4次模式切换</strong>（ALTCTL→POSCTL→ALTCTL→POSCTL→ALTCTL），频繁切换往往意味着飞手在尝试使用位置控制模式但遇到问题，或系统检测到异常自动触发保护逻辑。</li><li>两次 POSCTL 模式分别持续约4秒和12秒，持续时间较短，特别是第一次仅4秒，可能表明位置控制模式启动后很快出现问题。</li></ul></li></ul></li><li><strong>关键发现</strong>：<ul><li><strong>时间锚点与问题关联</strong>：<ul><li><strong>13.5秒（首次切入 POSCTL）</strong>：这是第一个关键时间点，结合后续分析可以发现，此时开始出现水平位置漂移和姿态控制异常。</li><li><strong>25.5秒（再次切入 POSCTL）</strong>：这是第二个关键时间点，也是持续时间最长的位置控制阶段，可能对应最严重的异常阶段（如位置对比图中35-45秒的异常峰值期）。</li></ul></li><li><strong>模式切换与异常的关系</strong>：每次从 ALTCTL 切换到 POSCTL 后，飞机开始依赖水平位置估计，若位置估计本身存在问题（如 EKF2 对外发布位置跳变），就会导致位置控制异常，表现为水平位置漂移和姿态控制异常；切回 ALTCTL 后，对水平位置估计的依赖减弱，异常现象可能暂时缓解。</li></ul></li><li><strong>结论验证</strong>：<br>这一飞行模式时间线为后续所有细节分析提供了<strong>明确的时间框架</strong>。通过将姿态角异常、位置跳变、加速度计波动等数据与模式切换时间点对齐，可以清晰地建立<strong>模式切换 → 位置估计异常 → 控制失效</strong>的因果链条，为问题诊断提供关键的时间锚点。</li></ul></li></ul><h3 id=32-姿态角时间序列>3.2 姿态角时间序列</h3><p>姿态角（Roll/Pitch/Yaw）时间序列是最直观反映飞控控制性能的图表之一。通过对比问题飞行（<code>log_284</code>）和正常飞行（<a href=/Docsy/files/log_287_2025-11-25-05-30-36.ulg><code>log_287</code></a>），可以很快判断控制回路是否处于健康工作区间。</p><p>脚本下载：<a href=/Docsy/files/plot_attitude.py><code>plot_attitude.py</code></a></p><p><strong>问题飞行</strong>
<img src=/Docsy/images/log_284_attitude_angles.png alt="姿态角时间序列（问题飞行 log_284）"></p><p><strong>正常飞行</strong>
<img src=/Docsy/images/log_287_attitude_angles.png alt="姿态角时间序列（正常飞行 log_287）"></p><ul><li><p><strong>图表含义</strong>：</p><ul><li><strong>横轴</strong>：时间（秒），从日志开始后的相对时间。</li><li><strong>纵轴</strong>：<ul><li><strong>姿态角图</strong>：角度（度），显示 Roll（横滚角，绕 X 轴，蓝色）、Pitch（俯仰角，绕 Y 轴，橙色）、Yaw（偏航角，绕 Z 轴，绿色）随时间的变化。</li><li><strong>角速度图</strong>：角速度（deg/s），显示 Roll Rate（蓝色）、Pitch Rate（橙色）、Yaw Rate（绿色）随时间的变化。</li></ul></li><li><strong>数据系列</strong>：<ul><li><strong>问题飞行（log_284）</strong>：显示约52秒的飞行数据，包含姿态角和角速度两个子图。</li><li><strong>正常飞行（log_287）</strong>：显示约125秒的飞行数据，包含姿态角和角速度两个子图。</li></ul></li><li><strong>关键标记</strong>：蓝色点标记快速角度变化（>10°/s），用于突出异常行为。</li></ul></li><li><p><strong>分析</strong>：</p><ul><li><strong>数据观察</strong>：<ul><li><strong><code>log_284</code>（问题飞行）</strong>：<ul><li><strong>Roll 和 Pitch 轴</strong>：姿态角在整个约52秒的飞行过程中<strong>保持相对稳定</strong>，角度值基本在 $\pm 10^\circ$ 范围内小幅波动，接近水平状态；角速度主要波动在 $\pm 500$ deg/s 范围内，属于正常的控制响应范围。</li><li><strong>Yaw 轴（严重异常）</strong>：姿态角出现<strong>频繁、剧烈的瞬时反转</strong>，在多个时间段（3-8秒、15-18秒、20-22秒、25-28秒、30-38秒、40-42秒）内，Yaw 角在 $-170^\circ$ 和 $+170^\circ$ 之间<strong>快速跳变</strong>，在图表上呈现为近垂直的线条，表明航向在短时间内发生 $340^\circ$ 的巨大变化；角速度出现<strong>极端峰值</strong>，幅度可达 $\pm 7500$ deg/s，与 Yaw 角的快速跳变完全对应；蓝色点标记集中在 Yaw 角的跳变区间，进一步突出了异常行为的严重性；42秒后 Yaw 角稳定在 $+170^\circ$ 附近。</li></ul></li><li><strong><code>log_287</code>（正常飞行）</strong>：<ul><li><strong>Roll 和 Pitch 轴</strong>：姿态角在整个约125秒的飞行过程中<strong>持续振荡</strong>，角度值在 $-5^\circ$ 到 $+10^\circ$ 范围内波动，围绕 $0^\circ$ 进行小幅调整，这是正常飞行中为保持姿态稳定而进行的持续修正；角速度显示<strong>高频、高幅振荡</strong>，频繁达到 $\pm 40$ deg/s 的峰值，甚至超出显示范围，表明系统在积极进行姿态修正，这是健康控制系统的正常表现。</li><li><strong>Yaw 轴（非常稳定）</strong>：姿态角在整个125秒内<strong>极其稳定</strong>，始终保持在 $95-96^\circ$ 附近，波动极小，几乎呈水平直线，表明航向估计和控制非常可靠；角速度在整个飞行过程中<strong>非常接近 0</strong> deg/s，波动仅在 $\pm 2$ deg/s 范围内，表明几乎没有绕 Z 轴的旋转运动，航向保持稳定。</li></ul></li></ul></li><li><strong>关键发现</strong>：<ul><li><strong>Yaw 轴的极端对比</strong>：这是最关键的发现——<code>log_284</code> 中 Yaw 角出现<strong>频繁、剧烈的瞬时反转</strong>（角速度峰值达 $\pm 7500$ deg/s），而 <code>log_287</code> 中 Yaw 角<strong>极其稳定</strong>（角速度接近 0），这种极端对比直接证明了问题出在<strong>航向估计或控制逻辑</strong>，而非机械结构。</li><li><strong>Roll/Pitch 表现差异</strong>：<code>log_284</code> 中 Roll/Pitch 相对稳定但缺乏主动修正，而 <code>log_287</code> 中 Roll/Pitch 持续振荡但处于健康控制状态，这种差异可能与飞行模式、控制参数或外部干扰有关，但<strong>不是导致问题的根本原因</strong>。</li><li><strong>问题定位</strong>：Roll/Pitch 在 <code>log_284</code> 中基本正常，而 Yaw 出现严重异常，说明<strong>问题不在基本姿态控制环路本身，而在更高层（如位置/航向估计或上层控制模式）</strong>。Yaw 的频繁跳变通常意味着位置/航向估计不稳定（EKF2 融合质量差），导致航向参考频繁跳变；或控制器在错误反馈信号驱动下不断反向调整，形成失控感。</li></ul></li><li><strong>结论验证</strong>：<br>通过这一对比，可以直接观察到：<strong>同一架飞机、相似的飞行场景，仅仅因为参数/配置不同，Yaw 控制就可以从稳定可控变为频繁反转、接近失控</strong>，从而证明问题根源在于位置估计与控制逻辑的配置不当（特别是 EKF2 航向估计和 Position 模式下的控制逻辑），而非机械结构或硬件故障。</li></ul></li></ul><h3 id=33-ekf2-内部位置-vs-对外发布位置>3.3 EKF2 内部位置 vs 对外发布位置</h3><p>位置对比图是 <code>log_284</code> 案例中最关键的证据之一：它将 EKF2 内部估计的位置（来自 <code>estimator_local_position</code>）与飞控对外发布的位置（如 <code>vehicle_local_position</code>）叠加到同一坐标系中，直观展示 EKF2 内部位置估计与对外发布位置之间的差异。</p><p>脚本下载：<a href=/Docsy/files/plot_position.py><code>plot_position.py</code></a></p><p><img src=/Docsy/images/log_284_position_comparison.png alt=位置对比图（log_284）></p><ul><li><p><strong>图表含义</strong>：</p><ul><li><strong>横轴</strong>：时间（秒），从日志开始后的相对时间，范围 0-55 秒。</li><li><strong>纵轴</strong>：位置（米），三个子图分别显示 X 轴（前后方向）、Y 轴（左右方向）、Z 轴（高度方向）的位置随时间的变化。</li><li><strong>数据系列</strong>：<ul><li><strong>蓝色线</strong>：<code>estimator_local_position</code>（EKF2 内部估计位置），表示 EKF2 滤波器内部的位置估计值。</li><li><strong>橙色线</strong>：<code>vehicle_local_position</code>（对外发布位置），表示飞控对上层控制和外部模块发布的位置值。</li></ul></li><li><strong>关键标记</strong>：红色虚线标记 &ldquo;Position Mode Start&rdquo;（位置模式启动时间点，约14秒），用于标识模式切换的关键时刻。</li></ul></li><li><p><strong>分析</strong>：</p><ul><li><strong>数据观察</strong>：<ul><li><strong>X 轴位置对比（前后方向）</strong>：<ul><li><strong>Position 模式启动前（0-14秒）</strong>：两条曲线<strong>紧密重合</strong>，在 4-6 米范围内平滑波动，表明此阶段位置估计整体可信。</li><li><strong>Position 模式启动后（14秒起）</strong>：橙色线（对外发布位置）立即开始<strong>剧烈波动</strong>，与蓝色线（内部估计）出现明显分离。</li><li><strong>异常峰值期（35-45秒）</strong>：橙色线出现<strong>极端跳变</strong>，峰值接近 10 米，最低降至 2 米以下，呈现<strong>锯齿状、高幅度的来回抖动</strong>；蓝色线在此期间也出现振荡，但幅度和频率明显小于橙色线，整体更平滑。</li><li><strong>恢复期（45秒后）</strong>：两条曲线重新收敛，从约 6 米平滑下降至 4 米并趋于稳定，表明系统恢复正常。</li></ul></li><li><strong>Y 轴位置对比（左右方向）</strong>：<ul><li><strong>Position 模式启动前（0-14秒）</strong>：两条曲线<strong>紧密重合</strong>，在 12.5-14.5 米范围内稳定波动，与 X 轴表现一致。</li><li><strong>Position 模式启动后（14秒起）</strong>：橙色线开始<strong>显著偏离</strong>蓝色线，波动加剧。</li><li><strong>异常峰值期（35-45秒）</strong>：橙色线出现<strong>极端跳变</strong>，峰值接近 15 米，最低降至 10 米以下，与 X 轴同步出现大幅锯齿状抖动；蓝色线同样显示振荡但幅度更小。</li><li><strong>恢复期（45秒后）</strong>：两条曲线收敛，从约 12 米平滑上升至 13 米并稳定，系统恢复正常。</li></ul></li><li><strong>Z 轴位置对比（高度方向）</strong>：<ul><li><strong>整体一致性</strong>：Z 轴两条曲线的一致性<strong>明显优于 X/Y 轴</strong>，即使在 Position 模式启动后，橙色线的波动也相对较小。</li><li><strong>0-14秒</strong>：两条曲线基本重合，从 -0.2 米平滑下降至 -0.55 到 -0.6 米，保持稳定。</li><li><strong>14秒后</strong>：橙色线波动稍大于蓝色线，但偏差远小于 X/Y 轴。</li><li><strong>38-42秒</strong>：两条曲线同步出现快速下降至 -0.85 米，随后快速上升至 -0.2 米（48秒），橙色线在此期间略显锯齿状，但整体趋势一致。</li></ul></li></ul></li><li><strong>关键发现</strong>：<ul><li><strong>X/Y 轴异常跳变</strong>：Position 模式启动后，对外发布的 X/Y 位置（橙色线）出现<strong>极端跳变和锯齿状抖动</strong>，而 EKF2 内部估计（蓝色线）虽然也有振荡，但幅度和频率明显更小，说明<strong>问题出在 EKF2 对外发布位置的处理环节</strong>，而非内部估计本身。</li><li><strong>Z 轴相对稳定</strong>：Z 轴两条曲线的一致性明显好于 X/Y 轴，表明高度估计和发布机制相对正常，问题主要集中在<strong>水平位置（X/Y）的发布环节</strong>。</li><li><strong>异常峰值期（35-45秒）</strong>：这是整个飞行过程中最严重的异常阶段，X/Y 轴对外发布位置出现极端跳变，峰值可达正常值的 2-3 倍，这直接导致 Position 控制器基于错误反馈产生剧烈修正动作。</li><li><strong>恢复机制</strong>：45秒后两条曲线重新收敛，可能与模式切换、飞手介入或 EKF2 重新收敛有关，说明系统具备恢复能力，但异常期间已造成位置控制失效。</li></ul></li><li><strong>结论验证</strong>：<ul><li>这一对比图与前文对 EKF2 <code>test_ratio</code> 和参数 <code>EKF2_EV_POS_X/Y</code> 过于严格的分析结论形成闭环：<strong>EKF2 外部位置数据被拒绝 → 内部估计与对外发布位置分离 → 对外发布位置出现跳变 → Position 控制器基于错误反馈输出错误控制量 → 飞机在 Position 模式下出现失控漂移</strong>。</li><li>在 PX4 的 Position 模式中，飞控会在切入该模式时<strong>将当前飞机所在的 X/Y 位置视为新的保持目标点</strong>，若对外发布的位置本身发生跳变，控制器会基于错误的位置反馈持续调整控制量，导致飞机出现缓慢甚至剧烈漂移；当退出 Position 模式，改为 Altitude 或 Manual 并由飞手直接控制姿态/油门时，对位置估计的依赖减弱，漂移现象立即消失。</li></ul></li></ul></li></ul><h3 id=34-加速度计时域对比>3.4 加速度计时域对比</h3><p>加速度计 X 轴和 Y 轴时域对比图，将问题飞行（<code>log_284</code>）与正常飞行（<code>log_287</code>）在同一时间标度下叠加，帮助我们从机体振动和动态响应的角度，验证系统是否处在一个合理的工作环境中。</p><p>脚本下载：<a href=/Docsy/files/plot_accel.py><code>plot_accel.py</code></a></p><p><img src=/Docsy/images/accel_plot.png alt="加速度计 X 轴和 Y 轴时域对比"></p><ul><li><p><strong>图表含义</strong>：</p><ul><li><strong>横轴</strong>：时间（秒），分别对两段日志做相对时间对齐，范围 0-130 秒。</li><li><strong>纵轴</strong>：加速度（m/s²），两个子图分别显示 X 轴（前后方向，通常是机头指向）和 Y 轴（左右方向）的加速度随时间的变化。</li><li><strong>数据系列</strong>：<ul><li><strong>蓝色线</strong>：<code>log_284 accel X/Y</code>（问题飞行），显示存在问题的飞行中的加速度数据。</li><li><strong>橙色线</strong>：<code>log_287 accel X/Y</code>（正常飞行），显示参数/配置优化后的稳定飞行中的加速度数据。</li></ul></li><li><strong>关键信息</strong>：通过对比两条曲线可以直观判断系统是否工作在健康的振动水平，识别异常振动和动态响应问题。</li></ul></li><li><p><strong>分析</strong>：</p><ul><li><strong>数据观察</strong>：<ul><li><strong><code>log_284</code>（问题飞行）</strong>：<ul><li>在前约50秒内，X 轴和 Y 轴加速度均显示出<strong>更大的振幅波动</strong>，振荡范围约在 $\pm 6$ 到 $\pm 7.5$ m/s² 之间，明显高于正常水平。</li><li>曲线呈现<strong>不规则、高频的抖动特征</strong>，表明此阶段机体振动水平确实偏高。</li><li>数据在大约50秒后停止记录，这与飞行模式时间线中显示的飞行终止时间点一致。</li></ul></li><li><strong><code>log_287</code>（正常飞行）</strong>：<ul><li>整体振幅显著更小，大部分时间加速度值稳定在 $\pm 2.5$ m/s² 范围内，基线接近 $0$ m/s²。</li><li>曲线平滑度明显优于 <code>log_284</code>，表明系统工作在<strong>健康的振动环境</strong>中。</li><li>存在少量尖锐的峰值（如45秒、65秒、95秒、105秒附近），这些可能是正常的机动动作（如快速转向、急停等），峰值后迅速恢复到稳定状态。</li><li>数据持续记录整个测量期间（约130秒），飞行过程完整。</li></ul></li></ul></li><li><strong>关键发现</strong>：<ul><li><strong>振动水平对比</strong>：<code>log_284</code> 在前50秒内确实存在<strong>更高的振动水平</strong>，这可能与 Position 模式下的位置控制异常导致的频繁修正动作有关，而非单纯的机械振动问题。</li><li><strong>系统优化效果</strong>：<code>log_287</code> 的平滑曲线证明，在相同的机械结构下，通过优化 EKF2 参数和位置控制逻辑，系统可以工作在低振动、稳定的状态。</li><li><strong>问题根源验证</strong>：通过对比两张图中曲线的整体平滑度和峰值大小，可以直观判断系统是否工作在一个健康的振动水平，为问题诊断提供重要的参考依据。</li></ul></li><li><strong>结论验证</strong>：<br>这一对比进一步验证了前文结论：<strong>问题的根源在于 EKF2 配置不当导致的位置估计跳变，进而引发 Position 控制器的异常响应和频繁修正，表现为加速度数据的剧烈波动；而非机械结构或硬件故障导致的振动问题</strong>。</li></ul></li></ul><h3 id=35-test-ratio-与位置跳变关联分析>3.5 Test Ratio 与位置跳变关联分析</h3><p>Test Ratio 与位置跳变关联分析图是 <code>log_284</code> 案例中最关键的诊断图表之一：它将 EKF2 的 test ratio（测试比率）、数据拒绝事件与位置跳变、Yaw 角异常叠加在同一时间轴上，直观展示 EKF2 数据拒绝机制与位置控制异常之间的因果关系。</p><p>脚本下载：<a href=/Docsy/files/plot_position_jump.py><code>plot_position_jump.py</code></a></p><p><img src=/Docsy/images/log_284_test_ratio_analysis.png alt="Test Ratio 与位置跳变关联分析（log_284）"></p><ul><li><p><strong>图表含义</strong>：</p><ul><li><strong>横轴</strong>：时间（秒），从日志开始后的相对时间，范围 0-55 秒。</li><li><strong>纵轴</strong>：三个子图分别显示不同的数据指标。<ul><li><strong>上子图</strong>：X 位置（米，左轴）和 Yaw 角（度，右轴），显示 EKF2 内部估计位置（蓝色）、对外发布位置（橙色）和 Yaw 角（绿色虚线）。</li><li><strong>中子图</strong>：X Test Ratio（无单位），显示 EKF2 对 X 轴位置数据的测试比率（红色实线）和拒绝阈值（黑色虚线，值为 1.0）。</li><li><strong>下子图</strong>：数据拒绝事件（二进制指标），红色点表示数据被拒绝的时刻。</li></ul></li><li><strong>关键标记</strong>：红色虚线标记 &ldquo;POSCTL&rdquo; 和 &ldquo;ALTCTL&rdquo;，用于标识飞行模式切换的时间点。</li><li><strong>关键信息</strong>：通过对比三个子图，可以直观观察 test ratio 峰值、数据拒绝事件与位置跳变、Yaw 角异常之间的时间对应关系。</li></ul></li><li><p><strong>分析</strong>：</p><ul><li><strong>数据观察</strong>：<ul><li><strong>ALTCTL 模式阶段（0-13.5秒、17.5-25.5秒、37.5-55秒）</strong>：<ul><li>X 位置：EKF2 内部估计（蓝色）与对外发布位置（橙色）<strong>紧密重合</strong>，在 4-6 米范围内稳定波动，位置估计整体可信。</li><li>Yaw 角：稳定在约 $10^\circ$ 附近，波动较小，航向控制正常。</li><li>X Test Ratio：大部分时间保持在拒绝阈值（1.0）以下，表明传感器数据质量良好，EKF2 正常接受数据。</li><li>数据拒绝事件：几乎没有或极少，系统运行稳定。</li></ul></li><li><strong>POSCTL 模式阶段（13.5-17.5秒、25.5-37.5秒）</strong>：<ul><li>X 位置：切换到 POSCTL 模式后，对外发布位置（橙色）开始出现<strong>波动和偏差</strong>，与内部估计（蓝色）出现分离。</li><li>Yaw 角：在模式切换时刻出现<strong>急剧变化</strong>，随后在 POSCTL 模式下波动加剧。</li><li>X Test Ratio：出现<strong>峰值</strong>，在约 13.5 秒、20 秒、32 秒等时刻超过拒绝阈值（1.0），最高峰值可达 30 以上。</li><li>数据拒绝事件：在 test ratio 超过阈值时出现，与位置跳变和 Yaw 角异常的时间点高度一致。</li></ul></li><li><strong>异常峰值期（35-45秒）</strong>：<ul><li>X 位置：对外发布位置出现<strong>极端跳变</strong>，从约 6 米跳至 9 米，随后降至 2 米以下，呈现<strong>锯齿状、高幅度的来回抖动</strong>，与内部估计位置严重分离。</li><li>Yaw 角：出现<strong>频繁、剧烈的瞬时反转</strong>，在 $-150^\circ$ 和 $+150^\circ$ 之间快速跳变，航向控制完全失效。</li><li>X Test Ratio：出现<strong>连续多次峰值</strong>，数值在 10-15 之间，持续超过拒绝阈值，表明 EKF2 在此阶段频繁拒绝传感器数据。</li><li>数据拒绝事件：在 35-40 秒期间出现<strong>密集的拒绝事件</strong>，红色点集中分布，与位置跳变和 Yaw 角异常完全对应。</li></ul></li><li><strong>恢复期（45秒后）</strong>：<ul><li>切回 ALTCTL 模式后，X 位置两条曲线重新收敛，稳定在约 4 米；Yaw 角稳定在 $0^\circ$ 附近；test ratio 降至阈值以下；数据拒绝事件消失，系统恢复正常。</li></ul></li></ul></li><li><strong>关键发现</strong>：<ul><li><strong>时间对应关系</strong>：test ratio 峰值、数据拒绝事件与位置跳变、Yaw 角异常在时间上<strong>高度一致</strong>，特别是在 POSCTL 模式下和异常峰值期（35-45秒），这种对应关系清晰地表明 EKF2 数据拒绝机制是导致位置跳变的直接原因。</li><li><strong>模式切换触发</strong>：每次从 ALTCTL 切换到 POSCTL 时，test ratio 都会出现峰值并超过阈值，导致数据拒绝事件，随后位置跳变和 Yaw 角异常开始出现；切回 ALTCTL 后，test ratio 恢复正常，位置和 Yaw 角也趋于稳定。</li><li><strong>异常峰值期的严重性</strong>：35-45 秒期间，test ratio 连续多次超过阈值，数据拒绝事件密集出现，对应最严重的位置跳变（峰值可达正常值的 2-3 倍）和 Yaw 角失控（$340^\circ$ 的巨大变化），这是整个飞行过程中最危险的阶段。</li><li><strong>EKF2 数据拒绝机制的影响</strong>：当 test ratio > 1.0 时，EKF2 拒绝外部位置数据（如视觉定位数据），只能依赖 IMU 预测，位置逐渐漂移；下次数据被接受时，位置突然"跳回"，形成锯齿状跳变；这种不稳定的位置反馈导致 Position 控制器产生错误的控制指令，进而引发 Yaw 角异常和水平位置漂移。</li></ul></li><li><strong>结论验证</strong>：<ul><li>这一关联分析图与前文对 EKF2 <code>test_ratio</code> 和参数 <code>EKF2_EV_POS_X/Y</code> 过于严格的分析结论形成完整的因果链条：<strong>EKF2 参数设置过小（<code>EKF2_EV_POS_X/Y</code> 过小） → innovation test 过于严格 → test ratio 频繁超过阈值 → 外部位置数据被拒绝 → 内部估计与对外发布位置分离 → 对外发布位置出现跳变 → Position 控制器基于错误反馈输出错误控制量 → Yaw 角异常和水平位置漂移 → 飞机在 Position 模式下出现失控漂移</strong>。</li><li>在 ALTCTL 模式下，系统对水平位置估计的依赖较弱，即使出现数据拒绝，影响也较小；但在 POSCTL 模式下，位置估计的准确性直接决定控制性能，数据拒绝导致的位置跳变会立即引发控制异常，这解释了为什么问题只在 POSCTL 模式下暴露出来。</li></ul></li></ul></li></ul><h2 id=4-问题诊断>4. 问题诊断</h2><p>基于 <code>log_284</code> 案例的可视化分析，本节系统性地讲解如何通过图表识别和诊断飞行过程中的常见问题，并提供相应的解决方案。</p><h3 id=41-位置估计异常分析>4.1 位置估计异常分析</h3><p>基于 <code>log_284</code> 案例的完整分析，位置估计异常问题具有以下典型特征：</p><ul><li><p><strong>问题症状</strong>：</p><ul><li><code>estimator_local_position</code>（EKF2 内部估计位置）与 <code>vehicle_local_position</code>（对外发布位置）出现明显偏差</li><li>X/Y 轴位置出现<strong>锯齿状跳变</strong>，位置在相邻采样之间快速来回抖动</li><li>Z 轴（高度）相对稳定，问题主要集中在水平位置（X/Y）</li><li>Yaw 角出现频繁、剧烈的瞬时反转</li><li>问题仅在 Position 模式下暴露，在 Altitude 模式下表现正常</li></ul></li><li><p><strong>诊断方法</strong>：</p><ul><li>对比 EKF2 内部估计位置与对外发布位置（见 <a href=/docsy/blog/02/25/2026/%E4%BD%BF%E7%94%A8-pyulog-%E5%88%86%E6%9E%90-px4-%E9%A3%9E%E6%8E%A7%E6%97%A5%E5%BF%97/#33-ekf2-%e5%86%85%e9%83%a8%e4%bd%8d%e7%bd%ae-vs-%e5%af%b9%e5%a4%96%e5%8f%91%e5%b8%83%e4%bd%8d%e7%bd%ae>3.3 节</a>）</li><li>分析 EKF2 test ratio 和数据拒绝事件（见 <a href=/docsy/blog/02/25/2026/%E4%BD%BF%E7%94%A8-pyulog-%E5%88%86%E6%9E%90-px4-%E9%A3%9E%E6%8E%A7%E6%97%A5%E5%BF%97/#35-test-ratio-%e4%b8%8e%e4%bd%8d%e7%bd%ae%e8%b7%b3%e5%8f%98%e5%85%b3%e8%81%94%e5%88%86%e6%9e%90>3.5 节</a>）</li><li>观察飞行模式切换与位置跳变的时间对应关系（见 <a href=/docsy/blog/02/25/2026/%E4%BD%BF%E7%94%A8-pyulog-%E5%88%86%E6%9E%90-px4-%E9%A3%9E%E6%8E%A7%E6%97%A5%E5%BF%97/#31-%e9%a3%9e%e8%a1%8c%e6%a8%a1%e5%bc%8f%e6%97%b6%e9%97%b4%e7%ba%bf>3.1 节</a>）</li><li>对比问题飞行与正常飞行的姿态角响应（见 <a href=/docsy/blog/02/25/2026/%E4%BD%BF%E7%94%A8-pyulog-%E5%88%86%E6%9E%90-px4-%E9%A3%9E%E6%8E%A7%E6%97%A5%E5%BF%97/#32-%e5%a7%bf%e6%80%81%e8%a7%92%e6%97%b6%e9%97%b4%e5%ba%8f%e5%88%97>3.2 节</a>）</li></ul></li><li><p><strong>问题原因分析</strong>（基于 log_284）：</p><ol><li><p><strong>EKF2 数据拒绝机制触发</strong>：</p><ul><li>当 <code>test_ratio > 1.0</code> 时，EKF2 拒绝外部位置数据（如视觉定位数据），只能依赖 IMU 预测</li><li>位置逐渐漂移；下次数据被接受时，位置突然"跳回"，形成锯齿状跳变</li><li>在 <code>log_284</code> 中，test ratio 峰值可达 30 以上，大部分在 5-20 之间</li></ul></li><li><p><strong>参数设置过小导致过度拒绝</strong>：</p><ul><li><code>EKF2_EV_POS_X/Y</code> 设置过小（如 0.1），导致 innovation test 过于严格</li><li>视觉数据频繁被拒绝，特别是在 Position 模式启动时和异常峰值期（35-45秒）</li><li>数据拒绝事件集中在模式切换时刻和异常峰值期，与位置跳变完全对应</li></ul></li><li><p><strong>控制回路反馈振荡</strong>：</p><ul><li>Position 模式下，位置控制器基于不稳定的位置反馈产生控制指令</li><li>位置跳变导致控制器不断尝试修正"错误"的位置，形成振荡反馈</li><li>这种振荡反馈进一步加剧了位置估计的不稳定性，形成恶性循环</li></ul></li><li><p><strong>模式依赖性问题</strong>：</p><ul><li>在 Altitude 模式下，系统对水平位置估计的依赖较弱，即使出现数据拒绝，影响也较小</li><li>在 Position 模式下，位置估计的准确性直接决定控制性能，数据拒绝导致的位置跳变会立即引发控制异常</li><li>这解释了为什么问题只在 Position 模式下暴露出来</li></ul></li></ol></li></ul><h3 id=42-解决方案>4.2 解决方案</h3><p>基于 <code>log_284</code> 案例的诊断结果，建议按照以下问题排查清单逐步检查和调整：</p><p><strong>问题排查清单</strong>：</p><ol><li><p><strong>检查并调整 EKF2 参数</strong>：</p><ul><li>检查 <code>EKF2_EV_POS_X</code> 和 <code>EKF2_EV_POS_Y</code> 的当前值，如果过小（如 0.1），建议调整到 0.3-0.5<ul><li>这些参数定义了外部位置数据（如视觉定位）的标准偏差</li><li>增大这些值可以放宽 innovation test 的严格程度，减少数据被过度拒绝的情况</li></ul></li><li>检查 <code>EKF2_EVP_GATE</code>（innovation gate 阈值），如果默认值为 3.0，可以尝试调整到 5.0<ul><li>这个参数控制 innovation test 的拒绝阈值，增大后可以减少数据拒绝</li></ul></li><li>调整后重新飞行并记录日志，检查 test ratio 是否降低，数据拒绝事件是否减少，确认位置跳变和 Yaw 角异常是否消失</li></ul></li><li><p><strong>检查外部定位数据质量</strong>：</p><ul><li>验证视觉定位数据（VRPN）的噪声水平<ul><li>检查数据转发脚本的过滤逻辑是否合理</li><li>确认数据更新频率是否在合理范围内（建议 20-50 Hz）</li><li>验证数据是否包含异常值或跳变</li></ul></li><li>优化数据预处理流程<ul><li>在数据转发脚本中添加异常值过滤</li><li>实现数据平滑滤波，减少噪声</li><li>确保数据时间戳同步准确</li></ul></li></ul></li><li><p><strong>验证传感器校准状态</strong>：</p><ul><li>重新校准 IMU（加速度计、陀螺仪）<ul><li>使用 PX4 的校准工具进行完整校准</li><li>确保传感器数据质量，减少 IMU 预测误差</li></ul></li><li>检查传感器安装情况<ul><li>确认传感器安装牢固，无松动</li><li>检查是否存在电磁干扰</li><li>验证传感器数据是否在合理范围内</li></ul></li></ul></li><li><p><strong>考虑固件和配置优化</strong>：</p><ul><li>检查是否有可用的固件升级<ul><li>考虑升级/降级 PX4 固件版本，可能包含位置处理逻辑的优化</li><li>查看固件更新日志，了解 EKF2 相关的改进</li></ul></li><li>根据实际飞行环境调整其他相关参数<ul><li><code>EKF2_AID_MASK</code>：控制哪些辅助数据源被使用</li><li><code>EKF2_HGT_MODE</code>：高度估计模式选择</li><li>根据实际飞行环境和传感器配置进行优化</li></ul></li></ul></li><li><p><strong>调整飞行策略</strong>（临时方案）：</p><ul><li>避免频繁模式切换<ul><li>在 Position 模式下保持稳定飞行，减少模式切换频率</li><li>如果必须切换，确保在 Altitude 模式下停留足够时间，让 EKF2 重新收敛</li></ul></li><li>如果问题持续存在，考虑使用其他飞行模式<ul><li>可以使用 Altitude 模式进行飞行</li><li>或者使用 Manual 模式，由飞手直接控制姿态和油门</li></ul></li></ul></li></ol><p><strong>验证和测试注意事项</strong>：</p><ul><li>每次参数调整后，先进行地面测试和短时间悬停测试</li><li>记录日志并对比调整前后的 test ratio、数据拒绝事件和位置稳定性</li><li>逐步调整参数，避免一次性大幅修改导致其他问题</li><li>参考 <code>log_287</code>（正常飞行）的参数配置，作为调整的参考基准</li></ul><h3 id=43-小结>4.3 小结</h3><p>本文档以 <code>log_284</code> 为实际案例，展示了使用 <code>pyulog</code> 库分析 PX4 飞控日志的完整流程。通过系统性的数据提取、可视化和诊断分析，成功定位了 Position 模式下位置跳变问题的根本原因。</p><p><strong>log_284 案例要点</strong>：</p><ul><li><strong>问题现象</strong>：切换到 Position 模式后，X/Y 轴出现锯齿状位置跳变，Yaw 角频繁反转</li><li><strong>根本原因</strong>：EKF2 参数（<code>EKF2_EV_POS_X/Y</code>）设置过小，导致 innovation test 过于严格，视觉数据频繁被拒绝</li><li><strong>诊断方法</strong>：通过对比 EKF2 内部估计位置与对外发布位置、分析 test ratio 和数据拒绝事件、观察飞行模式切换与异常的时间对应关系，建立了完整的因果链条</li><li><strong>解决方案</strong>：调整 <code>EKF2_EV_POS_X/Y</code>（从 0.1 调整到 0.3-0.5）和 <code>EKF2_EVP_GATE</code>（从 3.0 调整到 5.0），问题得到解决</li></ul><hr><h2 id=参考文档>参考文档</h2><ul><li><a href=https://github.com/PX4/pyulog>pyulog GitHub 仓库</a></li><li><a href=https://dev.px4.io/v1.12/en/log/ulog_file_format.html>PX4 ULog 文件格式文档</a></li><li><a href=https://docs.px4.io/main/en/log/flight_log_analysis.html>PX4 日志分析指南</a></li><li><a href=https://logs.px4.io/>Flight Review 在线日志分析工具</a></li><li><a href=https://www.plotjuggler.io/>PlotJuggler 数据可视化工具</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1d064c41083fdc82cfa08c6cf55c4fb0>基于 Pymavlink 的任务规划实现</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><h2 id=1-概述>1. 概述</h2><p>本文档使用MAVLink协议和pymavlink库进行航点发送，具有以下特点：</p><ul><li><strong>直接通信</strong>: 直接使用MAVLink协议，与QGC完全一致</li><li><strong>灵活控制</strong>: 可以精确控制消息发送和错误处理</li><li><strong>高效稳定</strong>: 直接通信，性能更好，减少潜在问题</li><li><strong>完全兼容</strong>: 支持与QGroundControl, MAVSDK-Python等应用同时使用</li></ul><h2 id=2-主要功能>2. 主要功能</h2><h3 id=21-航点管理>2.1 航点管理</h3><ul><li>标准MAVLink航点格式</li><li>支持航点参数配置（接受半径、停留时间等）</li><li>自动序列号管理</li></ul><h3 id=22-任务发送>2.2 任务发送</h3><ul><li>完整的MAVLink任务上传流程</li><li>支持任务确认和错误处理</li><li>实时进度监控</li><li><strong>多航点批量上传</strong>: 一次性上传多个航点，具有原子性</li></ul><h3 id=23-端口兼容性>2.3 端口兼容性</h3><ul><li><strong>一端口一应用</strong>: 一个UDP端口通常只能被一个应用独占接收使用</li><li><strong>多应用并行</strong>: 为每个应用分配不同端口，例如14540、14550，或自定义UDP/TCP端口</li><li><strong>示例建议</strong>: 将<code>QGroundControl</code>使用一个端口，<code>MAVSDK-Python</code>与<code>pymavlink</code>分别使用其他端口</li></ul><h4 id=连接配置>连接配置</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># QGroundControl 通常使用一个端口（示例：14540）</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># MAVSDK-Python 连接使用另一个端口（示例：14550）</span>
</span></span><span style=display:flex><span><span style=color:#000>System</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connect</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>system_address</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;udp://:14550&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pymavlink 再使用第三个端口（示例：14600，或任意未占用端口）</span>
</span></span><span style=display:flex><span><span style=color:#000>PyMAVLinkWrapper</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;drone1&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 关键点：不同应用使用不同UDP/TCP端口，避免端口冲突</span>
</span></span></code></pre></div><h4 id=实际使用场景>实际使用场景</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PX4飞控
</span></span><span style=display:flex><span>  ├─ 14540/udp ←→ QGroundControl
</span></span><span style=display:flex><span>  ├─ 14550/udp ←→ MAVSDK-Python应用
</span></span><span style=display:flex><span>  └─ 14600/udp ←→ pymavlink应用（或用户自定义端口/使用tcp）
</span></span></code></pre></div><h2 id=3-mavlink-协议流程>3. MAVLink 协议流程</h2><h3 id=31-任务上传流程>3.1 任务上传流程</h3><ol><li>发送<code>MISSION_COUNT</code>消息告知航点数量</li><li>等待飞控发送<code>MISSION_REQUEST_INT</code>或<code>MISSION_REQUEST</code>请求</li><li>根据请求类型发送对应的航点消息：<ul><li><code>MISSION_REQUEST_INT</code> → <code>MISSION_ITEM_INT</code></li><li><code>MISSION_REQUEST</code> → <code>MISSION_ITEM</code></li></ul></li><li>等待<code>MISSION_ACK</code>确认消息</li></ol><h3 id=32-多航点批量上传>3.2 多航点批量上传</h3><ul><li><strong>原子性</strong>: 所有航点要么全部成功，要么全部失败</li><li><strong>高效性</strong>: 一次连接完成所有航点上传</li><li><strong>一致性</strong>: 保证航点序列的完整性</li><li><strong>性能</strong>: 减少网络往返次数</li></ul><h3 id=33-消息类型>3.3 消息类型</h3><ul><li><code>MISSION_COUNT</code>: 任务数量</li><li><code>MISSION_REQUEST_INT</code>: 航点请求（INT格式）</li><li><code>MISSION_REQUEST</code>: 航点请求（普通格式）</li><li><code>MISSION_ITEM_INT</code>: 航点数据（INT格式）</li><li><code>MISSION_ITEM</code>: 航点数据（普通格式）</li><li><code>MISSION_ACK</code>: 任务确认</li><li><code>MISSION_CURRENT</code>: 当前航点</li></ul><h3 id=34-关键特性>3.4 关键特性</h3><ul><li><strong>异步操作</strong>: 支持异步连接和任务发送，所有方法需要使用<code>await</code>关键字</li><li><strong>双格式支持</strong>: 自动处理<code>MISSION_REQUEST</code>和<code>MISSION_REQUEST_INT</code>消息</li><li><strong>系统ID处理</strong>: 自动检测和设置系统ID和组件ID</li><li><strong>错误处理</strong>: 完善的超时和重试机制</li><li><strong>QGC兼容</strong>: 与QGroundControl完全兼容，使用相同的MAVLink消息格式</li><li><strong>灵活配置</strong>: 支持所有MAVLink航点参数</li></ul><h3 id=35-使用注意事项>3.5 使用注意事项</h3><ul><li>确保无人机已连接并GPS定位正常</li><li>检查MAVLink连接参数，默认使用<code>udp:127.0.0.1:14540</code>，可根据需要修改</li><li>必须先调用<code>await connect()</code>方法建立连接</li><li>航点坐标必须在有效范围内，高度设置要合理（避免碰撞）</li><li>接受半径要适中（避免过严导致盘旋）</li><li>大量航点（>100个）建议分批处理</li></ul><h2 id=4-航点格式>4. 航点格式</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>waypoint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;sequence&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>           <span style=color:#8f5902;font-style:italic># 序列号</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;command&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span>          <span style=color:#8f5902;font-style:italic># MAV_CMD_NAV_WAYPOINT</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;frame&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>             <span style=color:#8f5902;font-style:italic># MAV_FRAME_GLOBAL_RELATIVE_ALT</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;current&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>           <span style=color:#8f5902;font-style:italic># 是否为当前航点</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;autocontinue&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>      <span style=color:#8f5902;font-style:italic># 自动继续</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;param1&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>            <span style=color:#8f5902;font-style:italic># 停留时间</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;param2&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span>            <span style=color:#8f5902;font-style:italic># 接受半径</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;param3&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>            <span style=color:#8f5902;font-style:italic># 飞越半径</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;param4&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>            <span style=color:#8f5902;font-style:italic># 航向角</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;param5&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>lat</span><span style=color:#000;font-weight:700>,</span>          <span style=color:#8f5902;font-style:italic># 纬度</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;param6&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>lon</span><span style=color:#000;font-weight:700>,</span>          <span style=color:#8f5902;font-style:italic># 经度</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;param7&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>alt</span><span style=color:#000;font-weight:700>,</span>          <span style=color:#8f5902;font-style:italic># 高度</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#39;mission_type&#39;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span>       <span style=color:#8f5902;font-style:italic># 任务类型</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=5-mavlink-命令说明>5. MAVLink 命令说明</h2><h3 id=51-mavlink-命令参考>5.1 MAVLink 命令参考</h3><table><thead><tr><th>命令值</th><th>命令名称</th><th>说明</th><th>参数说明/使用场景</th></tr></thead><tbody><tr><td>0</td><td><code>MAV_CMD_NAV_WAYPOINT</code></td><td>空命令</td><td>占位符</td></tr><tr><td>1</td><td><code>MAV_CMD_NAV_LOITER_UNLIM</code></td><td>无限盘旋</td><td>待机、观察</td></tr><tr><td>2</td><td><code>MAV_CMD_NAV_LOITER_TURNS</code></td><td>指定圈数盘旋</td><td>精确盘旋</td></tr><tr><td>3</td><td><code>MAV_CMD_NAV_LOITER_TIME</code></td><td>指定时间盘旋</td><td>定时盘旋</td></tr><tr><td>4</td><td><code>MAV_CMD_NAV_RETURN_TO_LAUNCH</code></td><td>返回起飞点</td><td>紧急返航</td></tr><tr><td>5</td><td><code>MAV_CMD_NAV_LAND</code></td><td>降落</td><td>任务结束</td></tr><tr><td>6</td><td><code>MAV_CMD_NAV_TAKEOFF</code></td><td>起飞</td><td>任务开始</td></tr><tr><td>16</td><td><code>MAV_CMD_NAV_WAYPOINT</code></td><td>导航到航点</td><td>param1: 停留时间, param2: 接受半径, param3: 飞越半径, param4: 航向角</td></tr><tr><td>20</td><td><code>MAV_CMD_NAV_RETURN_TO_LAUNCH</code></td><td>返回起飞点</td><td>param1: 高度, param2: 空, param3: 空, param4: 空</td></tr><tr><td>21</td><td><code>MAV_CMD_NAV_LAND</code></td><td>降落</td><td>param1: 中止高度, param2: 降落方向, param3: 空, param4: 空</td></tr><tr><td>22</td><td><code>MAV_CMD_NAV_TAKEOFF</code></td><td>起飞</td><td>param1: 最小俯仰角, param2: 空, param3: 空, param4: 偏航角</td></tr><tr><td>82</td><td><code>MAV_CMD_NAV_SPLINE_WAYPOINT</code></td><td>样条航点</td><td>param1: 停留时间, param2: 接受半径, param3: 飞越半径, param4: 航向角</td></tr><tr><td>84</td><td><code>MAV_CMD_NAV_LOITER_UNLIM</code></td><td>无限盘旋</td><td>param1: 半径, param2: 空, param3: 空, param4: 空</td></tr><tr><td>85</td><td><code>MAV_CMD_NAV_LOITER_TURNS</code></td><td>指定圈数盘旋</td><td>param1: 圈数, param2: 半径, param3: 空, param4: 空</td></tr><tr><td>86</td><td><code>MAV_CMD_NAV_LOITER_TIME</code></td><td>指定时间盘旋</td><td>param1: 时间(秒), param2: 半径, param3: 空, param4: 空</td></tr></tbody></table><h3 id=52-坐标系说明>5.2 坐标系说明</h3><table><thead><tr><th>坐标系值</th><th>坐标系名称</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td>0</td><td><code>MAV_FRAME_GLOBAL</code></td><td>全球坐标系(绝对高度)</td><td>全球任务</td></tr><tr><td>1</td><td><code>MAV_FRAME_LOCAL_NED</code></td><td>本地NED坐标系</td><td>本地任务</td></tr><tr><td>2</td><td><code>MAV_FRAME_MISSION</code></td><td>任务坐标系</td><td>任务相关</td></tr><tr><td>3</td><td><code>MAV_FRAME_GLOBAL_RELATIVE_ALT</code></td><td>全球坐标系(相对高度)</td><td>推荐使用</td></tr><tr><td>4</td><td><code>MAV_FRAME_LOCAL_ENU</code></td><td>本地ENU坐标系</td><td>本地任务</td></tr><tr><td>6</td><td><code>MAV_FRAME_GLOBAL_INT</code></td><td>全球坐标系(整数格式)</td><td>高精度任务</td></tr><tr><td>7</td><td><code>MAV_FRAME_GLOBAL_RELATIVE_ALT_INT</code></td><td>全球坐标系(相对高度整数)</td><td>高精度相对高度</td></tr></tbody></table><h2 id=6-使用示例>6. 使用示例</h2><h3 id=61-安装依赖>6.1 安装依赖</h3><p>首先需要安装pymavlink库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install pymavlink
</span></span></code></pre></div><h3 id=62-基本使用---创建航点任务>6.2 基本使用 - 创建航点任务</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建发送器</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PyMAVLinkWrapper</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;drone1&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 连接到飞控</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connect</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;udp:127.0.0.1:14540&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建正方形航点任务</span>
</span></span><span style=display:flex><span><span style=color:#000>side_length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.001</span>  <span style=color:#8f5902;font-style:italic># 约100米</span>
</span></span><span style=display:flex><span><span style=color:#000>base_lat</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_lon</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_alt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>39.9042</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>116.4074</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>50.0</span>  <span style=color:#8f5902;font-style:italic># 基准位置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 第一个航点：基准位置</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>base_lat</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_lon</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_alt</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 第二个航点：向东</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>base_lat</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>side_length</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_lon</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_alt</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 第三个航点：东北</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>base_lat</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>side_length</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_lon</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>side_length</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_alt</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 第四个航点：北</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>base_lat</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_lon</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>side_length</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>base_alt</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 发送任务</span>
</span></span><span style=display:flex><span><span style=color:#000>success</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>send_mission</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><h3 id=63-高级配置>6.3 高级配置</h3><h4 id=自定义航点参数>自定义航点参数</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建发送器并连接</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PyMAVLinkWrapper</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;drone1&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connect</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;udp:127.0.0.1:14540&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 自定义航点参数</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>lat</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>39.9042</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#000>lon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>116.4074</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#000>alt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>50.0</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#000>acceptance_radius</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10</span>  <span style=color:#8f5902;font-style:italic># 接受半径10米</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h4 id=不同命令类型示例>不同命令类型示例</h4><h5 id=标准航点-mav_cmd_nav_waypoint>标准航点 (MAV_CMD_NAV_WAYPOINT)</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建发送器并连接</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PyMAVLinkWrapper</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;drone1&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connect</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;udp:127.0.0.1:14540&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 标准航点，默认命令16</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>lat</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>39.9042</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>116.4074</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>50.0</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h5 id=返回起飞点-mav_cmd_nav_return_to_launch>返回起飞点 (MAV_CMD_NAV_RETURN_TO_LAUNCH)</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 返回起飞点，命令20</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>lat</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 坐标会被忽略</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># MAV_CMD_NAV_RETURN_TO_LAUNCH</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h5 id=降落命令-mav_cmd_nav_land>降落命令 (MAV_CMD_NAV_LAND)</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 降落命令，命令21</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>lat</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>39.9042</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>116.4074</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># MAV_CMD_NAV_LAND</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>hold_time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10.0</span>  <span style=color:#8f5902;font-style:italic># 中止高度10米</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h5 id=起飞命令-mav_cmd_nav_takeoff>起飞命令 (MAV_CMD_NAV_TAKEOFF)</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 起飞命令，命令22</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>lat</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>39.9042</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>116.4074</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>50.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># MAV_CMD_NAV_TAKEOFF</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>hold_time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>15.0</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 最小俯仰角15度</span>
</span></span><span style=display:flex><span>    <span style=color:#000>yaw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>90.0</span>   <span style=color:#8f5902;font-style:italic># 偏航角90度</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h5 id=无限盘旋-mav_cmd_nav_loiter_unlim>无限盘旋 (MAV_CMD_NAV_LOITER_UNLIM)</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 无限盘旋，命令84</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>lat</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>39.9042</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>116.4074</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>50.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>84</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># MAV_CMD_NAV_LOITER_UNLIM</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>hold_time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>50.0</span>  <span style=color:#8f5902;font-style:italic># 盘旋半径50米</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h5 id=指定时间盘旋-mav_cmd_nav_loiter_time>指定时间盘旋 (MAV_CMD_NAV_LOITER_TIME)</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指定时间盘旋，命令86</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>lat</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>39.9042</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>116.4074</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>50.0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>86</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># MAV_CMD_NAV_LOITER_TIME</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>hold_time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60.0</span><span style=color:#000;font-weight:700>,</span>  <span style=color:#8f5902;font-style:italic># 盘旋时间60秒</span>
</span></span><span style=display:flex><span>    <span style=color:#000>acceptance_radius</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>30.0</span>   <span style=color:#8f5902;font-style:italic># 盘旋半径30米</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h4 id=调查任务示例>调查任务示例</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建发送器并连接</span>
</span></span><span style=display:flex><span><span style=color:#000>sender</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PyMAVLinkWrapper</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;drone1&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connect</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;udp:127.0.0.1:14540&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 调查任务 - 多航点批量上传</span>
</span></span><span style=display:flex><span><span style=color:#000>survey_waypoints</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 起飞点</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;lat&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>39.9042</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;lon&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>116.4074</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;alt&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;command&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>22</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;hold_time&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 调查点1</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;lat&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>39.9052</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;lon&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>116.4084</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;alt&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>50.0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;command&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;hold_time&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>30.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 调查点2</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;lat&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>39.9062</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;lon&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>116.4094</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;alt&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>50.0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;command&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;hold_time&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>30.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 调查点3</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;lat&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>39.9072</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;lon&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>116.4104</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;alt&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>50.0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;command&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;hold_time&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>30.0</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 返回起飞点</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;lat&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;lon&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;alt&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;command&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;hold_time&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 批量添加调查航点</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>wp</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>survey_waypoints</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add_waypoint</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>        <span style=color:#000>lat</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>wp</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;lat&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#000>lon</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>wp</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;lon&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#000>alt</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>wp</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;alt&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>wp</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;command&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#000>hold_time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>wp</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;hold_time&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>        <span style=color:#000>acceptance_radius</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5.0</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 一次性上传所有调查航点</span>
</span></span><span style=display:flex><span><span style=color:#000>success</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>await</span> <span style=color:#000>sender</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>send_mission</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><hr><h2 id=参考文档>参考文档</h2><ul><li><a href=https://docs.px4.io/main/en/flight_stack/communications/mavlink.html>PX4 MAVLink 通信概述（MAVLink on PX4）</a></li><li><a href=https://docs.qgroundcontrol.com/master/en/SettingsView/CommLinks.html>QGroundControl 通信设置（UDP 连接）</a></li><li><a href=https://mavsdk.mavlink.io/main/en/cpp/api_reference/classmavsdk_1_1_system.html#a2fc7c7d1f2a6b6baa5d2b9ed8a16b9c9>MAVSDK 连接URL格式（System.connect）</a></li><li><a href=https://www.ardusub.com/developers/pymavlink.html>pymavlink 文档与连接示例</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5850a7c933d4b43e7d209d56a7d23f90>基于 VRPN 的 PX4 EKF2 视觉融合基础调试指南</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><p>本文档<strong>不</strong>包含 <code>ROS 2</code>, <code>MAVROS</code>, <code>Gazebo</code> 等工具的基础使用方法，也没有如何安装、编译或运行这些软件的具体步骤；
而是<strong>专注于：VRPN 位姿数据是如何进入系统、在各个设备中如何被处理与融合、以及如何通过日志和脚本分析这些数据</strong>。</p><ul><li>阅读本文档默认你已经具备以下基础能力：</li><li>能够在自己的环境中安装并使用 <code>ROS 2</code>, <code>MAVROS</code> 和 <code>Gazebo</code></li><li>能够启动 <code>PX4</code> 飞控, <code>QGroundControl</code>，并、完成连接</li><li>能够运行简单的 Python 脚本和 <code>ROS</code> / <code>ROS 2</code> 节点命令</li></ul><h2 id=1-飞控的数据融合流程从-vrpn-到位置融合数据>1. 飞控的数据融合流程：从 VRPN 到位置融合数据</h2><h3 id=11-完整数据流>1.1 完整数据流</h3><p>VRPN 动捕系统的位置和姿态数据经过多个环节处理，最终融合到飞控的位置估计中。整个系统涉及三个主要设备：<strong>动捕系统</strong>，<strong>伴随计算机</strong> 和 <strong>飞控</strong>。</p><pre class=mermaid>graph TD
    subgraph 动捕系统[&#34;动捕系统设备&#34;]
        A[VRPN动捕系统&lt;br/&gt;位置和姿态测量]
    end
    
    subgraph 伴随计算机[&#34;伴随计算机&#34;]
        B[VRPN转发脚本&lt;br/&gt;get_pose.py&lt;br/&gt;数据预处理和过滤]
        C[MAVROS&lt;br/&gt;ROS与PX4通信桥梁]
    end
    
    subgraph 飞控[&#34;飞控设备&#34;]
        E[IMU传感器&lt;br/&gt;加速度计/陀螺仪]
        D[PX4 EKF2融合器&lt;br/&gt;多传感器融合]
        F[PX4位置控制器&lt;br/&gt;位置控制算法]
    end
    
    A --&gt;|1. /vrpn_mocap/drone1/pose&lt;br/&gt;PoseStamped原始数据| B
    B --&gt;|2. 数据有效性检查&lt;br/&gt;位置跳变过滤| C
    C --&gt;|3. /mavros/vision_pose/pose&lt;br/&gt;转换为MAVLink并发送给PX4| D
    E --&gt;|4. IMU原始数据| D
    D --&gt;|5. estimator_local_position&lt;br/&gt;融合后的位置估计| F
    F --&gt;|6. vehicle_local_position&lt;br/&gt;作为控制回路反馈| C
    C --&gt;|7. /mavros/local_position/pose&lt;br/&gt;提供给上层应用使用| G[外部应用&lt;br/&gt;MAVSDK/QGC等]
    
    style 动捕系统 fill:#e8f5e9,stroke:#009900,stroke-width:3px
    style 伴随计算机 fill:#fff4e1,stroke:#ff9900,stroke-width:3px
    style 飞控 fill:#e1f5ff,stroke:#0066cc,stroke-width:3px
    style D fill:#e1f5ff,stroke:#0066cc,stroke-width:3px
    style C fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    style B fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    style G fill:#fce4ec,stroke:#cc0066,stroke-width:2px</pre><p><strong>设备功能说明</strong>：</p><table><thead><tr><th>设备</th><th>运行的功能</th><th>说明</th></tr></thead><tbody><tr><td><strong>动捕系统</strong></td><td>VRPN动捕系统</td><td>提供高精度位置和姿态测量数据</td></tr><tr><td><strong>伴随计算机</strong></td><td>VRPN转发脚本</td><td>数据预处理、有效性检查、位置跳变过滤</td></tr><tr><td><strong>伴随计算机</strong></td><td>MAVROS</td><td>ROS话题与MAVLink消息转换，与飞控通信</td></tr><tr><td><strong>飞控</strong></td><td>IMU传感器</td><td>提供加速度和角速度数据（硬件）</td></tr><tr><td><strong>飞控</strong></td><td>PX4 EKF2融合器</td><td>融合VRPN和IMU数据，输出位置估计</td></tr><tr><td><strong>飞控</strong></td><td>PX4位置控制器</td><td>基于位置估计进行飞行控制</td></tr></tbody></table><h3 id=12-关键话题说明>1.2 关键话题说明</h3><table><thead><tr><th>话题名称</th><th>类型</th><th>说明</th><th>数据来源</th></tr></thead><tbody><tr><td><code>/vrpn_mocap/drone1/pose</code></td><td><code>geometry_msgs/PoseStamped</code></td><td>VRPN原始数据</td><td>VRPN动捕系统</td></tr><tr><td><code>/mavros/vision_pose/pose</code></td><td><code>geometry_msgs/PoseStamped</code></td><td>转发给PX4的VRPN数据</td><td>MAVROS</td></tr><tr><td><code>/mavros/local_position/pose</code></td><td><code>geometry_msgs/PoseStamped</code></td><td><strong>EKF2融合后的最终位置</strong></td><td>PX4 EKF2</td></tr></tbody></table><h3 id=13-视觉转发脚本>1.3 视觉转发脚本</h3><p>在伴随计算机上，需要一个“视觉转发脚本”<code>get_pose.py</code>，负责把动捕系统输出的位姿数据转换成飞控可以理解的形式，并转发给MAVROS。<br>可以简单理解为：<strong>MAVROS是 ROS ↔ PX4 的桥，而 <code>get_pose.py</code> 则是 VRPN ↔ MAVROS 的桥</strong>——负责在进入 MAVROS 之前，把视觉数据清洗、规范好。<br>其功能可以概括为：</p><ol><li>订阅动捕系统的位姿话题（例如 <code>/vrpn_mocap/drone1/pose</code>，类型为<code>geometry_msgs/PoseStamped</code>）。</li><li>检查数据有效性：过滤掉包含 NaN、无穷大或严重不合法四元数的数据。</li><li>限制位置跳变：如果相邻两帧的位置差异超过阈值（如 0.5 m），认为数据异常并丢弃。</li><li>可选：限制数据超时，如果长时间收不到新数据，则暂停转发，避免向飞控提供过期数据。</li><li>转发到MAVROS：将清洗后的位姿发布到 <code>/mavros/vision_pose/pose</code>，并将 <code>frame_id</code> 统一设为 <code>map</code> 坐标系，供飞控 EKF2 使用。</li><li>可选：记录日志，将实际转发的数据写入日志文件，方便之后用 Python 分析。</li></ol><p>下面是一个基于 <code>rospy</code> 的简化示例，展示 <code>get_pose.py</code> 的核心逻辑（省略异常处理和完整启动代码）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>rospy</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>geometry_msgs.msg</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>PoseStamped</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>math</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>VisionRelay</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>object</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>__init__</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 最大允许位置跳变（米）</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>max_position_change</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rospy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_param</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;~max_position_change&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0.5</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>last_pose</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 订阅 VRPN 动捕位姿</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sub</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rospy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Subscriber</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;/vrpn_mocap/drone1/pose&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>PoseStamped</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pose_callback</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>queue_size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 发布到 MAVROS，供飞控 EKF2 使用</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pub</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rospy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Publisher</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>            <span style=color:#4e9a06>&#34;/mavros/vision_pose/pose&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>PoseStamped</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>queue_size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_is_pose_valid</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>pose</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;检查位置和四元数是否有效&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pose</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>position</span>
</span></span><span style=display:flex><span>        <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pose</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>orientation</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 1）检查 NaN / Inf</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>v</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>z</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>z</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isnan</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>or</span> <span style=color:#000>math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isinf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 2）检查四元数近似归一化</span>
</span></span><span style=display:flex><span>        <span style=color:#000>q_norm</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sqrt</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>abs</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>q_norm</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0.1</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>_position_jump_too_large</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>new_pose</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;检查与上一帧相比是否位置跳变过大&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>last_pose</span> <span style=color:#204a87;font-weight:700>is</span> <span style=color:#204a87;font-weight:700>None</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>p1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>last_pose</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pose</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>position</span>
</span></span><span style=display:flex><span>        <span style=color:#000>p2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>new_pose</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pose</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>position</span>
</span></span><span style=display:flex><span>        <span style=color:#000>dx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>p1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span>
</span></span><span style=display:flex><span>        <span style=color:#000>dy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>p1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span>
</span></span><span style=display:flex><span>        <span style=color:#000>dz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>z</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>p1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>z</span>
</span></span><span style=display:flex><span>        <span style=color:#000>dist</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sqrt</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dx</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>dx</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dy</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>dy</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dz</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>dz</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dist</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>max_position_change</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pose_callback</span><span style=color:#000;font-weight:700>(</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>msg</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;&#34;&#34;接收 VRPN 位姿并进行过滤，再转发到 MAVROS&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_is_pose_valid</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pose</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 丢弃无效数据</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_position_jump_too_large</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic># 丢弃位置跳变过大的数据</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 通过检查，更新 last_pose</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>last_pose</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>msg</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 转发到 MAVROS，这里主动将 frame_id 规范到 \&#34;map\&#34; 坐标系</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 这样可以避免动捕系统原始 frame_id (如 \&#34;world\&#34; / 机体名等) 与 PX4/MAVROS 期望的全局坐标系不一致，</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># 方便在下游（EKF2、本地位置话题、可视化工具）中进行统一的坐标变换和调试。</span>
</span></span><span style=display:flex><span>        <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PoseStamped</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>stamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>stamp</span>
</span></span><span style=display:flex><span>        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>frame_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;map&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pose</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pose</span>
</span></span><span style=display:flex><span>        <span style=color:#3465a4>self</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pub</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>publish</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>out</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>__name__</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;__main__&#34;</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>rospy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>init_node</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;vision_relay&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>VisionRelay</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>    <span style=color:#000>rospy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>spin</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><p>无论使用 ROS1（<code>rospy</code>）还是 ROS2（<code>rclpy</code>），关键点都是：<strong>订阅 VRPN 位姿 → 进行数据过滤 → 以 <code>/mavros/vision_pose/pose</code> 的形式转发给 MAVROS</strong>，从而让飞控的 EKF2 接收到可靠的视觉位姿输入。</p><h3 id=14-px4-参数配置使用视觉imu-进行ekf2融合>1.4 PX4 参数配置：使用视觉+IMU 进行EKF2融合</h3><p>要让飞控真正使用视觉位置和高度，需要在 PX4 中正确配置 EKF2 相关参数，使其融合 External Vision（EV）和自身 IMU，并在需要时停用 GPS 融合。下面给出一个典型的配置思路（以 QGroundControl 参数界面为例）：</p><ol><li><p><strong>启用视觉位置融合（EKF2_AID_MASK）</strong></p><ul><li>在 QGC 中搜索参数 <code>EKF2_AID_MASK</code>。</li><li>确保勾选/包含：<ul><li>Vision position（视觉位置）</li><li>（可选）Vision yaw（视觉航向），如果动捕系统提供可靠的 yaw。</li></ul></li><li>如果不希望使用 GPS：取消 GPS position、GPS yaw 等相关选项，或者直接在飞控硬件上不接 GPS。</li></ul></li><li><p><strong>选择高度来源（EKF2_HGT_MODE / EKF2_EV_CTRL）</strong></p><ul><li>将 <code>EKF2_HGT_MODE</code> 设置为 Vision / External Vision（具体名称取决于 PX4 版本）。</li><li>在 <code>EKF2_EV_CTRL</code> 中启用高度相关融合选项（position + height）。</li></ul></li><li><p><strong>合理设置视觉噪声参数（EKF2_EV_POS_X / EKF2_EV_POS_Y 等）</strong></p><ul><li>在日志分析中，如果发现视觉数据经常被拒绝（test_ratio 很大），说明噪声参数过小或门限过严。</li><li>通常可以将：<ul><li><code>EKF2_EV_POS_X</code> / <code>EKF2_EV_POS_Y</code> 从 0.1 调整到 0.3–0.5。</li><li><code>EKF2_EVP_NOISE</code> 调整到与 EV_POS_X/Y 相近的数值。</li><li><code>EKF2_EVP_GATE</code> 调整到 5–7 之间，允许合理的残差。</li></ul></li></ul></li><li><p><strong>只保留需要的传感器融合</strong></p><ul><li>确保 <code>EKF2_AID_MASK</code> 中只启用你实际在用的传感器（IMU 必须，视觉按需，GPS 可停用）。</li><li>这样可以避免 EKF2 在 GPS 和视觉之间来回切换，导致位置跳变。</li></ul></li><li><p><strong>保存参数并重启飞控</strong></p><ul><li>修改完参数后，在 QGC 中保存参数并重启飞控，让新的融合配置生效。</li></ul></li></ol><p>完成以上配置后，EKF2 应当可以以 IMU 为高频预测源，以视觉位姿为慢速绝对参考，在无 GPS 的环境中完成稳定的位置和高度融合。</p><h3 id=15-ekf2融合过程>1.5 EKF2融合过程</h3><p>EKF2（Extended Kalman Filter 2）是PX4的核心融合算法，将VRPN数据与IMU数据融合：</p><pre class=mermaid>graph LR
    A[VRPN位置数据] --&gt;|External Vision| C[EKF2融合器]
    B[IMU数据] --&gt;|高频预测| C
    C --&gt;|融合算法| D[位置估计]
    D --&gt;|输出| E[local_position/pose]
    
    style C fill:#e1f5ff,stroke:#0066cc,stroke-width:3px
    style E fill:#fce4ec,stroke:#cc0066,stroke-width:2px</pre><p><strong>融合步骤</strong>：</p><ol><li><strong>IMU预测阶段</strong>：使用IMU数据（加速度计、陀螺仪）以高频（~200Hz）预测位置和姿态</li><li><strong>VRPN更新阶段</strong>：接收VRPN数据，计算innovation（预测值与测量值的差）</li><li><strong>数据有效性检查</strong>：计算test_ratio，如果超过阈值则拒绝数据</li><li><strong>状态更新</strong>：融合有效数据，更新位置和姿态估计</li></ol><h3 id=16-验证融合>1.6 验证融合</h3><p><strong>检查 <code>/mavros/local_position/pose</code> 话题输出</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查话题是否存在</span>
</span></span><span style=display:flex><span>rostopic list <span style=color:#000;font-weight:700>|</span> grep local_position
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查话题频率（应该&gt;10Hz）</span>
</span></span><span style=display:flex><span>rostopic hz /mavros/local_position/pose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看话题内容</span>
</span></span><span style=display:flex><span>rostopic <span style=color:#204a87>echo</span> /mavros/local_position/pose
</span></span></code></pre></div><p><strong>正常输出示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>header:
</span></span><span style=display:flex><span>  seq: 12345
</span></span><span style=display:flex><span>  stamp:
</span></span><span style=display:flex><span>    secs: 1234567890
</span></span><span style=display:flex><span>    nsecs: 123456789
</span></span><span style=display:flex><span>  frame_id: &#34;map&#34;
</span></span><span style=display:flex><span>pose:
</span></span><span style=display:flex><span>  position:
</span></span><span style=display:flex><span>    x: 1.234
</span></span><span style=display:flex><span>    y: 2.345
</span></span><span style=display:flex><span>    z: -0.567
</span></span><span style=display:flex><span>  orientation:
</span></span><span style=display:flex><span>    x: 0.0
</span></span><span style=display:flex><span>    y: 0.0
</span></span><span style=display:flex><span>    z: 0.0
</span></span><span style=display:flex><span>    w: 1.0
</span></span></code></pre></div><p>如果话题有正常输出且频率>10Hz，说明VRPN数据已成功融合到飞控位置信息中。<br>只要你使用 MAVROS 并持续发布：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rostopic <span style=color:#204a87>echo</span> /mavros/vision_pose/pose
</span></span></code></pre></div><p>MAVROS 会自动将其转换为 MAVLink 的 <code>VISION_POSITION_ESTIMATE</code>，在 EKF2 参数配置正确（例如 <code>EKF2_AID_MASK</code> 中启用 Vision 相关选项）的前提下，EKF2 就会融合这些视觉数据，并通过 <code>/mavros/local_position/pose</code> 话题输出。</p><h2 id=2-融合结果验证与快速排查>2. 融合结果验证与快速排查</h2><h3 id=21-使用-mavros-话题快速确认-ekf2-输出>2.1 使用 MAVROS 话题快速确认 EKF2 输出</h3><p>当怀疑 EKF2 没有正确融合 VRPN 视觉数据时，可以先用 MAVROS 话题做一个“最小自检”：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接查看局部位置输出</span>
</span></span><span style=display:flex><span>rostopic <span style=color:#204a87>echo</span> /mavros/local_position/pose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查话题频率（建议 &gt;10Hz）</span>
</span></span><span style=display:flex><span>rostopic hz /mavros/local_position/pose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看话题信息，确认发布者与消息类型</span>
</span></span><span style=display:flex><span>rostopic info /mavros/local_position/pose
</span></span></code></pre></div><p>如果 <code>/mavros/local_position/pose</code> 话题不存在、频率明显偏低，或者数据长时间不更新，说明 EKF2 融合过程存在问题，需要进一步检查 PX4 内部状态和日志。</p><p>如果 <code>/mavros/vision_pose/pose</code> 话题不存在，说明 get_pose.py 脚本运行存在问题，需要进一步检查和调试。</p><h3 id=22-检查-px4-ekf2-状态与常见失败原因>2.2 检查 PX4 EKF2 状态与常见失败原因</h3><p>PX4 内部通过 uORB 话题提供 EKF2 的详细状态与告警信息，可以直接在 ROS2 环境下查看：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看 EKF2 的时间戳信息（是否在正常更新）</span>
</span></span><span style=display:flex><span>ros2 topic <span style=color:#204a87>echo</span> /fmu/out/ekf2_timestamps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看 EKF2 估计器状态（融合标志、test_ratio 等）</span>
</span></span><span style=display:flex><span>ros2 topic <span style=color:#204a87>echo</span> /fmu/out/estimator_status
</span></span></code></pre></div><p>在 <code>estimator_status</code> 中，重点关注以下几个方面：</p><ul><li><strong>Innovation Test Ratios</strong>：各传感器的残差检验值，如果长期明显大于 1，说明该传感器数据经常被拒绝，可能存在噪声模型或数据质量问题。</li><li><strong>Control Status / Fusion Flags</strong>：哪些传感器被真正纳入融合（如 GPS、视觉位置、气压高度等），可用来确认视觉融合是否已实际启用。</li><li><strong>告警与错误信息</strong>：PX4 会通过状态位和日志给出融合失败的直接原因。</li></ul><p>常见 EKF2 融合失败原因包括：</p><ul><li>GPS 信号丢失或不稳定（但参数中仍启用 GPS 融合，导致状态在 GPS/视觉间频繁切换）。</li><li>IMU 数据异常（震动过大、传感器损坏或安装不当）。</li><li>磁力计干扰或偏差过大（航向不可靠，影响位置估计）。</li><li>参数配置错误（例如 <code>EKF2_AID_MASK</code> 未启用 Vision Position，或高度来源与实际数据来源不一致）。</li></ul><h3 id=23-结合日志与-flight-review-做进一步确认>2.3 结合日志与 Flight Review 做进一步确认</h3><p>如果通过话题和 uORB 状态仍无法快速判断问题根因，可以进一步查看 PX4 记录的 <code>.ulg</code> 日志：</p><ol><li>使用 QGroundControl 下载 <code>.ulg</code> 日志文件（参考后文“4.1 QGroundControl日志下载”）。</li><li>使用 QGroundControl 自带的日志浏览器或 Flight Review 网站打开日志。</li><li>在日志中重点查看 <code>Estimator Status / EKF2</code> 相关曲线：<ul><li><strong>Innovation Test Ratios</strong>：确认视觉位置、气压高度、IMU 等传感器的残差是否在合理范围。</li><li><strong>Control Status / Fusion Flags</strong>：确认 External Vision 是否真正被纳入融合，而不是一直处于“待用”或“拒绝”状态。</li><li><strong>Warning / Error 信息</strong>：例如 <code>GPS quality insufficient</code>，<code>Mag fusion failed</code>，<code>Bad IMU data</code> 等。</li></ul></li></ol><p>通过“话题自检 + uORB 状态 + 日志回放”这一套组合排查，可以较快定位是<strong>传感器数据本身的问题</strong>（如动捕数据不稳定、IMU 噪声过大）、<strong>参数配置错误</strong>，还是<strong>EKF2 内部对某类数据一直处于拒绝状态</strong>。</p><h2 id=3-可视化验证gazebo中的位置监控>3. 可视化验证：Gazebo中的位置监控</h2><h3 id=31-系统架构>3.1 系统架构</h3><p>使用Gazebo仿真环境和ROS2 bridge，可以实时可视化飞机的位置和姿态，对比实机位置数据与仿真显示：</p><pre class=mermaid>graph TD
    A[实机飞控] --&gt;|MAVLink| B[MAVROS]
    B --&gt;|/mavros/local_position/pose| C[ROS2 Bridge]
    C --&gt;|ROS2话题| D[Gazebo插件]
    D --&gt;|可视化| E[Gazebo场景]
    
    F[VRPN数据] --&gt;|/vrpn_mocap/drone1/pose| G[转发脚本]
    G --&gt;|/mavros/vision_pose/pose| B
    
    style E fill:#fce4ec,stroke:#cc0066,stroke-width:2px
    style C fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    style B fill:#e1f5ff,stroke:#0066cc,stroke-width:2px</pre><h3 id=33-gazebo可视化插件>3.3 Gazebo可视化插件</h3><p>创建Gazebo插件订阅飞机位置话题，在Gazebo场景中显示飞机模型：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- Gazebo模型文件示例 --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;model</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;drone1&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;pose&gt;</span>0 0 0 0 0 0<span style=color:#204a87;font-weight:700>&lt;/pose&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;static&gt;</span>false<span style=color:#204a87;font-weight:700>&lt;/static&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;plugin</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;pose_visualizer&#34;</span> <span style=color:#c4a000>filename=</span><span style=color:#4e9a06>&#34;libpose_visualizer.so&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;ros2_topic&gt;</span>/mavros/local_position/pose<span style=color:#204a87;font-weight:700>&lt;/ros2_topic&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;update_rate&gt;</span>50<span style=color:#204a87;font-weight:700>&lt;/update_rate&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/model&gt;</span>
</span></span></code></pre></div><h3 id=34-位置数据对比>3.4 位置数据对比</h3><p>在Gazebo中可以同时显示：</p><ol><li><strong>实机位置</strong>：来自<code>/mavros/local_position/pose</code>（EKF2融合后的位置）</li><li><strong>VRPN原始位置</strong>：来自<code>/vrpn_mocap/drone1/pose</code>（动捕系统原始数据）</li><li><strong>期望位置</strong>：来自位置控制器setpoint</li></ol><pre class=mermaid>graph LR
    A[实机位置&lt;br/&gt;mavros/local_position/pose] --&gt;|对比| D[Gazebo显示]
    B[VRPN原始位置&lt;br/&gt;vrpn_mocap/drone1/pose] --&gt;|对比| D
    C[期望位置&lt;br/&gt;setpoint] --&gt;|对比| D
    
    style D fill:#fce4ec,stroke:#cc0066,stroke-width:3px</pre><p><strong>观察要点</strong>：</p><ul><li><strong>位置差异</strong>：实机位置与VRPN原始位置的差异反映了EKF2融合的效果</li><li><strong>姿态差异</strong>：如果姿态显示不一致，可能是EKF2融合或IMU数据问题</li><li><strong>延迟</strong>：观察数据更新的延迟，如果延迟过大可能影响控制性能</li><li><strong>跳变</strong>：如果位置突然跳变，可能是数据过滤失效或EKF2融合异常</li></ul><h2 id=4-异常诊断使用-pyulog-库分析飞控日志>4. 异常诊断：使用 pyulog 库分析飞控日志</h2><h3 id=41-qgroundcontrol日志下载>4.1 QGroundControl日志下载</h3><p>当发现位置异常或融合问题时，需要下载飞行日志进行分析。</p><h4 id=411-连接飞控>4.1.1 连接飞控</h4><ol><li>打开QGroundControl（QGC）</li><li>通过USB或无线连接飞控</li><li>等待连接建立（状态栏显示"Connected"）</li></ol><h4 id=412-下载日志文件>4.1.2 下载日志文件</h4><pre class=mermaid>graph TD
    A[QGC连接飞控] --&gt;|连接成功| B[Vehicle Setup]
    B --&gt;|Log Files| C[查看日志列表]
    C --&gt;|选择日志| D[下载.ulg文件]
    D --&gt;|保存到本地| E[日志文件]
    
    style E fill:#e8f5e9,stroke:#009900,stroke-width:2px</pre><p><strong>操作步骤</strong>：</p><ol><li>在QGC主界面，点击左上角菜单 → <strong>Vehicle Setup</strong></li><li>选择 <strong>Log Files</strong> 标签页</li><li>查看日志列表，选择需要分析的日志（通常是最新的）</li><li>点击 <strong>Download</strong> 按钮下载</li><li>日志文件保存为<code>.ulg</code>格式</li></ol><p><strong>日志文件命名</strong>：</p><ul><li>格式：<code>log_XXX_YYYY-MM-DD-HH-MM-SS.ulg</code></li><li>例如：<code>log_287_2025-11-25-05-30-36.ulg</code></li></ul><h3 id=42-python脚本分析工具>4.2 Python脚本分析工具</h3><p>使用Python脚本解析<code>.ulg</code>文件，提取关键数据并生成可视化图表。</p><h4 id=421-安装依赖>4.2.1 安装依赖</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 安装pyulog库（用于解析.ulg文件）</span>
</span></span><span style=display:flex><span>pip install pyulog
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 安装其他依赖</span>
</span></span><span style=display:flex><span>pip install numpy matplotlib pandas
</span></span></code></pre></div><h4 id=422-基础分析脚本>4.2.2 基础分析脚本</h4><p>下面是一个简单的分析脚本示例：
从 <code>.ulg</code> 日志中读取 EKF 内部估计位置（<code>estimator_local_position</code>）和融合后对外发布的位置（<code>vehicle_local_position</code>）。<br>在一张图上绘制二者的 X/Y/Z 三轴曲线对比图并保存为PNG文件，同时在终端打印保存信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>pyulog</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>ULog</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>matplotlib.pyplot</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>plt</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 这里直接指定需要分析的 ulog 文件</span>
</span></span><span style=display:flex><span><span style=color:#000>ulog_file</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;log_284_2025-11-25-01-15-04.ulg&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从文件名中提取「ulog 编号」（例如 log_0_2025-... -&gt; log_0）</span>
</span></span><span style=display:flex><span><span style=color:#000>base_name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ulog_file</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>split</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>)[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000>ulog_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;_&#39;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>join</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>base_name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>split</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;_&#39;</span><span style=color:#000;font-weight:700>)[:</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span><span style=color:#000>output_png</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#39;</span><span style=color:#4e9a06>{</span><span style=color:#000>ulog_id</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.png&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 读取日志</span>
</span></span><span style=display:flex><span><span style=color:#000>ulog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ULog</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ulog_file</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 获取 EKF 估计位置</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>try</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>elp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ulog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_dataset</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;estimator_local_position0&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>except</span> <span style=color:#c00;font-weight:700>Exception</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>elp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ulog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_dataset</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;estimator_local_position&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 获取 vehicle_local_position</span>
</span></span><span style=display:flex><span><span style=color:#000>vlp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ulog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_dataset</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;vehicle_local_position&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 时间戳（秒）</span>
</span></span><span style=display:flex><span><span style=color:#000>t_el</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;timestamp&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>1e6</span>
</span></span><span style=display:flex><span><span style=color:#000>t_vl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>vlp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;timestamp&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>1e6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 位置数据</span>
</span></span><span style=display:flex><span><span style=color:#000>x_el</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;x&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000>y_el</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;y&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000>z_el</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;z&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>x_vl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>vlp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;x&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000>y_vl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>vlp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;y&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000>z_vl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>vlp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;z&#39;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 只做 XYZ 对比并输出图片</span>
</span></span><span style=display:flex><span><span style=color:#000>fig</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>axes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>subplots</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>figsize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>sharex</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># X</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>axes</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>plot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t_el</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>x_el</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;estimator_local_position.x&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alpha</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.7</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>plot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t_vl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>x_vl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;vehicle_local_position.x&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alpha</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.7</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>set_ylabel</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;X (m)&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>legend</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>grid</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alpha</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.3</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Y</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>axes</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>plot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t_el</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>y_el</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;estimator_local_position.y&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alpha</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.7</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>plot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t_vl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>y_vl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;vehicle_local_position.y&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alpha</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.7</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>set_ylabel</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Y (m)&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>legend</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>grid</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alpha</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.3</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Z</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>axes</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>plot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t_el</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>z_el</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;estimator_local_position.z&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alpha</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.7</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>plot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t_vl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>z_vl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;vehicle_local_position.z&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alpha</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.7</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>set_ylabel</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Z (m)&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>set_xlabel</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Time (s)&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>legend</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000>ax</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>grid</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>True</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>alpha</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0.3</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tight_layout</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>savefig</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>output_png</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>dpi</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>150</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#39;图表已保存为 </span><span style=color:#4e9a06>{</span><span style=color:#000>output_png</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>plt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>show</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><h3 id=43-执行分析>4.3 执行分析</h3><pre class=mermaid>graph TD
    A[飞行测试 / 采集数据] --&gt;|QGC下载| B[.ulg 日志文件]
    B --&gt;|Python基础分析脚本&lt;br/&gt;main.py| C[提取关键数据]
    C --&gt;|生成图表| D[位置 / 高度时间序列图]
    C --&gt;|生成图表| E[EV融合状态 / test_ratio 图]
    D --&gt;|对比| F[定位异常时间与位置跳变]
    E --&gt;|对比| F
    F --&gt;|在 Gazebo 中对比| G[实机 / VRPN / 期望轨迹可视化]
    G --&gt;|综合判断| H[确定问题原因]
    H --&gt;|调整参数 / 修改脚本| I[EKF2参数 / VRPN转发脚本 / 控制逻辑]
    I --&gt;|重新起飞并采集新日志| A
    
    style A fill:#e8f5e9,stroke:#009900,stroke-width:2px
    style B fill:#e8f5e9,stroke:#009900,stroke-width:2px
    style C fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    style D fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    style E fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    style F fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    style G fill:#e1f5ff,stroke:#0066cc,stroke-width:2px
    style H fill:#fce4ec,stroke:#cc0066,stroke-width:2px
    style I fill:#fce4ec,stroke:#cc0066,stroke-width:2px</pre><p>在图示流程中，当通过日志分析、Gazebo 可视化完成参数调整或问题修复后，<strong>应当重新回到流程起点（从新一轮飞行测试与日志采集开始）</strong>，形成闭环迭代的调试过程。</p><h3 id=44-分析调试过程案例>4.4 分析调试过程案例</h3><p>本节展示的是<strong>同一套系统在同一场景下的三轮重复测试与分析过程</strong>：每次起飞都记录 <code>.ulg</code> 日志，用前文的 Python 脚本生成三轴位置对比图，逐步调整参数与脚本，直到 <code>estimator_local_position</code> 与 <code>vehicle_local_position</code> 的 X/Y/Z 曲线基本重合。</p><h4 id=第一次测试log_284初步评估>第一次测试：log_284——初步评估</h4><p><code>log_284</code> 是该案例中的第一次测试飞行，通过 Python 分析脚本生成的三轴位置对比图如下：</p><p><img src=/Docsy/images/log_284.png alt="log_284 分析结果"></p><p>你可以下载对应的原始 <code>.ulg</code> 日志文件以便自行复现分析过程：</p><ul><li><a href=/Docsy/files/log_284_2025-11-25-01-15-04.ulg>log_284_2025-11-25-01-15-04.ulg</a></li></ul><p>在 <code>log_284</code> 中可以看到：在切换到 <code>Position</code> 模式之前，<code>estimator_local_position</code> 与 <code>vehicle_local_position</code> 的三轴曲线基本重合，XYZ 一致性良好，说明 EKF2 内部状态与对外发布的位置估计在非 <code>Position</code> 模式下工作正常。<br>当通过 QGC 将飞控切换到 <code>Position</code> 模式后，图中的 X/Y 轴曲线开始出现明显的锯齿状位置跳变，飞控开始拒绝超范围的位置输入，平面位置估计在相邻采样之间快速来回抖动，最终导致控制回路输出剧烈变化，飞机进入失控状态。</p><p><strong>问题原因分析</strong>：</p><ol><li><p><strong>Position 模式下的控制回路反馈振荡</strong>：在 <code>Position</code> 模式下，位置控制器会读取 <code>vehicle_local_position</code> 作为反馈信号，计算位置误差并生成控制指令。当位置估计不稳定时，会形成反馈循环：EKF2 内部估计（<code>estimator_local_position</code>）出现波动 → 位置控制器基于不稳定的位置反馈产生控制指令 → 控制指令导致飞机实际运动，进一步影响位置估计 → 形成振荡反馈，导致锯齿状跳变。这解释了为什么问题只在切换到 <code>Position</code> 模式后才暴露出来。</p></li><li><p><strong>EKF2 数据拒绝机制导致的间歇性跳变</strong>：EKF2 的 innovation test 会计算预测值与测量值的残差（innovation），如果 <code>test_ratio</code> 超过门限（如 <code>EKF2_EVP_GATE</code>），会拒绝该次视觉数据。视觉数据被拒绝时，EKF2 只能依赖 IMU 进行预测，位置逐渐漂移；下次视觉数据被接受时，位置突然"跳回"到正确值。这种"拒绝-接受"的切换导致位置曲线出现锯齿状跳变。在 <code>log_284</code> 中，由于视觉噪声参数（<code>EKF2_EV_POS_X/Y</code>）设置过小，视觉数据频繁被拒绝，导致锯齿状跳变非常明显。</p></li><li><p><strong>两个位置数据源的不同处理逻辑</strong>：<code>estimator_local_position</code> 是 EKF2 内部状态，相对平滑但可能有延迟；<code>vehicle_local_position</code> 是经过位置控制器和范围限制处理后的对外发布值。当 EKF2 内部估计与控制器期望不一致时，<code>vehicle_local_position</code> 可能被限制或修正，导致两者出现偏差。在 <code>log_284</code> 中，两个曲线"打架"的情况正是这种处理逻辑差异的体现。</p></li></ol><p>这一轮测试为后续调试建立了清晰的"问题基线"——<strong>问题只在 <code>Position</code> 模式下暴露，且主要集中在平面位置 X/Y 的估计质量上</strong>。</p><h4 id=第二次测试log_286参数调整>第二次测试：log_286——参数调整</h4><p>在第二次测试 <code>log_286</code> 中，在飞行前对 <code>EKF2_EV_POS_X</code>，<code>EKF2_EV_POS_Y</code> 等视觉噪声参数以及相关 innovation gate（<code>EKF2_EVP_GATE</code>）进行了调整，希望减少视觉数据被拒绝的次数，并改善 EKF2 对外发布的位置输出质量：</p><p><img src=/Docsy/images/log_286.png alt="log_286 分析结果"></p><p>对应的原始日志文件为：</p><ul><li><a href=/Docsy/files/log_286_2025-11-25-04-42-44.ulg>log_286_2025-11-25-04-42-44.ulg</a></li></ul><p>对比 <code>log_284</code> 与 <code>log_286</code> 的分析图可以看到：在切换到 <code>Position</code> 模式时，X/Y 轴上虽然依然存在大量锯齿状跳变，但 <code>estimator_local_position</code> 与 <code>vehicle_local_position</code> 在两个平面轴上的轨迹已经基本重合，不再出现前一轮测试中那种明显彼此"打架"的情况。</p><p><strong>改进原因分析</strong>：</p><p>通过调整 <code>EKF2_EV_POS_X/Y</code> 和 innovation gate（<code>EKF2_EVP_GATE</code>），减少了视觉数据被 EKF2 拒绝的频率。在 <code>log_284</code> 中，由于视觉噪声参数设置过小，EKF2 的 innovation test 频繁拒绝视觉数据，导致位置在"IMU 预测漂移"和"视觉数据跳回"之间快速切换，形成锯齿状跳变。参数调整后，虽然仍有跳变（说明问题尚未完全解决），但两个位置曲线已经基本重合，说明视觉数据被拒绝的频率显著降低，EKF2 内部状态与对外发布的位置估计已经趋于一致。</p><p>这表明视觉测量与 EKF2 内部状态本身是一致的，问题更可能来自当前 PX4 固件版本或其他高级参数配置，而不是 VRPN 数据链路或噪声模型本身。</p><h4 id=第三次测试log_287融合效果收敛>第三次测试：log_287——融合效果收敛</h4><p>第三次测试 <code>log_287</code> 展示的是在前两次测试基础上，<strong>更换 PX4 固件版本、重新配置 EKF2 相关参数并完成电机与遥控器校准之后</strong>，系统运行较为稳定的一次飞行：</p><p><img src=/Docsy/images/log_287.png alt="log_287 分析结果"></p><p>你可以下载该次飞行的日志文件进行进一步分析：</p><ul><li><a href=/Docsy/files/log_287_2025-11-25-05-30-36.ulg>log_287_2025-11-25-05-30-36.ulg</a></li></ul><p>在这次飞行中，从姿态控制到切换到 <code>Position</code> 模式的整个过程中，XYZ 三轴的 <code>estimator_local_position</code> 与 <code>vehicle_local_position</code> 曲线始终平滑且高度重合，X/Y 轴不再出现锯齿状位置跳变，<code>Position</code> 模式下飞行轨迹稳定可控，高度曲线也未出现明显漂移或突变。</p><p>通过三次测试的逐步改进，验证了问题的根本原因和解决方案：</p><ol><li><p><strong>参数调整的作用</strong>（log_286）：通过调整 <code>EKF2_EV_POS_X/Y</code> 和 innovation gate（<code>EKF2_EVP_GATE</code>），减少了视觉数据被拒绝的频率，使两个位置曲线基本重合，证明了参数配置的重要性。</p></li><li><p><strong>固件升级与完整校准的协同效果</strong>（log_287）：更换 PX4 固件版本、重新配置 EKF2 参数并完成传感器校准后，彻底消除了锯齿状跳变。这说明问题不仅来自参数配置，也可能与固件版本的位置处理逻辑有关。新固件版本可能修复了 Position 模式下的位置处理逻辑问题，或者优化了 EKF2 与位置控制器之间的接口，使得两个位置数据源能够更好地同步。</p></li><li><p><strong>控制回路反馈振荡的消除</strong>：在 <code>log_287</code> 中，由于位置估计稳定，Position 模式下的控制回路不再出现振荡反馈。位置控制器能够基于稳定的位置反馈产生平滑的控制指令，避免了锯齿状跳变。</p></li><li><p><strong>数据拒绝机制的优化</strong>：通过参数调整和固件升级，EKF2 的 innovation test 能够更准确地评估视觉数据的质量，减少了不必要的拒绝，使得位置估计更加连续和平滑。</p></li></ol><p>结合 Gazebo 可视化，对比 <code>/mavros/local_position/pose</code> 与 <code>/vrpn_mocap/drone1/pose</code> 可以看到，VRPN 融合后的整体轨迹与动捕原始轨迹保持一致。<br>通过这一个案例的三次测试与分析，可以将"日志采集 → Python 分析 → 参数/脚本调整 → 重新飞行验证"的闭环流程具体化，直到最终实现三轴位置曲线的高度重合，方便在后续调试中快速套用同样的方法。</p><hr><h2 id=参考文档>参考文档</h2><ul><li><a href=https://docs.px4.io/main/en/ros/external_position_estimation.html>PX4 User Guide - External Vision</a></li><li><a href=https://docs.px4.io/main/en/advanced_config/tuning_the_ecl_ekf.html>PX4 User Guide - EKF2 Tuning Guide</a></li><li><a href=https://github.com/mavlink/mavros>MAVROS 官方文档</a></li><li><a href=https://wiki.ros.org/rostopic>ROS 1 rostopic 命令参考</a></li><li><a href=https://docs.ros.org/en/foxy/Concepts/About-Command-Line-Tools.html>ROS 2 CLI 工具参考</a></li><li><a href=https://gazebosim.org/docs>Gazebo 官方文档</a></li><li><a href=https://github.com/vrpn/vrpn>VRPN - Virtual-Reality Peripheral Network</a></li><li><a href=https://logs.px4.io/>Flight Review 日志分析网站</a></li><li><a href=https://github.com/PX4/pyulog>pyulog GitHub 仓库</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-31c03dd6417fab4ded284383657807b4>MAVROS 与 MAVProxy：APM 平台上的使用场景、差异与取舍</h1><div class="td-byline mb-4"><time datetime=2026-02-25 class=text-body-secondary>2026年2月25日</time></div><p>本文围绕 ArduPilot/APM 飞控平台，系统梳理 MAVROS 与 MAVProxy 的定位、工作原理、典型使用场景、差异点与组合策略，并评估在不同任务形态下它们的必要性以及可替代方案。</p><pre class=mermaid>flowchart TB
  A[&#34;APM/ArduPilot 飞控&lt;br/&gt;(MAVLink)&#34;] --&gt; RP[&#34;MAVProxy（路由/桥接）&#34;]
  P[&#34;PX4 飞控&lt;br/&gt;(MAVLink)&#34;] --&gt; RR[&#34;MAVLink Router（路由）&#34;]
  RP --&gt; O(&#34;MAVLink 扇出&#34;)
  RR --&gt; O
  O --&gt; Q[&#34;QGC/地面站&#34;]
  O --&gt; S[&#34;MAVSDK 服务/后端&#34;]
  O --&gt; M
  
  %% ROS 子图（组合与数据流）
  subgraph ROS
    direction TB
    M[&#34;MAVROS&#34;]
    RA[&#34;ROS 算法/感知/规划&#34;]
    Tpub[&#34;状态/位置话题&lt;br/&gt;(/mavros/state, /local_position, /imu 等)&#34;]
    Tsub[&#34;控制/Setpoint 话题&lt;br/&gt;(/setpoint_position, /setpoint_raw 等)&#34;]
    Tsensor[&#34;传感器话题&lt;br/&gt;(IMU/里程计/相机/视觉定位)&#34;]
    
    M --&gt; Tpub
    Tpub --&gt; RA
    RA --&gt; Tsub
    Tsub --&gt; M
    Tsensor --&gt; RA
    Tsensor --&gt; M
  end
  
  %% 可选：飞控直连地面站（仅人控/参数/任务管理）
  </pre><ul><li>只需“把数据给多人看/多服务用”：用 MAVProxy（或 MAVLink Router）。</li><li>需要“在 ROS 内做算法并控制飞机”：用 MAVROS；若还要多路分发，再叠加 MAVProxy。</li><li>面向 APM 的通用稳健方案：APM → MAVLink 路由工具 →（QGC | MAVROS | MAVSDK&mldr;）。</li></ul><h2 id=1-概念>1. 概念</h2><ul><li><strong>MAVLink</strong>：飞控与外部系统之间的轻量级消息协议。消息是结构化的二进制帧，包含系统/组件 ID、消息 ID、序号、时间戳等；通过串口或 UDP/TCP 承载。关键点是“谁与谁在对话、以何种传输介质与频率对话”。</li><li><strong>APM/ArduPilot</strong>：在飞控端负责生成/消费 MAVLink 消息（心跳、状态、位置、参数、模式、任务、RCIO 等）；可配置消息流速率与输出端口。</li><li><strong>典型链路</strong>：飞控串口/UDP → 路由/桥接（可选） → 地面站/算法/服务。路由关注“扇入/扇出与可靠转发”，桥接关注“协议域间的语义映射（如 MAVLink↔ROS）”。</li></ul><h2 id=2-mavproxymavlink-路由工具>2. MAVProxy：MAVLink 路由工具</h2><h3 id=21-概念>2.1 概念</h3><ul><li><strong>定位</strong>：轻量“地面站/路由工具”。核心目标是“从一个或多个输入稳定扇出到多个输出”，不改变 MAVLink 协议语义；由 ArduPilot 官方维护。</li><li><strong>职责边界</strong>：以路由/转发为核心能力，其他能力按需启用。</li></ul><h3 id=22-工作机制>2.2 工作机制</h3><ul><li>输入（master）：显式指定串口或 UDP/TCP 源，只转发声明的输入。</li><li>输出（out）：可并行配置多个 UDP/TCP 目的端，逐帧复制转发。</li><li>流控（streamrate）：向飞控申请消息组频率；需与其他客户端协同，避免相互抢写导致抖动。</li><li>插件化：按需加载日志、地形、地理围栏、仿真辅助等模块。</li><li>功能要点：<ul><li>稳定扇出与可观测：输出目的端清晰，异常易于定位（心跳/计数异常等）。</li><li>低侵入与易部署：无需 ROS/DDS 等环境，常驻机载计算机做统一扇出。</li><li>直接交互飞控：读写参数、切换模式、解锁/上锁。</li><li>任务/航点：任务上传下载与流程管理。</li><li>速率管理：统一申请与调整消息组频率，控制链路负载。</li><li>日志记录：事件/日志输出，便于复现与追踪。</li><li>地理与仿真：地理围栏、地形数据、SITL/联调辅助。</li></ul></li></ul><blockquote><p>注意：关于 QGC 的 MAVLink 转发</p><p>QGC 的“MAVLink 转发”仅会将“QGC 接收到的 MAVLink 帧”单向转发到目标地址；它不会把来自该目标地址的控制/参数写入等指令再回送给飞控。因此，经由 QGC 转发链路发送控制命令通常会因无法到达飞控而超时。若需要可控的双向链路，请在飞控侧或近端使用 MAVProxy、MAVLink Router 等路由工具建立端到端会话。</p></blockquote><h3 id=23-典型使用场景>2.3 典型使用场景</h3><ul><li>多下游并发：同一飞控流同时提供给 QGC、MAVSDK 服务、日志录制、状态监控。</li><li>网络解耦：在不改飞控输出的前提下，本机扇出多路流。</li><li>安全隔离：结合端口控制与防火墙/ACL 管控可达范围。</li><li>多飞控集中接入：一台伴随计算机统一接入多块飞控，集中扇出与会话管理。</li><li>蜂群/编队分发：为编队提供稳定的遥测与指令分发通道，易于规模化监控。</li><li>异构链路聚合：串口/UDP/蜂窝/以太网等多链路统一转发与限流。</li><li>伴随端常驻：作为“入口与分发”常驻机载，向地面站、算法、日志稳定供数。</li><li>诊断与复现：配合日志/事件与可观测性指标，快速定位断流、环路与高负载。</li></ul><h3 id=24-优势与局限>2.4 优势与局限</h3><ul><li>优势：简单可靠、部署门槛低、与 APM 生态契合度高、职责边界清晰。</li><li>局限：无语义映射与高层控制 API；需配合其他组件完成算法/定位/融合。</li></ul><h3 id=25-mavproxy-与-px4>2.5 MAVProxy 与 PX4</h3><ul><li>MAVProxy 是基于 MAVLink 协议层的路由/地面站工具，由 ArduPilot 社区维护；并非 APM 专属。任何产出/消费 MAVLink 的系统（APM、PX4、SITL、外设网关等）都可接入与转发。</li><li>PX4 官方推荐在机载计算机侧采用其自有框架与工具链进行路由/桥接，例如 MAVLink Router（推荐）或基于 microROS/uXRCE-DDS 的通信栈，而非 MAVProxy。本推荐见 PX4 官方“机载电脑”文档。</li><li>MAVProxy 能够稳定转发 PX4 的遥测与指令流；实际工程中仍应优先评估 PX4 推荐方案，只有在需要命令行交互、插件生态与现场诊断等特性时再考虑使用 MAVProxy。</li><li>建议：<ul><li>以 PX4 官方支持路径、长期维护与系统服务形态为优先：倾向 MAVLink Router 或 uXRCE-DDS。</li><li>需要命令行交互、插件能力与快速诊断：可选 MAVProxy（注意协调 SYSID/COMPID、速率与签名/隔离策略）。</li></ul></li><li>注意：对 PX4 而言，MAVProxy“可用但非官方推荐/非必要”；对 APM 生态契合度最高，但并非唯一可选的路由工具。</li></ul><h2 id=3-mavrosrosmavlink>3. MAVROS：ROS↔MAVLink</h2><h3 id=31-概念>3.1 概念</h3><ul><li>MAVROS 是 ROS 的一个软件包，用于在 ROS 与支持 MAVLink 的飞控之间进行通信与语义映射；是连接 ROS 与 PX4/APM 的关键桥梁，使开发者可直接在 ROS 中以话题/服务的形式使用飞控能力。</li><li>若不使用 MAVROS，开发者需自行解析 MAVLink 并构建框架，无法复用 ROS 的大量工具链与第三方算法生态；使用 MAVROS 可显著降低集成成本与学习曲线。</li></ul><h3 id=32-工作机制>3.2 工作机制</h3><ul><li>插件化：如 state、setpoint_position、setpoint_raw、global_position、param、cmd 等，分别负责子域消息的解码、校验与发布/订阅。</li><li>语义映射：将 MAVLink 原语映射为 ROS 常用消息类型（geometry_msgs、sensor_msgs 等）。</li><li>控制与时间/坐标：提供 Offboard 控制接口；可启用时间同步与 TF/外参管理以保证闭环稳定。</li></ul><h3 id=33-典型使用场景>3.3 典型使用场景</h3><ul><li>Offboard/伴随计算：在 ROS 中执行路径规划、轨迹跟踪、任务编排，通过 setpoint 接口控制飞控。</li><li>传感器/定位融合：将里程计/SLAM/视觉定位等结果映射到飞控或用于外环控制。</li><li>仿真闭环：在 Gazebo/Ignition 等仿真环境中与 PX4/APM 形成闭环，快速迭代算法与任务逻辑。</li></ul><h3 id=34-优势与局限>3.4 优势与局限</h3><ul><li>优势：强语义桥接、算法栈与工具链丰富、成熟的 Offboard 接口与可视化支持（RViz、rqt 等）。</li><li>局限：引入 ROS 运行时的资源与复杂度；需管理话题队列、调度与时延；多客户端需协调参数写入与消息速率，避免竞争。</li></ul><h3 id=35-mavros-与-px4apm>3.5 MAVROS 与 PX4/APM</h3><ul><li>同时支持 PX4 与 APM，是两者与 ROS 之间的主流桥接路径之一。</li><li>在 PX4 侧，亦可选用 uXRCE-DDS（ROS2）等官方通信路径；选择取决于算法栈与系统架构。</li><li>与 MAVProxy 的关系：二者互补。常见组合为“APM/PX4 → 路由（MAVProxy/Router）→ MAVROS/算法栈”。</li></ul><h2 id=4-场景对比与实践策略>4. 场景对比与实践策略</h2><ul><li><strong>定位差异</strong>：<ul><li>MAVProxy：面向链路与路由，最小可行转发；不改变消息语义。</li><li>MAVROS：面向算法与应用，完成协议域到 ROS 域的语义投射与控制接口。</li></ul></li><li><strong>部署复杂度</strong>：MAVProxy &lt; MAVROS（需要 ROS 运行时与插件管理）。</li><li><strong>资源占用</strong>：MAVProxy 轻；MAVROS 随插件与话题规模增长。</li><li><strong>实时性/时延</strong>：<ul><li>路由层（MAVProxy）时延极低，主要受网络与系统负载影响。</li><li>ROS 桥接（MAVROS）受调度、话题队列、时间同步影响，需工程化调优（CPU 亲和、QoS/队列深度、发布频率）。</li></ul></li><li><strong>容错与观测</strong>：<ul><li>MAVProxy 输出侧可快速定位断流或下游异常。</li><li>MAVROS 通过 ROS 工具链（rqt、roswtf、tf 树）进行问题定位，粒度更细但系统更复杂。</li></ul></li></ul><h3 id=41-使用建议>4.1 使用建议</h3><ul><li><strong>何时用 MAVProxy</strong>：<ul><li>需要“把飞控数据转给若干消费方”，且无 ROS 依赖。</li><li>需要在机载端稳定地“一个输入、多输出”扇出，减少对飞控端改动。</li></ul></li><li><strong>何时用 MAVROS</strong>：<ul><li>主要运行环境在 ROS 内：路径规划、定位融合、任务执行、仿真闭环等。</li><li>不需要对外再扇出多条原始 MAVLink 流，或扇出可由 ROS 内部其他方式满足。</li></ul></li><li><strong>何时组合使用</strong>：<ul><li>在机载端用 MAVProxy 统一从飞控读取并扇出：一支给 QGC/监控，另一支给本机或远端的 MAVROS/算法栈。</li><li>这样可以把“链路可用性/端口安全”与“算法语义处理”解耦，减少相互干扰。</li></ul></li></ul><h3 id=42-可替代互补方案对比>4.2 可替代/互补方案对比</h3><ul><li><strong>MAVLink Router（mavlink-routerd）</strong>：<ul><li>职能与 MAVProxy 的“路由/扇出”类似，C 实现，资源占用更低，配置文件式管理，常见于 PX4，但同样适用 ArduPilot。</li><li>优点：性能优、守护进程形态、基于规则的管控；缺点：交互/调试能力不如 MAVProxy 命令行直观。</li></ul></li><li><strong>MAVSDK / MAVSDK-Server</strong>：<ul><li>面向应用开发的高层 API（C++/Python/Go 等），便于快速构建控制/任务逻辑。</li><li>与 MAVProxy/MAVROS 并不冲突：常见架构是“APM→路由→MAVSDK、QGC 等并列消费”。</li></ul></li><li><strong>cmavnode / 自研网关</strong>：<ul><li>轻量桥接/转发工具；适合极小型系统或定制需求，但生态/文档沉淀一般。</li></ul></li><li><strong>直接地面站（QGC/Mission Planner）</strong>：<ul><li>仅人控与参数/任务管理时可以直连；不解决“多消费者并发”“程序化接口”问题。</li></ul></li></ul><h3 id=43-工程选择建议>4.3 工程选择建议</h3><ul><li>若主要诉求是“稳定扇出”与“运维可控”，首选 MAVProxy 或 MAVLink Router（择其一）。</li><li>若主要诉求是“ROS 内算法闭环”，首选 MAVROS；是否叠加路由视是否有多消费者与安全隔离需求而定。</li></ul><h2 id=5-项目实践的思考>5. 项目实践的思考</h2><ul><li><strong>链路梳理</strong>：明确输入端（串口/UDP 单播/广播）、下游清单（QGC、服务、算法端）。</li><li><strong>频率与带宽</strong>：<ul><li>统一在路由侧申请/调整流速，避免多个客户端抢写导致消息抖动。</li><li>关注高频消息（姿态/位置/IMU），在无线链路下控制总体带宽与丢包敏感度。</li></ul></li><li><strong>ID 与签名</strong>：<ul><li>多客户端写参数/控制时，确保系统/组件 ID 唯一；在需要时启用 MAVLink 签名与网络隔离。</li></ul></li><li><strong>资源与实时性</strong>：<ul><li>在机载电脑上为路由与关键节点设定 CPU 亲和与优先级，保持时延稳定。</li></ul></li><li><strong>可观测性与排障</strong>：<ul><li>路由侧：定期检查下游端口存活状态、丢包与心跳计数；</li><li>ROS 侧：关注时间同步、话题队列、TF 树一致性与控制回路频率。</li></ul></li></ul><hr><h2 id=参考文档>参考文档</h2><ul><li><a href=http://wiki.ros.org/mavros>MAVROS 官方文档</a></li><li><a href=https://ardupilot.org/>ArduPilot 官方文档</a></li><li><a href=https://docs.qgroundcontrol.com/>QGroundControl 用户指南</a></li><li><a href=https://mavlink.io/>MAVLink 协议规范</a></li><li><a href=https://ardupilot.org/mavproxy/>MAVProxy 文档（ArduPilot）</a></li><li><a href=https://docs.px4.io/main/zh/companion_computer/>PX4 机载电脑（官方推荐路由：MAVLink Router / uXRCE-DDS）</a></li><li><a href=https://blog.csdn.net/lida2003/article/details/132171884>ArduPilot 开源飞控之 MAVProxy 简介（应用拓扑与多机场景）</a></li><li><a href=https://blog.csdn.net/qq_35598561/article/details/131281266>MAVROS 和 MAVLink 的关联与区别（CSDN）</a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Mail aria-label=Mail><a target=_blank rel=noopener href=/about/ aria-label=Mail><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Wechat aria-label=Wechat><a target=_blank rel=noopener href=/about/ aria-label=Wechat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=QQ aria-label=QQ><a target=_blank rel=noopener href=/about/ aria-label=QQ><i class="fab fa-qq"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Wallhaven aria-label=Wallhaven><a target=_blank rel=noopener href=https://wallhaven.cc/user/Zero-kq/favorites/1954116 aria-label=Wallhaven><i class="fa fa-image"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Docsy & Template" aria-label="Docsy & Template"><a target=_blank rel=noopener href=https://github.com/google/docsy aria-label="Docsy & Template"><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Docsy Authors | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=https://policies.google.com/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/docsy/js/main.min.b540f305b126afbbf8653419bb091d1c388e5adc77b849e8a878766c4de19b67.js integrity="sha256-tUDzBbEmr7v4ZTQZuwkdHDiOWtx3uEnoqHh2bE3hm2c=" crossorigin=anonymous></script><script defer src=/docsy/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/docsy/js/tabpane-persist.js></script></body></html>