<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/docsy/favicons/favicon.ico><link rel=apple-touch-icon href=/docsy/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/docsy/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/docsy/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/docsy/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/docsy/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/docsy/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/docsy/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/docsy/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/docsy/favicons/android-192x192.png sizes=192x192><title>在 QGC 和 大模型 FastAPI 后端实现的端到端无人机语音指令框架 | Zerokq</title>
<meta name=description content="基于 QGroundControl、FastAPI 与大模型构建无人机语音指令链路，从前端录音到后端智能体控制的完整实现说明。"><meta property="og:url" content="https://Zero-Kq.github.io/docsy/blog/02/25/2026/%E5%9C%A8-qgc-%E5%92%8C-%E5%A4%A7%E6%A8%A1%E5%9E%8B-fastapi-%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0%E7%9A%84%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%AF%AD%E9%9F%B3%E6%8C%87%E4%BB%A4%E6%A1%86%E6%9E%B6/"><meta property="og:site_name" content="Zerokq"><meta property="og:title" content="在 QGC 和 大模型 FastAPI 后端实现的端到端无人机语音指令框架"><meta property="og:description" content="基于 QGroundControl、FastAPI 与大模型构建无人机语音指令链路，从前端录音到后端智能体控制的完整实现说明。"><meta property="og:locale" content="cn"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-12-02T00:00:00+00:00"><meta property="article:modified_time" content="2026-02-25T15:18:48+08:00"><meta property="article:tag" content="QGroundControl"><meta property="article:tag" content="MAVLink"><meta property="article:tag" content="地面站"><meta property="article:tag" content="大模型"><meta property="article:tag" content="Python"><meta property="article:tag" content="前端"><meta itemprop=name content="在 QGC 和 大模型 FastAPI 后端实现的端到端无人机语音指令框架"><meta itemprop=description content="基于 QGroundControl、FastAPI 与大模型构建无人机语音指令链路，从前端录音到后端智能体控制的完整实现说明。"><meta itemprop=datePublished content="2025-12-02T00:00:00+00:00"><meta itemprop=dateModified content="2026-02-25T15:18:48+08:00"><meta itemprop=wordCount content="9585"><meta itemprop=keywords content="QGroundControl,MAVLink,地面站,大模型,Python,前端,后端,C++,Qt,无人机,任务规划"><meta name=twitter:card content="summary"><meta name=twitter:title content="在 QGC 和 大模型 FastAPI 后端实现的端到端无人机语音指令框架"><meta name=twitter:description content="基于 QGroundControl、FastAPI 与大模型构建无人机语音指令链路，从前端录音到后端智能体控制的完整实现说明。"><link rel=preload href=/docsy/scss/main.min.b3c5d5b5e4fe744101b7961318bcd54d586465cd4abf620f17de0fb0b88e151b.css as=style integrity="sha256-s8XVteT+dEEBt5YTGLzVTVhkZc1Kv2IPF94PsLiOFRs=" crossorigin=anonymous><link href=/docsy/scss/main.min.b3c5d5b5e4fe744101b7961318bcd54d586465cd4abf620f17de0fb0b88e151b.css rel=stylesheet integrity="sha256-s8XVteT+dEEBt5YTGLzVTVhkZc1Kv2IPF94PsLiOFRs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/docsy/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 640 640"><path d="M304 70.1C313.1 61.9 326.9 61.9 336 70.1l232 208C577.9 286.9 578.7 302.1 569.8 312 560.9 321.9 545.8 322.7 535.9 313.8L527.9 306.6V511.9c0 35.3000000000001-28.7 64-64 64h-288c-35.3.0-64-28.6999999999999-64-64V306.6L103.9 313.8C94 322.6 78.9 321.8 70 312 61.1 302.2 62 287 71.8 278.1L304 70.1zm16 50.1L160 263.7V512C160 520.8 167.2 528 176 528h48V424c0-39.8 32.2-72 72-72h48c39.8.0 72 32.2 72 72V528h48C472.8 528 480 520.8 480 512V263.7L320 120.3zM272 528h96V424c0-13.3-10.7-24-24-24H296c-13.3.0-24 10.7-24 24V528z"/></svg></span><span class=navbar-brand__name>Zerokq</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docsy/about/><span>关于</span></a></li><li class=nav-item><a class=nav-link href=/docsy/docs/><span>说明</span></a></li><li class=nav-item><a class="nav-link active" href=/docsy/blog/><span>博客</span></a></li><li class=nav-item><a class=nav-link href=/docsy/reviews/><span>读后感</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>中文(Chinese)</a><ul class=dropdown-menu><li><a class=dropdown-item href=/docsy/en/>English</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=搜索 aria-label=搜索 autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=搜索 aria-label=搜索 autocomplete=off></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><div class="td-sidebar-nav__section nav-item dropdown d-block d-lg-none"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>中文(Chinese)</a><ul class=dropdown-menu><li><a class=dropdown-item href=/docsy/en/>English</a></li></ul></div></div><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsyblog-li><a href=/docsy/blog/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docsyblog><span>博客</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsyblogaircraft-simulation-li><a href=/docsy/blog/aircraft-simulation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsyblogaircraft-simulation><span>Aircraft Simulation</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026airsim--px4-sitl--mavsdk-e7b3bbe7bb9fe99b86e68890e8b8a9e59d91e8aeb0e5bd95-li><a href=/docsy/blog/02/25/2026/airsim--px4-sitl--mavsdk-%E7%B3%BB%E7%BB%9F%E9%9B%86%E6%88%90%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026airsim--px4-sitl--mavsdk-e7b3bbe7bb9fe99b86e68890e8b8a9e59d91e8aeb0e5bd95><span>Airsim + PX4 SITL + MAVSDK 系统集成踩坑记录</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026airsim-agent-e5a4a7e6a8a1e59e8be9a9b1e58aa8e697a0e4babae69cba-li><a href=/docsy/blog/02/25/2026/airsim-agent-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E9%A9%B1%E5%8A%A8%E6%97%A0%E4%BA%BA%E6%9C%BA/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026airsim-agent-e5a4a7e6a8a1e59e8be9a9b1e58aa8e697a0e4babae69cba><span>AirSim Agent 大模型驱动无人机</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026airsim-e7bc96e8af91e697b6-unrealbuildtool-e8b7afe5be84e99499e8afafe997aee9a298e8a7a3e586b3e696b9e6a188-li><a href=/docsy/blog/02/25/2026/airsim-%E7%BC%96%E8%AF%91%E6%97%B6-unrealbuildtool-%E8%B7%AF%E5%BE%84%E9%94%99%E8%AF%AF%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026airsim-e7bc96e8af91e697b6-unrealbuildtool-e8b7afe5be84e99499e8afafe997aee9a298e8a7a3e586b3e696b9e6a188><span>AirSim 编译时 UnrealBuildTool 路径错误问题解决方案</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e59ca8-linux-e4b88ae4bdbfe794a8-epic-asset-manager-e7aea1e79086-ue-e8b584e6ba90e5ba93-li><a href=/docsy/blog/02/25/2026/%E5%9C%A8-linux-%E4%B8%8A%E4%BD%BF%E7%94%A8-epic-asset-manager-%E7%AE%A1%E7%90%86-ue-%E8%B5%84%E6%BA%90%E5%BA%93/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e59ca8-linux-e4b88ae4bdbfe794a8-epic-asset-manager-e7aea1e79086-ue-e8b584e6ba90e5ba93><span>在 Linux 上使用 Epic Asset Manager 管理 UE 资源库</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsyblogandroid-li><a href=/docsy/blog/android/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsyblogandroid><span>Android</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e4bdbfe794a8-termux-e59ca8-android-e8bf90e8a18c-python-e6ba90e7a081-li><a href=/docsy/blog/02/25/2026/%E4%BD%BF%E7%94%A8-termux-%E5%9C%A8-android-%E8%BF%90%E8%A1%8C-python-%E6%BA%90%E7%A0%81/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e4bdbfe794a8-termux-e59ca8-android-e8bf90e8a18c-python-e6ba90e7a081><span>使用 Termux 在 Android 运行 Python 源码</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e59ca8-ubuntu-e4bdbfe794a8-scrcpy-e8bf9be8a18c-android-e6a18ce99da2e8b083e8af95-li><a href=/docsy/blog/02/25/2026/%E5%9C%A8-ubuntu-%E4%BD%BF%E7%94%A8-scrcpy-%E8%BF%9B%E8%A1%8C-android-%E6%A1%8C%E9%9D%A2%E8%B0%83%E8%AF%95/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e59ca8-ubuntu-e4bdbfe794a8-scrcpy-e8bf9be8a18c-android-e6a18ce99da2e8b083e8af95><span>在 Ubuntu 使用 scrcpy 进行 Android 桌面调试</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsyblogbackend-li><a href=/docsy/blog/backend/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsyblogbackend><span>Backend</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02262026e7bbb4e5a49ae588a9e4ba9a3-e68898e4ba89e8b594e6acbee681b6e5908de4bc98e58c96mod-li><a href=/docsy/blog/02/26/2026/%E7%BB%B4%E5%A4%9A%E5%88%A9%E4%BA%9A3-%E6%88%98%E4%BA%89%E8%B5%94%E6%AC%BE%E6%81%B6%E5%90%8D%E4%BC%98%E5%8C%96mod/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02262026e7bbb4e5a49ae588a9e4ba9a3-e68898e4ba89e8b594e6acbee681b6e5908de4bc98e58c96mod><span>维多利亚3 战争赔款恶名优化mod</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e5ad97e88a82e5ba8fe997aee9a298e8af8ae696ade4b88ee5a484e79086qtc-e5928c-python-e4b8ade79a84e7bd91e7bb9ce9809ae4bfa1e5ae9ee8b7b5-li><a href=/docsy/blog/02/25/2026/%E5%AD%97%E8%8A%82%E5%BA%8F%E9%97%AE%E9%A2%98%E8%AF%8A%E6%96%AD%E4%B8%8E%E5%A4%84%E7%90%86qtc-%E5%92%8C-python-%E4%B8%AD%E7%9A%84%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%AE%9E%E8%B7%B5/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e5ad97e88a82e5ba8fe997aee9a298e8af8ae696ade4b88ee5a484e79086qtc-e5928c-python-e4b8ade79a84e7bd91e7bb9ce9809ae4bfa1e5ae9ee8b7b5><span>字节序问题诊断与处理：Qt、C++ 和 Python 中的网络通信实践</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02262026e7a88be5ba8fe997b4e99d9ee4beb5e585a5e5bc8fe689a9e5b195e69eb6e69e84hekilihelper-e6a188e4be8be7a094e7a9b6-li><a href=/docsy/blog/02/26/2026/%E7%A8%8B%E5%BA%8F%E9%97%B4%E9%9D%9E%E4%BE%B5%E5%85%A5%E5%BC%8F%E6%89%A9%E5%B1%95%E6%9E%B6%E6%9E%84hekilihelper-%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02262026e7a88be5ba8fe997b4e99d9ee4beb5e585a5e5bc8fe689a9e5b195e69eb6e69e84hekilihelper-e6a188e4be8be7a094e7a9b6><span>程序间非侵入式扩展架构：HekiliHelper 案例研究</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsyblogdev-tools-li><a href=/docsy/blog/dev-tools/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsyblogdev-tools><span>Dev Tools</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02262026markdown-e8bdac-pdf-e58aa0e6b0b4e58db0e5b7a5e585b7-li><a href=/docsy/blog/02/26/2026/markdown-%E8%BD%AC-pdf-%E5%8A%A0%E6%B0%B4%E5%8D%B0%E5%B7%A5%E5%85%B7/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02262026markdown-e8bdac-pdf-e58aa0e6b0b4e58db0e5b7a5e585b7><span>Markdown 转 PDF 加水印工具</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e4bdbfe794a8-whisper-tiny-e6a8a1e59e8be5ae9ee78eb0e5bfabe9809fe8afade99fb3e8bdace69687e5ad97python-e983a8e7bdb2e4b88ee5ae9ee8b7b5e68c87e58d97-li><a href=/docsy/blog/02/25/2026/%E4%BD%BF%E7%94%A8-whisper-tiny-%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0%E5%BF%AB%E9%80%9F%E8%AF%AD%E9%9F%B3%E8%BD%AC%E6%96%87%E5%AD%97python-%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e4bdbfe794a8-whisper-tiny-e6a8a1e59e8be5ae9ee78eb0e5bfabe9809fe8afade99fb3e8bdace69687e5ad97python-e983a8e7bdb2e4b88ee5ae9ee8b7b5e68c87e58d97><span>使用 Whisper Tiny 模型实现快速语音转文字：Python 部署与实践指南</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e4bdbfe794a8fuck-u-codee4bc98e58c96e4bba3e7a081e8b4a8e9878f-li><a href=/docsy/blog/02/25/2026/%E4%BD%BF%E7%94%A8fuck-u-code%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e4bdbfe794a8fuck-u-codee4bc98e58c96e4bba3e7a081e8b4a8e9878f><span>使用fuck-u-code优化代码质量</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e59ca8-linux-e4b8ade4bdbfe794a8-ventoy-e588b6e4bd9c-windows-e590afe58aa8e79b98-li><a href=/docsy/blog/02/25/2026/%E5%9C%A8-linux-%E4%B8%AD%E4%BD%BF%E7%94%A8-ventoy-%E5%88%B6%E4%BD%9C-windows-%E5%90%AF%E5%8A%A8%E7%9B%98/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e59ca8-linux-e4b8ade4bdbfe794a8-ventoy-e588b6e4bd9c-windows-e590afe58aa8e79b98><span>在 Linux 中使用 Ventoy 制作 Windows 启动盘</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsyblogfrontend-li><a href=/docsy/blog/frontend/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsyblogfrontend><span>Frontend</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e887aae5ae9ae4b989-nicegui-e4b8ad-leaflet-e79a84-marker-e6a0b7e5bc8fe5928ce6978be8bdac-li><a href=/docsy/blog/02/25/2026/%E8%87%AA%E5%AE%9A%E4%B9%89-nicegui-%E4%B8%AD-leaflet-%E7%9A%84-marker-%E6%A0%B7%E5%BC%8F%E5%92%8C%E6%97%8B%E8%BD%AC/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e887aae5ae9ae4b989-nicegui-e4b8ad-leaflet-e79a84-marker-e6a0b7e5bc8fe5928ce6978be8bdac><span>自定义 NiceGUI 中 Leaflet 的 marker 样式和旋转</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsyblogmavlink--fcu-li><a href=/docsy/blog/mavlink--fcu/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsyblogmavlink--fcu><span>MAVLink & FCU</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026mavlink-router-e5ae89e8a385e4b88ee4bdbfe794a8e68c87e58d97-li><a href=/docsy/blog/02/25/2026/mavlink-router-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026mavlink-router-e5ae89e8a385e4b88ee4bdbfe794a8e68c87e58d97><span>MAVLink Router-安装与使用指南</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026wsl2-e78eafe5a283e4b88b-px4-sitl-e5a49ae7abafe58fa3-mavlink-e9858de7bdaee68c87e58d97-li><a href=/docsy/blog/02/25/2026/wsl2-%E7%8E%AF%E5%A2%83%E4%B8%8B-px4-sitl-%E5%A4%9A%E7%AB%AF%E5%8F%A3-mavlink-%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026wsl2-e78eafe5a283e4b88b-px4-sitl-e5a49ae7abafe58fa3-mavlink-e9858de7bdaee68c87e58d97><span>WSL2 环境下 PX4 SITL 多端口 MAVLink 配置指南</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e4bdbfe794a8-pyulog-e58886e69e90-px4-e9a39ee68ea7e697a5e5bf97-li><a href=/docsy/blog/02/25/2026/%E4%BD%BF%E7%94%A8-pyulog-%E5%88%86%E6%9E%90-px4-%E9%A3%9E%E6%8E%A7%E6%97%A5%E5%BF%97/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e4bdbfe794a8-pyulog-e58886e69e90-px4-e9a39ee68ea7e697a5e5bf97><span>使用 pyulog 分析 PX4 飞控日志</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e59fbae4ba8e-pymavlink-e79a84e4bbbbe58aa1e8a784e58892e5ae9ee78eb0-li><a href=/docsy/blog/02/25/2026/%E5%9F%BA%E4%BA%8E-pymavlink-%E7%9A%84%E4%BB%BB%E5%8A%A1%E8%A7%84%E5%88%92%E5%AE%9E%E7%8E%B0/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e59fbae4ba8e-pymavlink-e79a84e4bbbbe58aa1e8a784e58892e5ae9ee78eb0><span>基于 Pymavlink 的任务规划实现</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e59fbae4ba8e-vrpn-e79a84-px4-ekf2-e8a786e8a789e89e8de59088e59fbae7a180e8b083e8af95e68c87e58d97-li><a href=/docsy/blog/02/25/2026/%E5%9F%BA%E4%BA%8E-vrpn-%E7%9A%84-px4-ekf2-%E8%A7%86%E8%A7%89%E8%9E%8D%E5%90%88%E5%9F%BA%E7%A1%80%E8%B0%83%E8%AF%95%E6%8C%87%E5%8D%97/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e59fbae4ba8e-vrpn-e79a84-px4-ekf2-e8a786e8a789e89e8de59088e59fbae7a180e8b083e8af95e68c87e58d97><span>基于 VRPN 的 PX4 EKF2 视觉融合基础调试指南</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026mavros-e4b88e-mavproxyapm-e5b9b3e58fb0e4b88ae79a84e4bdbfe794a8e59cbae699afe5b7aee5bc82e4b88ee58f96e8888d-li><a href=/docsy/blog/02/25/2026/mavros-%E4%B8%8E-mavproxyapm-%E5%B9%B3%E5%8F%B0%E4%B8%8A%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%E5%B7%AE%E5%BC%82%E4%B8%8E%E5%8F%96%E8%88%8D/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026mavros-e4b88e-mavproxyapm-e5b9b3e58fb0e4b88ae79a84e4bdbfe794a8e59cbae699afe5b7aee5bc82e4b88ee58f96e8888d><span>MAVROS 与 MAVProxy：APM 平台上的使用场景、差异与取舍</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsyblogqgroundcontrol-li><a href=/docsy/blog/qgroundcontrol/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsyblogqgroundcontrol><span>QGroundControl</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026mavsdke5928cqgce888aae782b9e8a784e58892e585bce5aeb9e680a7e997aee9a298e79a84e8a7a3e586b3e696b9e6a188-li><a href=/docsy/blog/02/25/2026/mavsdk%E5%92%8Cqgc%E8%88%AA%E7%82%B9%E8%A7%84%E5%88%92%E5%85%BC%E5%AE%B9%E6%80%A7%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026mavsdke5928cqgce888aae782b9e8a784e58892e585bce5aeb9e680a7e997aee9a298e79a84e8a7a3e586b3e696b9e6a188><span>MavSDK和QGC航点规划兼容性问题的解决方案</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026qgroundcontrol-docker-e8bf9be998b6e69e84e5bbbae68c87e58d97-li><a href=/docsy/blog/02/25/2026/qgroundcontrol-docker-%E8%BF%9B%E9%98%B6%E6%9E%84%E5%BB%BA%E6%8C%87%E5%8D%97/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026qgroundcontrol-docker-e8bf9be998b6e69e84e5bbbae68c87e58d97><span>QGroundControl Docker 进阶构建指南</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026qgroundcontrol-e59fbae4ba8ee5ae98e696b9e69687e6a1a3e79a84e5aeb9e599a8e58c96e69e84e5bbba-li><a href=/docsy/blog/02/25/2026/qgroundcontrol-%E5%9F%BA%E4%BA%8E%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%9A%84%E5%AE%B9%E5%99%A8%E5%8C%96%E6%9E%84%E5%BB%BA/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026qgroundcontrol-e59fbae4ba8ee5ae98e696b9e69687e6a1a3e79a84e5aeb9e599a8e58c96e69e84e5bbba><span>QGroundControl 基于官方文档的容器化构建</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsyblog02252026e59ca8-qgc-e5928c-e5a4a7e6a8a1e59e8b-fastapi-e5908ee7abafe5ae9ee78eb0e79a84e7abafe588b0e7abafe697a0e4babae69cbae8afade99fb3e68c87e4bba4e6a186e69eb6-li><a href=/docsy/blog/02/25/2026/%E5%9C%A8-qgc-%E5%92%8C-%E5%A4%A7%E6%A8%A1%E5%9E%8B-fastapi-%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0%E7%9A%84%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%AF%AD%E9%9F%B3%E6%8C%87%E4%BB%A4%E6%A1%86%E6%9E%B6/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e59ca8-qgc-e5928c-e5a4a7e6a8a1e59e8b-fastapi-e5908ee7abafe5ae9ee78eb0e79a84e7abafe588b0e7abafe697a0e4babae69cbae8afade99fb3e68c87e4bba4e6a186e69eb6><span class=td-sidebar-nav-active-item>在 QGC 和 大模型 FastAPI 后端实现的端到端无人机语音指令框架</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsyblogros-li><a href=/docsy/blog/ros/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsyblogros><span>ROS</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026ubuntu-2404-e5ae89e8a385-ros-2-jazzy-e5ae8ce695b4e68c87e58d97-li><a href=/docsy/blog/02/25/2026/ubuntu-24.04-%E5%AE%89%E8%A3%85-ros-2-jazzy-%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026ubuntu-2404-e5ae89e8a385-ros-2-jazzy-e5ae8ce695b4e68c87e58d97><span>Ubuntu 24.04 安装 ROS 2 Jazzy 完整指南</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e79086e8a7a3-ros-2-e79a84-node-e5928c-topic-li><a href=/docsy/blog/02/25/2026/%E7%90%86%E8%A7%A3-ros-2-%E7%9A%84-node-%E5%92%8C-topic/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e79086e8a7a3-ros-2-e79a84-node-e5928c-topic><span>理解 ROS 2 的 node 和 topic</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsyblog02252026e79086e8a7a3-ros-2-e79a84-services-params-e5928c-actions-li><a href=/docsy/blog/02/25/2026/%E7%90%86%E8%A7%A3-ros-2-%E7%9A%84-services-params-%E5%92%8C-actions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsyblog02252026e79086e8a7a3-ros-2-e79a84-services-params-e5928c-actions><span>理解 ROS 2 的 Services, Params 和 Actions</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/Zero-kq/docsy/tree/main/content/cn/blog/QGroundControl/attach-voice-engine-to-command-qgc.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> 查看此页面</a>
<a href=https://github.com/Zero-kq/docsy/edit/main/content/cn/blog/QGroundControl/attach-voice-engine-to-command-qgc.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> 编辑此页面</a>
<a href="https://github.com/Zero-kq/docsy/new/main/content/cn/blog/QGroundControl?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> 创建子页面</a>
<a href="https://github.com/Zero-kq/docsy/issues/new?title=%e5%9c%a8%20QGC%20%e5%92%8c%20%e5%a4%a7%e6%a8%a1%e5%9e%8b%20FastAPI%20%e5%90%8e%e7%ab%af%e5%ae%9e%e7%8e%b0%e7%9a%84%e7%ab%af%e5%88%b0%e7%ab%af%e6%97%a0%e4%ba%ba%e6%9c%ba%e8%af%ad%e9%9f%b3%e6%8c%87%e4%bb%a4%e6%a1%86%e6%9e%b6" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> 创建问题</a>
<a id=print href=/docsy/blog/qgroundcontrol/_print/><i class="fa-solid fa-print fa-fw"></i> 打印整个章节</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#1-概述>1. 概述</a><ul><li><a href=#11-版本信息>1.1 版本信息</a></li><li><a href=#12-二次开发说明>1.2 二次开发说明</a></li></ul></li><li><a href=#2-系统架构>2. 系统架构</a><ul><li><a href=#21-整体架构图>2.1 整体架构图</a></li><li><a href=#22-数据流向时序图>2.2 数据流向：时序图</a></li></ul></li><li><a href=#3-核心组件>3. 核心组件</a><ul><li><a href=#31-audiorecordercontrollerc音频控制器>3.1 AudioRecorderController（C++音频控制器）</a></li><li><a href=#32-音频格式配置>3.2 音频格式配置</a></li><li><a href=#33-开始录制流程>3.3 开始录制流程</a></li><li><a href=#34-周期性数据读取>3.4 周期性数据读取</a></li><li><a href=#35-停止录制并生成wav文件>3.5 停止录制并生成WAV文件</a></li><li><a href=#36-wav文件头部生成>3.6 WAV文件头部生成</a></li><li><a href=#38-qml界面层>3.8 QML界面层</a></li></ul></li><li><a href=#4-端到端语音链路>4. 端到端语音链路</a><ul><li><a href=#41-后端整体角色与接口约束>4.1 后端整体角色与接口约束</a></li><li><a href=#42-后端分层结构>4.2 后端分层结构</a></li><li><a href=#43-语音转命令接口逻辑流程>4.3 语音转命令接口：逻辑流程</a></li><li><a href=#44-语音转文字接口测试接口>4.4 语音转文字接口（测试接口）</a></li><li><a href=#45-端到端时序总结后端视角>4.5 端到端时序总结（后端视角）</a></li></ul></li><li><a href=#5-api-接口规范>5. API 接口规范</a><ul><li><a href=#51-语音命令接口>5.1 语音命令接口</a></li></ul></li><li><a href=#6-附录文件位置参考>6. 附录：文件位置参考</a><ul><li></li></ul></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Tag Cloud</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/airsim/ data-taxonomy-term=airsim><span class=taxonomy-label>AirSim</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/android/ data-taxonomy-term=android><span class=taxonomy-label>Android</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/c++/ data-taxonomy-term=c++><span class=taxonomy-label>C++</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/cmake/ data-taxonomy-term=cmake><span class=taxonomy-label>CMake</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/docker/ data-taxonomy-term=docker><span class=taxonomy-label>Docker</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/docs/ data-taxonomy-term=docs><span class=taxonomy-label>Docs</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/fastdds/ data-taxonomy-term=fastdds><span class=taxonomy-label>FastDDS</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/gazebo/ data-taxonomy-term=gazebo><span class=taxonomy-label>Gazebo</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/javascript/ data-taxonomy-term=javascript><span class=taxonomy-label>JavaScript</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/leaflet/ data-taxonomy-term=leaflet><span class=taxonomy-label>Leaflet</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/linux/ data-taxonomy-term=linux><span class=taxonomy-label>Linux</span><span class=taxonomy-count>8</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/lua/ data-taxonomy-term=lua><span class=taxonomy-label>Lua</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/mavlink/ data-taxonomy-term=mavlink><span class=taxonomy-label>MAVLink</span><span class=taxonomy-count>7</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/mavlink-router/ data-taxonomy-term=mavlink-router><span class=taxonomy-label>MAVLink Router</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/mavproxy/ data-taxonomy-term=mavproxy><span class=taxonomy-label>MAVProxy</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/mavros/ data-taxonomy-term=mavros><span class=taxonomy-label>MAVROS</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/mavsdk/ data-taxonomy-term=mavsdk><span class=taxonomy-label>MAVSDK</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/mavsdk-python/ data-taxonomy-term=mavsdk-python><span class=taxonomy-label>MAVSDK-Python</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/nicegui/ data-taxonomy-term=nicegui><span class=taxonomy-label>NiceGUI</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/px4/ data-taxonomy-term=px4><span class=taxonomy-label>PX4</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/pymavlink/ data-taxonomy-term=pymavlink><span class=taxonomy-label>Pymavlink</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/python/ data-taxonomy-term=python><span class=taxonomy-label>Python</span><span class=taxonomy-count>12</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/qgroundcontrol/ data-taxonomy-term=qgroundcontrol><span class=taxonomy-label>QGroundControl</span><span class=taxonomy-count>8</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/qt/ data-taxonomy-term=qt><span class=taxonomy-label>Qt</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/ros/ data-taxonomy-term=ros><span class=taxonomy-label>ROS</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/ros-2/ data-taxonomy-term=ros-2><span class=taxonomy-label>ROS 2</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/rpc/ data-taxonomy-term=rpc><span class=taxonomy-label>RPC</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/sample/ data-taxonomy-term=sample><span class=taxonomy-label>Sample</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/sitl/ data-taxonomy-term=sitl><span class=taxonomy-label>SITL</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/test/ data-taxonomy-term=test><span class=taxonomy-label>Test</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/ubuntu/ data-taxonomy-term=ubuntu><span class=taxonomy-label>Ubuntu</span><span class=taxonomy-count>8</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/windows/ data-taxonomy-term=windows><span class=taxonomy-label>Windows</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/wsl2/ data-taxonomy-term=wsl2><span class=taxonomy-label>WSL2</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91/ data-taxonomy-term=%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91><span class=taxonomy-label>二次开发</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E4%BB%BB%E5%8A%A1%E8%A7%84%E5%88%92/ data-taxonomy-term=%E4%BB%BB%E5%8A%A1%E8%A7%84%E5%88%92><span class=taxonomy-label>任务规划</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E4%BB%BF%E7%9C%9F/ data-taxonomy-term=%E4%BB%BF%E7%9C%9F><span class=taxonomy-label>仿真</span><span class=taxonomy-count>7</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E5%89%8D%E7%AB%AF/ data-taxonomy-term=%E5%89%8D%E7%AB%AF><span class=taxonomy-label>前端</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E5%90%8E%E7%AB%AF/ data-taxonomy-term=%E5%90%8E%E7%AB%AF><span class=taxonomy-label>后端</span><span class=taxonomy-count>6</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E5%9C%B0%E9%9D%A2%E7%AB%99/ data-taxonomy-term=%E5%9C%B0%E9%9D%A2%E7%AB%99><span class=taxonomy-label>地面站</span><span class=taxonomy-count>9</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/ data-taxonomy-term=%E5%A4%A7%E6%A8%A1%E5%9E%8B><span class=taxonomy-label>大模型</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/ data-taxonomy-term=%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7><span class=taxonomy-label>实用工具</span><span class=taxonomy-count>6</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/ data-taxonomy-term=%E5%AE%B9%E5%99%A8%E5%8C%96><span class=taxonomy-label>容器化</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ data-taxonomy-term=%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90><span class=taxonomy-label>数据分析</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E6%97%A0%E4%BA%BA%E6%9C%BA/ data-taxonomy-term=%E6%97%A0%E4%BA%BA%E6%9C%BA><span class=taxonomy-label>无人机</span><span class=taxonomy-count>13</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E7%BC%96%E8%AF%91/ data-taxonomy-term=%E7%BC%96%E8%AF%91><span class=taxonomy-label>编译</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E9%80%9A%E4%BF%A1/ data-taxonomy-term=%E9%80%9A%E4%BF%A1><span class=taxonomy-label>通信</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/tags/%E9%A3%9E%E6%8E%A7/ data-taxonomy-term=%E9%A3%9E%E6%8E%A7><span class=taxonomy-label>飞控</span><span class=taxonomy-count>3</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/categories/examples/ data-taxonomy-term=examples><span class=taxonomy-label>Examples</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/categories/placeholders/ data-taxonomy-term=placeholders><span class=taxonomy-label>Placeholders</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ data-taxonomy-term=%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0><span class=taxonomy-label>学习笔记</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/ data-taxonomy-term=%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3><span class=taxonomy-label>技术文档</span><span class=taxonomy-count>20</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/categories/%E6%B8%B8%E6%88%8F%E6%8F%92%E4%BB%B6/ data-taxonomy-term=%E6%B8%B8%E6%88%8F%E6%8F%92%E4%BB%B6><span class=taxonomy-label>游戏插件</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/categories/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/ data-taxonomy-term=%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95><span class=taxonomy-label>踩坑记录</span><span class=taxonomy-count>2</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><style>body{background-image:url(/docsy/images/backgrounds/wallhaven-odr71m.jpg);background-size:cover;background-position:50%;background-attachment:fixed;background-repeat:no-repeat}body::before{content:'';display:block!important;background-color:rgba(255,255,255,.8)!important;position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1}.td-section.td-blog .td-sidebar,.td-section.td-blog .td-sidebar-toc{color:#000!important}.td-section.td-blog .td-sidebar a,.td-section.td-blog .td-sidebar-toc a{color:#000!important}.td-content p{margin-top:.5rem;margin-bottom:.2rem}</style><div class=td-content><h1>在 QGC 和 大模型 FastAPI 后端实现的端到端无人机语音指令框架</h1><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>标签:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/qgroundcontrol/ data-taxonomy-term=QGroundControl><span class=taxonomy-label>QGroundControl</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/mavlink/ data-taxonomy-term=MAVLink><span class=taxonomy-label>MAVLink</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/%E5%9C%B0%E9%9D%A2%E7%AB%99/ data-taxonomy-term=地面站><span class=taxonomy-label>地面站</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/ data-taxonomy-term=大模型><span class=taxonomy-label>大模型</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/python/ data-taxonomy-term=Python><span class=taxonomy-label>Python</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/%E5%89%8D%E7%AB%AF/ data-taxonomy-term=前端><span class=taxonomy-label>前端</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/%E5%90%8E%E7%AB%AF/ data-taxonomy-term=后端><span class=taxonomy-label>后端</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/c++/ data-taxonomy-term=C++><span class=taxonomy-label>C++</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/qt/ data-taxonomy-term=Qt><span class=taxonomy-label>Qt</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/%E6%97%A0%E4%BA%BA%E6%9C%BA/ data-taxonomy-term=无人机><span class=taxonomy-label>无人机</span></a></li><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/tags/%E4%BB%BB%E5%8A%A1%E8%A7%84%E5%88%92/ data-taxonomy-term=任务规划><span class=taxonomy-label>任务规划</span></a></li></ul></div><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>分类:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://Zero-Kq.github.io/docsy/cn/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/ data-taxonomy-term=技术文档><span class=taxonomy-label>技术文档</span></a></li></ul></div></header><div class="last-modified my-2">更新于 2026/02/25 :
<a href=https://github.com/Zero-kq/docsy/commit/0339b328365e895a74488aae345c6f37f1b60281 target=_blank rel=noopener>``` chore(ci): 添加bundler依赖更新并优化GitHub Pages工作流</a></div><div class="original-statement my-3" style="font-size:.9em;color:#666;font-style:italic;border-left:3px solid #007bff;padding-left:12px">原创声明：本文为作者原创作品，采用开放许可，允许自由使用、修改、分发及商业应用，无需额外授权。</div><hr class=my-4><h2 id=1-概述>1. 概述</h2><h3 id=11-版本信息>1.1 版本信息</h3><p><strong>基础版本</strong>：QGroundControl v5.0.6 Stable
<strong>开发目标</strong>：为QGC添加语音交互能力，实现通过自然语言控制无人机</p><h3 id=12-二次开发说明>1.2 二次开发说明</h3><p>本实现在不修改QGC核心功能的前提下，通过以下方式扩展语音交互能力：</p><p><strong>新增源文件</strong>：</p><ul><li><code>AudioRecorderController.h/cc</code>：独立的音频录制控制器</li><li><code>BackendSettings.h/cc</code>：后端配置管理</li><li><code>Backend.SettingsGroup.json</code>：配置项定义</li><li><code>BottomFlyViewToolBar.qml</code>：添加语音按钮和交互逻辑</li></ul><p><strong>修改现有文件</strong>：</p><ul><li><code>QGroundControlQmlGlobal.cc</code>：注册新的QML类型</li><li><code>CMakeLists.txt</code>：添加新源文件到构建系统</li><li><code>MainWindow.qml</code>：添加全局状态管理</li></ul><p><strong>保持兼容性</strong>：</p><ul><li>所有新功能作为可选模块，不影响现有功能</li><li>使用QGC现有的设置管理框架</li><li>遵循QGC的代码风格和架构设计</li><li>新增组件与原有组件解耦，便于独立维护</li></ul><h2 id=2-系统架构>2. 系统架构</h2><h3 id=21-整体架构图>2.1 整体架构图</h3><pre class=mermaid>graph TB
    subgraph QGC[&#34;QGroundControl 客户端&#34;]
        User[&#34;用户操作&lt;br/&gt;(按住/松开按钮)&#34;]
        
        subgraph UI[&#34;QML 界面层&#34;]
            ToolBar[&#34;BottomFlyViewToolBar.qml&#34;]
        end
        
        subgraph Controller[&#34;C&#43;&#43; 控制器层&#34;]
            Audio[&#34;AudioRecorderController&lt;br/&gt;• startRecording()&lt;br/&gt;• stopRecording()&lt;br/&gt;• 音频格式配置&lt;br/&gt;• WAV文件生成&#34;]
        end
        
        subgraph QtLayer[&#34;Qt Multimedia 层&#34;]
            QtAudio[&#34;QAudioSource / QAudioFormat&lt;br/&gt;• 音频设备管理&lt;br/&gt;• PCM数据采集&#34;]
        end
        
        User -.-&gt; ToolBar
        ToolBar --&gt;|调用C&#43;&#43;接口| Audio
        Audio --&gt;|使用Qt框架| QtAudio
    end
    
    subgraph Backend[&#34;后端服务器 (FastAPI)&#34;]
        APIRouter[&#34;/api/v1/voice&lt;br/&gt;(FastAPI 路由)&#34;]
        VoiceCommand[&#34;POST /api/v1/voice/command&lt;br/&gt;voice_command()&#34;]
        Whisper[&#34;Whisper 模型&lt;br/&gt;(small, CPU, 单例)&#34;]
        Agent[&#34;DroneAgent&lt;br/&gt;(LLM 解释命令)&#34;]
        Fleet[&#34;FleetManager / MavSDKWrapper&lt;br/&gt;(实际控制无人机)&#34;]
        LLM[&#34;外部 / 本地部署 LLM 服务&lt;br/&gt;&#34;]
        
        APIRouter --&gt; VoiceCommand
        VoiceCommand --&gt; Whisper
        Whisper --&gt; Agent
        Agent --&gt; LLM
        Agent --&gt; Fleet
    end
    
    Dialog[&#34;结果展示&lt;br/&gt;对话框&#34;]
    
    QtAudio --&gt;|&#34;HTTP POST&lt;br/&gt;(multipart/form-data)&lt;br/&gt;字段: audio(WAV)&#34;| APIRouter
    Fleet --&gt;|&#34;执行结果字符串&lt;br/&gt;(含ANSI颜色)&#34;| Agent
    Agent --&gt;|&#34;JSON { result: &#39;执行结果...&#39; }&#34;| VoiceCommand
    VoiceCommand --&gt; Dialog
    
    style QGC fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style Backend fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style User fill:#f3e5f5,stroke:#4a148c
    style ToolBar fill:#e8f5e9,stroke:#1b5e20
    style Audio fill:#fff9c4,stroke:#f57f17
    style QtAudio fill:#fce4ec,stroke:#880e4f
    style Dialog fill:#f1f8e9,stroke:#33691e
    style APIRouter fill:#ffe0b2,stroke:#ef6c00
    style VoiceCommand fill:#ffe082,stroke:#ff8f00
    style Whisper fill:#fff9c4,stroke:#fbc02d
    style Agent fill:#e1bee7,stroke:#6a1b9a
    style Fleet fill:#c8e6c9,stroke:#2e7d32
    style LLM fill:#bbdefb,stroke:#1565c0</pre><h3 id=22-数据流向时序图>2.2 数据流向：时序图</h3><h4 id=完整交互流程>完整交互流程</h4><pre class=mermaid>sequenceDiagram
    autonumber
    actor User as 用户
    participant UI as QML界面&lt;br/&gt;BottomFlyViewToolBar
    participant Controller as C&#43;&#43;控制器&lt;br/&gt;AudioRecorderController
    participant Timer as 定时器&lt;br/&gt;QTimer(50ms)
    participant QtAudio as Qt Multimedia&lt;br/&gt;QAudioSource
    participant Network as 网络层&lt;br/&gt;XMLHttpRequest
    participant APIRouter as FastAPI路由&lt;br/&gt;/api/v1/voice
    participant VoiceAPI as 语音接口&lt;br/&gt;voice_command()
    participant Whisper as Whisper模型&lt;br/&gt;small@CPU(单例)
    participant Agent as DroneAgent&lt;br/&gt;LLM 命令解释器
    participant LLM as 外部 / 本地部署 LLM 服务&lt;br/&gt;
    participant Fleet as 机队管理器&lt;br/&gt;FleetManager/MavSDK
    
    %% 阶段1: 开始录音
    rect rgb(227, 242, 253)
        Note over User,QtAudio: 阶段1: 开始录音
        User-&gt;&gt;&#43;UI: 按下&#34;发送语音&#34;按钮
        UI-&gt;&gt;&#43;Controller: startRecording()
        Controller-&gt;&gt;Controller: 清空旧数据&lt;br/&gt;_rawAudioData.clear()
        Controller-&gt;&gt;QtAudio: 创建QAudioSource
        activate QtAudio
        QtAudio--&gt;&gt;Controller: 返回音频设备
        Controller-&gt;&gt;QtAudio: start() 启动录音
        QtAudio--&gt;&gt;Controller: 返回QIODevice
        Controller-&gt;&gt;Timer: start() 启动定时器
        activate Timer
        Controller--&gt;&gt;UI: emit isRecordingChanged(true)
        UI--&gt;&gt;User: 显示&#34;录音中...&#34;
        Controller--&gt;&gt;UI: 录音已启动
    end
    
    %% 阶段2: 周期性读取音频数据
    rect rgb(243, 229, 245)
        Note over Timer,Controller: 阶段2: 周期性读取音频数据
        loop 每50ms循环
            Timer-&gt;&gt;Controller: timeout() 触发
            Controller-&gt;&gt;QtAudio: bytesAvailable() 检查
            QtAudio--&gt;&gt;Controller: 可用字节数
            Controller-&gt;&gt;QtAudio: read() 读取PCM数据
            QtAudio--&gt;&gt;Controller: PCM音频数据
            Controller-&gt;&gt;Controller: _rawAudioData.append()&lt;br/&gt;追加到缓冲区
            Note right of Controller: 内存缓冲区持续增长
        end
    end
    
    %% 阶段3: 停止录音
    rect rgb(255, 243, 224)
        Note over User,Controller: 阶段3: 停止录音
        User-&gt;&gt;UI: 松开按钮
        UI-&gt;&gt;Controller: stopRecording()
        Controller-&gt;&gt;Timer: stop() 停止定时器
        deactivate Timer
        Controller-&gt;&gt;QtAudio: 读取剩余数据
        QtAudio--&gt;&gt;Controller: 最后的PCM数据
        Controller-&gt;&gt;QtAudio: stop() 停止录音
        deactivate QtAudio
        Controller-&gt;&gt;Controller: _createWavHeader()&lt;br/&gt;生成WAV头部(44字节)
        Controller-&gt;&gt;Controller: _audioData = header &#43; _rawAudioData&lt;br/&gt;拼接完整WAV文件
        Note right of Controller: 完整WAV文件已准备就绪
        Controller--&gt;&gt;UI: emit recordingFinished()
        Controller--&gt;&gt;UI: emit isRecordingChanged(false)
        UI--&gt;&gt;User: 显示确认对话框
        deactivate UI
    end
    
    %% 阶段4: 用户确认
    rect rgb(232, 245, 233)
        Note over User,UI: 阶段4: 用户确认
        User-&gt;&gt;&#43;UI: 点击&#34;是&#34;确认发送
    end
    
    %% 阶段5: 准备网络请求
    rect rgb(255, 249, 196)
        Note over UI,Network: 阶段5: 准备网络请求
        UI-&gt;&gt;Controller: 获取audioData
        Controller--&gt;&gt;UI: 返回QByteArray(WAV文件)
        UI-&gt;&gt;UI: 转换QByteArray → Uint8Array
        UI-&gt;&gt;&#43;Network: 构建multipart/form-data
        Network-&gt;&gt;Network: 生成boundary标识
        Network-&gt;&gt;Network: 构建HTTP头部
        Network-&gt;&gt;Network: 组装ArrayBuffer
        Note right of Network: 完整HTTP请求已构建完成
        UI-&gt;&gt;Controller: clearAudioData() 立即清理
        Note right of Controller: 内存清理(关键优化点)
    end
    
    %% 阶段6: 发送HTTP请求
    rect rgb(252, 228, 236)
        Note over Network,APIRouter: 阶段6: 发送HTTP请求
        Network-&gt;&gt;&#43;APIRouter: POST /api/v1/voice/command&lt;br/&gt;Content-Type: multipart/form-data&lt;br/&gt;Body: audio=WAV
        UI--&gt;&gt;User: 显示&#34;等待响应...&#34;
        deactivate UI
    end
    
    %% 阶段7: 后端处理（语音 → 文本 → 命令 → 控制）
    rect rgb(224, 242, 241)
        Note over APIRouter,Fleet: 阶段7: 后端处理
        APIRouter-&gt;&gt;&#43;VoiceAPI: 路由到 voice_command()&lt;br/&gt;依赖注入 DroneAgent
        VoiceAPI-&gt;&gt;VoiceAPI: 校验文件名/扩展名/内容长度
        VoiceAPI-&gt;&gt;VoiceAPI: 写入临时文件(temp.wav)
        VoiceAPI-&gt;&gt;&#43;Whisper: get_whisper_model()&lt;br/&gt;单例加载 small 模型
        Whisper--&gt;&gt;VoiceAPI: model 实例
        VoiceAPI-&gt;&gt;Whisper: transcribe(temp.wav)
        Whisper--&gt;&gt;VoiceAPI: transcribed_text(自然语言命令)
        VoiceAPI-&gt;&gt;VoiceAPI: 删除临时文件
        VoiceAPI-&gt;&gt;&#43;Agent: await process(transcribed_text)
        Agent-&gt;&gt;Agent: 构造控制提示词&lt;br/&gt;检查机队状态
        Agent-&gt;&gt;&#43;Fleet: get_fleet_status()&lt;br/&gt;仅使用已连接无人机
        Fleet--&gt;&gt;Agent: 当前无人机状态
        Agent-&gt;&gt;&#43;LLM: chat.completions.create()&lt;br/&gt;生成控制代码
        LLM--&gt;&gt;Agent: Python 控制代码
        Agent-&gt;&gt;Agent: 在受限作用域内执行代码&lt;br/&gt;调用 FleetManager/MavSDK
        Agent--&gt;&gt;VoiceAPI: 执行结果字符串&lt;br/&gt;(含ANSI颜色/Success等)
        VoiceAPI--&gt;&gt;-APIRouter: AgentResponse(result=...)
        APIRouter--&gt;&gt;-Network: JSON响应&lt;br/&gt;{result: &#34;...&#34;}
    end
    
    %% 阶段8: 处理响应
    rect rgb(225, 245, 254)
        Note over Network,User: 阶段8: 处理响应
        Network--&gt;&gt;&#43;UI: onreadystatechange&lt;br/&gt;xhr.responseText
        UI-&gt;&gt;UI: parseResponseText()&lt;br/&gt;提取result字段
        UI-&gt;&gt;UI: ansiToHtml()&lt;br/&gt;转换ANSI颜色→HTML
        UI-&gt;&gt;Controller: clearAudioData() 防御性清理
        deactivate Controller
        Note right of Controller: 确保内存已释放
        UI--&gt;&gt;User: 显示结果对话框&lt;br/&gt;可选择复制
        deactivate UI
        User-&gt;&gt;User: 查看执行结果
    end</pre><h2 id=3-核心组件>3. 核心组件</h2><h3 id=31-audiorecordercontrollerc音频控制器>3.1 AudioRecorderController（C++音频控制器）</h3><h4 id=类设计>类设计</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AudioRecorderController</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>QObject</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_OBJECT</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QML_ELEMENT</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// QML可访问属性
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Q_PROPERTY</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>isRecording</span> <span style=color:#000>READ</span> <span style=color:#000>isRecording</span> <span style=color:#000>NOTIFY</span> <span style=color:#000>isRecordingChanged</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_PROPERTY</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QByteArray</span> <span style=color:#000>audioData</span> <span style=color:#000>READ</span> <span style=color:#000>audioData</span> <span style=color:#000>NOTIFY</span> <span style=color:#000>audioDataChanged</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_PROPERTY</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>audioDataSize</span> <span style=color:#000>READ</span> <span style=color:#000>audioDataSize</span> <span style=color:#000>NOTIFY</span> <span style=color:#000>audioDataChanged</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>explicit</span> <span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QObject</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>nullptr</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 公共方法 - QML可调用
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Q_INVOKABLE</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_INVOKABLE</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Q_INVOKABLE</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#f57900>signals</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>isRecordingChanged</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>isRecording</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>audioDataChanged</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>recordingFinished</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>errorOccurred</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>QString</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>errorString</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QAudioSource</span><span style=color:#ce5c00;font-weight:700>*</span>  <span style=color:#000>_audioSource</span><span style=color:#000;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// 音频输入设备
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QIODevice</span><span style=color:#ce5c00;font-weight:700>*</span>     <span style=color:#000>_audioIODevice</span><span style=color:#000;font-weight:700>;</span>      <span style=color:#8f5902;font-style:italic>// I/O设备接口
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QTimer</span><span style=color:#ce5c00;font-weight:700>*</span>        <span style=color:#000>_readTimer</span><span style=color:#000;font-weight:700>;</span>          <span style=color:#8f5902;font-style:italic>// 定时读取音频数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QAudioFormat</span>   <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// 音频格式配置
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QByteArray</span>     <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// 原始PCM数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QByteArray</span>     <span style=color:#000>_audioData</span><span style=color:#000;font-weight:700>;</span>          <span style=color:#8f5902;font-style:italic>// 完整WAV数据（含头部）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>bool</span>           <span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// 录制状态
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><h3 id=32-音频格式配置>3.2 音频格式配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QObject</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>parent</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>QObject</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>_audioSource</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>nullptr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>_audioIODevice</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>nullptr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>_readTimer</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>QTimer</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>false</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 配置音频格式: 16位PCM, 44100Hz采样率, 单声道
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleRate</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>44100</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setChannelCount</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleFormat</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QAudioFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SampleFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Int16</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 设置定时器周期性读取音频数据（每50ms）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>setInterval</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>setSingleShot</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>false</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>connect</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_readTimer</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>QTimer</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>timeout</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>_onAudioDataReady</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=33-开始录制流程>3.3 开始录制流程</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 1. 状态检查
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>qCWarning</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>AudioRecorderControllerLog</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Already recording&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 2. 清空旧数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clear</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clear</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 3. 创建音频源
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>_audioSource</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>_audioSource</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>deleteLater</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>QAudioSource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 4. 启动音频输入
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioIODevice</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_audioSource</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>start</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_audioIODevice</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>emit</span> <span style=color:#000>errorOccurred</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to start audio input device&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 5. 启动定时器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>start</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 6. 更新状态
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_isRecording</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>emit</span> <span style=color:#000>isRecordingChanged</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=34-周期性数据读取>3.4 周期性数据读取</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>_onAudioDataReady</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_audioIODevice</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 检查可用字节数
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint64</span> <span style=color:#000>bytesAvailable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_audioIODevice</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>bytesAvailable</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>bytesAvailable</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 读取音频数据并追加到缓冲区
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>QByteArray</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_audioIODevice</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>read</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytesAvailable</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>qCDebug</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>AudioRecorderControllerLog</span><span style=color:#000;font-weight:700>)</span> 
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Read audio data:&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>()</span> 
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;bytes, total:&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=35-停止录制并生成wav文件>3.5 停止录制并生成WAV文件</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 1. 停止定时器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>stop</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 2. 读取剩余数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>_audioIODevice</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>_audioIODevice</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>bytesAvailable</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>QByteArray</span> <span style=color:#000>remainingData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_audioIODevice</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>readAll</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>remainingData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>remainingData</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 3. 停止音频源
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>_audioSource</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>_audioSource</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>stop</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_audioIODevice</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>nullptr</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 4. 生成WAV文件头部
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>QByteArray</span> <span style=color:#000>wavHeader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_createWavHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>(),</span> 
</span></span><span style=display:flex><span>                                                 <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>_audioData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>wavHeader</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>_rawAudioData</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// WAV文件结构验证
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>qCDebug</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>AudioRecorderControllerLog</span><span style=color:#000;font-weight:700>)</span> 
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;WAV total size:&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>_audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 5. 更新状态并发出信号
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_isRecording</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>false</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>emit</span> <span style=color:#000>isRecordingChanged</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_isRecording</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>emit</span> <span style=color:#000>recordingFinished</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>emit</span> <span style=color:#000>audioDataChanged</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=36-wav文件头部生成>3.6 WAV文件头部生成</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>QByteArray</span> <span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>_createWavHeader</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint32</span> <span style=color:#000>dataSize</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>QAudioFormat</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>format</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>const</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QByteArray</span> <span style=color:#000>header</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>QDataStream</span> <span style=color:#000>stream</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>header</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>QIODevice</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>WriteOnly</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setByteOrder</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QDataStream</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>LittleEndian</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 计算格式参数
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint16</span> <span style=color:#000>numChannels</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>format</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>channelCount</span><span style=color:#000;font-weight:700>();</span>      <span style=color:#8f5902;font-style:italic>// 1 (单声道)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint32</span> <span style=color:#000>sampleRate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>format</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sampleRate</span><span style=color:#000;font-weight:700>();</span>         <span style=color:#8f5902;font-style:italic>// 44100
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint16</span> <span style=color:#000>bytesPerSample</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>format</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>bytesPerSample</span><span style=color:#000;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 2 (16位)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint16</span> <span style=color:#000>bitsPerSample</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bytesPerSample</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// 16
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>qint32</span> <span style=color:#000>byteRate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sampleRate</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>numChannels</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>bytesPerSample</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint16</span> <span style=color:#000>blockAlign</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>numChannels</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>bytesPerSample</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// RIFF头部 (12字节)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>writeRawData</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;RIFF&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint32</span> <span style=color:#000>fileSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>36</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dataSize</span><span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// 总大小 - 8
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>fileSize</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>writeRawData</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;WAVE&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// fmt块 (24字节)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>writeRawData</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;fmt &#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint32</span> <span style=color:#000>fmtChunkSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>;</span>         <span style=color:#8f5902;font-style:italic>// PCM格式块大小
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>fmtChunkSize</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>qint16</span> <span style=color:#000>audioFormat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>           <span style=color:#8f5902;font-style:italic>// PCM = 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>audioFormat</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>numChannels</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>sampleRate</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>byteRate</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>blockAlign</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>bitsPerSample</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// data块头 (8字节)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stream</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>writeRawData</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>stream</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>dataSize</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 验证头部大小 (应为44字节)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>header</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>44</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>qCWarning</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>AudioRecorderControllerLog</span><span style=color:#000;font-weight:700>)</span> 
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;WAV header size incorrect:&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>header</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>header</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>WAV文件格式详解</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>偏移  大小  字段           值
</span></span><span style=display:flex><span>─────────────────────────────────────
</span></span><span style=display:flex><span>0     4     ChunkID       &#34;RIFF&#34;
</span></span><span style=display:flex><span>4     4     ChunkSize     文件大小-8
</span></span><span style=display:flex><span>8     4     Format        &#34;WAVE&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>12    4     Subchunk1ID   &#34;fmt &#34;
</span></span><span style=display:flex><span>16    4     Subchunk1Size 16 (PCM)
</span></span><span style=display:flex><span>20    2     AudioFormat   1 (PCM)
</span></span><span style=display:flex><span>22    2     NumChannels   1 (单声道)
</span></span><span style=display:flex><span>24    4     SampleRate    44100
</span></span><span style=display:flex><span>28    4     ByteRate      88200 (=44100*1*2)
</span></span><span style=display:flex><span>32    2     BlockAlign    2 (=1*2)
</span></span><span style=display:flex><span>34    2     BitsPerSample 16
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>36    4     Subchunk2ID   &#34;data&#34;
</span></span><span style=display:flex><span>40    4     Subchunk2Size PCM数据大小
</span></span><span style=display:flex><span>44    N     Data          实际音频数据
</span></span></code></pre></div><h4 id=音频质量与性能平衡>音频质量与性能平衡</h4><table><thead><tr><th>参数</th><th>值</th><th>理由</th></tr></thead><tbody><tr><td>采样率</td><td>44100 Hz</td><td>标准CD音质，适合所有语音识别系统</td></tr><tr><td>位深度</td><td>16 bit</td><td>足够的动态范围，比8bit清晰，比24bit节省空间</td></tr><tr><td>声道数</td><td>1 (单声道)</td><td>语音识别不需要立体声，减少50%数据量</td></tr><tr><td>读取间隔</td><td>50 ms</td><td>平衡响应性和CPU占用</td></tr></tbody></table><p><strong>数据量计算</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>每秒数据量 = 44100 Hz × 2 bytes × 1 channel = 88,200 bytes/s ≈ 86 KB/s
</span></span><span style=display:flex><span>10秒录音 ≈ 860 KB
</span></span><span style=display:flex><span>30秒录音 ≈ 2.5 MB
</span></span></code></pre></div><h4 id=音频参数配置>音频参数配置</h4><p>如需修改音频参数，编辑 <code>AudioRecorderController</code> 构造函数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QObject</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>parent</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 可自定义的参数
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleRate</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>44100</span><span style=color:#000;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// 采样率：8000, 16000, 44100, 48000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setChannelCount</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>        <span style=color:#8f5902;font-style:italic>// 声道数：1=单声道, 2=立体声
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleFormat</span><span style=color:#000;font-weight:700>(</span>           <span style=color:#8f5902;font-style:italic>// 采样格式
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>QAudioFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SampleFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Int16</span>   <span style=color:#8f5902;font-style:italic>// Int16, Int32, Float
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 读取间隔（毫秒）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>setInterval</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>);</span>            <span style=color:#8f5902;font-style:italic>// 10-100ms范围推荐
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>常见配置组合</strong>：</p><table><thead><tr><th>场景</th><th>采样率</th><th>位深度</th><th>声道</th><th>数据率</th></tr></thead><tbody><tr><td>语音识别（推荐）</td><td>44100Hz</td><td>16bit</td><td>单声道</td><td>86KB/s</td></tr><tr><td>低质量/节省带宽</td><td>16000Hz</td><td>16bit</td><td>单声道</td><td>31KB/s</td></tr><tr><td>高质量/专业录音</td><td>48000Hz</td><td>24bit</td><td>立体声</td><td>281KB/s</td></tr><tr><td>电话音质</td><td>8000Hz</td><td>16bit</td><td>单声道</td><td>16KB/s</td></tr></tbody></table><h3 id=38-qml界面层>3.8 QML界面层</h3><h4 id=主要组件结构>主要组件结构</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-qml data-lang=qml><span style=display:flex><span><span style=color:#000>Item</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>id:</span> <span style=color:#000>_root</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 属性定义 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>property</span> <span style=color:#000>bool</span> <span style=color:#204a87;font-weight:700>isBackendAlive:</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>    <span style=color:#000>property</span> <span style=color:#000>bool</span> <span style=color:#204a87;font-weight:700>isWaitingForBackendResponse:</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>    <span style=color:#000>property</span> <span style=color:#000>bool</span> <span style=color:#204a87;font-weight:700>isRecording:</span> <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isRecording</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 后端API URLs
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>backendBaseUrl:</span> 
</span></span><span style=display:flex><span>        <span style=color:#000>QGroundControl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settingsManager</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backendSettings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backendBaseUrl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span>
</span></span><span style=display:flex><span>    <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>voiceApiPath:</span> 
</span></span><span style=display:flex><span>        <span style=color:#000>QGroundControl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>settingsManager</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>backendSettings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>voiceApiPath</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span>
</span></span><span style=display:flex><span>    <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>voiceApiUrl:</span> <span style=color:#000>_buildCompleteUrl</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>voiceApiPath</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 音频录制控制器 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>AudioRecorderController</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>id: audioRecorderController</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>onRecordingFinished:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 录音完成，显示确认对话框
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>dialog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>voiceConfirmDialogComponent</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>createObject</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000>dialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>open</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>onErrorOccurred:</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>errorString</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 处理录音错误
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Audio recording error:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errorString</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 录音按钮 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>QGCButton</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>id: microphoneButton</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>text:</span> <span style=color:#000>isRecording</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;录音中...&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;发送语音&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>enabled:</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>isWaitingForBackendResponse</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>onPressed:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>_root</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>onReleased:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>_root</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 确认对话框 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Component</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>id: voiceConfirmDialogComponent</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>QGCPopupDialog</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>title:</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;发送语音指令&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>buttons:</span> <span style=color:#000>Dialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Yes</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Dialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>No</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>onAccepted:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>audioData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>audioData</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>audioData</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>_root</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sendVoiceCommandFromMemory</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>onRejected:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ========== 响应显示对话框 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Component</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>id: responseDialogComponent</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>QGCPopupDialog</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>responseText:</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>plainText:</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>property</span> <span style=color:#000>string</span> <span style=color:#204a87;font-weight:700>coloredHtml:</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 可滚动的文本显示区域
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ScrollView</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>TextEdit</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>text:</span> <span style=color:#000>responseDialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>coloredHtml</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>textFormat:</span> <span style=color:#000>TextEdit</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RichText</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>readOnly:</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>selectByMouse:</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 复制按钮
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>QGCButton</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>text:</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;复制&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>onClicked:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>clipboard</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>text</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>responseDialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>plainText</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=启动录制>启动录制</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-qml data-lang=qml><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>startRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Started recording to memory&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to start recording:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=停止录制>停止录制</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-qml data-lang=qml><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>stopRecording</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Stopped recording&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to stop recording:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=发送语音命令>发送语音命令</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-qml data-lang=qml><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>sendVoiceCommandFromMemory</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>audioData</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>===</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;No audio data to send&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 设置等待状态
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isWaitingForBackendResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 数据转换 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 将QByteArray转换为Uint8Array
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>uint8Array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Uint8Array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>uint8Array</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>charCodeAt</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#0000cf;font-weight:700>0xFF</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 构建multipart请求 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;----WebKitFormBoundary&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>fileName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;recording_&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.wav&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 辅助函数：字符串转字节数组
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>function</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Uint8Array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>str</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>str</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>bytes</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>str</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>charCodeAt</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#0000cf;font-weight:700>0xFF</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bytes</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 构建multipart各部分
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>boundaryStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;--&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\r\n&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>dispositionStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;Content-Disposition: form-data; &#39;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>                            <span style=color:#4e9a06>&#39;name=&#34;audio&#34;; filename=&#34;&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>fileName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;&#34;\r\n&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>contentTypeStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Content-Type: audio/wav\r\n\r\n&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>crlfStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;\r\n&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>closingStr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;--&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;--\r\n&#34;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>boundaryBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>boundaryStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>dispositionBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dispositionStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>contentTypeBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>contentTypeStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>crlfBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>crlfStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>closingBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stringToBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>closingStr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 组装完整请求体 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>totalSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundaryBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>dispositionBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>contentTypeBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>uint8Array</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>crlfBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                       <span style=color:#000>closingBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>multipartBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayBuffer</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>totalSize</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>multipartView</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Uint8Array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>multipartBuffer</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 按顺序复制各部分
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>boundaryBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>boundaryBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dispositionBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>dispositionBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>contentTypeBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>contentTypeBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uint8Array</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>uint8Array</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>crlfBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>crlfBytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>multipartView</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>closingBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 发送HTTP请求 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>xhr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLHttpRequest</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>open</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;POST&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>voiceApiUrl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setRequestHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Content-Type&#34;</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                            <span style=color:#4e9a06>&#34;multipart/form-data; boundary=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setRequestHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Accept&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;application/json&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 立即清理音频数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Sending audio, size:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>totalSize</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 发送请求
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>multipartBuffer</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ========== 处理响应 ==========
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>onreadystatechange</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>readyState</span> <span style=color:#ce5c00;font-weight:700>===</span> <span style=color:#000>XMLHttpRequest</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DONE</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>status</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>body</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>responseText</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// 确保清理内存
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isWaitingForBackendResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#0000cf;font-weight:700>200</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>300</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// 成功响应
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>parsedBody</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseResponseText</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>body</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>displayText</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parsedBody</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>?</span> 
</span></span><span style=display:flex><span>                        <span style=color:#204a87;font-weight:700>parsedBody :</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;命令执行成功，但未返回内容&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>parsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ansiToHtml</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>displayText</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>dialog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>responseDialogComponent</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>createObject</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#204a87;font-weight:700>responseTitle:</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;命令执行结果&#34;</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>                            <span style=color:#204a87;font-weight:700>plainText:</span> <span style=color:#000>parsed</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>plain</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#204a87;font-weight:700>coloredHtml:</span> <span style=color:#000>parsed</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>colored</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>dialog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>open</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// 错误响应
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>errorText</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>qsTr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;命令执行失败\n状态码: %1\n响应: %2&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>.</span><span style=color:#000>arg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>status</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>arg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parseResponseText</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>body</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>                    
</span></span><span style=display:flex><span>                    <span style=color:#8f5902;font-style:italic>// 显示错误对话框...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>onerror</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>            <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isWaitingForBackendResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 显示网络错误...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>audioRecorderController</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clearAudioData</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>mainWindow</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>isWaitingForBackendResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
</span></span><span style=display:flex><span>        <span style=color:#000>console</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error sending voice command:&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=音频质量与性能考虑>音频质量与性能考虑</h5><p>在发送语音命令时，音频数据的质量和性能参数直接影响传输效率和识别准确度。本实现采用以下参数配置：</p><p><strong>音频参数配置</strong>：</p><table><thead><tr><th>参数</th><th>值</th><th>理由</th></tr></thead><tbody><tr><td>采样率</td><td>44100 Hz</td><td>标准CD音质，适合所有语音识别系统</td></tr><tr><td>位深度</td><td>16 bit</td><td>足够的动态范围，比8bit清晰，比24bit节省空间</td></tr><tr><td>声道数</td><td>1 (单声道)</td><td>语音识别不需要立体声，减少50%数据量</td></tr><tr><td>读取间隔</td><td>50 ms</td><td>平衡响应性和CPU占用</td></tr></tbody></table><p><strong>数据量计算</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>每秒数据量 = 44100 Hz × 2 bytes × 1 channel = 88,200 bytes/s ≈ 86 KB/s
</span></span><span style=display:flex><span>10秒录音 ≈ 860 KB
</span></span><span style=display:flex><span>30秒录音 ≈ 2.5 MB
</span></span></code></pre></div><p><strong>为什么选择这些参数</strong>：</p><ol><li><p><strong>44100 Hz 采样率</strong>：这是标准CD音质，能够完整保留人声频率范围（20 Hz - 20 kHz），确保语音识别系统能够准确识别语音内容。虽然16000 Hz也能满足基本需求，但44100 Hz提供了更好的音质冗余，适应不同环境下的录音质量变化。</p></li><li><p><strong>16 bit 位深度</strong>：提供了65536个量化级别，足够捕捉人声的动态范围。8 bit（256级）会导致明显的量化噪声，而24 bit虽然更精确，但会增加50%的数据量，对语音识别来说收益有限。</p></li><li><p><strong>单声道</strong>：语音识别主要关注频率内容和时间序列，不需要立体声的空间信息。使用单声道可以将数据量减半，显著降低网络传输负担和内存占用。</p></li><li><p><strong>50 ms 读取间隔</strong>：在录音过程中，每50毫秒读取一次音频数据，既能及时响应录音状态变化，又不会过度占用CPU资源。过短的间隔（如10 ms）会增加CPU开销，过长的间隔（如100 ms）会导致内存缓冲区过大。</p></li></ol><p><strong>常见配置组合对比</strong>：</p><table><thead><tr><th>场景</th><th>采样率</th><th>位深度</th><th>声道</th><th>数据率</th><th>适用性</th></tr></thead><tbody><tr><td>语音识别（推荐）</td><td>44100Hz</td><td>16bit</td><td>单声道</td><td>86KB/s</td><td>✅ 最佳平衡</td></tr><tr><td>低质量/节省带宽</td><td>16000Hz</td><td>16bit</td><td>单声道</td><td>31KB/s</td><td>⚠️ 音质可能不足</td></tr><tr><td>高质量/专业录音</td><td>48000Hz</td><td>24bit</td><td>立体声</td><td>281KB/s</td><td>❌ 过度配置</td></tr><tr><td>电话音质</td><td>8000Hz</td><td>16bit</td><td>单声道</td><td>16KB/s</td><td>❌ 音质较差</td></tr></tbody></table><p><strong>性能影响</strong>：</p><ul><li><strong>网络传输</strong>：10秒录音约860 KB，即使在较慢的网络环境下也能快速上传</li><li><strong>内存占用</strong>：单次录音的内存占用可控，不会导致内存溢出</li><li><strong>CPU占用</strong>：50 ms读取间隔保证了流畅的录音体验，不会造成明显的CPU负担</li></ul><p>如需修改音频参数，可在 <code>AudioRecorderController</code> 构造函数中调整：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>AudioRecorderController</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>AudioRecorderController</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>QObject</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>parent</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 可自定义的参数
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleRate</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>44100</span><span style=color:#000;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// 采样率：8000, 16000, 44100, 48000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setChannelCount</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>        <span style=color:#8f5902;font-style:italic>// 声道数：1=单声道, 2=立体声
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_audioFormat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setSampleFormat</span><span style=color:#000;font-weight:700>(</span>           <span style=color:#8f5902;font-style:italic>// 采样格式
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>QAudioFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SampleFormat</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Int16</span>   <span style=color:#8f5902;font-style:italic>// Int16, Int32, Float
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 读取间隔（毫秒）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_readTimer</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>setInterval</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>);</span>            <span style=color:#8f5902;font-style:italic>// 10-100ms范围推荐
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h5 id=multipartform-data>multipart/form-data</h5><p>与上面的 <code>sendVoiceCommandFromMemory</code> 函数对应，音频数据通过 <code>multipart/form-data</code> 编码发送到后端。</p><h5 id=什么是-multipartform-data>什么是 multipart/form-data</h5><p><code>multipart/form-data</code> 是 HTTP 协议中定义的一种内容编码类型（Content-Type），用于在单个 HTTP 请求中传输<strong>多个不同类型的数据块</strong>。</p><p><strong>核心特点</strong>：</p><ul><li><strong>多部分传输</strong>：可在一个请求中同时发送文本字段和二进制文件</li><li><strong>边界分隔</strong>：使用 boundary（边界标识符）分隔不同的数据部分</li><li><strong>独立描述</strong>：每个部分都有自己的 Content-Disposition 和 Content-Type</li><li><strong>二进制安全</strong>：能够正确传输任意二进制数据，不会损坏文件内容</li></ul><h5 id=为什么使用-multipartform-data>为什么使用 multipart/form-data</h5><p><strong>文件上传的标准方式</strong></p><p>传统的表单编码方式 <code>application/x-www-form-urlencoded</code> 存在局限：</p><ul><li>只能传输文本数据</li><li>会对二进制数据进行 URL 编码，导致文件体积膨胀 33%</li><li>无法高效传输大文件</li></ul><p>而 <code>multipart/form-data</code> 专为文件上传设计：</p><ul><li>原样传输二进制数据，无额外开销</li><li>可同时上传多个文件</li><li>支持混合文本字段和文件</li></ul><p><strong>在本项目中的应用场景</strong></p><p>QGC 需要将录制的 WAV 音频文件发送到后端服务器进行语音识别：</p><pre class=mermaid>sequenceDiagram
    participant Client as 客户端(QGC)
    participant Server as 服务端(后端API)
    
    Note over Client: 录制音频&lt;br/&gt;(内存中的WAV文件)
    
    Client-&gt;&gt;&#43;Server: POST multipart/form-data
    Note right of Client: 字段名: &#34;audio&#34;&lt;br/&gt;文件名: &#34;recording.wav&#34;&lt;br/&gt;内容类型: audio/wav&lt;br/&gt;二进制数据: [WAV bytes]
    
    Note over Server: 语音识别 &#43; 意图理解&lt;br/&gt;&#43; 命令执行
    
    Server--&gt;&gt;-Client: JSON响应
    Note left of Server: { &#34;result&#34;: &#34;执行结果&#34; }</pre><p><strong>选择 multipart/form-data 的原因</strong>：</p><ul><li>WAV 是二进制格式，必须保持原始字节不变</li><li>服务端可通过标准的文件上传处理库解析</li><li>符合 Web 标准，兼容性好</li><li>便于调试（可用 curl、Postman 等工具测试）</li></ul><p><strong>与其他格式的对比</strong></p><table><thead><tr><th>编码格式</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><code>application/x-www-form-urlencoded</code></td><td>简单文本表单</td><td>简单，历史悠久</td><td>不支持文件，二进制数据效率低</td></tr><tr><td><code>application/json</code></td><td>API 数据交换</td><td>结构清晰，易解析</td><td>二进制需 Base64 编码（+33%体积）</td></tr><tr><td><strong><code>multipart/form-data</code></strong></td><td><strong>文件上传</strong></td><td><strong>二进制高效，标准化</strong></td><td><strong>格式复杂，需手动构建</strong></td></tr><tr><td><code>application/octet-stream</code></td><td>纯二进制流</td><td>最简单</td><td>无元数据，无法传递文件名等信息</td></tr></tbody></table><h4 id=格式结构说明>格式结构说明</h4><p><strong>基本组成</strong>：</p><div class=chem>$$请求头：
Content-Type: multipart/form-data; boundary=<边界标识符>
请求体：
--<边界标识符> ← 开始边界
Content-Disposition: form-data; ... ← 字段描述
Content-Type: ... ← 内容类型
← 空行（重要！）
[数据内容] ← 实际数据
--<边界标识符>-- ← 结束边界（多了两个横杠）$$</div><p><strong>关键概念</strong>：</p><ol><li><strong>Boundary（边界）</strong>：唯一标识符，不能出现在数据内容中</li><li><strong>CRLF（\r\n）</strong>：每行必须以 <code>\r\n</code> 结尾（HTTP 标准）</li><li><strong>Content-Disposition</strong>：描述字段名（name）和文件名（filename）</li><li><strong>Content-Type</strong>：指定数据的 MIME 类型</li></ol><h5 id=完整请求示例>完整请求示例</h5><div class=chem>$$POST /api/v1/voice/command HTTP/1.1
Host: 127.0.0.1:8000
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary1234567890
Content-Length: 44132
Accept: application/json
------WebKitFormBoundary1234567890
Content-Disposition: form-data; name="audio"; filename="recording_1234567890.wav"
Content-Type: audio/wav
RIFF....WAVE....data[二进制音频数据]
------WebKitFormBoundary1234567890--$$</div><h5 id=构建步骤>构建步骤</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 1. 生成唯一boundary
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;----WebKitFormBoundary&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87>Date</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 2. 构建各个部分（所有部分都是Uint8Array）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>parts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>boundary</span><span style=color:#ce5c00;font-weight:700>:</span>     <span style=color:#4e9a06>&#34;--&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\r\n&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>disposition</span><span style=color:#ce5c00;font-weight:700>:</span>  <span style=color:#4e9a06>&#39;Content-Disposition: form-data; name=&#34;audio&#34;; filename=&#34;file.wav&#34;\r\n&#39;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>contentType</span><span style=color:#ce5c00;font-weight:700>:</span>  <span style=color:#4e9a06>&#34;Content-Type: audio/wav\r\n\r\n&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>audioData</span><span style=color:#ce5c00;font-weight:700>:</span>    <span style=color:#000;font-weight:700>[</span><span style=color:#000>WAV文件的二进制数据</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#000>crlf</span><span style=color:#ce5c00;font-weight:700>:</span>         <span style=color:#4e9a06>&#34;\r\n&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>closing</span><span style=color:#ce5c00;font-weight:700>:</span>      <span style=color:#4e9a06>&#34;--&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>boundary</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;--\r\n&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 3. 计算总大小
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>totalSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>boundary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disposition</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>contentType</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>crlf</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>                <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>closing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 4. 分配ArrayBuffer
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayBuffer</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>totalSize</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>view</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Uint8Array</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 5. 按顺序复制
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>boundary</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>boundary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disposition</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>disposition</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>contentType</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>contentType</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>audioData</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>crlf</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>crlf</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span>
</span></span><span style=display:flex><span><span style=color:#000>view</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>parts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>closing</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 6. 发送
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>send</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=4-端到端语音链路>4. 端到端语音链路</h2><h3 id=41-后端整体角色与接口约束>4.1 后端整体角色与接口约束</h3><ul><li><strong>后端框架</strong>：基于一个现代的 Python Web 框架构建，对外提供 REST 风格 API。</li><li><strong>版本管理</strong>：所有接口统一挂载在一个版本前缀之下，例如 <code>/api/v1</code>，便于未来扩展与兼容。</li><li><strong>语音相关接口</strong>：<ul><li>语音转命令接口：<code>POST /api/v1/voice/command</code></li><li>语音转文字接口（测试语音）：<code>POST /api/v1/voice/transcribe</code></li></ul></li><li><strong>与 QGC 对接方式</strong>：<ul><li>QGC 前端通过 <code>multipart/form-data</code> 上传字段名为 <code>audio</code> 的音频文件。</li><li>后端返回 JSON 结构，主体字段为 <code>result</code> 或 <code>text</code> 等，用于承载执行结果或转写文字。</li></ul></li></ul><h3 id=42-后端分层结构>4.2 后端分层结构</h3><ul><li><p><strong>API 接口层</strong>：</p><ul><li>暴露 <code>/voice/command</code> 和 <code>/voice/transcribe</code> 等 HTTP 接口。</li><li>负责请求解析、基础校验、依赖注入以及异常到 HTTP 错误码的转换。</li></ul></li><li><p><strong>语音处理层</strong>：</p><ul><li>接收上传音频，完成格式和内容的基础检查（例如：文件是否为空、扩展名是否在允许列表中）。</li><li>将音频内容写入临时介质或缓冲区，以便后续语音识别模型使用。</li><li>调用本地语音识别模型（如 Whisper small@CPU，单例加载），得到转写文本。</li></ul></li><li><p><strong>智能体与无人机控制层</strong>：</p><ul><li>提供一个“无人机智能体”对象，对外暴露 <code>process(command_text, task_type)</code> 等高层方法。</li><li>内部持有一个“机队管理器”对象，用于实际下发飞行指令（如起飞、降落、绕圈、飞往航点等）。</li><li>通过外部大模型（LLM）完成自然语言到控制代码的转换，并在受控环境中执行。</li></ul></li><li><p><strong>配置与异常处理层</strong>：</p><ul><li>定义一组专门的异常类型（例如：音频为空、音频格式不支持、语音模型不可用、转写结果为空、智能体未初始化等），并由统一异常处理器转换为结构化 HTTP 响应。</li></ul></li></ul><h3 id=43-语音转命令接口逻辑流程>4.3 语音转命令接口：逻辑流程</h3><p>语音转命令接口的逻辑可以概括为以下步骤：</p><ol><li><p><strong>接收上传音频</strong></p><ul><li>使用一个通用的文件上传参数（例如 <code>audio_file</code>），通过 <code>multipart/form-data</code> 方式接收。</li><li>若文件名缺失或内容为空，抛出如 <code>EmptyAudioError</code> 之类的业务异常。</li></ul></li><li><p><strong>文件格式与内容校验</strong></p><ul><li>允许扩展名集合如：<code>{".wav", ".mp3", ".flac", ".m4a", ".ogg", ".webm", ".mpeg", ".mp4"}</code>。</li><li>若扩展名不在允许列表中，抛出如 <code>UnsupportedAudioFormatError</code> 异常，并在错误信息中提示支持的格式。</li><li>QGC 端推荐统一上传标准 WAV（PCM, 44100Hz, 16bit, 单声道），以简化链路和调试。</li></ul></li><li><p><strong>写入临时介质并调用语音模型</strong></p><ul><li>将上传的二进制内容写入一个临时路径或缓冲区，供语音识别模型使用。</li><li>通过类似 <code>get_speech_model()</code> 的单例函数获取语音识别模型实例：<ul><li>首次调用时完成模型加载，并捕获缺少依赖、加载失败等情况。</li><li>后续请求复用同一个模型实例，避免重复加载导致的性能问题。</li></ul></li><li>调用模型的 <code>transcribe(temp_audio)</code> 方法获得 <code>transcribed_text</code>。</li><li>无论成功与否，都在合适时机删除临时音频文件或释放缓冲区，避免磁盘/内存泄漏。</li><li>若 <code>transcribed_text</code> 为空，抛出如 <code>AudioTranscribeError</code> 的语义化异常。</li></ul></li><li><p><strong>调用智能体进行命令解释与执行</strong></p><ul><li>通过依赖注入或全局管理函数获取当前的“无人机智能体”实例（例如 <code>get_drone_agent()</code>）。</li><li>若智能体尚未正确初始化（例如机队管理器不可用等），直接返回指引用户检查环境的配置提示，而不是继续执行。</li><li>调用智能体的异步方法，例如：<ul><li><code>agent.process(transcribed_text, task_type="control")</code></li></ul></li><li>在 <code>task_type="control"</code> 场景下，智能体内部的大致逻辑为：<ol><li>读取当前机队状态，只允许对“已连接无人机”进行操作。</li><li>若无可用无人机，直接返回例如“未连接任何无人机”的错误文案，而不是尝试自行连接。</li><li>构造上游约束清晰的提示词，将用户自然语言命令、可用方法列表和安全限制一同输入 LLM。</li><li>从 LLM 返回中提取 Python 控制代码片段，在受限制的命名空间内执行，仅暴露受控的机队管理对象和必要的工具方法。</li><li>汇总“生成代码文本 + 实际执行结果”，拼接成一个富文本字符串，作为最终返回值。</li></ol></li></ul></li><li><p><strong>统一结果封装与返回</strong></p><ul><li>将智能体返回的字符串包装到统一的响应模型中，例如：<ul><li><code>{ "result": "&lt;带或不带 ANSI 颜色的执行结果文本>" }</code></li></ul></li><li>发生异常时，将内部异常转换为结构化 JSON 错误响应，包含至少：<ul><li>机器可读的错误类型（如 <code>"error_type": "empty_audio"</code>）</li><li>面向用户的错误提示（如 <code>"message": "音频文件为空，请重新录制后再试"</code>）</li></ul></li></ul></li></ol><h3 id=44-语音转文字接口测试接口>4.4 语音转文字接口（测试接口）</h3><p>除语音转命令外，后端还提供一个纯“语音转文字”能力，主要用于：</p><ul><li>调试语音识别链路（确认录音质量与模型表现）。</li><li>为其他上层应用提供字幕/转写服务。</li></ul><p>该接口的典型行为：</p><ol><li>与 <code>/voice/command</code> 相同方式接收 <code>multipart/form-data</code> 的音频文件。</li><li>复用相同的语音识别模型，将音频转写为文本。</li><li>返回结构化响应，例如：<ul><li><code>text</code>: 转写得到的文本内容。</li><li><code>language</code>: 语言标识（如 <code>"zh"</code>）。</li><li><code>duration</code>: 音频时长的字符串表示。</li><li><code>processing_time</code>: 服务端处理耗时的字符串表示。</li></ul></li></ol><h3 id=45-端到端时序总结后端视角>4.5 端到端时序总结（后端视角）</h3><p>结合前端章节中的整体时序图，从后端视角可以将关键步骤概括为：</p><ol><li><strong>接收请求</strong>：收到 <code>POST /api/v1/voice/command</code> 请求，Content-Type 为 <code>multipart/form-data</code>，字段名为 <code>audio</code>。</li><li><strong>基础校验</strong>：检查文件名、扩展名、内容长度，过滤掉明显无效请求。</li><li><strong>语音转写</strong>：将音频内容交给本地语音识别模型，得到自然语言 <code>transcribed_text</code>。</li><li><strong>智能体处理</strong>：调用无人机智能体的 <code>process()</code> 方法，由 LLM 生成受约束的控制代码并执行，严格遵守“只操作已连接无人机、不自行连接”的规则。</li><li><strong>结果封装</strong>：将执行结果封装成统一 JSON 响应返回前端，可包含 ANSI 颜色信息以便前端渲染。</li><li><strong>资源清理</strong>：确保临时音频文件和中间缓冲在成功或异常场景下均被正确清理，避免长期资源泄漏。</li></ol><h2 id=5-api-接口规范>5. API 接口规范</h2><h3 id=51-语音命令接口>5.1 语音命令接口</h3><h4 id=请求规范>请求规范</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>POST /api/v1/voice/command
</span></span><span style=display:flex><span>Content-Type: multipart/form-data; boundary=&lt;boundary&gt;
</span></span><span style=display:flex><span>Accept: application/json
</span></span></code></pre></div><p><strong>请求体（multipart格式）</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>------WebKitFormBoundary1234567890
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;audio&#34;; filename=&#34;recording_1234567890.wav&#34;
</span></span><span style=display:flex><span>Content-Type: audio/wav
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[WAV文件二进制数据]
</span></span><span style=display:flex><span>------WebKitFormBoundary1234567890--
</span></span></code></pre></div><p><strong>WAV文件格式要求</strong>：</p><ul><li>格式：PCM</li><li>采样率：44100 Hz</li><li>位深度：16 bit</li><li>声道数：1 (单声道)</li><li>文件格式：标准WAV (RIFF header)</li></ul><h4 id=响应规范>响应规范</h4><p><strong>成功响应（200 OK）</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;result&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;命令执行成功的详细信息&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>result字段</strong>可以包含：</p><ul><li>纯文本</li><li>带ANSI颜色代码的文本</li><li>多行文本（\n换行）</li></ul><p><strong>ANSI颜色代码示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>\033[32m成功\033[0m: 起飞命令已执行
</span></span><span style=display:flex><span>\033[33m警告\033[0m: 电池电量较低
</span></span><span style=display:flex><span>\033[31m错误\033[0m: GPS信号弱
</span></span></code></pre></div><h2 id=6-附录文件位置参考>6. 附录：文件位置参考</h2><h4 id=c文件>C++文件</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>src/QmlControls/AudioRecorderController.h       - 音频控制器头文件
</span></span><span style=display:flex><span>src/QmlControls/AudioRecorderController.cc      - 音频控制器实现
</span></span><span style=display:flex><span>src/Settings/BackendSettings.h                  - 后端设置头文件
</span></span><span style=display:flex><span>src/Settings/BackendSettings.cc                 - 后端设置实现
</span></span><span style=display:flex><span>src/QmlControls/QGroundControlQmlGlobal.cc      - QML类型注册
</span></span></code></pre></div><h4 id=json配置文件>JSON配置文件</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>src/Settings/Backend.SettingsGroup.json         - 后端设置配置
</span></span></code></pre></div><h4 id=qml文件>QML文件</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>src/QmlControls/BottomFlyViewToolBar.qml        - 底部工具栏（含语音交互）
</span></span><span style=display:flex><span>src/UI/MainWindow.qml                           - 主窗口状态管理
</span></span></code></pre></div><h4 id=构建配置>构建配置</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>src/QmlControls/CMakeLists.txt                  - 添加AudioRecorderController
</span></span></code></pre></div><hr><h2 id=参考文档>参考文档</h2><ul><li><a href=https://docs.qgroundcontrol.com/master/en/>QGroundControl 开发文档</a></li><li><a href=https://fastapi.tiangolo.com/>FastAPI 官方文档</a></li><li><a href=https://platform.openai.com/docs/api-reference>OpenAI GPT 模型 API 参考</a></li><li><a href=https://github.com/openai/whisper>Whisper 模型文档</a></li></ul><hr class=my-4><section class=donate-section><h3>请我喝杯咖啡</h3><p>如果本文对你有帮助，欢迎打赏支持作者。</p><div class=donate-images style=display:flex;gap:12px;flex-wrap:wrap;align-items:center><img src=https://Zero-Kq.github.io/docsy/images/coffee/afdian-Zed%20Liu.jpeg alt="donation afdian-Zed Liu.jpeg" loading=lazy style="max-height:500px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)">
<img src=https://Zero-Kq.github.io/docsy/images/coffee/alipay.jpg alt="donation alipay.jpg" loading=lazy style="max-height:500px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)"></div></section></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\[",right:"\\]",display:!0},{left:"\\(",right:"\\)",display:!1}],throwOnError:!1})'></script><script defer src=https://Zero-Kq.github.io/docsy/js/toc-glider.js></script><script defer src=https://Zero-Kq.github.io/docsy/js/custom-scrollbar.js></script><script defer src=https://Zero-Kq.github.io/docsy/js/taxonomy-collapse.js></script></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Mail aria-label=Mail><a target=_blank rel=noopener href=/about/ aria-label=Mail><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Wechat aria-label=Wechat><a target=_blank rel=noopener href=/about/ aria-label=Wechat><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=QQ aria-label=QQ><a target=_blank rel=noopener href=/about/ aria-label=QQ><i class="fab fa-qq"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Wallhaven aria-label=Wallhaven><a target=_blank rel=noopener href=https://wallhaven.cc/user/Zero-kq/favorites/1954116 aria-label=Wallhaven><i class="fa fa-image"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Docsy & Template" aria-label="Docsy & Template"><a target=_blank rel=noopener href=https://github.com/google/docsy aria-label="Docsy & Template"><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Docsy Authors | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=https://policies.google.com/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><link rel=stylesheet href=/docsy/css/katex.min.css integrity="sha512-ZM1PixOs+Hiz5T4s/tUuBQT7UEr+DwSRATmWGFJHdtCkNBfGenbU/j/JScRWP3g8J5NAEgsak7vg8ukL4KHv9w==" crossorigin=anonymous><script defer src=/docsy/js/katex.min.js integrity="sha512-vFkXe/gge28FXBtE7UvBb051/SXO7VQ2caFUFwoguvU6H0NI3QSbvrL7qzCXr8QlWJXiVIbvWJ5Yf+CmdNsFJw==" crossorigin=anonymous></script><script defer src=/docsy/js/mhchem.min.js integrity="sha512-3ev+ZV+t8BSzoQQ3rz9+H/C0Eq+islU1W1BuSYQ+XNPvlZi96z5MlGcS7WrzVceYvYXt56+1nKQcGNVcyQwZWg==" crossorigin=anonymous></script><script defer src=/docsy/js/auto-render.min.js integrity="sha512-b7lFrW8ua+HKkcEoQoS3DhCfDvlN18+gmLjlYHauOs0LzIBsh/iwYC9bfxZCn6RUKhLruAHGVaGYw8xk16lIFg==" crossorigin=anonymous onload=renderMathInElement(document.body,null)></script><script type=module async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@latest\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script><script src=/docsy/js/main.min.b540f305b126afbbf8653419bb091d1c388e5adc77b849e8a878766c4de19b67.js integrity="sha256-tUDzBbEmr7v4ZTQZuwkdHDiOWtx3uEnoqHh2bE3hm2c=" crossorigin=anonymous></script><script defer src=/docsy/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/docsy/js/tabpane-persist.js></script></body></html>